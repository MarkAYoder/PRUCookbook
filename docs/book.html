<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="Mark A. Yoder">
<title>PRU Cookbook</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
<h1>PRU Cookbook</h1>
<div class="details">
<span id="author" class="author">Mark A. Yoder</span><br>
<span id="email" class="email"><a href="mailto:Mark.A.Yoder@Rose-Hulman.edu">Mark.A.Yoder@Rose-Hulman.edu</a></span><br>
<span id="revnumber">version 2.0 beta</span>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_case_studies_introduction">1. Case Studies - Introduction</a>
<ul class="sectlevel2">
<li><a href="#_robotics_control_library">1.1. Robotics Control Library</a></li>
<li><a href="#_beaglelogic_a_14_channel_logic_analyzer">1.2. BeagleLogic - a 14-channel Logic Analyzer</a></li>
<li><a href="#_neopixels_5050_rgb_leds_with_integrated_drivers_ledscape">1.3. NeoPixels - 5050 RGB LEDs with Integrated Drivers (LEDScape)</a></li>
<li><a href="#case_rgb_matrix">1.4. RGB LED Matrix - No Integrated Drivers (Falcon Christmas)</a></li>
<li><a href="#_machinekit">1.5. MachineKit</a></li>
<li><a href="#_ardupilot">1.6. ArduPilot</a></li>
</ul>
</li>
<li><a href="#_getting_started">2. Getting Started</a>
<ul class="sectlevel2">
<li><a href="#_selecting_a_beagle">2.1. Selecting a Beagle</a></li>
<li><a href="#_installing_the_latest_os_on_your_bone">2.2. Installing the Latest OS on Your Bone</a></li>
<li><a href="#_flashing_a_micro_sd_card">2.3. Flashing a Micro SD Card</a></li>
<li><a href="#_cloud9_ide">2.4. Cloud9 IDE</a></li>
<li><a href="#_getting_example_code">2.5. Getting Example Code</a></li>
<li><a href="#_blinking_an_led">2.6. Blinking an LED</a></li>
</ul>
</li>
<li><a href="#_running_a_program_configuring_pins">3. Running a Program; Configuring Pins</a>
<ul class="sectlevel2">
<li><a href="#_getting_example_code_2">3.1. Getting Example Code</a></li>
<li><a href="#_compiling_and_running">3.2. Compiling and Running</a></li>
<li><a href="#_stopping_and_starting_the_pru">3.3. Stopping and Starting the PRU</a></li>
<li><a href="#details_makefile">3.4. The Standard Makefile</a></li>
<li><a href="#_compiling_with_clpru_and_lnkpru">3.5. Compiling with clpru and lnkpru</a></li>
<li><a href="#detail_linker">3.6. The Linker Command File - am335x_pru.cmd</a></li>
<li><a href="#_loading_firmware">3.7. Loading Firmware</a></li>
<li><a href="#details_configure_servos">3.8. Configuring Pins for Controlling Servos</a></li>
<li><a href="#details_configure_encoders">3.9. Configuring Pins for Controlling Encoders</a></li>
</ul>
</li>
<li><a href="#_debugging_and_benchmarking">4. Debugging and Benchmarking</a>
<ul class="sectlevel2">
<li><a href="#_debugging_via_an_led">4.1. Debugging via an LED</a></li>
<li><a href="#_dmesg_hw">4.2. dmesg â€“Hw</a></li>
<li><a href="#debug_prudebug">4.3. prudebug - A Simple Debugger for the PRU</a></li>
<li><a href="#_uart">4.4. UART</a></li>
<li><a href="#_copyright">4.5. Copyright</a></li>
</ul>
</li>
<li><a href="#_building_blocks_applications">5. Building Blocks - Applications</a>
<ul class="sectlevel2">
<li><a href="#_memory_allocation">5.1. Memory Allocation</a></li>
<li><a href="#_auto_initialization_of_built_in_led_triggers">5.2. Auto Initialization of built-in LED Triggers</a></li>
<li><a href="#blocks_pwm">5.3. PWM Generator</a></li>
<li><a href="#_controlling_the_pwm_frequency">5.4. Controlling the PWM Frequency</a></li>
<li><a href="#_loop_unrolling_for_better_performance">5.5. Loop Unrolling for Better Performance</a></li>
<li><a href="#_making_all_the_pulses_start_at_the_same_time">5.6. Making All the Pulses Start at the Same Time</a></li>
<li><a href="#_adding_more_channels_via_pru_1">5.7. Adding More Channels via PRU 1</a></li>
<li><a href="#_sychronziing_two_prus">5.8. Sychronziing Two PRUs</a></li>
<li><a href="#_reading_an_input_at_regular_intervals">5.9. Reading an Input at Regular Intervals</a></li>
<li><a href="#_analog_wave_generator">5.10. Analog Wave Generator</a></li>
<li><a href="#blocks_ws2812">5.11. WS2812 (NeoPixel) driver</a></li>
<li><a href="#_setting_neopixels_to_different_colors">5.12. Setting NeoPixels to Different Colors</a></li>
<li><a href="#_controlling_arbitrary_leds">5.13. Controlling Arbitrary LEDs</a></li>
<li><a href="#_controlling_neopixels_through_a_kernel_driver">5.14. Controlling NeoPixels Through a Kernel Driver</a></li>
<li><a href="#_rgb_led_matrix_no_integrated_drivers">5.15. RGB LED Matrix - No Integrated Drivers</a></li>
<li><a href="#_compiling_and_inserting_rpmsg_pru">5.16. Compiling and Inserting rpmsg_pru</a></li>
<li><a href="#_copyright_2">5.17. Copyright</a></li>
</ul>
</li>
<li><a href="#_accessing_more_io">6. Accessing More I/O</a>
<ul class="sectlevel2">
<li><a href="#_editing_bootuenv_txt_to_access_the_p8_header_on_the_black">6.1. Editing /boot/uEnv.txt to Access the P8 Header on the Black</a></li>
<li><a href="#_accessing_gpio">6.2. Accessing gpio</a></li>
<li><a href="#io_uio">6.3. Configuring for UIO Instead of RemoteProc</a></li>
<li><a href="#_converting_pasm_assembly_code_to_clpru">6.4. Converting pasm Assembly Code to clpru</a></li>
</ul>
</li>
<li><a href="#_more_performance">7. More Performance</a>
<ul class="sectlevel2">
<li><a href="#_calling_assembly_from_c">7.1. Calling Assembly from C</a></li>
<li><a href="#_returning_a_value_from_assembly">7.2. Returning a Value from Assembly</a></li>
<li><a href="#_using_the_built_in_counter_for_timing">7.3. Using the Built-In Counter for Timing</a></li>
<li><a href="#_xout_and_xin_transfering_between_prus">7.4. Xout and Xin - Transfering Between PRUs</a></li>
<li><a href="#_copyright_3">7.5. Copyright</a></li>
</ul>
</li>
<li><a href="#_moving_to_the_beaglebone_ai">8. Moving to the BeagleBone AI</a>
<ul class="sectlevel2">
<li><a href="#_moving_from_two_to_four_prus">8.1. Moving from two to four PRUs</a></li>
<li><a href="#ai_config">8.2. Seeing how pins are configured</a></li>
<li><a href="#ai_device_tree">8.3. Configuring pins on the AI via device trees</a></li>
<li><a href="#ai_using_pru_pins">8.4. Using the PRU pins</a></li>
</ul>
</li>
<li><a href="#_index">Index</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div style="page-break-after: always;"></div>
<div class="paragraph">
<p><a href="../index.html">Outline</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_case_studies_introduction"><a class="link" href="#_case_studies_introduction">1. Case Studies - Introduction</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>It&#8217;s an exciting time to be making projects that use embedded processors.
Make:'s <a href="https://makezine.com/comparison/boards/">Makers' Guide to Boards</a> shows
many of the options that are available and groups them into different types.
<em>Single board computers</em> (SBCs) generally run Linux on some sort of <a href="https://www.arm.com/">ARM</a>
processor.  Examples are the BeagleBoard and the Raspberry Pi.  Another type
is the <em>microcontroller</em>, of which the <a href="https://www.arduino.cc/">Arduino</a> is
popular.</p>
</div>
<div class="paragraph">
<p>The SBCs are used because they have an operating system to manage files, I/O,
and schedule when things are run, all while possibly talking to the Internet.
Microcontrollers shine when things
being interfaced require careful timing and can&#8217;t afford to have an OS preempt an
operation.</p>
</div>
<div class="paragraph">
<p>But what if you have a projcet that needs the flexibility of an OS and the timing
of a microcontroller?  This is where the BeagleBoard excells since it has both
an ARM procssor running Linux and two <sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>;
<strong>P</strong>rogrammable <strong>R</strong>eal-Time <strong>U</strong>nits (PRUs).
The PRUs have 32-bit cores which run
independently of the ARM processor, therefore they can
be programmed to respond quickly to inputs and produce very precisely timed
outputs.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>TODO Update link</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are many projects that use the PRU
(<a href="http://processors.wiki.ti.com/index.php/PRU_Projects" class="bare">http://processors.wiki.ti.com/index.php/PRU_Projects</a>)
&lt;&lt;<a href="http://../projects.html" class="bare">http://../projects.html</a>, PRU Projects&gt;&gt;</p>
</div>
<div class="paragraph">
<p>to do things that can&#8217;t be
done with just a SBC or just a microcontroller. Here we present some case studies that give a high-level view of using the PRUs.  In later
chapters you will see the details of how they work.</p>
</div>
<div class="paragraph">
<p>Here we present</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Robotics Control Library <a href="http://strawsondesign.com/docs/roboticscape/" class="bare">http://strawsondesign.com/docs/roboticscape/</a></p>
</li>
<li>
<p>BeagleLogic <a href="https://github.com/abhishek-kakkar/BeagleLogic/wiki" class="bare">https://github.com/abhishek-kakkar/BeagleLogic/wiki</a></p>
</li>
<li>
<p>NeoPixels - 5050 RGB LEDs with Integrated Drivers (LEDscape) <a href="https://github.com/Yona-Appletree/LEDscape" class="bare">https://github.com/Yona-Appletree/LEDscape</a></p>
</li>
<li>
<p>RGB LED Matrix (Falcon Christmas) <a href="http://falconchristmas.com" class="bare">http://falconchristmas.com</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following are resources used in this chapter.</p>
</div>
<div class="ulist">
<div class="title">Resources</div>
<ul>
<li>
<p><a href="https://github.com/beagleboard/pocketbeagle/wiki/System-Reference-Manual#673_PRUICSS_Pin_Access">Pocket Beagle System Reference Manual</a></p>
</li>
<li>
<p><a href="https://github.com/derekmolloy/exploringBB/blob/master/chp06/docs/BeagleboneBlackP8HeaderTable.pdf">BeagleBone Black P8 Header Table</a></p>
</li>
<li>
<p><a href="https://github.com/derekmolloy/exploringBB/blob/master/chp06/docs/BeagleboneBlackP9HeaderTable.pdf">BeagleBone Black P9 Header Table</a></p>
</li>
<li>
<p><a href="https://github.com/beagleboard/beaglebone-ai/wiki/System-Reference-Manual">BeagleBone AI System Reference Manual</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_robotics_control_library"><a class="link" href="#_robotics_control_library">1.1. Robotics Control Library</a></h3>
<div class="paragraph">
<p>Robotics is an embedded application that often requires both an SBC to control the
high-level tasks (such as path planning, line following, communicating with the user)
<em>and</em> a microcontroller to handle the low-level tasks (such as telling motors how fast
to turn, or how to balance in response to an IMU input).  The
<a href="https://www.ucsdrobotics.org/edumip">EduMIP</a> balancing
<a href="https://www.hackster.io/edumip/edumip-13a29c">robot</a>
demonstrates that by using the PRU, the Blue can handle both the high
and low -level tasks without an additional microcontroller. The EduMIP is shown
in <a href="#case_blue">Blue balancing</a>.</p>
</div>
<div id="case_blue" class="paragraph">
<div class="title">Blue balancing</div>
<p><span class="image"><img src="./01case/figures/blue.png" alt="Blue balancing"></span></p>
</div>
<div class="paragraph">
<p>The <a href="http://strawsondesign.com/docs/roboticscape/">Robotics Control Library</a> is a
package that is already installed on the Beagle
that contains a C library and example/testing programs. It uses the PRU to extend the
real-time hardware of the Bone by adding eight addional servo channels and one
addition real-time encoder input.</p>
</div>
<div class="paragraph">
<p>The following examples show how easy it is to use the PRU for robotics.</p>
</div>
<div class="sect3">
<h4 id="_controlling_eight_servos"><a class="link" href="#_controlling_eight_servos">Controlling Eight Servos</a></h4>
<div class="sect4">
<h5 id="_problem"><a class="link" href="#_problem">Problem</a></h5>
<div class="paragraph">
<p>You need to control eight servos, but the Bone doesn&#8217;t have enough pulse width
modulation (PWM) channels
and you don&#8217;t want to add hardware.</p>
</div>
</div>
<div class="sect4">
<h5 id="_solution"><a class="link" href="#_solution">Solution</a></h5>
<div class="paragraph">
<p>The Robotics Control Library provides eight additional PWM channels via the PRU that can be used out of the box.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The I/O pins on the Beagles have a mutliplexer that lets you select what I/O
appears on a given pin.  The Blue has the mux already configured to to run these
examples.  Follow the instructions in
<a href="../03details/detailsl.html#details_configure_servos">Configuring Pins for Controlling Servos</a>
to configure the pins for the Black and the Pocket.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Just run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>sudo rc_test_servos -f 10 -p 1.5</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>-f 10</code> says to use a frequency of 10 Hz and the <code>-p 1.5</code> says to set the position to <code>1.5</code>.  The range of positions is
<code>-1.5</code> to <code>1.5</code>.   Run <code>rc_test_servos -h</code> to see all the options.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>rc_test_servos -h</strong>

 Options
 -c {channel}   Specify one channel from 1-8.
                Otherwise all channels will be driven equally
 -f {hz}        Specify pulse frequency, otherwise 50hz is used
 -p {position}  Drive servo to a position between -1.5 &amp; 1.5
 -w {width_us}  Send pulse width in microseconds (us)
 -s {limit}     Sweep servo back/forth between +- limit
                Limit can be between 0 &amp; 1.5
 -r {ch}        Use DSM radio channel {ch} to control servo
 -h             Print this help messege

sample use to center servo channel 1:
   rc_test_servo -c 1 -p 0.0</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_discussion"><a class="link" href="#_discussion">Discussion</a></h5>
<div class="paragraph">
<p>The BeagleBone Blue sends these eight outputs to it&#8217;s servo channels.  The others use the pins shown in the
<a href="#sase__register_to_pin_table">Register to pin table</a>.</p>
</div>
<table id="sase__register_to_pin_table" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. PRU register to pin table</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">PRU pin</th>
<th class="tableblock halign-left valign-top">Blue pin</th>
<th class="tableblock halign-left valign-top">Black pin</th>
<th class="tableblock halign-left valign-top">Pocket pin</th>
<th class="tableblock halign-left valign-top">AI pin</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pru1_r30_8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_27</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.35</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pru1_r30_10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_28</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.35</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_42</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pru1_r30_9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_29</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.02</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_14</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pru1_r30_11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_30</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.04</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_27</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pru1_r30_6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_39</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_19</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pru1_r30_7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_40</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_13</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pru1_r30_4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_41</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pru1_r30_5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_42</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_18</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can find these details in the
<a href="https://github.com/derekmolloy/exploringBB/blob/master/chp06/docs/BeagleboneBlackP8HeaderTable.pdf">P8 Header Table</a>,
<a href="https://github.com/derekmolloy/exploringBB/blob/master/chp06/docs/BeagleboneBlackP9HeaderTable.pdf">P9 Header Table</a>,
<a href="https://github.com/beagleboard/pocketbeagle/wiki/System-Reference-Manual#673_PRUICSS_Pin_Access">Pocket Beagle System Reference Manual</a>
(Here is a more usable version of the <a href="https://docs.google.com/spreadsheets/d/1FRGvYOyW1RiNSEVprvstfJAVeapnASgDXHtxeDOjgqw/edit?usp=sharing">table</a>.)
and
<a href="https://github.com/beagleboard/beaglebone-ai/wiki/System-Reference-Manual">BeagleBone AI System Reference Manual</a>.
(Here is a more usable version of the <a href="https://docs.google.com/spreadsheets/d/1dFSBVem86vAUD7MLXvqdS-N0Efi8_g_O1iTqzql8DAo/edit#gid=0">table</a>.)</p>
</div>
<div class="paragraph">
<p>Be default the PRUs are already loaded with the code needed to run the
servos.  All you have to do is run the command.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_controlling_individual_servos"><a class="link" href="#_controlling_individual_servos">Controlling Individual Servos</a></h4>
<div class="sect4">
<h5 id="_problem_2"><a class="link" href="#_problem_2">Problem</a></h5>
<div class="paragraph">
<p><code>rc_test_servos</code> is nice, but I need to control the servos individually.</p>
</div>
</div>
<div class="sect4">
<h5 id="_solution_2"><a class="link" href="#_solution_2">Solution</a></h5>
<div class="paragraph">
<p>You can modify <code>rc_test_servos.c</code>.  You&#8217;ll find it on the bone online at
&lt;<a href="https://github.com/beagleboard/librobotcontrol/blob/master/examples/src/rc_test_servos.c" class="bare">https://github.com/beagleboard/librobotcontrol/blob/master/examples/src/rc_test_servos.c</a>.</p>
</div>
<div class="paragraph">
<p>Just past line 250 you&#8217;ll find a <code>while</code> loop that has calls to <code>rc_servo_send_pulse_normalized(ch,servo_pos)</code> and
<code>rc_servo_send_pulse_us(ch, width_us)</code>.  The first call sets the pulse width relative to the pulse period; the other
sets the width to an absolute time.  Use whichever works for you.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_controlling_more_than_eight_channels"><a class="link" href="#_controlling_more_than_eight_channels">Controlling More Than Eight Channels</a></h4>
<div class="sect4">
<h5 id="_problem_3"><a class="link" href="#_problem_3">Problem</a></h5>
<div class="paragraph">
<p>I need more than eight PWM channels, or I need less jitter on the off time.</p>
</div>
</div>
<div class="sect4">
<h5 id="_solution_3"><a class="link" href="#_solution_3">Solution</a></h5>
<div class="paragraph">
<p>This is a more advanced problem and required reprograming the PRUs.  See
<a href="../05blocks/blocks.html.html#blocks_pwm">PWM Generator</a> for an example.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_reading_hardware_encoders"><a class="link" href="#_reading_hardware_encoders">Reading Hardware Encoders</a></h4>
<div class="sect4">
<h5 id="_problem_4"><a class="link" href="#_problem_4">Problem</a></h5>
<div class="paragraph">
<p>I want to use four encoders to measure four motors, but I only see hardware for three.</p>
</div>
</div>
<div class="sect4">
<h5 id="_solution_4"><a class="link" href="#_solution_4">Solution</a></h5>
<div class="paragraph">
<p>The forth encoder can be implemented on the PRU. If you run <code>rc_test_encoders_eqep</code> on the Blue, you will see the output of
encoders E1-E3 which are connected to the eEQP hardware.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>rc_test_encoders_eqep</strong>

Raw encoder positions
      E1   |      E2   |      E3   |
         0 |         0 |         0 |^C</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also access these hardware encoders on the Black and Pocket using the
pins shown in <a href="#case_pin_mapping">eQEP to pin mapping</a>.</p>
</div>
<table id="case_pin_mapping" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. eQEP to pin mapping</caption>
<colgroup>
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">eQEP</th>
<th class="tableblock halign-left valign-top">Blue pin</th>
<th class="tableblock halign-left valign-top">Black pin A</th>
<th class="tableblock halign-left valign-top">Black pin B</th>
<th class="tableblock halign-left valign-top">AI pin A</th>
<th class="tableblock halign-left valign-top">AI pin B</th>
<th class="tableblock halign-left valign-top">Pocket pin A</th>
<th class="tableblock halign-left valign-top">Pocket pin B</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_42B</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_27</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.31</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.24</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_35</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_33</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_35</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_33</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.10</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.24</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.33</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_41</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_42</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_19</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_41</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_15</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.09</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.18</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_25</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_24</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_42</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_27</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The I/O pins on the Beagles have a mutliplexer that lets you select what I/O
appears on a given pin.  The Blue has the mux already configured to to run these
examples.  Follow the instructions in
<a href="../03details/details.adocs.html#details_configure_encoders">Configuring Pins for Controlling Encoders</a>
to configure the pins for the Black and the Pocket.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_reading_pru_encoder"><a class="link" href="#_reading_pru_encoder">Reading PRU Encoder</a></h4>
<div class="sect4">
<h5 id="_problem_5"><a class="link" href="#_problem_5">Problem</a></h5>
<div class="paragraph">
<p>I want to access the PRU encoder.</p>
</div>
</div>
<div class="sect4">
<h5 id="_solution_5"><a class="link" href="#_solution_5">Solution</a></h5>
<div class="paragraph">
<p>The forth encoder is implemented on the PRU and accessed with <code>sudo rc_test_encoders_pru</code></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This command
needs root permission, so the <code>sudo</code> is needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here&#8217;s what you will see</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>sudo rc_test_encoders_pru</strong>
[sudo] password for debian:

Raw encoder position
      E4   |
         0 |^C</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you aren&#8217;t running the Blue you will have to configure the pins as shown
in the note above.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_beaglelogic_a_14_channel_logic_analyzer"><a class="link" href="#_beaglelogic_a_14_channel_logic_analyzer">1.2. BeagleLogic - a 14-channel Logic Analyzer</a></h3>
<div class="sect3">
<h4 id="_problem_6"><a class="link" href="#_problem_6">Problem</a></h4>
<div class="paragraph">
<p>I need a 100Msps, 14-channel logic analyzer</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_6"><a class="link" href="#_solution_6">Solution</a></h4>
<div class="paragraph">
<p><a href="https://beaglelogic.readthedocs.io/en/latest/">BeagleLogic</a> is a 100Msps,
14-channel logic analyzer that runs on the Beagle.</p>
</div>
<div class="verseblock">
<pre class="content">BeagleLogic turns your BeagleBone [Black] into a 14-channel, 100Msps Logic Analyzer. Once loaded, it presents itself as a character device node <strong>/dev/beaglelogic</strong>.

The core of the logic analyzer is the 'beaglelogic' kernel module that reserves memory for and drives the two Programmable Real-Time Units (PRU) via the remoteproc interface wherein the PRU directly writes logic samples to the System Memory (DDR RAM) at the configured sample rate one-shot or continuously without intervention from the ARM core.</pre>
<div class="attribution">
&#8212; https://github.com/abhishek-kakkar/BeagleLogic/wiki
</div>
</div>
<div class="paragraph">
<p>The quickest solution is to get the <a href="https://github.com/abhishek-kakkar/BeagleLogic/wiki/BeagleLogic-%22no-setup-required%22-setup:-Introducing-System-Image!">no-setup-required image</a>.  It runs on an older image (15-Apr-2016) but should still work.</p>
</div>
<div class="paragraph">
<p>If you want to be running a newer image, there are instructions on the site for <a href="https://beaglelogic.readthedocs.io/en/latest/install.html">installing BeagleLogic</a>, but I had to do the additional steps in <a href="#case_installing_beaglelogic">Installing BeagleLogic</a>.</p>
</div>
<div id="case_installing_beaglelogic" class="listingblock">
<div class="title">Installing BeagleLogic</div>
<div class="content">
<pre class="highlight"><code class="language-linenums" data-lang="linenums">bone$ <strong>git clone https://github.com/abhishek-kakkar/BeagleLogic</strong>
bone$ <strong>cd BeagleLogic/kernel</strong>
bone$ <strong>mv beaglelogic-00A0.dts beaglelogic-00A0.dts.orig</strong>
bone$ <strong>wget https://gist.githubusercontent.com/abhishek-kakkar/0761ef7b10822cff4b3efd194837f49c/raw/eb2cf6cfb59ff5ccb1710dcd7d4a40cc01cfc050/beaglelogic-00A0.dts</strong>
bone$ <strong>make overlay</strong>
bone$ <strong>sudo cp beaglelogic-00A0.dtbo /lib/firmware/</strong>
bone$ <strong>sudo update-initramfs -u -k `uname -r`</strong>
bone$ <strong>sudo reboot</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the Bone has rebooted, browse to 192.168.7.2:4000 where you&#8217;ll see
<a href="#case_beaglelogic_capture">BeagleLogic Data Capture</a>.  Here you can easily select the sample
rate, number of samples, and which pins to sample.
Then click <strong>Begin Capture</strong> to capture your data, at up to 100 MHz!</p>
</div>
<div id="case_beaglelogic_capture" class="imageblock">
<div class="content">
<img src="./01case/figures/beaglelogic_capture.png" alt="BeagleLogic Data Capture">
</div>
<div class="title">Figure 1. BeagleLogic Data Capture</div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_2"><a class="link" href="#_discussion_2">Discussion</a></h4>
<div class="paragraph">
<p>BeagleLogic is a complete system that includes firmware for the PRUs,
a kernel module and a web interface that create a powerful 100 MHz
logic analyzer on the Bone with no additional hardware needed.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you need buffered inputs, consider
<a href="http://standalone.beaglelogic.net/en/latest/">BeagleLogic Standalone</a>,
a turnkey Logic Analyzer built on top of BeagleLogic.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The kernel interface makes it easy to control the PRUs through the
command line.  For example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bone$ <strong>dd if=/dev/beaglelogic of=mydump bs=1M count=1</strong></pre>
</div>
</div>
<div class="paragraph">
<p>will capture a binary dump from the PRUs. The sample rate and number of
bits per sample can be controlled through <code>/sys/</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bone$ <strong>cd /sys/devices/virtual/misc/beaglelogic</strong>
bone$ <strong>ls</strong>
buffers      filltestpattern  power       state         uevent
bufunitsize  lasterror        samplerate  subsystem
dev          memalloc         sampleunit  triggerflags
bone$ <strong>cat samplerate</strong>
1000
bone$ <strong>cat sampleunit</strong>
8bit</pre>
</div>
</div>
<div class="paragraph">
<p>You can set the sample rate by simply writing to <code>samplerate</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bone$ <strong>echo 100000000 &gt; samplerate</strong></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://beaglelogic.readthedocs.io/en/latest/sysfs_attributes.html">sysfs attributes Reference</a>
has more details on configuring via sysfs.</p>
</div>
<div class="paragraph">
<p>If you run <code>dmesg -Hw</code> in another window you can see when a capture
is started and stopped.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bone$ <strong>dmesg -Hw</strong>
[Jul25 08:46] misc beaglelogic: capture started with sample rate=100000000 Hz, sampleunit=1, triggerflags=0
[  +0.086261] misc beaglelogic: capture session ended</pre>
</div>
</div>
<div class="paragraph">
<p>BeagleLogic uses the two PRUs to sample at 100Msps.  Getting a PRU running at 200Hz to sample at 100Msps is a slick trick.
<a href="http://theembeddedkitchen.net/beaglelogic-building-a-logic-analyzer-with-the-prus-part-1/449">The Embedded Kitchen</a> has a nice article
explaining how the PRUs get this type of performance.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_neopixels_5050_rgb_leds_with_integrated_drivers_ledscape"><a class="link" href="#_neopixels_5050_rgb_leds_with_integrated_drivers_ledscape">1.3. NeoPixels - 5050 RGB LEDs with Integrated Drivers (LEDScape)</a></h3>
<div class="sect3">
<h4 id="_problem_7"><a class="link" href="#_problem_7">Problem</a></h4>
<div class="paragraph">
<p>




You have an <a href="http://www.adafruit.com/products/1138">Adafruit NeoPixel LED string</a>,
<a href="http://www.adafruit.com/products/1487">Adafruit NeoPixel LED matrix</a> or
any other type of
<a href="https://cdn-shop.adafruit.com/datasheets/WS2812.pdf">WS2812 LED</a>
and want to light it up.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_7"><a class="link" href="#_solution_7">Solution</a></h4>
<div class="paragraph">
<p>You can either write your own code
(See <a href="../05blocks/blocks.html#blocks_ws2812">WS2812 Driver</a>), or
use <a href="https://github.com/Yona-Appletree/LEDscape">LEDscape</a> which
is a library for controlling NeoPixels using <a href="http://openpixelcontrol.org/">Open
Pixel Control</a>.</p>
</div>
<div class="verseblock">
<pre class="content">LEDscape is a library and service for controlling individually addressable LEDs from a Beagle Bone Black or Beagle Bone Green using the onboard PRUs. It currently supports WS281x (WS2811, WS2812, WS2812b), WS2801 and initial support for DMX.

It can support up to 48 connected strings and can drive them with very little load on the main processor.

Background
LEDscape was originally written by Trammell Hudson (<a href="http://trmm.net/Category:LEDscape" class="bare">http://trmm.net/Category:LEDscape</a>) for controlling WS2811-based LEDs. Since his original work, his version (<a href="https://github.com/osresearch/LEDscape" class="bare">https://github.com/osresearch/LEDscape</a>) has been repurposed to drive a different type of LED panel (e.g. <a href="http://www.adafruit.com/products/420" class="bare">http://www.adafruit.com/products/420</a>).

This version of the library was forked from his original WS2811 work. Various improvements have been made in the attempt to make an accessible and powerful LED driver based on the BBB. Many thanks to Trammell for his excellent work in scaffolding the BBB and PRUs for driving LEDs.</pre>
<div class="attribution">
&#8212; https://github.com/Yona-Appletree/LEDscape
</div>
</div>
<div class="paragraph">
<p>LEDscape can drive 48 strings of LEDs that are arbitary length with no addional
hardware!  Here&#8217;s how to install it.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>LEDscape uses UIO, an older method for talking to the PRU.  See
<a href="../06io/io.html#io_uio">Configuring for UIO Instead of RemoteProc</a> to configure your Bone to use UIO.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This has only been tested on the BeagleBone Black.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>First install LEDscape and openpixelcontrol.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>git clone https://github.com/Yona-Appletree/LEDscape.git</strong>
bone$ <strong>git clone https://github.com/zestyping/openpixelcontrol</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next find which channels are on which pins</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>node LEDscape/pru/pinmap.js</strong>
Using mapping: Original LEDscape from original-ledscape
                       Internal Channel Index
 Row  Pin#           P9            Pin#  |  Pin#           P8            Pin# Row
  1    1                            2    |   1                            2    1
  2    3                            4    |   3                            4    2
  3    5                            6    |   5                            6    3
  4    7                            8    |   7       25          26       8    4
  5    9                            10   |   9       28          27       10   5
  6    11      13          23       12   |   11      16          15       12   6
  7    13      14          21       14   |   13      10          11       14   7
  8    15      19          22       16   |   15      18          17       16   8
  9    17                           18   |   17      12          24       18   9
  10   19                           20   |   19       9                   20   10
  11   21       1           <strong>0       22</strong>   |   21                           22   11
  12   23      20                   24   |   23                           24   12
  13   25                   7       26   |   25                           26   13
  14   27                  47       28   |   27      41                   28   14
  15   29      45          46       30   |   29      42          43       30   15
  16   31      44                   32   |   31       5           6       32   16
  17   33                           34   |   33       4          40       34   17
  18   35                           36   |   35       3          39       36   18
  19   37                           38   |   37      37          38       38   19
  20   39                           40   |   39      35          36       40   20
  21   41       8           2       42   |   41      33          34       42   21
  22   43                           44   |   43      31          32       44   22
  23   45                           46   |   45      29          30       46   23</code></pre>
</div>
</div>
<div class="paragraph">
<p>LEDscape supports up to 48 channels (strings) of LEDs.  The above table shows
how the channel numbers map to BeagleBone Black pins.  We&#8217;ll use channel 0
which maps to P9_22. Wire your LED string to P9_22.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>The following is a hack, but it makes it work.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We need to edit <code>ledsacpe.c</code> and <code>opc-server.c</code> to make them work.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>cd LEDscape</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now edit <code>opc-server.c</code> and comment out line 723.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>// pthread_create(&amp;g_threads.e131_server_thread.handle, NULL, e131_server_thread, NULL</pre>
</div>
</div>
<div class="paragraph">
<p>Next edit <code>ledscape.c</code> and comment out lines 29-44</p>
</div>
<div class="listingblock">
<div class="content">
<pre>// static const uint8_t gpios0[] = {
//  // 2, 3, 7, 8, 9, 10, 11, 14, 20, 22, 23, 26, 27, 30, 31
//  3, 7, 8, 9, 10, 11, 14, 20, 22, 23, 26, 27, 30, 31
// };

// static const uint8_t gpios1[] = {
//  12, 13, 14, 15, 16, 17, 18, 19, 28, 29
// };

// static const uint8_t gpios2[] = {
//  1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 22, 23, 24, 25,
// };

// static const uint8_t gpios3[] = {
//  14, 15, 16, 17, 19, 21
// };</pre>
</div>
</div>
<div class="paragraph">
<p>And also lines 176-184</p>
</div>
<div class="listingblock">
<div class="content">
<pre>// Configure all of our output pins.
// for (unsigned i = 0 ; i &lt; ARRAY_COUNT(gpios0) ; i++)
//  pru_gpio(0, gpios0[i], 1, 0);
// for (unsigned i = 0 ; i &lt; ARRAY_COUNT(gpios1) ; i++)
//  pru_gpio(1, gpios1[i], 1, 0);
// for (unsigned i = 0 ; i &lt; ARRAY_COUNT(gpios2) ; i++)
//  pru_gpio(2, gpios2[i], 1, 0);
// for (unsigned i = 0 ; i &lt; ARRAY_COUNT(gpios3) ; i++)
//  pru_gpio(3, gpios3[i], 1, 0);</pre>
</div>
</div>
<div class="paragraph">
<p>Now configure P9_22 and run <code>make</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>config-pin P9_22 out</strong>
bone$ <strong>config-pin -q P9_22</strong>
P9_22 Mode: gpio Direction: out Value: 0
bone$ <strong>make</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now run <code>sudo opc-server</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>sudo ./opc-server</strong>
[main] Starting server on ports (tcp=7890, udp=7890) for 176 pixels on 48 strips
[main] Demo Mode Enabled
Allocating buffers for 8448 pixels (202752 bytes)
[main] Initializing / Updating server...frame_size1=8448
Starting demo data thread
[udp] Starting UDP server on port 7890
[render] Starting render thread for 8448 total pixels
[main] Starting LEDscape...pru_init: PRU 0: data 0xb4d5d000 @ 8192 bytes,  DMA 0xb4cdd000 / 9c940000 @ 262144 bytes
pru_init: PRU 1: data 0xa4c5f000 @ 8192 bytes,  DMA 0xa4bdd000 / 9c940000 @ 262144 bytes
String PRU0 with pru/bin/ws281x-original-ledscape-pru0.bin... OK
String PRU1 with pru/bin/ws281x-original-ledscape-pru1.bin... OK
[tcp] Starting TCP server on 7890
[demo] Starting Demo: fade
{
    "outputMode": "ws281x",
    "outputMapping": "original-ledscape",
    "demoMode": "fade",
    "ledsPerStrip": 176,
    "usedStripCount": 48,
    "colorChannelOrder": "BRG",
    "opcTcpPort": 7890,
    "opcUdpPort": 7890,
    "enableInterpolation": true,
    "enableDithering": true,
    "enableLookupTable": true,
    "lumCurvePower": 2.0000,
    "whitePoint": {
        "red": 0.9000,
        "green": 1.0000,
        "blue": 1.0000
    }
}
[render] fps_info={frame_avg_usec: 1924, possible_fps: 519.75, actual_fps: 0.10, sample_frames: 1}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should now see "a pleasing pattern of rotating color hues".</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_3"><a class="link" href="#_discussion_3">Discussion</a></h4>
<div class="paragraph">
<p>LEDscape is higly configurable.  When you run <code>opc-server</code> it first prints out
its configuration.  If it doesn&#8217;t receive any data after three seconds it
will go into demo mode.  In this configuration, <code>demoMode</code> is set to <code>fade</code>
which produces the nice pattern you are seeing.  (You can set <code>demoMode</code>
to <code>none</code> if you would rather not see anything.  See README.md for
other options.)</p>
</div>
<div class="paragraph">
<p>Notice it&#8217;s currently configured to drive 48 strings (<code>usedStripCount</code>) with
176 LEDS (<code>ledsPerStrip</code>). It&#8217;s also set to interpolate (<code>enableInterpolation</code>)
colors, that is, rather than abruptly switching to a new color, it will
smoothly fade between the two.  With this configuration it uses about 26%
of the ARM CPU.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s write a configuration file that fits our LEDs string. Copy the default
configuration and edit it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>cp configs/ws281x-config.json my-config.json</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now edit it to match <a href="#case_config">my-config.json</a>.</p>
</div>
<div id="case_config" class="listingblock">
<div class="title">my-config.json</div>
<div class="content">
<pre class="highlight"><code>{
    "outputMode": "ws281x",
    "outputMapping": "original-ledscape",
    "demoMode": "fade",
    "ledsPerStrip": 16,
    "usedStripCount": 1,
    "colorChannelOrder": "BRG",
    "opcTcpPort": 7890,
    "opcUdpPort": 7890,
    "enableInterpolation": false,
    "enableDithering": false,
    "enableLookupTable": true,
    "lumCurvePower": 2.0000,
    "whitePoint": {
        "red": 0.9000,
        "green": 1.0000,
        "blue": 1.0000
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run this with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>sudo ./opc-server --config my-config.json</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we are only using about 7% of the ARM CPU.</p>
</div>
<div class="paragraph">
<p>You can now run a program that sends data to the string.  <a href="#case_circle">circle.py</a> is
a simple python example that sequencies an LED through the entire string.  It
uses <code>opc.py</code> which is included in the <code>code</code> directory.</p>
</div>
<div id="case_circle" class="listingblock">
<div class="title">circle.py</div>
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">#!/usr/bin/env python3

"""A demo client for Open Pixel Control
http://github.com/zestyping/openpixelcontrol

Runs an LED around in a circle

"""

import time
import opc

ADDRESS = 'localhost:7890'

# Create a client object
client = opc.Client(ADDRESS)

# Test if it can connect
if client.can_connect():
    print('connected to %s' % ADDRESS)
else:
    # We could exit here, but instead let's just print a warning
    # and then keep trying to send pixels in case the server
    # appears later
    print('WARNING: could not connect to %s' % ADDRESS)

# Send pixels forever
STR_LEN=16
for i in range(STR_LEN):
    leds = [(0, 0, 0)] * STR_LEN
leds[0] = (0, 127, 0)

while True:
    tmp = leds[0]
    for i in range(STR_LEN-1):
        leds[i] = leds[i+1]
    leds[-1] = tmp
    if client.put_pixels(leds, channel=0):
        print('sent')
    else:
        print('not connected')
    time.sleep(0.1)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="case_rgb_matrix"><a class="link" href="#case_rgb_matrix">1.4. RGB LED Matrix - No Integrated Drivers (Falcon Christmas)</a></h3>
<div class="sect3">
<h4 id="_problem_8"><a class="link" href="#_problem_8">Problem</a></h4>
<div class="paragraph">
<p>You want to use a RGB LED Matrix display that doesn&#8217;t have integrated
drivers such as the
<a href="https://www.adafruit.com/product/2277">64x32 RGB LED Matrix</a> by Adafuit
shown in <a href="#case_adfruit_matrix">Adafruit LED Matrix</a>.</p>
</div>
<div id="case_adfruit_matrix" class="imageblock">
<div class="content">
<img src="./01case/figures/ledmatrix.jpg" alt="Adafruit LED Matrix">
</div>
<div class="title">Figure 2. Adafruit LED Matrix</div>
</div>
</div>
<div class="sect3">
<h4 id="_solution_8"><a class="link" href="#_solution_8">Solution</a></h4>
<div class="paragraph">
<p><a href="http://falconchristmas.com">Falcon Christmas</a> makes a software package
called
<a href="http://falconchristmas.com/forum/index.php/board,8.0.html">Falcon Player</a> (FPP) which can drive such displays.</p>
</div>
<div class="verseblock">
<pre class="content">The Falcon Player (FPP) is a lightweight, optimized, feature-rich sequence player designed to run on low-cost SBC&#8217;s (Single Board Computers).
FPP is a software solution that you download and install on hardware which can be purchased from numerous sources around the internet. FPP aims to be controller agnostic, it can talk E1.31, DMX, Pixelnet, and Renard to hardware from multiple hardware vendors, including controller hardware from Falcon Christmas available via COOPs or in the store on FalconChristmas.com.</pre>
<div class="attribution">
&#8212; http://www.falconchristmas.com/wiki/FPP:FAQ#What_is_FPP.3F
</div>
</div>
<div class="sect4">
<h5 id="_hardware"><a class="link" href="#_hardware">Hardware</a></h5>
<div class="paragraph">
<p>The Beagle hardware can be either a BeagleBone Black with the
<a href="https://oshpark.com/shared_projects/7mSHNZcD">Octoscroller Cape</a>, or a
PocketBeagle with the
<a href="https://www.hackster.io/daniel-kulp/pocketscroller-led-panel-cape-for-pocketbeagle-fe12a6">PocketScroller LED Panel Cape</a>.
(See <a href="https://www.tindie.com/products/dkulp/pocketscroller-led-panel-cape-for-pocketbeagle/">to purchase</a>.)
<a href="https://www.diychristmas.org/wiki/index.php?title=Building_an_Octoscroller_Matrix_Display">Building and Octoscroller Matrix Display</a>
gives details for using the BeagleBone Black.</p>
</div>
<div class="paragraph">
<p><a href="#case_pocket">Pocket Beagle Driving a P5 RGB LED Matrix via the PocketScroller Cape</a> shows how to attach the PocketBeagle to the P5 LED matrix
and where to attach the 5V power.  If you are going to turn on all the LEDs
to full white at the same time you will need at least a 4A supply.</p>
</div>
<div id="case_pocket" class="imageblock">
<div class="content">
<img src="./01case/figures/pocketscroller.jpg" alt="Pocket Beagle Driving a P5 RGB LED Matrix via the PocketScroller Cape">
</div>
<div class="title">Figure 3. Pocket Beagle Driving a P5 RGB LED Matrix via the PocketScroller Cape</div>
</div>
</div>
<div class="sect4">
<h5 id="_software"><a class="link" href="#_software">Software</a></h5>
<div class="paragraph">
<p>The FPP software is most easily installed by downloading the
<a href="http://dankulp.com/bbb/">current FPP image</a>, flashing an SD card and
booting from it.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>The really brave can install it on a already running image.  See details at
<a href="https://github.com/FalconChristmas/fpp/blob/master/SD/FPP_Install.sh" class="bare">https://github.com/FalconChristmas/fpp/blob/master/SD/FPP_Install.sh</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Assuming the PocketBeagle is attached via the USB cable,
on your host computer browse to <a href="http://192.168.7.2/" class="bare">http://192.168.7.2/</a> and you will see
<a href="#case_fpp_program_control">Falcon Play Program Control</a>.</p>
</div>
<div id="case_fpp_program_control" class="imageblock">
<div class="content">
<img src="./01case/figures/fpp_program_control.png" alt="Falcon Play Program Control">
</div>
<div class="title">Figure 4. Falcon Play Program Control</div>
</div>
<div class="paragraph">
<p>You can test the display by first setting up the Channel Outputs and then
going to <strong>Display Testing</strong>.  <a href="#case_channel_outputs_menu">Selecting Channel Outputs</a> shows where to
select Channel Outputs and <a href="#case_channel_outputs">Channel Outputs Settings</a> shows which settings to use.</p>
</div>
<div id="case_channel_outputs_menu" class="imageblock">
<div class="content">
<img src="./01case/figures/fpp_channel_outputs_menu.png" alt="Selecting Channel Outputs">
</div>
<div class="title">Figure 5. Selecting Channel Outputs</div>
</div>
<div id="case_channel_outputs" class="imageblock">
<div class="content">
<img src="./01case/figures/fpp_channel_outputs.png" alt="Channel Outputs Settings">
</div>
<div class="title">Figure 6. Channel Outputs Settings</div>
</div>
<div class="paragraph">
<p>Click on the <strong>LED Panels</strong> tab and then the only changes I made was
to select the <strong>Single Panel Size</strong> to be
<strong>64x32</strong> and to check the <strong>Enable LED Panel Output</strong>.</p>
</div>
<div class="paragraph">
<p>Next we need to test the display.  Select <strong>Display Testing</strong> shown in
<a href="#case_display_testing_menu">Selecting Display Testing</a>.</p>
</div>
<div id="case_display_testing_menu" class="imageblock">
<div class="content">
<img src="./01case/figures/fpp_display_testing_menu.png" alt="Selecting Display Testing">
</div>
<div class="title">Figure 7. Selecting Display Testing</div>
</div>
<div class="paragraph">
<p>Set the <strong>End Channel</strong> to <strong>6144</strong>. (6144 is 3*64*32)
Click <strong>Enable Test Mode</strong> and your matrix should light up.  Try the different
testing patterns shown in <a href="#case_display_testing">Display Testing Options</a>.</p>
</div>
<div id="case_display_testing" class="imageblock">
<div class="content">
<img src="./01case/figures/fpp_display_testing.png" alt="Display Testing Options">
</div>
<div class="title">Figure 8. Display Testing Options</div>
</div>
</div>
<div class="sect4">
<h5 id="_xlights_creating_content_for_the_display"><a class="link" href="#_xlights_creating_content_for_the_display">xLights - Creating Content for the Display</a></h5>
<div class="paragraph">
<p>Once you are sure your LED Matrix is working correctly you can program it
with a sequence.</p>
</div>
<div class="verseblock">
<pre class="content">xLights is a free and open source program that enables you to design, create and play amazing lighting displays through the use of DMX controllers, E1.31 Ethernet controllers and more.

With it you can layout your display visually then assign effects to the various items throughout your sequence. This can be in time to music (with beat-tracking built into xLights) or just however you like.
xLights runs on Windows, OSX and Linux</pre>
<div class="attribution">
&#8212; https://xlights.org/
</div>
</div>
<div class="paragraph">
<p>xLights can be installed on your host computer (not the Beagle) by
following instructions at
<a href="https://code.launchpad.net/~chris-debenham/+archive/ubuntu/xlights" class="bare">https://code.launchpad.net/~chris-debenham/+archive/ubuntu/xlights</a>.</p>
</div>
<div class="paragraph">
<p>Run xLights and you&#8217;ll see <a href="#case_xlights_setup">xLights Setup</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>host$ <strong>apt install xlights</strong>
host$ <strong>xLights</strong></code></pre>
</div>
</div>
<div id="case_xlights_setup" class="imageblock">
<div class="content">
<img src="./01case/figures/xlights_setup.png" alt="xLights Setup">
</div>
<div class="title">Figure 9. xLights Setup</div>
</div>
<div class="paragraph">
<p>We&#8217;ll walk you through a simple setup to get an animation to display on the
RGB Matrix.  xLights can use a protocol called E1.31 to send information to
the display.  Setup xLights by clicking on <strong>Add E1.31</strong> and entering the values
shown in <a href="#case_xlights_setup_e1_31">Setting Up E1.31</a>.</p>
</div>
<div id="case_xlights_setup_e1_31" class="imageblock">
<div class="content">
<img src="./01case/figures/xlights_setup_e1_31.png" alt="Setting Up E1.31">
</div>
<div class="title">Figure 10. Setting Up E1.31</div>
</div>
<div class="paragraph">
<p>The <strong>IP Address</strong> is the Bone&#8217;s address as seen from the host computer.
Each LED is one channel, so one RGB LED is three channels.  The P5 board
has 3*64*32 or 6144 channels.  These are grouped into universes of 512
channels each.  This gives 6144/512 = 12 universes. See the
<a href="https://www.doityourselfchristmas.com/wiki/index.php?title=E1.31_(Streaming-ACN)_Protocol#Configuring_Sequencing_Software_to_use_E1.31_Output">E.13 documentation</a>
for more details.</p>
</div>
<div class="paragraph">
<p>Your setup should look like <a href="#case_xlights_setup_done">xLights setup for P5 display</a>.  Click the
<strong>Save Setup</strong> button to save.</p>
</div>
<div id="case_xlights_setup_done" class="imageblock">
<div class="content">
<img src="./01case/figures/xlights_setup_done.png" alt="xLights setup for P5 display">
</div>
<div class="title">Figure 11. xLights setup for P5 display</div>
</div>
<div class="paragraph">
<p>Next click on the <strong>Layout</strong> tab.  Click on the <strong>Matrix</strong> button as shown in
<a href="#case_xlights_matrix">Setting up the Matrix Layout</a>, then click on the black area where you want your
matrix to appear.</p>
</div>
<div id="case_xlights_matrix" class="imageblock">
<div class="content">
<img src="./01case/figures/xlights_layout.png" alt="Setting up the Matrix Layout">
</div>
<div class="title">Figure 12. Setting up the Matrix Layout</div>
</div>
<div class="paragraph">
<p><a href="#case_xlights_layout_details">Layout details for P5 matrix</a> shows the setting to use for the P5 matrix.</p>
</div>
<div id="case_xlights_layout_details" class="imageblock">
<div class="content">
<img src="./01case/figures/xlights_layout_details.png" alt="Layout details for P5 matrix">
</div>
<div class="title">Figure 13. Layout details for P5 matrix</div>
</div>
<div class="paragraph">
<p>All I changed was <strong># Strings</strong>, <strong>Nodes/String</strong>, <strong>Starting Location</strong> and most
importantly, expand <strong>String Properties</strong> and select at <strong>String Type</strong> of
<strong>RGB Nodes</strong>.  Above the seeting you should see that <strong>Start Chan</strong> is 1 and
the <strong>End Chan</strong> is 6144, which is the total number of individual LEDs (3*63*32).
xLights now knows we are working with a P5 matrix, now on to the sequencer.</p>
</div>
<div class="paragraph">
<p>Now click on the <strong>Sequencer</strong> tab and then click on the <strong>New Sequence</strong> button
(<a href="#case_seq_new">Starting a new sequence</a>).</p>
</div>
<div id="case_seq_new" class="imageblock">
<div class="content">
<img src="./01case/figures/xlights_seq_new.png" alt="Starting a new sequence">
</div>
<div class="title">Figure 14. Starting a new sequence</div>
</div>
<div class="paragraph">
<p>Then click on <strong>Animation</strong>, <strong>20fps (50ms)</strong>, and <strong>Quick Start</strong>. Learning how to
do sequences is beyond the scope of this cookbook, however I&#8217;ll shown you how
do simple sequence just to be sure xLights is talking to the Bone.</p>
</div>
</div>
<div class="sect4">
<h5 id="_setting_up_e1_31_on_the_bone"><a class="link" href="#_setting_up_e1_31_on_the_bone">Setting Up E1.31 on the Bone</a></h5>
<div class="paragraph">
<p>First we need to setup FPP to take input from xLights.  Do this by going to
the <strong>Input/Output Setup</strong> menu and selecting <strong>Channel Inputs</strong>.  Then
enter <strong>12</strong> for <strong>Universe Count</strong> and click <strong>set</strong> and you will see
<a href="#case_inputs_setup">E1.31 Bridge Mode Universes</a>.</p>
</div>
<div id="case_inputs_setup" class="imageblock">
<div class="content">
<img src="./01case/figures/fpp_inputs_setup.png" alt=".E1.31 Bridge Mode Universes">
</div>
<div class="title">Figure 15. E1.31 Bridge Mode Universes</div>
</div>
<div class="paragraph">
<p>Click on the <strong>Save</strong> button above the table.  Then go to the <strong>Status Control</strong>
menu and select <strong>Status Page</strong>.  Set the <strong>FPPD Mode:</strong> to <strong>Bridge</strong> as shown
in <a href="#case_mode_bridge">Bridge Mode</a>.</p>
</div>
<div id="case_mode_bridge" class="imageblock">
<div class="content">
<img src="./01case/figures/fpp_mode_bridge.png" alt="Bridge Mode">
</div>
<div class="title">Figure 16. Bridge Mode</div>
</div>
</div>
<div class="sect4">
<h5 id="_testing_the_xlights_connection"><a class="link" href="#_testing_the_xlights_connection">Testing the xLights Connection</a></h5>
<div class="paragraph">
<p>The Bone is now listening for commands from xLights via the E1.31 protocol.
A quick way to verify everything is t o return to xLights and go to the
<strong>Tools</strong> menu and select <strong>Test</strong> (<a href="#case_xlights_test">xLights test page</a>).</p>
</div>
<div id="case_xlights_test" class="imageblock">
<div class="content">
<img src="./01case/figures/xlights_test.png" alt="xLights test page">
</div>
<div class="title">Figure 17. xLights test page</div>
</div>
<div class="paragraph">
<p>Click the box under <strong>Select channels&#8230;&#8203;</strong>, click <strong>Output to lights</strong> and
select <strong>Twinkle 50%</strong>.  You matrix should have a colorful twinkle pattern
(<a href="#case_xlights_twinkle">xLights Twinkle test pattern</a>).</p>
</div>
<div id="case_xlights_twinkle" class="imageblock">
<div class="content">
<img src="./01case/figures/xlights_twinkle.jpg" alt="xLights Twinkle test pattern">
</div>
<div class="title">Figure 18. xLights Twinkle test pattern</div>
</div>
</div>
<div class="sect4">
<h5 id="_a_simple_xlights_sequence"><a class="link" href="#_a_simple_xlights_sequence">A Simple xLights Sequence</a></h5>
<div class="paragraph">
<p>Now that the xLights to FPP link is tested you can generate a sequence to
play.  Close the Test window and click on the <strong>Sequencer</strong> tab.  Then drag
an effect from the <strong>Effects</strong> box to the timeline that below it.  Drop it to
the right of the <strong>Matrix</strong> label (<a href="#case_seq_drag">Drag an effect to the timeline</a>).  The click
<strong>Output To Lights</strong> which is the yellow lightbulb to the right on the top
toolbar.  Your matrix should now be displaying your effect.</p>
</div>
<div id="case_seq_drag" class="paragraph">
<div class="title">Drag an effect to the timeline</div>
<p><span class="image"><img src="./01case/figures/xlights_seq_drag.png" alt="Drag an effect to the timeline"></span></p>
</div>
<div class="paragraph">
<p>The setup requires the host computer to send the animation data to the Bone.
The next section shows how to save the sequence and play it on the Bone
standalone.</p>
</div>
</div>
<div class="sect4">
<h5 id="_saving_a_sequence_and_playing_it_standalone"><a class="link" href="#_saving_a_sequence_and_playing_it_standalone">Saving a Sequence and Playing it Standalone</a></h5>
<div class="paragraph">
<p>In xLights save your sequence by hitting Ctrl-S and giving it a name.  I called
mine <strong>fire</strong> since I used a fire effect.  Now, switch back to FPP and select
the <strong>Content Setup</strong> menu and select <strong>File Manager</strong>.  Click the blue
<strong>Select Files</strong> button and select your sequence file that ends in <strong>.fseq</strong>
(<a href="#case_file_manager">FPP file manager</a>).</p>
</div>
<div id="case_file_manager" class="paragraph">
<div class="title">FPP file manager</div>
<p><span class="image"><img src="./01case/figures/fpp_file_manager.png" alt="FPP file manager"></span></p>
</div>
<div class="paragraph">
<p>Once your sequence is uploaded, got to <strong>Content Steup</strong> and select <strong>Playlists</strong>.
Enter you playlist name (I used <strong>fire</strong>) and click <strong>Add</strong>.  Then go down to
the <strong>New Playlist Entry</strong> section and select <strong>Sequence Only</strong>
(<a href="#case_playlist">Adding a new playlist to FPP</a>), then click <strong>Add</strong>.</p>
</div>
<div id="case_playlist" class="imageblock">
<div class="content">
<img src="./01case/figures/fpp_playlist.png" alt="Adding a new playlist to FPP">
</div>
<div class="title">Figure 19. Adding a new playlist to FPP</div>
</div>
<div class="paragraph">
<p>Be sure to click <strong>Save</strong> under <strong>Playlist Details</strong>. Now return to
<strong>Status/Control</strong> and <strong>Status Page</strong> and make sure <strong>FPPD Mode:</strong> is set
to <strong>Player (Standalone)</strong>.  You should see your playlist.  Click the <strong>Play</strong>
button at the bottom of the page and your sequence will play.</p>
</div>
<div class="paragraph">
<p>The beauty of the PRU is that the Beagle can play a detailed sequence at
20 frames per second and the ARM procossor is only 15% used.  The PRUs
are doing all the work.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_machinekit"><a class="link" href="#_machinekit">1.5. MachineKit</a></h3>
<div class="paragraph">
<p><a href="http://www.machinekit.io/">MachineKit</a> is a platform for machine control
applications.  It can control
machine tools, robots, or other automated devices. It can control servo
motors, stepper motors, relays, and other devices related to machine tools.</p>
</div>
<div class="verseblock">
<pre class="content">Machinekit is portable across a wide range of hardware platforms and real-time environments, and delivers excellent performance at low cost. It is based on the HAL component architecture, an intuitive and easy to use circuit model that includes over 150 building blocks for digital logic, motion, control loops, signal processing, and hardware drivers. Machinekit supports local and networked UI options, including ubiquitous platforms like phones or tablets.</pre>
<div class="attribution">
&#8212; http://www.machinekit.io/about/
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ardupilot"><a class="link" href="#_ardupilot">1.6. ArduPilot</a></h3>
<div class="paragraph">
<p><a href="http://ardupilot.org/">ArduPilot</a> is a open source autopilot system supporting multi-copters, traditional helicopters, fixed wing aircraft and rovers.
ArduPilot runs on a many
<a href="http://ardupilot.org/copter/docs/common-autopilots.html">hardware platforms</a>
including the
<a href="http://ardupilot.org/dev/docs/building-for-beaglebone-black-on-linux.html#building-for-beaglebone-black-on-linux">BeagleBone Black</a> and the
<a href="http://ardupilot.org/copter/docs/common-beagle-bone-blue.html">BeagleBone Blue</a>.</p>
</div>
<div class="verseblock">
<pre class="content">Ardupilot is the most advanced, full-featured and reliable open source autopilot software available. It has been developed over 5+ years by a team of diverse professional engineers and computer scientists. It is the only autopilot software capable of controlling any vehicle system imaginable, from conventional airplanes, multirotors, and helicopters, to boats and even submarines. And now being expanded to feature support for new emerging vehicle types such as quad-planes and compound helicopters.
Installed in over 1,000,000 vehicles world-wide, and with its advanced data-logging, analysis and simulation tools, Ardupilot is the most tested and proven autopilot software. The open-source code base means that it is rapidly evolving, always at the cutting edge of technology development. With many peripheral suppliers creating interfaces, users benefit from a broad ecosystem of sensors, companion computers and communication systems. Finally, since the source code is open, it can be audited to ensure compliance with security and secrecy requirements.

The software suite is installed in aircraft from many OEM UAV companies, such as 3DR, jDrones, PrecisionHawk, AgEagle and Kespry. It is also used for testing and development by several large institutions and corporations such as NASA, Intel and Insitu/Boeing, as well as countless colleges and universities around the world.</pre>
<div class="attribution">
&#8212; http://www.machinekit.io/about/
</div>
</div>
<div style="page-break-after: always;"></div>
<div class="paragraph">
<p><a href="../index.html">Outline</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_started"><a class="link" href="#_getting_started">2. Getting Started</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>We assume you have some experience with the Beagle and are here to learn about
the PRU.  This chapter discusses what Beagles are out there, how to load the
latest software image on your beagle, how to run the Cloud9 IDE and how to
blink an LED.</p>
</div>
<div class="paragraph">
<p>If you already have your Beagle and know your way around it, you can find the
code (and the whole book) on the PRU Cookbook github site:
<a href="https://github.com/MarkAYoder/PRUCookbook" class="bare">https://github.com/MarkAYoder/PRUCookbook</a>.</p>
</div>
<div class="sect2">
<h3 id="_selecting_a_beagle"><a class="link" href="#_selecting_a_beagle">2.1. Selecting a Beagle</a></h3>
<div class="sect3">
<h4 id="_problem_9"><a class="link" href="#_problem_9">Problem</a></h4>
<div class="paragraph">
<p>Which Beagle should you use?</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_9"><a class="link" href="#_solution_9">Solution</a></h4>
<div class="paragraph">
<p><a href="http://beagleboard.org/boards" class="bare">http://beagleboard.org/boards</a> lists the many Beagles from which to choose.
Here we&#8217;ll
give examples for the venerable <a href="http://beagleboard.org/black">BeagleBone Black</a>,
the robotics <a href="http://beagleboard.org/blue">BeagleBone Blue</a>,
tiny <a href="http://beagleboard.org/pocket">PockeBeagle</a> and the powerful <a href="http://beagleboard.org/ai">AI</a>.
All the examples should also run on the other Beagles too.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_4"><a class="link" href="#_discussion_4">Discussion</a></h4>
<div class="sect4">
<h5 id="_beaglebone_black"><a class="link" href="#_beaglebone_black">BeagleBone Black</a></h5>
<div class="paragraph">
<p>If you aren&#8217;t sure which Beagle to use, it&#8217;s hard to go wrong with the
<a href="http://beagleboard.org/black">BeagleBone Black</a>.  It&#8217;s the most popular member of the open hardware Beagle family.</p>
</div>
<div id="start_black" class="paragraph">
<div class="title">BeagleBone Black</div>
<p><span class="image"><img src="./02start/figures/product_detail_black_sm.jpg" alt="BeableBone Black"></span></p>
</div>
<div class="paragraph">
<p>The Black has:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>AM335x 1GHz ARMÂ® Cortex-A8 processor</p>
</li>
<li>
<p>512MB DDR3 RAM</p>
</li>
<li>
<p>4GB 8-bit eMMC on-board flash storage</p>
</li>
<li>
<p>3D graphics accelerator</p>
</li>
<li>
<p>NEON floating-point accelerator</p>
</li>
<li>
<p>2x PRU 32-bit microcontrollers</p>
</li>
<li>
<p>USB client for power &amp; communications</p>
</li>
<li>
<p>USB host</p>
</li>
<li>
<p>Ethernet</p>
</li>
<li>
<p>HDMI</p>
</li>
<li>
<p>2x 46 pin headers</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See <a href="http://beagleboard.org/black" class="bare">http://beagleboard.org/black</a> for more details.</p>
</div>
</div>
<div class="sect4">
<h5 id="_beaglebone_blue"><a class="link" href="#_beaglebone_blue">BeagleBone Blue</a></h5>
<div class="paragraph">
<p>The <a href="http://beagleboard.org/blue">Blue</a> is a good choice if you are doing robotics.</p>
</div>
<div id="start_blue" class="imageblock">
<div class="content">
<img src="./02start/figures/beagle-blue.png" alt="BeagleBone Blue">
</div>
<div class="title">Figure 20. BeagleBone Blue</div>
</div>
<div class="paragraph">
<p>The Blue has everything the Black has except it has no Ethernet or HDMI.
But it also has:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Wireless: 802.11bgn, Bluetooth 4.1 and BLE</p>
</li>
<li>
<p>Battery support: 2-cell LiPo with balancing, LED state-of-charge monitor</p>
</li>
<li>
<p>Charger input: 9-18V</p>
</li>
<li>
<p>Motor control: 8 6V servo out, 4 bidirectional DC motor out, 4 quadrature encoder in</p>
</li>
<li>
<p>Sensors: 9 axis IMU (accels, gyros, magnetometer), barometer, thermometer</p>
</li>
<li>
<p>User interface: 11 user programmable LEDs, 2 user programmable buttons</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition you can mount the Blue on the
<a href="https://www.renaissancerobotics.com/eduMIP.html">EduMIP kit</a> as shown in
<a href="#start_edumip">BeagleBone Blue EduMIP Kit</a> to get a balancing robot.</p>
</div>
<div id="start_edumip" class="imageblock">
<div class="content">
<img src="./02start/figures/edumip.png" alt="BeagleBone Blue EduMIP Kit">
</div>
<div class="title">Figure 21. BeagleBone Blue EduMIP Kit</div>
</div>
<div class="paragraph">
<p><a href="https://www.hackster.io/53815/controlling-edumip-with-ni-labview-2005f8" class="bare">https://www.hackster.io/53815/controlling-edumip-with-ni-labview-2005f8</a>
shows how to assemble the robot and control it from
<a href="http://www.ni.com/en-us/shop/labview.html">LabVIEW</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_pocketbeagle"><a class="link" href="#_pocketbeagle">PocketBeagle</a></h5>
<div class="paragraph">
<p>The <a href="http://beagleboard.org/pocket">PocketBeagle</a> is the smallest member of the
Beagle family.  It is an ultra-tiny-yet-complete Beagle that is software
compatible with the other Beagles.</p>
</div>
<div id="start_pocket" class="imageblock">
<div class="content">
<img src="./02start/figures/PocketBeagle-size-compare-small.jpg" alt="PocketBeagle">
</div>
<div class="title">Figure 22. PocketBeagle</div>
</div>
<div class="paragraph">
<p>The Pocket is based on the same processor as the Black and Blue and has:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>8 analog inputs</p>
</li>
<li>
<p>44 digital I/Os and</p>
</li>
<li>
<p>numerous digital interface peripherals</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See <a href="http://beagleboard.org/pocket" class="bare">http://beagleboard.org/pocket</a> for more details.</p>
</div>
</div>
<div class="sect4">
<h5 id="_beaglebone_ai"><a class="link" href="#_beaglebone_ai">BeagleBone AI</a></h5>
<div class="paragraph">
<p>If you want to do deep learning, try the  <a href="http://beagleboard.org/ai">BeagleBone AI</a>.</p>
</div>
<div id="start_ai" class="paragraph">
<div class="title">BeagleBone AI</div>
<p><span class="image"><img src="./02start/figures/BB_AI_BeautyAngle_800px.jpg" alt="BeableBone AI"></span></p>
</div>
<div class="paragraph">
<p>The AI has:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Dual ArmÂ® CortexÂ®-A15 microprocessor subsystem</p>
</li>
<li>
<p>2 C66x floating-point VLIW DSPs</p>
</li>
<li>
<p>2.5MB of on-chip L3 RAM</p>
</li>
<li>
<p>2x dual ArmÂ® CortexÂ®-M4 co-processors</p>
</li>
<li>
<p>4x Embedded Vision Engines (EVEs)</p>
</li>
<li>
<p>2x dual-core Programmable Real-Time Unit and Industrial Communication SubSystem (PRU-ICSS)</p>
</li>
<li>
<p>2D-graphics accelerator (BB2D) subsystem</p>
</li>
<li>
<p>Dual-core PowerVRÂ® SGX544â„¢ 3D GPU</p>
</li>
<li>
<p>IVA-HD subsystem (4K @ 15fps encode and decode support for H.264, 1080p60 for others)</p>
</li>
<li>
<p>BeagleBone Black mechanical and header compatibility</p>
</li>
<li>
<p>1GB RAM and 16GB on-board eMMC flash with high-speed interface</p>
</li>
<li>
<p>USB type-C for power and superspeed dual-role controller; and USB type-A host</p>
</li>
<li>
<p>Gigabit Ethernet, 2.4/5GHz WiFi, and Bluetooth</p>
</li>
<li>
<p>microHDMI</p>
</li>
<li>
<p>Zero-download out-of-box software experience with Debian GNU/Linux</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_installing_the_latest_os_on_your_bone"><a class="link" href="#_installing_the_latest_os_on_your_bone">2.2. Installing the Latest OS on Your Bone</a></h3>
<div class="sect3">
<h4 id="_problem_10"><a class="link" href="#_problem_10">Problem</a></h4>
<div class="paragraph">
<p>You want to find the lastest version of Debian that is available for your Bone.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_10"><a class="link" href="#_solution_10">Solution</a></h4>
<div class="paragraph">
<p>On your host computer open a browser and go to
<a href="http://beagleboard.org/latest-images" class="bare">http://beagleboard.org/latest-images</a>.
This shows you two current choices of recent Debian images,
one for the BeagleBone AI
(<a href="https://debian.beagleboard.org/images/am57xx-debian-10.3-iot-tidl-armhf-2020-04-06-6gb.img.xz">AM5729 Debian 10.3 2020-04-06 8GB SD IoT TIDL</a>) and
one for all the other Beagles (
<a href="https://debian.beagleboard.org/images/bone-debian-10.3-iot-armhf-2020-04-06-4gb.img.xz">AM3358 Debian 10.3 2020-04-06 4GB SD IoT</a>).
Download the one for your Beagle.</p>
</div>
<div class="paragraph">
<div class="title">Latest Debian images</div>
<p><span class="image"><img src="./02start/figures/latest-images.png" alt="Latest Debian images"></span></p>
</div>
<div class="paragraph">
<p>It contains all the packages we&#8217;ll need.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_flashing_a_micro_sd_card"><a class="link" href="#_flashing_a_micro_sd_card">2.3. Flashing a Micro SD Card</a></h3>
<div class="sect3">
<h4 id="_problem_11"><a class="link" href="#_problem_11">Problem</a></h4>
<div class="paragraph">
<p>I&#8217;ve downloaded the image and need to flash my micro SD card.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_11"><a class="link" href="#_solution_11">Solution</a></h4>
<div class="paragraph">
<p>Get a micro SD card that has at least 4GB and preferibly 8GB.</p>
</div>
<div class="paragraph">
<p>There are many ways to flash the card, but the best seems to be Etcher by
<a href="https://www.balena.io/" class="bare">https://www.balena.io/</a>.  Go to <a href="https://www.balena.io/etcher/" class="bare">https://www.balena.io/etcher/</a> and download the version for your host
computer.  Fire up Etcher, select the image you just downloaded (no need to
uncompress it, Etcher does it for you), select the SD card and hit the <strong>Flash</strong>
button and wait for it to finish.</p>
</div>
<div id="start_etcher" class="imageblock">
<div class="content">
<img src="./02start/figures/etcher.png" alt="Ether">
</div>
<div class="title">Figure 23. Etcher</div>
</div>
<div class="paragraph">
<p>Once the SD is flashed, insert it in the Beagle and power it up.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_cloud9_ide"><a class="link" href="#_cloud9_ide">2.4. Cloud9 IDE</a></h3>
<div class="sect3">
<h4 id="_problem_12"><a class="link" href="#_problem_12">Problem</a></h4>
<div class="paragraph">
<p>How do I manage and edit my files?</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_12"><a class="link" href="#_solution_12">Solution</a></h4>
<div class="paragraph">
<p>The image you downloaded includes <a href="https://aws.amazon.com/cloud9/">Cloud9</a>,
a web-based intergrated development environment (IDE) as shown in
<a href="#start_c9">Cloud9 IDE</a>.</p>
</div>
<div id="start_c9" class="paragraph">
<div class="title">Cloud9 IDE</div>
<p><span class="image"><img src="./02start/figures/c9.png" alt="The Cloud9 IDE"></span></p>
</div>
<div class="paragraph">
<p>Just point the browswer on your host computer to <a href="http://192.168.7.2" class="bare">http://192.168.7.2</a>
and start exploring.  If you wnat the files in your home directory to appear
in the tree structure click the settings gear and select <strong>Show Home in Favorites</strong>
as shown in <a href="#start_c9_show_home">Cloud9 Showing Home files</a>.</p>
</div>
<div id="start_c9_show_home" class="paragraph">
<div class="title">Cloud9 Showing Home files</div>
<p><span class="image"><img src="./02start/figures/c9ShowHome.png" alt="Cloud9 showing home files"></span></p>
</div>
<div class="paragraph">
<p>If you want to edit files beyond your home directory you can link to the root file
system by:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>cd</strong>
bone$ <strong>ln -s / root</strong>
bone$ <strong>cd root</strong>
bone$ <strong>ls</strong>
bbb-uEnv.txt  boot  etc   ID.txt  lost+found  mnt           opt   root  sbin  sys  usr
bin           dev   home  lib     media       nfs-uEnv.txt  proc  run   srv   tmp  var</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can reach all the files from Cloud9.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_getting_example_code"><a class="link" href="#_getting_example_code">2.5. Getting Example Code</a></h3>
<div class="sect3">
<h4 id="_problem_13"><a class="link" href="#_problem_13">Problem</a></h4>
<div class="paragraph">
<p>You are ready to start playing with the examples and need to find the code.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_13"><a class="link" href="#_solution_13">Solution</a></h4>
<div class="paragraph">
<p>You can find the code (and the whole book) on the PRU Cookbook github site:
<a href="https://github.com/MarkAYoder/PRUCookbook/tree/master/docs" class="bare">https://github.com/MarkAYoder/PRUCookbook/tree/master/docs</a>.  Just clone
it on your Beagle and then look in the <strong>docs</strong> directory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-linenums" data-lang="linenums">bone$ <strong>git clone https://github.com/MarkAYoder/PRUCookbook.git</strong>
bone$ <strong>cd PRUCookbook/docs/</strong>
bone$ <strong>ls -F</strong>
01case/     05blocks/  book.html       header.adoc  notes.adoc
02start/    06io/      book.pdf        index.adoc   notes.html
03details/  07more/    copyright.adoc  index.html   style.adoc
04debug/    book.adoc  hack.sh*        Makefile     style.html</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each chapter has its own
directory and within that directory is a <strong>code</strong> directory that has all of the
code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-linenums" data-lang="linenums">bone$ <strong>cd 02start/code/</strong>
bone$ <strong>ls</strong>
hello.pru0.c  hello.pru1_1.c  Makefile  setup.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Go and explore.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_blinking_an_led"><a class="link" href="#_blinking_an_led">2.6. Blinking an LED</a></h3>
<div class="sect3">
<h4 id="_problem_14"><a class="link" href="#_problem_14">Problem</a></h4>
<div class="paragraph">
<p>You want to make sure everything is set up by blinking an LED.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_14"><a class="link" href="#_solution_14">Solution</a></h4>
<div class="paragraph">
<p>The 'hello, world' of the embedded world is to flash an LED. <a href="#start_hello">hello.pru0.c</a>
is some code that blinks the <code>USR3</code> LED ten times using the PRU.</p>
</div>
<div id="start_hello" class="listingblock">
<div class="title">hello.pru0.c</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">#include &lt;stdint.h&gt;
#include &lt;pru_cfg.h&gt;
#include "resource_table_empty.h"
#include "prugpio.h"

volatile register unsigned int <em>R30;
volatile register unsigned int </em>R31;

void main(void) {
    int i;

    uint32_t <strong>gpio1 = (uint32_t *)GPIO1;

    /</strong> Clear SYSCFG[STANDBY_INIT] to enable OCP master port */
    CT_CFG.SYSCFG_bit.STANDBY_INIT = 0;

    for(i=0; i&lt;10; i++) {
        gpio1[GPIO_SETDATAOUT]   = USR3;    // The the USR3 LED on

        <em>delay_cycles(500000000/5);        // Wait 1/2 second

        gpio1[GPIO_CLEARDATAOUT] = USR3;

        </em>delay_cycles(500000000/5);

    }
    __halt();
}

// Turns off triggers
#pragma DATA_SECTION(init_pins, ".init_pins")
#pragma RETAIN(init_pins)
const char init_pins[] =
    "/sys/class/leds/beaglebone:green:usr3/trigger\0none\0" \
    "\0\0";</code></pre>
</div>
</div>
<div class="paragraph">
<p>Later chapters will go into details of how this code works, but if you want
to run it right now do the following.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>git clone https://github.com/MarkAYoder/PRUCookbook.git</strong>
bone$ <strong>cd PRUCookbook/docs/02start/code</strong></code></pre>
</div>
</div>
<div id="start_running_code" class="listingblock">
<div class="title">Running Code on the Black or Pocket</div>
<div class="content">
<pre class="highlight"><code>bone$ <strong>make TARGET=hello.pru0</strong>
/var/lib/cloud9/common/Makefile:28: MODEL=TI_AM335x_BeagleBone_Black,TARGET=hello.pru0,COMMON=/var/lib/cloud9/common
/var/lib/cloud9/common/Makefile:147: GEN_DIR=/tmp/cloud9-examples,CHIP=am335x,PROC=pru,PRUN=0,PRU_DIR=/sys/class/remoteproc/remoteproc1,EXE=.out
-    Stopping PRU 0
-   copying firmware file /tmp/cloud9-examples/hello.pru0.out to /lib/firmware/am335x-pru0-fw
write_init_pins.sh
writing "none" to "/sys/class/leds/beaglebone:green:usr3/trigger"
-    Starting PRU 0
MODEL   = TI_AM335x_BeagleBone_Black
PROC    = pru
PRUN    = 0
PRU_DIR = /sys/class/remoteproc/remoteproc1</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Running Code on the AI</div>
<div class="content">
<pre class="highlight"><code>bone$ <strong>make TARGET=hello.pru1_1</strong>
/var/lib/cloud9/common/Makefile:28: MODEL=BeagleBoard.org_BeagleBone_AI,TARGET=hello.pru1_1
-    Stopping PRU 1_1
CC  hello.pru1_1.c
"/var/lib/cloud9/common/prugpio.h", line 4: warning #1181-D: #warning directive: "Found AI"
LD  /tmp/cloud9-examples/hello.pru1_1.o
-   copying firmware file /tmp/cloud9-examples/hello.pru1_1.out to /lib/firmware/am57xx-pru1_1-fw
write_init_pins.sh
writing "none" to "/sys/class/leds/beaglebone:green:usr3/trigger"
-    Starting PRU 1_1
MODEL   = BeagleBoard.org_BeagleBone_AI
PROC    = pru
PRUN    = 1_1
PRU_DIR = /dev/remoteproc/pruss1-core1
rm /tmp/cloud9-examples/hello.pru1_1.o</code></pre>
</div>
</div>
<div class="paragraph">
<p>Look quickly and you will see the <code>USR3</code> LED blinking.</p>
</div>
<div class="paragraph">
<p>Later sections give more details on how all this works.</p>
</div>
<div style="page-break-after: always;"></div>
<div class="paragraph">
<p><a href="../index.html">Outline</a></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_running_a_program_configuring_pins"><a class="link" href="#_running_a_program_configuring_pins">3. Running a Program; Configuring Pins</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are a lot of details in compiling and running PRU code.
Fortunately those details are captured in a common <code>Makefile</code> that is
used througout this book.  This chapter shows how to use the <code>Makefile</code> to
compile code and also start and stop the PRUs.</p>
</div>
<div class="paragraph">
<p>The following are resources used in this chapter.</p>
</div>
<div class="ulist">
<div class="title">Resources</div>
<ul>
<li>
<p><a href="http://software-dl.ti.com/codegen/esd/cgt_public_sw/PRU/2.1.5/ti_cgt_pru_2.1.5_armlinuxa8hf_busybox_installer.sh">PRU Code Generation Tools - Compiler</a></p>
</li>
<li>
<p><a href="http://git.ti.com/pru-software-support-package">PRU Software Support Package</a></p>
</li>
<li>
<p><a href="http://www.ti.com/lit/ug/spruhv7b/spruhv7b.pdf">PRU Optimizing C/C++ Compiler</a></p>
</li>
<li>
<p><a href="http://www.ti.com/lit/ug/spruhv6b/spruhv6b.pdf">PRU Assembly Language Tools</a></p>
</li>
<li>
<p><a href="http://www.ti.com/lit/pdf/spruhz6l">AM572x Technical Reference Manual</a> (AI)</p>
</li>
<li>
<p><a href="http://www.ti.com/lit/pdf/spruh73">AM335x Technical Reference Manual</a> (All others)</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_getting_example_code_2"><a class="link" href="#_getting_example_code_2">3.1. Getting Example Code</a></h3>
<div class="sect3">
<h4 id="_problem_15"><a class="link" href="#_problem_15">Problem</a></h4>
<div class="paragraph">
<p>I want to get the files used in this book.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_15"><a class="link" href="#_solution_15">Solution</a></h4>
<div class="paragraph">
<p>It&#8217;s all on a GitHub repository.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>git clone https://github.com/MarkAYoder/PRUCookbook.git</strong></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_compiling_and_running"><a class="link" href="#_compiling_and_running">3.2. Compiling and Running</a></h3>
<div class="sect3">
<h4 id="_problem_16"><a class="link" href="#_problem_16">Problem</a></h4>
<div class="paragraph">
<p>I want to compile and run an example.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_16"><a class="link" href="#_solution_16">Solution</a></h4>
<div class="paragraph">
<p>Change to the directory of the code you want to run.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>cd PRUCookbook/docs/06io/code</strong>
bone$ <strong>ls</strong>
gpio.pru0.c  Makefile  setup.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Source the setup file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>source setup.sh</strong>
TARGET=gpio.pru0
PocketBeagle Found
P1_36
Current mode for P1_36 is:     default</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you are ready to compile and run.  This is automated for you in the Makefile</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>make</strong>
/var/lib/cloud9/common/Makefile:28: MODEL=TI_AM335x_BeagleBone_Black,TARGET=gpio.pru0,COMMON=/var/lib/cloud9/common
/var/lib/cloud9/common/Makefile:147: GEN_DIR=/tmp/cloud9-examples,CHIP=am335x,PROC=pru,PRUN=0,PRU_DIR=/sys/class/remoteproc/remoteproc1,EXE=.out
-    Stopping PRU 0
/bin/sh: 1: echo: echo: I/O error
Cannot stop 0
CC  gpio.pru0.c
"/var/lib/cloud9/common/prugpio.h", line 53: warning #1181-D: #warning directive: "Found am335x"
LD  /tmp/cloud9-examples/gpio.pru0.o
-   copying firmware file /tmp/cloud9-examples/gpio.pru0.out to /lib/firmware/am335x-pru0-fw
write_init_pins.sh
writing "out" to "/sys/class/gpio/gpio30/direction"
-    Starting PRU 0
MODEL   = TI_AM335x_BeagleBone_Black
PROC    = pru
PRUN    = 0
PRU_DIR = /sys/class/remoteproc/remoteproc1
rm /tmp/cloud9-examples/gpio.pru0.o</code></pre>
</div>
</div>
<div class="paragraph">
<p>Congratulations, your are now running a PRU.  If you have an LED attached to
<code>P9_11</code> on the Black, it should be blinking.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_5"><a class="link" href="#_discussion_5">Discussion</a></h4>
<div class="paragraph">
<p>The <code>setup.sh</code> file sets the <code>TARGET</code> to the file you want to compile.
Set it to the filename, without the <code>.c</code> extension (<code>gpio.pru0</code>).
The file extension <code>.pru0</code> specifies the number of the PRU you are using
(either <code>1_0</code>, <code>1_1</code>, <code>2_0</code>, <code>2_1</code> on the AI or <code>0</code> or <code>1</code> on the others)</p>
</div>
<div class="paragraph">
<p>You can override the <code>TARGET</code> on the command line.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bone$ <strong>cp gpio.pru0.c gpio.pru1.c</strong>
bone$ <strong>export TARGET=gpio.pru1</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the <code>TARGET</code> doesn&#8217;t have the <code>.c</code> on the end.</p>
</div>
<div class="paragraph">
<p>You can also specify them when running <code>make</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bone$ <strong>cp gpio.pru0.c gpio.pru1.c</strong>
bone$ <strong>make TARGET=gpio.pru1</strong></pre>
</div>
</div>
<div class="paragraph">
<p>The setup file also contains instructions to figure out which Beagle you are running
and then configure the pins acordingly.</p>
</div>
<div class="listingblock">
<div class="title">setup.sh</div>
<div class="content">
<pre class="highlight"><code class="language-linenums" data-lang="linenums">#!/bin/bash

export TARGET=gpio.pru0
echo TARGET=$TARGET

# Configure the PRU pins based on which Beagle is running
machine=$(awk '{print $NF}' /proc/device-tree/model)
echo -n $machine
if [ $machine = "Black" ]; then
    echo " Found"
    pins="P9_11"
elif [ $machine = "Blue" ]; then
    echo " Found"
    pins=""
elif [ $machine = "PocketBeagle" ]; then
    echo " Found"
    pins="P1_36"
else
    echo " Not Found"
    pins=""
fi

for pin in $pins
do
    echo $pin
    config-pin $pin out
    config-pin -q $pin
done</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2-5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set which PRU to use and which file to compile.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Figure out which type of Beagle we have.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">9-21</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Based on the type, set the <code>pins</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">23-28</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configure (set the pin mux) for each of the pins.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>The BeagleBone AI has it&#8217;s pins preconfigured at boot time, so there&#8217;s no
need to use <code>config-pin</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>Makefile</code> stops the PRU, compiles the file and moves it where it will
be loaded, and then restarts the PRU.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_stopping_and_starting_the_pru"><a class="link" href="#_stopping_and_starting_the_pru">3.3. Stopping and Starting the PRU</a></h3>
<div class="sect3">
<h4 id="_problem_17"><a class="link" href="#_problem_17">Problem</a></h4>
<div class="paragraph">
<p>I want to stop and start the PRU.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_17"><a class="link" href="#_solution_17">Solution</a></h4>
<div class="paragraph">
<p>It&#8217;s easy, if you already have <code>TARGET</code> set up:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>make stop</strong>
-    Stopping PRU 0
stop
bone$ <strong>make start</strong>
-    Starting PRU 0
start</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="../04debug/debug.html.html#_dmesg_hw">dmesg -Hw</a> to see how to tell if the PRU
is stopped.</p>
</div>
<div class="paragraph">
<p>This assumes <code>TARGET</code> is set to the PRU you are using.
If you want to control the other PRU use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>cp gpio.pru0.c gpio.pru1.c</strong>
bone$ <strong>make TARGET=gpio.pru1</strong>
bone$ <strong>make TARGET=gpio.pru1 stop</strong>
bone$ <strong>make TARGET=gpio.pru1 start</strong></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="details_makefile"><a class="link" href="#details_makefile">3.4. The Standard Makefile</a></h3>
<div class="sect3">
<h4 id="_problem_18"><a class="link" href="#_problem_18">Problem</a></h4>
<div class="paragraph">
<p>There are all sorts of options that need to be set when compiling
a program.  How can I be sure to get them all right?</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_18"><a class="link" href="#_solution_18">Solution</a></h4>
<div class="paragraph">
<p>The surest way to make sure everything is right is to use our
standard <code>Makefile</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_6"><a class="link" href="#_discussion_6">Discussion</a></h4>
<div class="paragraph">
<p>It&#8217;s assumed you already know how Makefiles work.  If not, there are
many resources online that can bring you up to speed.
Here is the local <code>Makefile</code> used throughout this book.</p>
</div>
<div class="listingblock">
<div class="title">Local Makefile</div>
<div class="content">
<pre class="highlight"><code class="language-makefile" data-lang="makefile">include /var/lib/cloud9/common/Makefile</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each of the local Makefiles refer to the same standard Makefile.  The details
of how the Makefile works is beyond the scope of this cookbook.</p>
</div>
<div class="paragraph">
<p>Fortunately you shouldn&#8217;t have to modify the <code>Makefile</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_compiling_with_clpru_and_lnkpru"><a class="link" href="#_compiling_with_clpru_and_lnkpru">3.5. Compiling with clpru and lnkpru</a></h3>
<div class="sect3">
<h4 id="_problem_19"><a class="link" href="#_problem_19">Problem</a></h4>
<div class="paragraph">
<p>You need details on the c compiler, linker and other tools for the PRU.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_19"><a class="link" href="#_solution_19">Solution</a></h4>
<div class="paragraph">
<p>The PRU compiler and linker are already installed on the standard images.
They are called <code>clpru</code> and <code>lnkpru</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>which clpru</strong>
/usr/bin/clpru</code></pre>
</div>
</div>
<div class="paragraph">
<p>Details on each can be found here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://www.ti.com/lit/ug/spruhv7b/spruhv7b.pdf">PRU Optimizing C/C++ Compiler</a></p>
</li>
<li>
<p><a href="http://www.ti.com/lit/ug/spruhv6b/spruhv6b.pdf">PRU Assembly Language Tools</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In fact there are PRU versions of many of the standard code generation tools.</p>
</div>
<div class="listingblock">
<div class="title">code tools</div>
<div class="content">
<pre class="highlight"><code>bone$ <strong>ls /usr/bin/*pru</strong>
/usr/bin/abspru    /usr/bin/clistpru  /usr/bin/hexpru      /usr/bin/ofdpru
/usr/bin/acpiapru  /usr/bin/clpru     /usr/bin/ilkpru      /usr/bin/optpru
/usr/bin/arpru     /usr/bin/dempru    /usr/bin/libinfopru  /usr/bin/rc_test_encoders_pru
/usr/bin/asmpru    /usr/bin/dispru    /usr/bin/lnkpru      /usr/bin/strippru
/usr/bin/cgpru     /usr/bin/embedpru  /usr/bin/nmpru       /usr/bin/xrefpru</code></pre>
</div>
</div>
<div class="paragraph">
<p>See the <a href="http://www.ti.com/lit/ug/spruhv6b/spruhv6b.pdf">PRU Assembly Language Tools</a> for more details.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="detail_linker"><a class="link" href="#detail_linker">3.6. The Linker Command File - am335x_pru.cmd</a></h3>
<div class="sect3">
<h4 id="_problem_20"><a class="link" href="#_problem_20">Problem</a></h4>
<div class="paragraph">
<p>The linker needs to be told where in memory to place the code and variables.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_20"><a class="link" href="#_solution_20">Solution</a></h4>
<div class="paragraph">
<p><code>am335x_pru.cmd</code> is the standard linker command file that tells the linker
where to put what for the BeagleBone Black and Blue, and the Pocket.
The <code>am57xx_pru.cmd</code> does the same for the AI.
Both files can be found in <code>/var/lib/cloud9/common</code>.</p>
</div>
<div class="listingblock">
<div class="title">am335x_pru.cmd</div>
<div class="content">
<pre class="highlight"><code class="language-linker" data-lang="linker">/****************************************************************************/
/*  AM335x_PRU.cmd                                                          */
/*  Copyright (c) 2015  Texas Instruments Incorporated                      */
/*                                                                          */
/*    Description: This file is a linker command file that can be used for  */
/*                 linking PRU programs built with the C compiler and       */
/*                 the resulting .out file on an AM335x device.             */
/****************************************************************************/

-cr                             /* Link using C conventions */

/* Specify the System Memory Map */
MEMORY
{
      PAGE 0:
    PRU_IMEM        : org = 0x00000000 len = 0x00002000  /* 8kB PRU0 Instruction RAM */

      PAGE 1:

    /* RAM */

    PRU_DMEM_0_1    : org = 0x00000000 len = 0x00002000 CREGISTER=24 /* 8kB PRU Data RAM 0_1 */
    PRU_DMEM_1_0    : org = 0x00002000 len = 0x00002000 CREGISTER=25 /* 8kB PRU Data RAM 1_0 */

      PAGE 2:
    PRU_SHAREDMEM   : org = 0x00010000 len = 0x00003000 CREGISTER=28 /* 12kB Shared RAM */

    DDR             : org = 0x80000000 len = 0x00000100 CREGISTER=31
    L3OCMC          : org = 0x40000000 len = 0x00010000 CREGISTER=30


    /* Peripherals */

    PRU_CFG         : org = 0x00026000 len = 0x00000044 CREGISTER=4
    PRU_ECAP        : org = 0x00030000 len = 0x00000060 CREGISTER=3
    PRU_IEP         : org = 0x0002E000 len = 0x0000031C CREGISTER=26
    PRU_INTC        : org = 0x00020000 len = 0x00001504 CREGISTER=0
    PRU_UART        : org = 0x00028000 len = 0x00000038 CREGISTER=7

    DCAN0           : org = 0x481CC000 len = 0x000001E8 CREGISTER=14
    DCAN1           : org = 0x481D0000 len = 0x000001E8 CREGISTER=15
    DMTIMER2        : org = 0x48040000 len = 0x0000005C CREGISTER=1
    PWMSS0          : org = 0x48300000 len = 0x000002C4 CREGISTER=18
    PWMSS1          : org = 0x48302000 len = 0x000002C4 CREGISTER=19
    PWMSS2          : org = 0x48304000 len = 0x000002C4 CREGISTER=20
    GEMAC           : org = 0x4A100000 len = 0x0000128C CREGISTER=9
    I2C1            : org = 0x4802A000 len = 0x000000D8 CREGISTER=2
    I2C2            : org = 0x4819C000 len = 0x000000D8 CREGISTER=17
    MBX0            : org = 0x480C8000 len = 0x00000140 CREGISTER=22
    MCASP0_DMA      : org = 0x46000000 len = 0x00000100 CREGISTER=8
    MCSPI0          : org = 0x48030000 len = 0x000001A4 CREGISTER=6
    MCSPI1          : org = 0x481A0000 len = 0x000001A4 CREGISTER=16
    MMCHS0          : org = 0x48060000 len = 0x00000300 CREGISTER=5
    SPINLOCK        : org = 0x480CA000 len = 0x00000880 CREGISTER=23
    TPCC            : org = 0x49000000 len = 0x00001098 CREGISTER=29
    UART1           : org = 0x48022000 len = 0x00000088 CREGISTER=11
    UART2           : org = 0x48024000 len = 0x00000088 CREGISTER=12

    RSVD10          : org = 0x48318000 len = 0x00000100 CREGISTER=10
    RSVD13          : org = 0x48310000 len = 0x00000100 CREGISTER=13
    RSVD21          : org = 0x00032400 len = 0x00000100 CREGISTER=21
    RSVD27          : org = 0x00032000 len = 0x00000100 CREGISTER=27

}

/* Specify the sections allocation into memory */
SECTIONS {
    /* Forces _c_int00 to the start of PRU IRAM. Not necessary when loading
       an ELF file, but useful when loading a binary */
    .text:_c_int00* &gt;  0x0, PAGE 0

    .text       &gt;  PRU_IMEM, PAGE 0
    .stack      &gt;  PRU_DMEM_0_1, PAGE 1
    .bss        &gt;  PRU_DMEM_0_1, PAGE 1
    .cio        &gt;  PRU_DMEM_0_1, PAGE 1
    .data       &gt;  PRU_DMEM_0_1, PAGE 1
    .switch     &gt;  PRU_DMEM_0_1, PAGE 1
    .sysmem     &gt;  PRU_DMEM_0_1, PAGE 1
    .cinit      &gt;  PRU_DMEM_0_1, PAGE 1
    .rodata     &gt;  PRU_DMEM_0_1, PAGE 1
    .rofardata  &gt;  PRU_DMEM_0_1, PAGE 1
    .farbss     &gt;  PRU_DMEM_0_1, PAGE 1
    .fardata    &gt;  PRU_DMEM_0_1, PAGE 1

    .resource_table &gt; PRU_DMEM_0_1, PAGE 1
    .init_pins &gt; PRU_DMEM_0_1, PAGE 1
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The cmd file for the AI is about the same, with appropriate addresses for the AI.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_7"><a class="link" href="#_discussion_7">Discussion</a></h4>
<div class="paragraph">
<p>The important things to notice in the file are given in the following table.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. AM335x_PRU.cmd important things</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is where the instructions are stored. See page 206 of the
<a href="https://www.ti.com/lit/ug/spruh73p/spruh73p.pdf">AM335x Technical Reference Manual</a>
Or see page 417 of
<a href="http://www.ti.com/lit/pdf/spruhz6l">AM572x Technical Reference Manual</a> for the AI.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">22</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is where PRU 0&#8217;s DMEM 0 is mapped.  It&#8217;s also where PRU 1&#8217;s
DMEM 1 is mapped.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">23</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The reverse to above.  PRU 0&#8217;s DMEM 1 appears here and PRU 1&#8217;s DMEM 0
is here.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">26</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The shared memory for both PRU&#8217;s appears here.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">72</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>.text</code> section is where the code goes.  It&#8217;s mapped to <code>IMEM</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">73</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The stack is then mapped to DMEM 0. Notice that DMEM 0 is one bank
of memory for PRU 0 and another for PRU1, so they both get their own stacks.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">74</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>.bss</code> section is where the heap goes.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Why is it important to understand this file?  If you are going to store things
in DMEM, you need to be sure to start at address 0x0200 since the stack and
the heap are in the locations below 0x0200.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_loading_firmware"><a class="link" href="#_loading_firmware">3.7. Loading Firmware</a></h3>
<div class="sect3">
<h4 id="_problem_21"><a class="link" href="#_problem_21">Problem</a></h4>
<div class="paragraph">
<p>I have my PRU code all compiled and need to load it on the PRU.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_21"><a class="link" href="#_solution_21">Solution</a></h4>
<div class="paragraph">
<p>It&#8217;s a simple three step process.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Stop the PRU</p>
</li>
<li>
<p>Write the <code>.out</code> file to the right place in <code>/lib/firmware</code></p>
</li>
<li>
<p>Start the PRU.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This is all handled in the <a href="#details_makefile">The Standard Makefile</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_8"><a class="link" href="#_discussion_8">Discussion</a></h4>
<div class="paragraph">
<p>The PRUs appear in the Linux file space at <code>/dev/remoteproc/</code>.</p>
</div>
<div class="listingblock">
<div class="title">Finding the PRUs</div>
<div class="content">
<pre class="highlight"><code>bone$ <strong>cd /dev/remoteproc/</strong>
bone$ <strong>ls</strong>
pruss-core0  pruss-core1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or if you are on the AI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>cd /dev/remoteproc/</strong>
bone$ <strong>ls</strong>
dsp1  dsp2  ipu1  ipu2  pruss1-core0  pruss1-core1  pruss2-core0  pruss2-core1</code></pre>
</div>
</div>
<div class="paragraph">
<p>You see there that the AI has two pairs of PRUs, plus a couple of DSPs and other
goodies.</p>
</div>
<div class="paragraph">
<p>Here we see PRU 0 and PRU 1 in the path.  Let&#8217;s follow PRU 0.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>cd pruss-core0</strong>
bone$ <strong>ls</strong>
device  firmware  name  power  state  subsystem  uevent</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we see the files that control PRU 0.  <code>firmware</code> tells where in <code>/lib/firmware</code>
to look for the code to run on the PRU.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>cat firmware</strong>
am335x-pru0-fw</code></pre>
</div>
</div>
<div class="paragraph">
<p>Therefore you copy your <code>.out</code> file to <code>/lib/firmware/am335x-pru0-fw</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="details_configure_servos"><a class="link" href="#details_configure_servos">3.8. Configuring Pins for Controlling Servos</a></h3>
<div class="sect3">
<h4 id="_problem_22"><a class="link" href="#_problem_22">Problem</a></h4>
<div class="paragraph">
<p>You want to configure the pins so the PRU <em>outputs</em> are accessable.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_22"><a class="link" href="#_solution_22">Solution</a></h4>
<div class="paragraph">
<p>It depends on which Beagle you are running on.  If you are on the AI or Blue,
everything is already configured for you.
If you are on the Black or Pocket you&#8217;ll need to run the following script.</p>
</div>
<div class="listingblock">
<div class="title">servos_setup.sh</div>
<div class="content">
<pre class="highlight"><code class="language-linenums" data-lang="linenums">#!/bin/bash
# Configure the PRU pins based on which Beagle is running
machine=$(awk '{print $NF}' /proc/device-tree/model)
echo -n $machine
if [ $machine = "Black" ]; then
    echo " Found"
    pins="P8_27 P8_28 P8_29 P8_30 P8_39 P8_40 P8_41 P8_42"
elif [ $machine = "Blue" ]; then
    echo " Found"
    pins=""
elif [ $machine = "PocketBeagle" ]; then
    echo " Found"
    pins="P2_35 P1_35 P1_02 P1_04"
else
    echo " Not Found"
    pins=""
fi

for pin in $pins
do
    echo $pin
    config-pin $pin pruout
    config-pin -q $pin
done</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_9"><a class="link" href="#_discussion_9">Discussion</a></h4>
<div class="paragraph">
<p>The first part of the code looks in <code>/proc/device-tree/model</code> to see which Beagle is running. Based on that it
assigns <code>pins</code> a list of pins to configure.  Then the last part of the script loops through each of the pins and configures it.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="details_configure_encoders"><a class="link" href="#details_configure_encoders">3.9. Configuring Pins for Controlling Encoders</a></h3>
<div class="sect3">
<h4 id="_problem_23"><a class="link" href="#_problem_23">Problem</a></h4>
<div class="paragraph">
<p>You want to configure the pins so the PRU <em>inputs</em> are accessable.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_23"><a class="link" href="#_solution_23">Solution</a></h4>
<div class="paragraph">
<p>It depends on which Beagle you are running on.  If you are on the AI or Blue,
everything is already configured for you.
If you are on the Black or Pocket you&#8217;ll need to run the following script.</p>
</div>
<div class="listingblock">
<div class="title">encoder_setup.sh</div>
<div class="content">
<pre class="highlight"><code class="language-linenums" data-lang="linenums">#!/bin/bash
# Configure the pins based on which Beagle is running
machine=$(awk '{print $NF}' /proc/device-tree/model)
echo -n $machine

# Configure eQEP pins
if [ $machine = "Black" ]; then
    echo " Found"
    pins="P9_92 P9_27 P8_35 P8_33 P8_12 P8_11 P8_41 P8_42"
elif [ $machine = "Blue" ]; then
    echo " Found"
    pins=""
elif [ $machine = "PocketBeagle" ]; then
    echo " Found"
    pins="P1_31 P2_34 P2_10 P2_24 P2_33"
else
    echo " Not Found"
    pins=""
fi

for pin in $pins
do
    echo $pin
    config-pin $pin qep
    config-pin -q $pin
done

##########################################
# Configure PRU pins
if [ $machine = "Black" ]; then
    echo " Found"
    pins="P8_16 P8_15"
elif [ $machine = "Blue" ]; then
    echo " Found"
    pins=""
elif [ $machine = "PocketBeagle" ]; then
    echo " Found"
    pins="P2_09 P2_18"
else
    echo " Not Found"
    pins=""
fi

for pin in $pins
do
    echo $pin
    config-pin $pin pruin
    config-pin -q $pin
done</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_10"><a class="link" href="#_discussion_10">Discussion</a></h4>
<div class="paragraph">
<p>This works like the servo setup except some of the pins are configured as
to the hardware eQEPs and other to the PRU inputs.</p>
</div>
<div style="page-break-after: always;"></div>
<div class="paragraph">
<p><a href="../index.html">Outline</a></p>
</div>
<div class="paragraph">
<p>These examples are based on other&#8217;s examples.  The copyright headers
have been removed from the code for claity and reproduced at the end of the
chaper.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_debugging_and_benchmarking"><a class="link" href="#_debugging_and_benchmarking">4. Debugging and Benchmarking</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>One of the challenges is getting debug
information out of the PRUs since they don&#8217;t have a traditional <code>printf()</code>.
In this chapter four different methods are presented that I&#8217;ve found useful in
debugging.  The first is simply attaching an LED.  The second is using
<code>dmesg</code> to watch the kernel messages.  <code>prudebug</code>, a simple debugger that
allows you to inspect registers and memory of the PRUs, is then presented.
Finally, using one of the UARTS to send debugging information out a serial port
is shown.</p>
</div>
<div class="sect2">
<h3 id="_debugging_via_an_led"><a class="link" href="#_debugging_via_an_led">4.1. Debugging via an LED</a></h3>
<div class="sect3">
<h4 id="_problem_24"><a class="link" href="#_problem_24">Problem</a></h4>
<div class="paragraph">
<p>I need a simple way to see if my program is running without slowing the
real-time execution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_24"><a class="link" href="#_solution_24">Solution</a></h4>
<div class="paragraph">
<p>One of the
simplest ways to do this is to attach an LED to the output pin and watch it
flash.
<a href="#debug_LED">LED used for debugging P9_29</a> shows an LED attached to pin P9_29 of the BeagleBone Black.</p>
</div>
<div id="debug_LED" class="imageblock">
<div class="content">
<img src="./04debug/figures/LED_bb.png" alt="LED used for debugging P9_29">
</div>
<div class="title">Figure 24. LED used for debugging P9_29</div>
</div>
<div class="paragraph">
<p>Make sure you have the LED in the correct way, or it won&#8217;t work.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_11"><a class="link" href="#_discussion_11">Discussion</a></h4>
<div class="paragraph">
<p>If your output is changing more than a few times a second, the LED will be
blinking too fast and you&#8217;ll need an oscilloscope or a logic analyzer to
see what&#8217;s happening.</p>
</div>
<div class="paragraph">
<p>Another useful tool that let&#8217;s you see the contents of the registers and
RAM is discussed in <a href="#debug_prudebug">prudebug - A Simple Debugger for the PRU</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_dmesg_hw"><a class="link" href="#_dmesg_hw">4.2. dmesg â€“Hw</a></h3>
<div class="sect3">
<h4 id="_problem_25"><a class="link" href="#_problem_25">Problem</a></h4>
<div class="paragraph">
<p>I&#8217;m getting an error message (<code>/sys/devices/platform/ocp/4a326000.pruss-soc-bus/4a300000.pruss/4a334000.pru0/remoteproc/remoteproc1/state: Invalid argument</code>)
when I load my code, but don&#8217;t know what&#8217;s causing it.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_25"><a class="link" href="#_solution_25">Solution</a></h4>
<div class="paragraph">
<p>The command <code>dmesg</code> outputs useful information when dealing with the kernel.
Simplying running <code>dmesg -Hw</code> can tell you a lot.  The <code>-H</code> flag puts the
dates in the human readable form, the <code>-w</code> tells it to wait for more information.
Often I&#8217;ll have a window open running <code>dmesg -Hw</code>.
.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s what <code>dmesg</code> said for the example above.</p>
</div>
<div class="listingblock">
<div class="title">dmesg -Hw</div>
<div class="content">
<pre class="highlight"><code class="language-linenums" data-lang="linenums">[  +0.000018] remoteproc remoteproc1: header-less resource table
[  +0.011879] remoteproc remoteproc1: Failed to find resource table
[  +0.008770] remoteproc remoteproc1: Boot failed: -22</code></pre>
</div>
</div>
<div class="paragraph">
<p>It quickly told me I needed to add the line <code>#include "resource_table_empty.h"</code>
to my code.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="debug_prudebug"><a class="link" href="#debug_prudebug">4.3. prudebug - A Simple Debugger for the PRU</a></h3>
<div class="sect3">
<h4 id="_problem_26"><a class="link" href="#_problem_26">Problem</a></h4>
<div class="paragraph">
<p>You need to examine registers and memory on the PRUs.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_26"><a class="link" href="#_solution_26">Solution</a></h4>
<div class="paragraph">
<p><code>prudebug</code> is a simple debugger for the PRUs that lets you start and stop the PRUs and
examine the registers and memory. It can be found on GitHub
<a href="https://github.com/RRvW/prudebug-rl" class="bare">https://github.com/RRvW/prudebug-rl</a>.  I have a version I updated to use byte
addressing rather than word addressing.  This makes it easier to work with the
assembler output. You can find it in my GitHub BeagleBoard repo
<a href="https://github.com/MarkAYoder/BeagleBoard-exercises/tree/master/pru/prudebug" class="bare">https://github.com/MarkAYoder/BeagleBoard-exercises/tree/master/pru/prudebug</a>.</p>
</div>
<div class="paragraph">
<p>Just download the files and type <code>make</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_12"><a class="link" href="#_discussion_12">Discussion</a></h4>
<div class="paragraph">
<p>Once <code>prudebug</code> is installed is rather easy to use.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p><code>prudebug</code> hasn&#8217;t been ported to the AI.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>sudo prudebug</strong>
PRU Debugger v0.25
(C) Copyright 2011, 2013 by Arctica Technologies.  All rights reserved.
Written by Steven Anderson

Using /dev/mem device.
Processor type      AM335x
PRUSS memory address    0x4a300000
PRUSS memory length 0x00080000

         offsets below are in 32-bit byte addresses (not ARM byte addresses)
         PRU            Instruction    Data         Ctrl
         0              0x00034000     0x00000000   0x00022000
         1              0x00038000     0x00002000   0x00024000</code></pre>
</div>
</div>
<div class="paragraph">
<p>You get help by entering <code>help</code>.  You cal also enter <code>hb</code> to get a brief help.</p>
</div>
<div class="listingblock bash">
<div class="content">
<pre class="highlight"><code>PRU0&gt; <strong>hb</strong>
Command help

    BR [breakpoint_number [address]] - View or set an instruction breakpoint
    D memory_location_ba [length] - Raw dump of PRU data memory (32-bit byte offset from beginning of full PRU memory block - all PRUs)
    DD memory_location_ba [length] - Dump data memory (32-bit byte offset from beginning of PRU data memory)
    DI memory_location_ba [length] - Dump instruction memory (32-bit byte offset from beginning of PRU instruction memory)
    DIS memory_location_ba [length] - Disassemble instruction memory (32-bit byte offset from beginning of PRU instruction memory)
    G - Start processor execution of instructions (at current IP)
    GSS - Start processor execution using automatic single stepping - this allows running a program with breakpoints
    HALT - Halt the processor
    L memory_location_iwa file_name - Load program file into instruction memory
    PRU pru_number - Set the active PRU where pru_number ranges from 0 to 1
    Q - Quit the debugger and return to shell prompt.
    R - Display the current PRU registers.
    RESET - Reset the current PRU
    SS - Single step the current instruction.
    WA [watch_num [address [value]]] - Clear or set a watch point
    WR memory_location_ba value1 [value2 [value3 ...]] - Write a 32-bit value to a raw (offset from beginning of full PRU memory block)
    WRD memory_location_ba value1 [value2 [value3 ...]] - Write a 32-bit value to PRU data memory for current PRU
    WRI memory_location_ba value1 [value2 [value3 ...]] - Write a 32-bit value to PRU instruction memory for current PRU</code></pre>
</div>
</div>
<div class="paragraph">
<p>Initially you are talking to PRU 0.  You can enter <code>pru 1</code> to talk to PRU 1.
The commands I find most useful are, <code>r</code>, to see the registers.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>PRU0&gt; <strong>r</strong>
Register info for PRU0
    Control register: 0x00008003
      Reset PC:0x0000  RUNNING, FREE_RUN, COUNTER_DISABLED, NOT_SLEEPING, PROC_ENABLED

    Program counter: 0x0030
      Current instruction: ADD R0.b0, R0.b0, R0.b0

    Rxx registers not available since PRU is RUNNING.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the PRU has to be stopped to see the register contents.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>PRU0&gt; <strong>h</strong>
PRU0 Halted.
PRU0&gt; <strong>r</strong>
Register info for PRU0
    Control register: 0x00000001
      Reset PC:0x0000  STOPPED, FREE_RUN, COUNTER_DISABLED, NOT_SLEEPING, PROC_DISABLED

    Program counter: 0x0028
      Current instruction: LBBO R15, R15, 4, 4

    R00: 0x00000000    R08: 0x00000000    R16: 0x00000001    R24: 0x00000002
    R01: 0x00000000    R09: 0xaf40dcf2    R17: 0x00000000    R25: 0x00000003
    R02: 0x000000dc    R10: 0xd8255b1b    R18: 0x00000003    R26: 0x00000003
    R03: 0x000f0000    R11: 0xc50cbefd    R19: 0x00000100    R27: 0x00000002
    R04: 0x00000000    R12: 0xb037c0d7    R20: 0x00000100    R28: 0x8ca9d976
    R05: 0x00000009    R13: 0xf48bbe23    R21: 0x441fb678    R29: 0x00000002
    R06: 0x00000000    R14: 0x00000134    R22: 0xc8cc0752    R30: 0x00000000
    R07: 0x00000009    R15: 0x00000200    R23: 0xe346fee9    R31: 0x00000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can resume using <code>g</code> which starts right where you left off, or use <code>reset</code> to
restart back at the beginning.</p>
</div>
<div class="paragraph">
<p>The <code>dd</code> command dumps the memory.  Keep in mind the following.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Important memory locations</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Address</th>
<th class="tableblock halign-left valign-top">Contents</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Start of the stack for PRU 0.  The file AM335x_PRU.cmd specifies
where the stack is.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00100</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Start of the heap for PRU 0.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Start of DRAM that your programs can use.  The Makefile specifies
the size of the stack and the heap.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x10000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Start of the memory shared between the PRUs.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Using <code>dd</code> with no address prints the next section of memory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>PRU0&gt; <strong>dd</strong>
dd
Absolute addr = 0x0000, offset = 0x0000, Len = 16
[0x0000] 0x00000000 0x00000000 0x00000000 0x00000000
[0x0010] 0x00000000 0x00000000 0x00000000 0x00000000
[0x0020] 0x00000000 0x00000000 0x00000000 0x00000000
[0x0030] 0x00000000 0x00000000 0x00000000 0x00000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>The stack grows from higher memory to lower memory, so you often won&#8217;t see
much around address <code>0x0000</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>PRU0&gt; <strong>dd 0x100</strong>
dd 0x100
Absolute addr = 0x0100, offset = 0x0000, Len = 16
[0x0100] 0x00000001 0x00000002 0x00000003 0x00000004
[0x0110] 0x00000004 0x00000003 0x00000002 0x00000001
[0x0120] 0x00000001 0x00000000 0x00000000 0x00000000
[0x0130] 0x00000000 0x00000200 0x862e5c18 0xfeb21aca</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we see some values on the heap.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>PRU0&gt; <strong>dd 0x200</strong>
dd 0x200
Absolute addr = 0x0200, offset = 0x0000, Len = 16
[0x0200] 0x00000001 0x00000004 0x00000002 0x00000003
[0x0210] 0x00000003 0x00000011 0x00000004 0x00000010
[0x0220] 0x0a4fe833 0xb222ebda 0xe5575236 0xc50cbefd
[0x0230] 0xb037c0d7 0xf48bbe23 0x88c460f0 0x011550d4</code></pre>
</div>
</div>
<div class="paragraph">
<p>Data written explicity to <code>0x0200</code> of the DRAM.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>PRU0&gt; <strong>dd 0x10000</strong>
dd 0x10000
Absolute addr = 0x10000, offset = 0x0000, Len = 16
[0x10000] 0x8ca9d976 0xebcb119e 0x3aebce31 0x68c44d8b
[0x10010] 0xc370ba7e 0x2fea993b 0x15c67fa5 0xfbf68557
[0x10020] 0x5ad81b4f 0x4a55071a 0x48576eb7 0x1004786b
[0x10030] 0x2265ebc6 0xa27b32a0 0x340d34dc 0xbfa02d4b</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s the shared memory.</p>
</div>
<div class="paragraph">
<p>You can also use <code>prudebug</code> to set breakpoints and single step,
but I haven&#8217;t used that feature much.</p>
</div>
<div class="paragraph">
<p><a href="../05blocks/blocks.html.html#_memory_allocation">Memory Allocation</a> gives examples
of how you can control where your vaiables are stored in memory.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_uart"><a class="link" href="#_uart">4.4. UART</a></h3>
<div class="sect3">
<h4 id="_problem_27"><a class="link" href="#_problem_27">Problem</a></h4>
<div class="paragraph">
<p>I&#8217;d like to use something like <code>printf()</code> to debug my code.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_27"><a class="link" href="#_solution_27">Solution</a></h4>
<div class="paragraph">
<p>One simple, yet effective approach to 'printing' from the PRU is
an idea taken from the Adruino playbook;
use the UART (serial port) to output debug information.  The PRU has it&#8217;s
own UART that can send characters to a serial port.</p>
</div>
<div class="paragraph">
<p>You&#8217;ll need a 3.3V FTDI cable to go between your Beagle and the USB port
on your host computer as shown in <a href="#debug_ftdi">FTDI cable</a>.<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>
You can get such a cable from places such as
<a href="https://www.sparkfun.com/products/9717">Sparkfun</a> or
<a href="https://www.adafruit.com/product/70">Adafruit</a>.</p>
</div>
<div id="debug_ftdi" class="imageblock">
<div class="content">
<img src="./04debug/figures/FTDIcable.jpg" alt="FTDI cable">
</div>
<div class="title">Figure 25. FTDI cable</div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_13"><a class="link" href="#_discussion_13">Discussion</a></h4>
<div class="paragraph">
<p>The Beagle side of the FTDI cable has a small triangle on it as shown in
<a href="#debug_ftdi_connector">FTDI connector</a> which marks the ground pin, pin 1.</p>
</div>
<div id="debug_ftdi_connector" class="imageblock">
<div class="content">
<img src="./04debug/figures/FTDIconnector.jpg" alt="FTDI connector">
</div>
<div class="title">Figure 26. FTDI connector</div>
</div>
<div class="paragraph">
<p>The <a href="#debug_FTDI">Wriing for FTDI cable to Beagle</a> table shows which pins connect where and <a href="#debug_ftdi_pins">FTDI to BB Black</a>
is a wiring diagram for the BeagleBone Black.</p>
</div>
<table id="debug_FTDI" class="tableblock frame-all grid-all" style="width: 35%;">
<caption class="title">Table 5. Wriing for FTDI cable to Beagle</caption>
<colgroup>
<col style="width: 4%;">
<col style="width: 16%;">
<col style="width: 16%;">
<col style="width: 16%;">
<col style="width: 16%;">
<col style="width: 16%;">
<col style="width: 16%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">FTDI pin</th>
<th class="tableblock halign-left valign-top">Color</th>
<th class="tableblock halign-left valign-top">Black pin</th>
<th class="tableblock halign-left valign-top">AI 1 pin</th>
<th class="tableblock halign-left valign-top">AI 2 pin</th>
<th class="tableblock halign-left valign-top">Pocket</th>
<th class="tableblock halign-left valign-top">Function</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">black</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1_16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ground</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">orange</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_24</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_43</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_33a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1_12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rx</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yellow</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_26</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_44</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_31a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1_06</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tx</p></td>
</tr>
</tbody>
</table>
<div id="debug_ftdi_pins" class="imageblock">
<div class="content">
<img src="./04debug/figures/FTDIhookup_bb.png" alt="FTDI to BB Black">
</div>
<div class="title">Figure 27. FTDI to BB Black</div>
</div>
<div class="sect4">
<h5 id="_details"><a class="link" href="#_details">Details</a></h5>
<div class="paragraph">
<p>Two examples of using the UART are presented here.  The first
(<a href="#debug_uart1">uart1.pru1_0.c</a>) sends
a character out the serial port then waits for a character to come in.  Once
the new character arrives another character is output.</p>
</div>
<div class="paragraph">
<p>The second example (<a href="#debug_uart2">uart2.pru1_0.c</a>) prints out a string and then
waits for characters to arrive.
Once an ENTER appears the string is sent back.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>On the Black, either PRU0 and PRU1 can run this code.  Both have access to the same UART.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You need to set the pin muxes.</p>
</div>
<div class="listingblock">
<div class="title">config-pin</div>
<div class="content">
<pre class="highlight"><code class="language-linenums" data-lang="linenums"># Configure tx Black
bone$ <strong>config-pin P9_24 pru_uart</strong>
# Configure rx Black
bone$ <strong>config-pin P9_26 pru_uart</strong>

# Configure tx Pocket
bone$ <strong>config-pin P1_06 pru_uart</strong>
# Configure rx Pocket
bone$ <strong>config-pin P1_12 pru_uart</strong></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>See <a href="08ai/ai.html.html">Configuring pins on the AI via device trees</a> for configuring
pins on the AI. Make sure your <code>rx</code> pins are configured as input pins in the device tree.
For example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>DRA7XX_CORE_IOPAD(0x3610, <strong>PIN_INPUT</strong> | MUX_MODE10) // C6: P8.33a:</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_uart1_pru1_0_c"><a class="link" href="#_uart1_pru1_0_c">uart1.pru1_0.c</a></h5>
<div class="paragraph">
<p>Set the following variables so <code>make</code> will know what to compile.</p>
</div>
<div class="listingblock">
<div class="title">make</div>
<div class="content">
<pre class="highlight"><code class="language-linenums" data-lang="linenums">bone$ <strong>make TARGET=uart1.pru0</strong>
/var/lib/cloud9/common/Makefile:29: MODEL=TI_AM335x_BeagleBone_Black,TARGET=uart1.pru0
-    Stopping PRU 0
-   copying firmware file /tmp/cloud9-examples/uart1.pru0.out to /lib/firmware/am335x-pru0-fw
write_init_pins.sh
-    Starting PRU 0
MODEL   = TI_AM335x_BeagleBone_Black
PROC    = pru
PRUN    = 0
PRU_DIR = /dev/remoteproc/pruss-core0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now <code>make</code> will compile, load PRU0 and start it.  In a terminal window
on your host computer run</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-linenums" data-lang="linenums">host$ <strong>screen /dev/ttyUSB0 115200</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>It will initially display the first charters (<code>H</code>) and then as you enter
characters on the keyboard, the rest of the message will appear.</p>
</div>
<div class="paragraph">
<div class="title">uart1.pru0.c output</div>
<p><span class="image"><img src="./04debug/figures/uart1.pru0.png" alt="uart1.pru0.c output"></span></p>
</div>
<div class="paragraph">
<p>Here&#8217;s the code (<code>uart1.pru1_0.c</code>) that does it.</p>
</div>
<div id="debug_uart1" class="listingblock">
<div class="title">uart1.pru1_0.c</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">// From: http://git.ti.com/pru-software-support-package/pru-software-support-package/trees/master/examples/am335x/PRU_Hardware_UART
// This example was converted to the am5729 by changing the names in pru_uart.h
// for the am335x to the more descriptive names for the am5729.
// For example  DLL convertes to DIVISOR_REGISTER_LSB_
#include &lt;stdint.h&gt;
#include &lt;pru_uart.h&gt;
#include "resource_table_empty.h"

/* The FIFO size on the PRU UART is 16 bytes; however, we are (arbitrarily)
 * only going to send 8 at a time */
#define FIFO_SIZE   16
#define MAX_CHARS   8

void main(void)
{
    uint8_t tx;
    uint8_t rx;
    uint8_t cnt;

    /*  hostBuffer points to the string to be printed */
    char* hostBuffer;

    /*** INITIALIZATION ***/

    /* Set up UART to function at 115200 baud - DLL divisor is 104 at 16x oversample
     * 192MHz / 104 / 16 = ~115200 */
    CT_UART.DIVISOR_REGISTER_LSB_ = 104;
    CT_UART.DIVISOR_REGISTER_MSB_ = 0;
    CT_UART.MODE_DEFINITION_REGISTER = 0x0;

    /* Enable Interrupts in UART module. This allows the main thread to poll for
     * Receive Data Available and Transmit Holding Register Empty */
    CT_UART.INTERRUPT_ENABLE_REGISTER = 0x7;

    /* If FIFOs are to be used, select desired trigger level and enable
     * FIFOs by writing to FCR. FIFOEN bit in FCR must be set first before
     * other bits are configured */
    /* Enable FIFOs for now at 1-byte, and flush them */
    CT_UART.INTERRUPT_IDENTIFICATION_REGISTER_FIFO_CONTROL_REGISTER = (0x8) | (0x4) | (0x2) | (0x1);
    //CT_UART.FCR = (0x80) | (0x4) | (0x2) | (0x01); // 8-byte RX FIFO trigger

    /* Choose desired protocol settings by writing to LCR */
    /* 8-bit word, 1 stop bit, no parity, no break control and no divisor latch */
    CT_UART.LINE_CONTROL_REGISTER = 3;

    /* Enable loopback for test */
    CT_UART.MODEM_CONTROL_REGISTER = 0x00;

    /* Choose desired response to emulation suspend events by configuring
     * FREE bit and enable UART by setting UTRST and URRST in PWREMU_MGMT */
    /* Allow UART to run free, enable UART TX/RX */
    CT_UART.POWERMANAGEMENT_AND_EMULATION_REGISTER = 0x6001;

    /*** END INITIALIZATION ***/

    /* Priming the 'hostbuffer' with a message */
    hostBuffer = "Hello!  This is a long string\r\n";

    /*** SEND SOME DATA ***/

    /* Let's send/receive some dummy data */
    while(1) {
        cnt = 0;
        while(1) {
            /* Load character, ensure it is not string termination */
            if ((tx = hostBuffer[cnt]) == '\0')
                break;
            cnt++;
            CT_UART.RBR_THR_REGISTERS = tx;

            /* Because we are doing loopback, wait until LSR.DR == 1
             * indicating there is data in the RX FIFO */
            while ((CT_UART.LINE_STATUS_REGISTER &amp; 0x1) == 0x0);

            /* Read the value from RBR */
            rx = CT_UART.RBR_THR_REGISTERS;

            /* Wait for TX FIFO to be empty */
            while (!((CT_UART.INTERRUPT_IDENTIFICATION_REGISTER_FIFO_CONTROL_REGISTER &amp; 0x2) == 0x2));
        }
    }

    /*** DONE SENDING DATA ***/

    /* Disable UART before halting */
    CT_UART.POWERMANAGEMENT_AND_EMULATION_REGISTER = 0x0;

    /* Halt PRU core */
    __halt();
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>I&#8217;m using the AI version of the code since it uses variables with more desciptive
names.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The first part of the code initializes the UART. Then the line
<code>CT_UART.RBR_THR_REGISTERS = tx;</code>
takes a character in <code>tx</code> and sends it to the transmit buffer on the UART.
Think of this as the UART version of the <code>printf()</code>.</p>
</div>
<div class="paragraph">
<p>Later the line
<code>while (!CT_UART.INTERRUPT_IDENTIFICATION_REGISTER_FIFO_CONTROL_REGISTER &amp; 0x2) == 0x2;</code>
waits for the transmitter FIFO to be empty.  This makes sure later characters
won&#8217;t overwrite the buffer before they can be sent.  The downside is, this will
cause your code to wait on the buffer and it might miss an important
real-time event.</p>
</div>
<div class="paragraph">
<p>The line <code>while ((CT_UART.LINE_STATUS_REGISTER &amp; 0x1) == 0x0);</code> waits for an input from the
UART (possibly missing something) and <code>rx = CT_UART.RBR_THR_REGISTERS;</code> reads from the
receive register on the UART.</p>
</div>
<div class="paragraph">
<p>These simple lines should be enough to place in your code to print out
debugging information.</p>
</div>
</div>
<div class="sect4">
<h5 id="_uart2_pru0_c"><a class="link" href="#_uart2_pru0_c">uart2.pru0.c</a></h5>
<div class="paragraph">
<p>If you want to try <code>uart2.pru0.c</code>, run the following:</p>
</div>
<div class="listingblock">
<div class="title">make</div>
<div class="content">
<pre class="highlight"><code class="language-linenums" data-lang="linenums">bone$ <strong>make TARGET=uart2.pru0</strong>
/var/lib/cloud9/common/Makefile:29: MODEL=TI_AM335x_BeagleBone_Black,TARGET=uart2.pru0
-    Stopping PRU 0
-   copying firmware file /tmp/cloud9-examples/uart2.pru0.out to /lib/firmware/am335x-pru0-fw
write_init_pins.sh
-    Starting PRU 0
MODEL   = TI_AM335x_BeagleBone_Black
PROC    = pru
PRUN    = 0
PRU_DIR = /dev/remoteproc/pruss-core0</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will see:</p>
</div>
<div class="paragraph">
<div class="title">uart2.pru0.c output</div>
<p><span class="image"><img src="./04debug/figures/uart2.pru0.png" alt="uart2.pru0.c output"></span></p>
</div>
<div class="paragraph">
<p>Type a few characters and hit ENTER.  The PRU will playback what you typed,
but it won&#8217;t echo it as you type.</p>
</div>
<div class="paragraph">
<p><code>uart2.pru0.c</code> defines <code>PrintMessageOut()</code> which is passed a string that is
sent to the UART. It takes advantage of the eight character FIFO on the UART.
Be careful using it because it also uses <code>while (!CT_UART.LSR_bit.TEMT);</code> to
wait for the FIFO to empty, which may cause your code to miss something.</p>
</div>
<div class="paragraph">
<p><a href="#debug_uart2">uart2.pru1_0.c</a> is the code that does it.</p>
</div>
<div id="debug_uart2" class="listingblock">
<div class="title">uart2.pru1_0.c</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">// From: http://git.ti.com/pru-software-support-package/pru-software-support-package/trees/master/pru_cape/pru_fw/PRU_Hardware_UART

#include &lt;stdint.h&gt;
#include &lt;pru_uart.h&gt;
#include "resource_table_empty.h"

/* The FIFO size on the PRU UART is 16 bytes; however, we are (arbitrarily)
 * only going to send 8 at a time */
#define FIFO_SIZE   16
#define MAX_CHARS   8
#define BUFFER      40

//******************************************************************************
//    Print Message Out
//      This function take in a string literal of any size and then fill the
//      TX FIFO when it's empty and waits until there is info in the RX FIFO
//      before returning.
//******************************************************************************
void PrintMessageOut(volatile char* Message)
{
    uint8_t cnt, index = 0;

    while (1) {
        cnt = 0;

        /* Wait until the TX FIFO and the TX SR are completely empty */
        while (!CT_UART.LINE_STATUS_REGISTER_bit.TEMT);

        while (Message[index] != NULL &amp;&amp; cnt &lt; MAX_CHARS) {
            CT_UART.RBR_THR_REGISTERS = Message[index];
            index++;
            cnt++;
        }
        if (Message[index] == NULL)
            break;
    }

    /* Wait until the TX FIFO and the TX SR are completely empty */
    while (!CT_UART.LINE_STATUS_REGISTER_bit.TEMT);

}

//******************************************************************************
//    IEP Timer Config
//      This function waits until there is info in the RX FIFO and then returns
//      the first character entered.
//******************************************************************************
char ReadMessageIn(void)
{
    while (!CT_UART.LINE_STATUS_REGISTER_bit.DR);

    return CT_UART.RBR_THR_REGISTERS_bit.DATA;
}

void main(void)
{
    uint32_t i;
    volatile uint32_t not_done = 1;

    char rxBuffer[BUFFER];
    rxBuffer[BUFFER-1] = NULL; // null terminate the string

    /*** INITIALIZATION ***/

    /* Set up UART to function at 115200 baud - DLL divisor is 104 at 16x oversample
     * 192MHz / 104 / 16 = ~115200 */
    CT_UART.DIVISOR_REGISTER_LSB_ = 104;
    CT_UART.DIVISOR_REGISTER_MSB_ = 0;
    CT_UART.MODE_DEFINITION_REGISTER_bit.OSM_SEL = 0x0;

    /* Enable Interrupts in UART module. This allows the main thread to poll for
     * Receive Data Available and Transmit Holding Register Empty */
    CT_UART.INTERRUPT_ENABLE_REGISTER = 0x7;

    /* If FIFOs are to be used, select desired trigger level and enable
     * FIFOs by writing to FCR. FIFOEN bit in FCR must be set first before
     * other bits are configured */
    /* Enable FIFOs for now at 1-byte, and flush them */
    CT_UART.INTERRUPT_IDENTIFICATION_REGISTER_FIFO_CONTROL_REGISTER = (0x80) | (0x8) | (0x4) | (0x2) | (0x01); // 8-byte RX FIFO trigger

    /* Choose desired protocol settings by writing to LCR */
    /* 8-bit word, 1 stop bit, no parity, no break control and no divisor latch */
    CT_UART.LINE_CONTROL_REGISTER = 3;

    /* If flow control is desired write appropriate values to MCR. */
    /* No flow control for now, but enable loopback for test */
    CT_UART.MODEM_CONTROL_REGISTER = 0x00;

    /* Choose desired response to emulation suspend events by configuring
     * FREE bit and enable UART by setting UTRST and URRST in PWREMU_MGMT */
    /* Allow UART to run free, enable UART TX/RX */
    CT_UART.POWERMANAGEMENT_AND_EMULATION_REGISTER_bit.FREE = 0x1;
    CT_UART.POWERMANAGEMENT_AND_EMULATION_REGISTER_bit.URRST = 0x1;
    CT_UART.POWERMANAGEMENT_AND_EMULATION_REGISTER_bit.UTRST = 0x1;

    /* Turn off RTS and CTS functionality */
    CT_UART.MODEM_CONTROL_REGISTER_bit.AFE = 0x0;
    CT_UART.MODEM_CONTROL_REGISTER_bit.RTS = 0x0;

    /*** END INITIALIZATION ***/

    while(1) {
        /* Print out greeting message */
        PrintMessageOut("Hello you are in the PRU UART demo test please enter some characters\r\n");

        /* Read in characters from user, then echo them back out */
        for (i = 0; i &lt; BUFFER-1 ; i++) {
            rxBuffer[i] = ReadMessageIn();
            if(rxBuffer[i] == '\r') {   // Quit early if ENTER is hit.
                rxBuffer[i+1] = NULL;
                break;
            }
        }

        PrintMessageOut("you typed:\r\n");
        PrintMessageOut(rxBuffer);
        PrintMessageOut("\r\n");
    }

    /*** DONE SENDING DATA ***/
    /* Disable UART before halting */
    CT_UART.POWERMANAGEMENT_AND_EMULATION_REGISTER = 0x0;

    /* Halt PRU core */
    __halt();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>More complex examples can be built using the principles shown in these
examples.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_copyright"><a class="link" href="#_copyright">4.5. Copyright</a></h3>
<div class="listingblock">
<div class="title">copyright.c</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">/*
 * Copyright (C) 2015 Texas Instruments Incorporated - http://www.ti.com/
 *
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 *  * Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 *
 *  * Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the
 *    distribution.
 *
 *  * Neither the name of Texas Instruments Incorporated nor the names of
 *    its contributors may be used to endorse or promote products derived
 *    from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
<div class="paragraph">
<p><a href="../index.html">Outline</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_building_blocks_applications"><a class="link" href="#_building_blocks_applications">5. Building Blocks - Applications</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here are some examples that use the basic PRU building blocks.</p>
</div>
<div class="paragraph">
<p>The following are resources used in this chapter.</p>
</div>
<div class="ulist">
<div class="title">Resources</div>
<ul>
<li>
<p><a href="http://www.ti.com/lit/ug/spruhv7b/spruhv7b.pdf">PRU Optimizing C/C++ Compiler, v2.2, User&#8217;s Guide</a></p>
</li>
<li>
<p><a href="http://www.ti.com/lit/pdf/spruhz6l">AM572x Technical Reference Manual</a> (AI)</p>
</li>
<li>
<p><a href="http://www.ti.com/lit/pdf/spruh73">AM335x Technical Reference Manual</a> (All others)</p>
</li>
<li>
<p><a href="http://exploringbeaglebone.com/">Exploring BeagleBone by Derek Molloy</a></p>
</li>
<li>
<p><a href="https://cdn-shop.adafruit.com/datasheets/WS2812.pdf">WS2812 Data Sheet</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These examples are based on other&#8217;s examples.  The copyright headers
have been removed from the code for claity and reproduced at the end of the
chaper.</p>
</div>
<div class="sect2">
<h3 id="_memory_allocation"><a class="link" href="#_memory_allocation">5.1. Memory Allocation</a></h3>
<div class="sect3">
<h4 id="_problem_28"><a class="link" href="#_problem_28">Problem</a></h4>
<div class="paragraph">
<p>I want to control where my variables are stored in memory.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_28"><a class="link" href="#_solution_28">Solution</a></h4>
<div class="paragraph">
<p>Each PRU has is own 8KB of data memory (Data Mem0 and Mem1) and 12KB of shared memory (Shared RAM) as shown in <a href="#blocks_PRU_block_diagram">PRU Block Diagram</a>.</p>
</div>
<div id="blocks_PRU_block_diagram" class="imageblock">
<div class="content">
<img src="./05blocks/figures/blockDiagram.png" alt="PRU Block diagram">
</div>
<div class="title">Figure 28. PRU Block Diagram</div>
</div>
<div class="paragraph">
<p>Each PRU accesses it&#8217;s own DRAM starting at location 0x0000_0000. Each PRU
can also access the other PRU&#8217;s DRAM starting at 0x0000_2000. Both PRUs
access the shared RAM at 0x0001_0000. The compiler can control where each
of these memories variables are stored.</p>
</div>
<div class="paragraph">
<p><a href="#blocks_shared">shared.pro0.c - Examples of Using Different Memory Locations</a> shows how to allocate seven variable in six different locations.</p>
</div>
<div id="blocks_shared" class="listingblock">
<div class="title">shared.pro0.c - Examples of Using Different Memory Locations</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">// From: http://git.ti.com/pru-software-support-package/pru-software-support-package/blobs/master/examples/am335x/PRU_access_const_table/PRU_access_const_table.c
#include &lt;stdint.h&gt;
#include &lt;pru_cfg.h&gt;
#include &lt;pru_ctrl.h&gt;
#include "resource_table_empty.h"

#define PRU_SRAM  <em>far </em>attribute<em>((cregister("PRU_SHAREDMEM", near)))
#define PRU_DMEM0 </em>far <em>attribute</em>((cregister("PRU_DMEM_0_1",  near)))
#define PRU_DMEM1 <em>far </em>attribute<em>((cregister("PRU_DMEM_1_0",  near)))

/* NOTE:  Allocating shared_x to PRU Shared Memory means that other PRU cores on
 *        the same subsystem must take care not to allocate data to that memory.
 *        Users also cannot rely on where in shared memory these variables are placed
 *        so accessing them from another PRU core or from the ARM is an undefined behavior.
 <strong>/
volatile uint32_t shared_0;
PRU_SRAM  volatile uint32_t shared_1;
PRU_DMEM0 volatile uint32_t shared_2;
PRU_DMEM1 volatile uint32_t shared_3;
#pragma DATA_SECTION(shared_4, ".bss")
volatile uint32_t shared_4;

/</strong> NOTE:  Here we pick where in memory to store shared_5.  The stack and
 *        heap take up the first 0x200 words, so we must start after that.
 *        Since we are hardcoding where things are stored we can share
 *        this between the PRUs and the ARM.
<strong>/
#define PRU0_DRAM       0x00000         // Offset to DRAM
// Skip the first 0x200 bytes of DRAM since the Makefile allocates
// 0x100 for the STACK and 0x100 for the HEAP.
volatile unsigned int *shared_5 = (unsigned int *) (PRU0_DRAM + 0x200);


int main(void)
{
    volatile uint32_t shared_6;
    volatile uint32_t shared_7;
    /<strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong>/
    /* Access PRU peripherals using Constant Table &amp; PRU header file <strong>/
    /<strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong>/

    /* Clear SYSCFG[STANDBY_INIT] to enable OCP master port <strong>/
    CT_CFG.SYSCFG_bit.STANDBY_INIT = 0;

    /<strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong>/
    /* Access PRU Shared RAM using Constant Table                    <strong>/
    /<strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong>/

    /* C28 defaults to 0x00000000, we need to set bits 23:8 to 0x0100 in order to have it point to 0x00010000    <strong>/
    PRU0_CTRL.CTPPR0_bit.C28_BLK_POINTER = 0x0100;

    shared_0 =  0xfeef;
    shared_1 = 0xdeadbeef;
    shared_2 = shared_2 + 0xfeed;
    shared_3 = 0xdeed;
    shared_4 = 0xbeed;
    shared_5[0] = 0x1234;
    shared_6 = 0x4321;
    shared_7 = 0x9876;

    /</strong> Halt PRU core */
    </em>halt();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_14"><a class="link" href="#_discussion_14">Discussion</a></h4>
<div class="paragraph">
<p>Here&#8217;s the line-by-line</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. Line-byline for shared.pru0.c</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PRU_SRAM</code> is defined here.  It will be used later to declare variables
in the <code>Shared RAM</code> location of memory.  Section 5.5.2 on page 75 of the
<a href="http://www.ti.com/lit/ug/spruhv7b/spruhv7b.pdf">PRU Optimizing C/C++ Compiler, v2.2, User&#8217;s Guide</a> gives details of the command.  The <code>PRU_SHAREDMEM</code>
refers to the memory section defined in <code>am335x_pru.cmd</code> on line 26.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">8 9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">These are like the previous line except for the DMEM sections.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Variables declared outside of <code>main()</code> are put on the heap.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">17</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adding <code>PRU_SRAM</code> has the variable stored in the shared memory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">18, 19</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">These are stored in the PRU&#8217;s local RAM.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">20, 21</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">These lines are for storing in the <code>.bss</code> section as declared on
line 74 of <code>am335x_pru.cmd</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">28-31</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All the previous examples direct the compiler to an area in memory
and the compilers figures out what to put where.  With these lines we
specify the exact location.  Here are start with the PRU_DRAM starting address and add 0x200 to it to avoid
the stack and the heap.  The advantage of this technique is you can
easily share these variables between the ARM and the two PRUs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">36, 37</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Variable declared inside <code>main()</code> go on the stack.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
<div class="paragraph">
<p>Using the technique of line 28-31 you can put variables anywhere,
even where the compiler has put them.
Be careful, it&#8217;s easy to overwrite what the compiler has done</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Compile and run the program.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-linenums" data-lang="linenums">bone$ <strong>source shared_setup.sh</strong>
TARGET=shared.pru0
Black Found
P9_31
Current mode for P9_31 is:     pruout
Current mode for P9_31 is:     pruout
P9_29
Current mode for P9_29 is:     pruout
Current mode for P9_29 is:     pruout
P9_30
Current mode for P9_30 is:     pruout
Current mode for P9_30 is:     pruout
P9_28
Current mode for P9_28 is:     pruout
Current mode for P9_28 is:     pruout
bone$ <strong>make</strong>
/var/lib/cloud9/common/Makefile:29: MODEL=TI_AM335x_BeagleBone_Black,TARGET=shared.pru0
-    Stopping PRU 0
-   copying firmware file /tmp/cloud9-examples/shared.pru0.out to /lib/firmware/am335x-pru0-fw
write_init_pins.sh
-    Starting PRU 0
MODEL   = TI_AM335x_BeagleBone_Black
PROC    = pru
PRUN    = 0
PRU_DIR = /sys/class/remoteproc/remoteproc1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now check the symbol table to see where things are allocated.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-linenums" data-lang="linenums">bone $ <strong>grep shared /tmp/cloud9-examples/shared.pru0.map</strong>
....
1     0000011c  shared_0
2     00010000  shared_1
1     00000000  shared_2
1     00002000  shared_3
1     00000118  shared_4
1     00000120  shared_5</code></pre>
</div>
</div>
<div class="paragraph">
<p>We see, <code>shared_0</code> had no directives and was places in the heap that is 0x100
to 0x1ff.  <code>shared_1</code> was directed to go to the SHAREDMEM, <code>shared_2</code> to
the start of the local DRAM (which is also the top of the stack).  <code>shared_3</code>
was placed in the DRAM of PRU 1, <code>shared_4</code> was placed in the <code>.bss</code> section,
which is in the heap.  Finally <code>shared_5</code> is a pointer to where the value
is stored.</p>
</div>
<div class="paragraph">
<p>Where are <code>shared_6</code> and <code>shared_7</code>?  They are declared inside <code>main()</code> and are
therefore placed on the stack at run time.  The <code>shared.map</code> file shows the
compile time allocations.  We have to look in the memory itself to see what
happen at run time.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s fire up <code>prudebug</code>
(<a href="../04debug/debug.html.html#debug_prudebug">prudebug - A Simple Debugger for the PRU</a>)
to see where things are.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-linenums" data-lang="linenums">bone$ <strong>sudo ./prudebug</strong>
PRU Debugger v0.25
(C) Copyright 2011, 2013 by Arctica Technologies.  All rights reserved.
Written by Steven Anderson

Using /dev/mem device.
Processor type      AM335x
PRUSS memory address    0x4a300000
PRUSS memory length 0x00080000

         offsets below are in 32-bit byte addresses (not ARM byte addresses)
         PRU            Instruction    Data         Ctrl
         0              0x00034000     0x00000000   0x00022000
         1              0x00038000     0x00002000   0x00024000

PRU0&gt; <strong>d 0</strong>
Absolute addr = 0x0000, offset = 0x0000, Len = 16
[0x0000] 0x0000feed 0x00000000 0x00000000 0x00000000
[0x0010] 0x00000000 0x00000000 0x00000000 0x00000000
[0x0020] 0x00000000 0x00000000 0x00000000 0x00000000
[0x0030] 0x00000000 0x00000000 0x00000000 0x00000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>The value of <code>shared_2</code> is in memory location 0.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-linenums" data-lang="linenums">PRU0&gt; <strong>dd 0x100</strong>
Absolute addr = 0x0100, offset = 0x0000, Len = 16
[0x0100] 0x00000000 0x00000001 0x00000000 0x00000000
[0x0110] 0x00000000 0x00000000 0x0000beed 0x0000feef
[0x0120] 0x00000200 0x3ec71de3 0x1a013e1a 0xbf2a01a0
[0x0130] 0x111110b0 0x3f811111 0x55555555 0xbfc55555</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are <code>shared_0</code> and <code>shared_4</code> in the heap, but where is <code>shared_6</code> and
<code>shared_7</code>?  They are supposed to be on the stack that starts at 0.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-linenums" data-lang="linenums">PRU0&gt; dd <strong>0xc0</strong>
Absolute addr = 0x00c0, offset = 0x0000, Len = 16
[0x00c0] 0x00000000 0x00000000 0x00000000 0x00000000
[0x00d0] 0x00000000 0x00000000 0x00000000 0x00000000
[0x00e0] 0x00000000 0x00000000 0x00000000 0x00000000
[0x00f0] 0x00000000 0x00000000 0x00004321 0x00009876</code></pre>
</div>
</div>
<div class="paragraph">
<p>There they are; the stack grows from the top. (The heap grows from the bottom.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-linenums" data-lang="linenums">PRU0&gt; dd <strong>0x2000</strong>
Absolute addr = 0x2000, offset = 0x0000, Len = 16
[0x2000] 0x0000deed 0x00000001 0x00000000 0x557fcfb5
[0x2010] 0xce97bd0f 0x6afb2c8f 0xc7f35df4 0x5afb6dcb
[0x2020] 0x8dec3da3 0xe39a6756 0x642cb8b8 0xcb6952c0
[0x2030] 0x2f22ebda 0x548d97c5 0x9241786f 0x72dfeb86</code></pre>
</div>
</div>
<div class="paragraph">
<p>And there is PRU 1&#8217;s memory with <code>shared_3</code>. And finally the shared memory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-linenums" data-lang="linenums">PRU0&gt; <strong>dd 0x10000</strong>
Absolute addr = 0x10000, offset = 0x0000, Len = 16
[0x10000] 0xdeadbeef 0x0000feed 0x00000000 0x68c44f8b
[0x10010] 0xc372ba7e 0x2ffa993b 0x11c66da5 0xfbf6c5d7
[0x10020] 0x5ada3fcf 0x4a5d0712 0x48576fb7 0x1004796b
[0x10030] 0x2267ebc6 0xa2793aa1 0x100d34dc 0x9ca06d4a</code></pre>
</div>
</div>
<div class="paragraph">
<p>The compiler offers great control over where variables are stored. Just
be sure if you are hand picking where things are put, not to put them in places
used by the compiler.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_auto_initialization_of_built_in_led_triggers"><a class="link" href="#_auto_initialization_of_built_in_led_triggers">5.2. Auto Initialization of built-in LED Triggers</a></h3>
<div class="sect3">
<h4 id="_problem_29"><a class="link" href="#_problem_29">Problem</a></h4>
<div class="paragraph">
<p>I see the built-in LEDs blink to their own patterns.  How do I turn this off?
Can this be automated?</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_29"><a class="link" href="#_solution_29">Solution</a></h4>
<div class="paragraph">
<p>Each built-in LED has a default action (trigger) when the Bone boots up.
This is controlled by <code>/sys/class/leds</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bone$ <strong>cd /sys/class/leds</strong>
bone$ <strong>ls</strong>
beaglebone:green:usr0  beaglebone:green:usr2
beaglebone:green:usr1  beaglebone:green:usr3</pre>
</div>
</div>
<div class="paragraph">
<p>Here you see a directory for each of the LEDs.  Let&#8217;s pick USR1.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bone$ <strong>cd beaglebone\:green\:usr1</strong>
bone$ <strong>ls</strong>
brightness  device  max_brightness  power  subsystem  trigger  uevent
bone$ <strong>cat trigger</strong>
none rc-feedback kbd-scrolllock kbd-numlock kbd-capslock kbd-kanalock
kbd-shiftlock kbd-altgrlock kbd-ctrllock kbd-altlock kbd-shiftllock
kbd-shiftrlock kbd-ctrlllock kbd-ctrlrlock usb-gadget usb-host
<strong>[mmc0]</strong> mmc1 timer oneshot disk-activity ide-disk mtd nand-disk
heartbeat backlight gpio cpu0 default-on</pre>
</div>
</div>
<div class="paragraph">
<p>Notice <code>[mmc0]</code> is in brackets.  This means it&#8217;s the current trigger; it flashes
when the built-in flash memory is in use.  You can turn this off using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bone$ <strong>echo none &gt; trigger</strong>
bone$ <strong>cat trigger</strong>
[none] rc-feedback kbd-scrolllock kbd-numlock kbd-capslock kbd-kanalock
kbd-shiftlock kbd-altgrlock kbd-ctrllock kbd-altlock kbd-shiftllock
kbd-shiftrlock kbd-ctrlllock kbd-ctrlrlock usb-gadget usb-host
mmc0 mmc1 timer oneshot disk-activity ide-disk mtd nand-disk
heartbeat backlight gpio cpu0 default-on</pre>
</div>
</div>
<div class="paragraph">
<p>Now it is no longer flashing.</p>
</div>
<div class="paragraph">
<p>How can this be automated so when code is run that needs the trigger off, it&#8217;s
turned off automatically?  Here&#8217;s a trick.  Include the following in your code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">#pragma DATA_SECTION(init_pins, ".init_pins")
#pragma RETAIN(init_pins)
const char init_pins[] =
        "/sys/class/leds/beaglebone:green:usr3/trigger\0none\0" \
        "\0\0";</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lines 3 and 4 declare the array <code>init_pins</code> to have an entry which is the path
to <code>trigger</code> and the value that should be 'echoed' into it. Both are NULL
terminated.  Line 1 says to put this in a section called <code>.init_pins</code> and
line 2 says to <code>RETAIN</code> it.  That is don&#8217;t throw it away if it appears to be
unused.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_15"><a class="link" href="#_discussion_15">Discussion</a></h4>
<div class="paragraph">
<p>The above code stores this array in the <code>.out</code> file thats created, but that&#8217;s not
enough. You need to run <a href="#blocks_write_init_pins">write_init_pins.sh</a> on the <code>.out</code> file to make
the code work.  Fortunately the Makefile always runs it.</p>
</div>
<div id="blocks_write_init_pins" class="listingblock">
<div class="title">write_init_pins.sh</div>
<div class="content">
<pre class="highlight"><code class="language-linenums" data-lang="linenums">#!/bin/bash
init_pins=$(readelf -x .init_pins $1 | grep 0x000 | cut -d' ' -f4-7 | xxd -r -p | tr '\0' '\n' | paste - -)
while read -a line; do
    if [ ${#line[@]} == 2 ]; then
        echo writing \"${line[1]}\" to \"${line[0]}\"
        echo ${line[1]} &gt; ${line[0]}
        sleep 0.1
    fi
done &lt;&lt;&lt; "$init_pins"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>readelf</code> command extracts the path and value from the <code>.out</code> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-linenums" data-lang="linenums">bone$ <strong>readelf -x .init_pins /tmp/pru0-gen/shared.out</strong>

Hex dump of section '.init_pins':
  0x000000c0 2f737973 2f636c61 73732f6c 6564732f /sys/class/leds/
  0x000000d0 62656167 6c65626f 6e653a67 7265656e beaglebone:green
  0x000000e0 3a757372 332f7472 69676765 72006e6f :usr3/trigger.no
  0x000000f0 6e650000 0000                       ne....</code></pre>
</div>
</div>
<div class="paragraph">
<p>The rest of the command formats it.  Finally line 6 echos the <code>none</code> into
the path.</p>
</div>
<div class="paragraph">
<p>This can be generalized to initialize other things.  The point is, the <code>.out</code>
file contains everything needed to run the executable.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="blocks_pwm"><a class="link" href="#blocks_pwm">5.3. PWM Generator</a></h3>
<div class="paragraph">
<p>One of the simplest things a PRU can to is generate a simple
signals starting with a single channel PWM that has a fixed frequency and
duty cycle and ending with a multi channel PWM that the ARM can change
the frequency and duty cycle on the fly.</p>
</div>
<div class="sect3">
<h4 id="_problem_30"><a class="link" href="#_problem_30">Problem</a></h4>
<div class="paragraph">
<p>I want to generate a PWM signal that has a fixed frequency and duty cycle.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_30"><a class="link" href="#_solution_30">Solution</a></h4>
<div class="paragraph">
<p>The solution is fairly easy, but be sure to check the <strong>Discussion</strong> section
for details on making it work.</p>
</div>
<div class="paragraph">
<p><a href="#blocks_pwm1">pwm1.pru0.c</a> shows the code.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>This code is for the BeagleBone Black.  See <code>pwm1.pru1_1.c</code> for an example
that works on the AI.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="blocks_pwm1" class="listingblock">
<div class="title">pwm1.pru0.c</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">#include &lt;stdint.h&gt;
#include &lt;pru_cfg.h&gt;
#include "resource_table_empty.h"
#include "prugpio.h"

volatile register uint32_t __R30;
volatile register uint32_t __R31;

void main(void)
{
    uint32_t gpio = P9_31;  // Select which pin to toggle.;

    /* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */
    CT_CFG.SYSCFG_bit.STANDBY_INIT = 0;

    while(1) {
        __R30 |= gpio;      // Set the GPIO pin to 1
        __delay_cycles(100000000);
        __R30 &amp;= ~gpio;     // Clear the GPIO pin
        __delay_cycles(100000000);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To run this code you need to configure the pin muxes to output the PRU.  If you are on the Black run</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>config-pin P9_31 pruout</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>On the Pocket run</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>config-pin P1_36 pruout</strong></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>See <a href="08ai/ai.html.html">Configuring pins on the AI via device trees</a> for configuring
pins on the AI.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then, tell <code>Makefile</code> which PRU you are compiling for and what your target file is</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>export TARGET=pwm1.pru0</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you are ready to compile</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-linenums" data-lang="linenums">bone$ <strong>make</strong>
/var/lib/cloud9/common/Makefile:29: MODEL=TI_AM335x_BeagleBone_Black,TARGET=pwm1.pru0
-    Stopping PRU 0
-   copying firmware file /tmp/cloud9-examples/pwm1.pru0.out to /lib/firmware/am335x-pru0-fw
write_init_pins.sh
-    Starting PRU 0
MODEL   = TI_AM335x_BeagleBone_Black
PROC    = pru
PRUN    = 0
PRU_DIR = /sys/class/remoteproc/remoteproc1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now attach an LED (or oscilloscope) to <code>P9_31</code> on the Black or <code>P1.36</code> on the Pocket.  You should see a squarewave.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_16"><a class="link" href="#_discussion_16">Discussion</a></h4>
<div class="paragraph">
<p>Since this is our first example we&#8217;ll discuss the many parts in detail.</p>
</div>
<div class="sect4">
<h5 id="_pwm1_pru0_c"><a class="link" href="#_pwm1_pru0_c">pwm1.pru0.c</a></h5>
<div class="paragraph">
<p><a href="#blocks_pwm1_line_by_line">Line-by-line of pwm1.pru0.c</a> is a line-by-line expanation of the c code.</p>
</div>
<table id="blocks_pwm1_line_by_line" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. Line-by-line of pwm1.pru0.c</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Standard c-header include</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Include for the PRU.  The compiler knows where to find this since the <code>Makefile</code> says to look for includes in <code>/usr/lib/ti/pru-software-support-package</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The file <code>resource_table_empty.h</code> is used by the PRU loader.  Generally we&#8217;ll use the same file, and don&#8217;t need to modify it.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This include has addresses for the GPIO ports and some bit positions for some
of the headers.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Here&#8217;s what&#8217;s in <code>resource_table_empty.h</code></p>
</div>
<div class="listingblock">
<div class="title">resource_table_empty.c</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">/*
 *  ======== resource_table_empty.h ========
 *
 *  Define the resource table entries for all PRU cores. This will be
 *  incorporated into corresponding base images, and used by the remoteproc
 *  on the host-side to allocated/reserve resources.  Note the remoteproc
 *  driver requires that all PRU firmware be built with a resource table.
 *
 *  This file contains an empty resource table.  It can be used either as:
 *
 *        1) A template, or
 *        2) As-is if a PRU application does not need to configure PRU_INTC
 *                  or interact with the rpmsg driver
 *
 */

#ifndef _RSC_TABLE_PRU_H_
#define _RSC_TABLE_PRU_H_

#include &lt;stddef.h&gt;
#include &lt;rsc_types.h&gt;

struct my_resource_table {
    struct resource_table base;

    uint32_t offset[1]; /* Should match 'num' in actual definition */
};

#pragma DATA_SECTION(pru_remoteproc_ResourceTable, ".resource_table")
#pragma RETAIN(pru_remoteproc_ResourceTable)
struct my_resource_table pru_remoteproc_ResourceTable = {
    1,  /* we're the first version that implements this */
    0,  /* number of entries in the table */
    0, 0,   /* reserved, must be zero */
    0,  /* offset[0] */
};

#endif /* _RSC_TABLE_PRU_H_ */</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Line-by-line (continuted)</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">6-7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>__R30</code> and <code>__R31</code> are two variables that refer to the PRU output (<code>__R30</code>) and input (<code>__R31</code>) registers.
When you write something to <code>__R30</code> it will show up on the corresponding output pins.
When you read from <code>__R31</code> you read the data on the input pins.
NOTE: Both names begin with two underscore&#8217;s. Section 5.7.2 of the
<a href="http://www.ti.com/lit/ug/spruhv7b/spruhv7b.pdf">PRU Optimizing C/C++ Compiler, v2.2, User&#8217;s Guide</a>
gives more details.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This line selects which GPIO pin to toggle.  The table below shows which bits in <code>__R30</code> map to which pins</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CT_CFG.SYSCFG_bit.STANDBY_INIT</code> is set to <code>0</code> to enable the OCP master port. More details on this and thousands of other regesters see the
<a href="https://www.ti.com/lit/ug/spruh73p/spruh73p.pdf">AM335x Technical Reference Manual</a>. Section 4 is on the PRU and section 4.5 gives details for all the registers.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Bit 0 is the LSB.</p>
</div>
<div class="paragraph">
<p></p>
</div>
<table id="blocks_mapping_bits" class="tableblock frame-all grid-all" style="width: 35%;">
<caption class="title">Table 9. Mapping bit positions to pin names</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 10%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">PRU</th>
<th class="tableblock halign-left valign-top">Bit</th>
<th class="tableblock halign-left valign-top">Black pin</th>
<th class="tableblock halign-left valign-top">Pocket pin</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_31</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.36</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_29</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.33</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_30</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.32</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_28</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.30</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_92</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.31</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_27</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.34</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_91</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.28</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_25</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.29</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_12(out) P8_16(in)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.24</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_11(out) P8_15(in)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.33</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">---</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">---</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">---------</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-----</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_45</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_46</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_43</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_44</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_41</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_42</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_39</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_40</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_27</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.35</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_29</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.01</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_28</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.35</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_30</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.04</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_21</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">13</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_20</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">14</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.32</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.30</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_26(in)</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>See <a href="08ai/ai.html.html">Configuring pins on the AI via device trees</a> for all
the PRU pins on the AI.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Since we are running on PRU 0, and we&#8217;re using <code>0x0001</code>, that is bit 0,
we&#8217;ll be toggling <code>P9_31</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 10. Line-by-line (continued again)</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">17</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Here is where the action is.  This line reads <code>__R30</code> and then ORs it with <code>gpio</code>, setting the bits where there is a 1 in <code>gpio</code> and leaving the bits where there is a 0.  Thus we are setting the bit we selected. Finally the new value is written back to <code>__R30</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">18</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>__delay_cycles</code> is an instrinsic function that delays with number of cycles passed to it. Each cycle is 5ns, and we are delaying 100,000,000 cycles which is 500,000,000ns, or 0.5 seconds.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">19</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is like line 17, but <code>~gpio</code> inverts all the bits in <code>gpio</code> so that where we had a 1, there is now a 0.  This 0 is then ANDed with <code>__R30</code> setting the corresponding bit to 0.  Thus we are clearing the bit we selected.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can read more about instrinsics in section 5.11 of the (<a href="http://www.ti.com/lit/ug/spruhv7b/spruhv7b.pdf">PRU Optimizing C/C++ Compiler, v2.2, User&#8217;s Guide</a>.)</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When you run this code and look at the output you will see something like the following figure.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./05blocks/figures/pwm1.png" alt="pwm1.pru0.c output">
</div>
<div class="title">Figure 29. Output of pwm1.pru0.c with 100,000,000 delays cycles giving a 1s period</div>
</div>
<div class="paragraph">
<p>Notice the on time (<code>+Width(1)</code>) is 500ms, just as we predicted.  The off time is 498ms, which is only 2ms off from our prediction.  The standard deviation is 0, or only 380as, which is 380 * 10<sup>-18</sup>!.</p>
</div>
<div class="paragraph">
<p>You can see how fast the PRU can run by setting both of the <code>__delay_cycles</code> to 0. This results in the next figure.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./05blocks/figures/pwm2.png" alt="pwm1.pru0.c output with 0 delay">
</div>
<div class="title">Figure 30. Output of pwm1.pru0c with 0 delay cycles</div>
</div>
<div class="paragraph">
<p>Notice the period is 15ns which gives us a frequency of about 67MHz. At this high frequency the breadboard that I&#8217;m using distorts the waveform so it&#8217;s no longer a squarewave. The <em>on</em> time is 5.3ns and the <em>off</em> time is 9.8ns.  That means <code>__R30 |= gpio</code> took only one 5ns cycle and <code>__R30 &amp;= ~gpio</code> also only took one cycle, but there is also an extra cycle needed for the loop.  This means the compiler was able to implement the <code>while</code> loop in just three 5ns instructions!  Not bad.</p>
</div>
<div class="paragraph">
<p>We want a square wave, so we need to add a delay to correct for the delay of looping back.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the code that does just that.</p>
</div>
<div class="listingblock">
<div class="title">pwm2.pru0.c</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">#include &lt;stdint.h&gt;
#include &lt;pru_cfg.h&gt;
#include "resource_table_empty.h"
#include "prugpio.h"

volatile register uint32_t __R30;
volatile register uint32_t __R31;

void main(void)
{
    uint32_t gpio = P9_31;  // Select which pin to toggle.;

    /* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */
    CT_CFG.SYSCFG_bit.STANDBY_INIT = 0;

    while (1) {
        __R30 |= gpio;      // Set the GPIO pin to 1
        __delay_cycles(1);  // Delay one cycle to correct for loop time
        __R30 &amp;= ~gpio;     // Clear the GPIO pin
        __delay_cycles(0);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output now looks like:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./05blocks/figures/pwm3.png" alt="pwm2.c corrected delay">
</div>
<div class="title">Figure 31. Output of pwm2.pru0.c corrected delay</div>
</div>
<div class="paragraph">
<p>It&#8217;s not hard to adjust the two <code>__delay_cycles</code> to get the desired frequency and duty cycle.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_controlling_the_pwm_frequency"><a class="link" href="#_controlling_the_pwm_frequency">5.4. Controlling the PWM Frequency</a></h3>
<div class="sect3">
<h4 id="_problem_31"><a class="link" href="#_problem_31">Problem</a></h4>
<div class="paragraph">
<p>You would like to control the frequency and duty cycle of the PWM without recompiling.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_31"><a class="link" href="#_solution_31">Solution</a></h4>
<div class="paragraph">
<p>Have the PRU read the <em>on</em> and <em>off</em> times from a shared memory location.  Each PRU has is own 8KB of data memory (DRAM) and 12KB of shared memory (SHAREDMEM) that the ARM processor can also access.  See <a href="#blocks_PRU_block_diagram">PRU Block Diagram</a>.</p>
</div>
<div class="paragraph">
<p>The DRAM 0 address is 0x0000 for PRU 0.  The same DRAM appears at address 0x4A300000 as seen from the ARM processor.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>See page
184 of the <a href="https://www.ti.com/lit/ug/spruh73p/spruh73p.pdf">AM335x Technical Reference Manual</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We take the previous PRU code and add the lines</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">#define PRU0_DRAM       0x00000         // Offset to DRAM
volatile unsigned int *pru0_dram = PRU0_DRAM;</code></pre>
</div>
</div>
<div class="paragraph">
<p>to define a pointer to the DRAM.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>volatile</code> keyword is used here to tell the compiler the value this
points to may change, so don&#8217;t make any assumptions while optimizing.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Later in the code we use</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">    pru0_dram[ch] = on[ch];         // Copy to DRAM0 so the ARM can change it
    pru0_dram[ch+MAXCH] = off[ch];  // Copy after the on array</code></pre>
</div>
</div>
<div class="paragraph">
<p>to write the <code>on</code> and <code>off</code> times to the DRAM.  Then inside the <code>while</code> loop we use</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">    onCount[ch] = pru0_dram[2*ch];      // Read from DRAM0
    offCount[ch]= pru0_dram[2*ch+1];</code></pre>
</div>
</div>
<div class="paragraph">
<p>to read from the DRAM when reseting the counters.  Now, while the PRU is running, the ARM can write values into the DRAM and change
the PWM on and off times.  <a href="#blocks_pwm4">pwm4.pru0.c</a> is the whole code.</p>
</div>
<div id="blocks_pwm4" class="listingblock">
<div class="title">pwm4.pru0.c</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">// This code does MAXCH parallel PWM channels.
// It's period is 3 us
#include &lt;stdint.h&gt;
#include &lt;pru_cfg.h&gt;
#include "resource_table_empty.h"

#define PRU0_DRAM       0x00000         // Offset to DRAM
// Skip the first 0x200 byte of DRAM since the Makefile allocates
// 0x100 for the STACK and 0x100 for the HEAP.
volatile unsigned int *pru0_dram = (unsigned int *) (PRU0_DRAM + 0x200);

#define MAXCH   4   // Maximum number of channels per PRU

volatile register uint32_t __R30;
volatile register uint32_t __R31;

void main(void)
{
    uint32_t ch;
    uint32_t on[]  = {1, 2, 3, 4};  // Number of cycles to stay on
    uint32_t off[] = {4, 3, 2, 1};  // Number to stay off
    uint32_t onCount[MAXCH];        // Current count
    uint32_t offCount[MAXCH];

    /* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */
    CT_CFG.SYSCFG_bit.STANDBY_INIT = 0;

    // Initialize the channel counters.
    for(ch=0; ch&lt;MAXCH; ch++) {
        pru0_dram[2*ch  ] = on[ch];     // Copy to DRAM0 so the ARM can change it
        pru0_dram[2*ch+1] = off[ch];    // Interleave the on and off values
        onCount[ch] = on[ch];
        offCount[ch]= off[ch];
    }

    while (1) {
        for(ch=0; ch&lt;MAXCH; ch++) {
            if(onCount[ch]) {
                onCount[ch]--;
                __R30 |= 0x1&lt;&lt;ch;       // Set the GPIO pin to 1
            } else if(offCount[ch]) {
                offCount[ch]--;
                __R30 &amp;= ~(0x1&lt;&lt;ch);    // Clear the GPIO pin
            } else {
                onCount[ch] = pru0_dram[2*ch];      // Read from DRAM0
                offCount[ch]= pru0_dram[2*ch+1];
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is code that runs on the ARM side to set the on and off time values.</p>
</div>
<div class="listingblock">
<div class="title">pwm-test.c</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">/*
 *
 *  pwm tester
 *  The on cycle and off cycles are stored in each PRU's Data memory
 *
 */

#include &lt;stdio.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;sys/mman.h&gt;

#define MAXCH 4

#define PRU_ADDR        0x4A300000      // Start of PRU memory Page 184 am335x TRM
#define PRU_LEN         0x80000         // Length of PRU memory
#define PRU0_DRAM       0x00000         // Offset to DRAM
#define PRU1_DRAM       0x02000
#define PRU_SHAREDMEM   0x10000         // Offset to shared memory

unsigned int    *pru0DRAM_32int_ptr;        // Points to the start of local DRAM
unsigned int    *pru1DRAM_32int_ptr;        // Points to the start of local DRAM
unsigned int    *prusharedMem_32int_ptr;    // Points to the start of the shared memory

/*******************************************************************************
* int start_pwm_count(int ch, int countOn, int countOff)
*
* Starts a pwm pulse on for countOn and off for countOff to a single channel (ch)
*******************************************************************************/
int start_pwm_count(int ch, int countOn, int countOff) {
    unsigned int *pruDRAM_32int_ptr = pru0DRAM_32int_ptr;

    printf("countOn: %d, countOff: %d, count: %d\n",
        countOn, countOff, countOn+countOff);
    // write to PRU shared memory
    pruDRAM_32int_ptr[2*(ch)+0] = countOn;  // On time
    pruDRAM_32int_ptr[2*(ch)+1] = countOff; // Off time
    return 0;
}

int main(int argc, char *argv[])
{
    unsigned int    *pru;       // Points to start of PRU memory.
    int fd;
    printf("Servo tester\n");

    fd = open ("/dev/mem", O_RDWR | O_SYNC);
    if (fd == -1) {
        printf ("ERROR: could not open /dev/mem.\n\n");
        return 1;
    }
    pru = mmap (0, PRU_LEN, PROT_READ | PROT_WRITE, MAP_SHARED, fd, PRU_ADDR);
    if (pru == MAP_FAILED) {
        printf ("ERROR: could not map memory.\n\n");
        return 1;
    }
    close(fd);
    printf ("Using /dev/mem.\n");

    pru0DRAM_32int_ptr =     pru + PRU0_DRAM/4 + 0x200/4;   // Points to 0x200 of PRU0 memory
    pru1DRAM_32int_ptr =     pru + PRU1_DRAM/4 + 0x200/4;   // Points to 0x200 of PRU1 memory
    prusharedMem_32int_ptr = pru + PRU_SHAREDMEM/4; // Points to start of shared memory

    int i;
    for(i=0; i&lt;MAXCH; i++) {
        start_pwm_count(i, i+1, 20-(i+1));
    }

    if(munmap(pru, PRU_LEN)) {
        printf("munmap failed\n");
    } else {
        printf("munmap succeeded\n");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A quick check on the 'scope shows <a href="#blocks_pwm_arm_control">Four Channel PWM with ARM control</a>.</p>
</div>
<div id="blocks_pwm_arm_control" class="imageblock">
<div class="content">
<img src="./05blocks/figures/pwm4.png" alt="pwm4.png">
</div>
<div class="title">Figure 32. Four Channel PWM with ARM control</div>
</div>
<div class="paragraph">
<p>From the 'scope you see a 1 cycle <em>on</em> time results in a 450ns wide pulse and
a 3.06us period is 326KHz, much
slower than the 10ns pulse we saw before.  But it may be more than fast enough
for many applications.  For example, most servos run at 50Hz.</p>
</div>
<div class="paragraph">
<p>But we can do better.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_loop_unrolling_for_better_performance"><a class="link" href="#_loop_unrolling_for_better_performance">5.5. Loop Unrolling for Better Performance</a></h3>
<div class="sect3">
<h4 id="_problem_32"><a class="link" href="#_problem_32">Problem</a></h4>
<div class="paragraph">
<p>The ARM controlled PRU code runs too slowly.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_32"><a class="link" href="#_solution_32">Solution</a></h4>
<div class="paragraph">
<p>Simple loop unrolling can greatly improve the speed.  <code>pwm5.pru0.c</code> is our unrolled
version.</p>
</div>
<div class="listingblock">
<div class="title">pwm5.pru0.c Unrolled</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">// This code does MAXCH parallel PWM channels.
// It's period is 510ns.
#include &lt;stdint.h&gt;
#include &lt;pru_cfg.h&gt;
#include "resource_table_empty.h"

#define PRU0_DRAM       0x00000         // Offset to DRAM
// Skip the first 0x200 byte of DRAM since the Makefile allocates
// 0x100 for the STACK and 0x100 for the HEAP.
volatile unsigned int *pru0_dram = (unsigned int *) (PRU0_DRAM + 0x200);

#define MAXCH   4   // Maximum number of channels per PRU

#define update(ch) \
            if(onCount[ch]) {           \
                onCount[ch]--;          \
                __R30 |= 0x1&lt;&lt;ch;       \
            } else if(offCount[ch]) {   \
                offCount[ch]--;         \
                __R30 &amp;= ~(0x1&lt;&lt;ch);    \
            } else {                    \
                onCount[ch] = pru0_dram[2*ch];  \
                offCount[ch]= pru0_dram[2*ch+1];    \
            }

volatile register uint32_t __R30;
volatile register uint32_t __R31;

void main(void)
{
    uint32_t ch;
    uint32_t on[]  = {1, 2, 3, 4};
    uint32_t off[] = {4, 3, 2, 1};
    uint32_t onCount[MAXCH], offCount[MAXCH];

    /* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */
    CT_CFG.SYSCFG_bit.STANDBY_INIT = 0;

#pragma UNROLL(MAXCH)
    for(ch=0; ch&lt;MAXCH; ch++) {
        pru0_dram[2*ch  ] = on[ch];     // Copy to DRAM0 so the ARM can change it
        pru0_dram[2*ch+1] = off[ch];    // Interleave the on and off values
        onCount[ch] = on[ch];
        offCount[ch]= off[ch];
    }

    while (1) {
        update(0)
        update(1)
        update(2)
        update(3)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output of <code>pwm5.pru0.c</code> is in the figure below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./05blocks/figures/pwm5_no_loop.png" alt="pwm5.pru0.c Unrolled version of pwm4.pru0.c">
</div>
<div class="title">Figure 33. pwm5.pru0.c Unrolled version of pwm4.pru0.c</div>
</div>
<div class="paragraph">
<p>It&#8217;s running about 6 times faster than <code>pwm4.pru0.c</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 11. pwm4.pru0.c vs. pwm5.pru0.c</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Measure</th>
<th class="tableblock halign-left valign-top">pwm4.pru0.c time</th>
<th class="tableblock halign-left valign-top">pwm5.pru0.c time</th>
<th class="tableblock halign-left valign-top">Speedup</th>
<th class="tableblock halign-left valign-top">pwm5.pru0.c w/o UNROLL</th>
<th class="tableblock halign-left valign-top">Speedup</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Period</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.06&mu;s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">510ns</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.81&mu;s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">~1.7x</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Width+</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">450ns</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">70ns</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">~6x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.56&mu;s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">~.3x</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Not a bad speed up for just a couple of simple changes.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_17"><a class="link" href="#_discussion_17">Discussion</a></h4>
<div class="paragraph">
<p>Here&#8217;s how it works.
First look at line 39.  You see <code>#pragma UNROLL(MAXCH)</code> which is a <code>pragma</code>
that tells the compiler to unroll the loop that follows.  We are unrolling it
<code>MAXCH</code> times (four times in this example). Just removing the <code>pragma</code> causes
the speedup compared to the <code>pwm4.pru0.c</code> case to drop from 6x to only 1.7x.</p>
</div>
<div class="paragraph">
<p>We also have our <code>for</code> loop inside the <code>while</code> loop that can be unrolled.
Unfortunately <code>UNROLL()</code> doesn&#8217;t work on it, therefore we have to do it by
hand. We could take the loop and just copy it three times, but that would
make it harder to maintain the code.  Instead I convered the loop into a
<code>#define</code> (lines 14-24) and invoked <code>update()</code> as needed (lines 48-51).
This is not a function call. Whenever the preprocessor sees the <code>update()</code>
it copies the code an then it&#8217;s compiled.</p>
</div>
<div class="paragraph">
<p>This unrolling gets us an impressive 6x speedup.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_making_all_the_pulses_start_at_the_same_time"><a class="link" href="#_making_all_the_pulses_start_at_the_same_time">5.6. Making All the Pulses Start at the Same Time</a></h3>
<div class="sect3">
<h4 id="_problem_33"><a class="link" href="#_problem_33">Problem</a></h4>
<div class="paragraph">
<p>I have a mutlichannel PWM working, but the pulses aren&#8217;t synchronized, that is
they don&#8217;t all start at the same time.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_33"><a class="link" href="#_solution_33">Solution</a></h4>
<div class="paragraph">
<p><a href="#blocks_zoomed">pwm5.pru0 Zoomed In</a> is a zoomed in version of the previous figure. Notice the pulse in each channel starts about 15ns later than the channel above
it.</p>
</div>
<div id="blocks_zoomed" class="imageblock">
<div class="content">
<img src="./05blocks/figures/pwm5_zoomed.png" alt="pwm5.pru0 zoomed.png">
</div>
<div class="title">Figure 34. pwm5.pru0 Zoomed In</div>
</div>
<div class="paragraph">
<p>The solution is to declare <code>Rtmp</code> (line 35) which holds the value for <code>__R30</code>.</p>
</div>
<div class="listingblock">
<div class="title">pwm6.pru0.c Sync&#8217;ed Version of pwm5.pru0.c</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">// This code does MAXCH parallel PWM channels.
// All channels start at the same time. It's period is 510ns
#include &lt;stdint.h&gt;
#include &lt;pru_cfg.h&gt;
#include "resource_table_empty.h"

#define PRU0_DRAM       0x00000         // Offset to DRAM
// Skip the first 0x200 byte of DRAM since the Makefile allocates
// 0x100 for the STACK and 0x100 for the HEAP.
volatile unsigned int *pru0_dram = (unsigned int *) (PRU0_DRAM + 0x200);

#define MAXCH   4   // Maximum number of channels per PRU

#define update(ch) \
            if(onCount[ch]) {           \
                onCount[ch]--;          \
                Rtmp |= 0x1&lt;&lt;ch;        \
            } else if(offCount[ch]) {   \
                offCount[ch]--;         \
                Rtmp &amp;= ~(0x1&lt;&lt;ch); \
            } else {                    \
                onCount[ch] = pru0_dram[2*ch];  \
                offCount[ch]= pru0_dram[2*ch+1];    \
            }

volatile register uint32_t __R30;
volatile register uint32_t __R31;

void main(void)
{
    uint32_t ch;
    uint32_t on[]  = {1, 2, 3, 4};
    uint32_t off[] = {4, 3, 2, 1};
    uint32_t onCount[MAXCH], offCount[MAXCH];
    register uint32_t Rtmp;

    /* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */
    CT_CFG.SYSCFG_bit.STANDBY_INIT = 0;

#pragma UNROLL(MAXCH)
    for(ch=0; ch&lt;MAXCH; ch++) {
        pru0_dram[2*ch  ] = on[ch];     // Copy to DRAM0 so the ARM can change it
        pru0_dram[2*ch+1] = off[ch];    // Interleave the on and off values
        onCount[ch] = on[ch];
        offCount[ch]= off[ch];
    }
    Rtmp = __R30;

    while (1) {
        update(0)
        update(1)
        update(2)
        update(3)
        __R30 = Rtmp;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each channel writes it&#8217;s value to <code>Rtmp</code> (lines 17 and 20) and then after
each channel has updated, <code>Rtmp</code> is copied to <code>__R30</code> (line 54).</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_18"><a class="link" href="#_discussion_18">Discussion</a></h4>
<div class="paragraph">
<p>The following figure shows the channel are sync&#8217;ed. Though the period is slightly
longer than before.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./05blocks/figures/pwm6_synced.png" alt="pwm6.pru0 Synchronized Channels">
</div>
<div class="title">Figure 35. pwm6.pru0 Synchronized Channels</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_adding_more_channels_via_pru_1"><a class="link" href="#_adding_more_channels_via_pru_1">5.7. Adding More Channels via PRU 1</a></h3>
<div class="sect3">
<h4 id="_problem_34"><a class="link" href="#_problem_34">Problem</a></h4>
<div class="paragraph">
<p>You need more output channels, or you need to shorten the period.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_34"><a class="link" href="#_solution_34">Solution</a></h4>
<div class="paragraph">
<p>PRU 0 can output up to eight output pins (see
<a href="#blocks_mapping_bits">Mapping bit positions to pin names</a>). The code presented so far
can be easily extended to use the eight output pins.</p>
</div>
<div class="paragraph">
<p>But what if you need more channels?
You can always use PRU1, it has 14 output pins.</p>
</div>
<div class="paragraph">
<p>Or, what if four channels is enough, but you need a shorter period. Everytime
you add a channel, the overall period gets longer.  Twice as many channels
means twice as long a period.  If you move half the channels to PRU 1, you
will make the period half as long.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the code (<code>pwm7.pru0.c</code>)</p>
</div>
<div class="listingblock">
<div class="title">pwm7.pru0.c Using Both PRUs</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">// This code does MAXCH parallel PWM channels on both PRU 0 and PRU 1
// All channels start at the same time. But the PRU 1 ch have a difference period
// It's period is 370ns
#include &lt;stdint.h&gt;
#include &lt;pru_cfg.h&gt;
#include "resource_table_empty.h"

#define PRUNUM 0

#define PRU0_DRAM       0x00000         // Offset to DRAM
// Skip the first 0x200 byte of DRAM since the Makefile allocates
// 0x100 for the STACK and 0x100 for the HEAP.
volatile unsigned int *pru0_dram = (unsigned int *) (PRU0_DRAM + 0x200);

#define MAXCH   2   // Maximum number of channels per PRU

#define update(ch) \
            if(onCount[ch]) {           \
                onCount[ch]--;          \
                Rtmp |= 0x1&lt;&lt;ch;        \
            } else if(offCount[ch]) {   \
                offCount[ch]--;         \
                Rtmp &amp;= ~(0x1&lt;&lt;ch); \
            } else {                    \
                onCount[ch] = pru0_dram[2*ch];  \
                offCount[ch]= pru0_dram[2*ch+1];    \
            }

volatile register uint32_t __R30;
volatile register uint32_t __R31;

void main(void)
{
    uint32_t ch;
    uint32_t on[]  = {1, 2, 3, 4};
    uint32_t off[] = {4, 3, 2, 1};
    uint32_t onCount[MAXCH], offCount[MAXCH];
    register uint32_t Rtmp;

    /* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */
    CT_CFG.SYSCFG_bit.STANDBY_INIT = 0;

#pragma UNROLL(MAXCH)
    for(ch=0; ch&lt;MAXCH; ch++) {
        pru0_dram[2*ch  ] = on [ch+PRUNUM*MAXCH];   // Copy to DRAM0 so the ARM can change it
        pru0_dram[2*ch+1] = off[ch+PRUNUM*MAXCH];   // Interleave the on and off values
        onCount[ch] = on [ch+PRUNUM*MAXCH];
        offCount[ch]= off[ch+PRUNUM*MAXCH];
    }
    Rtmp = __R30;

    while (1) {
        update(0)
        update(1)
        __R30 = Rtmp;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Be sure to run <code>pwm7_setup.sh</code> to get the correct pins configured.</p>
</div>
<div class="listingblock">
<div class="title">pwm7_setup.sh</div>
<div class="content">
<pre>#!/bin/bash
#
export TARGET=pwm7.pru0
echo TARGET=$TARGET

# Configure the PRU pins based on which Beagle is running
machine=$(awk '{print $NF}' /proc/device-tree/model)
echo -n $machine
if [ $machine = "Black" ]; then
    echo " Found"
    pins="P9_31 P9_29 P8_45 P8_46"
elif [ $machine = "Blue" ]; then
    echo " Found"
    pins=""
elif [ $machine = "PocketBeagle" ]; then
    echo " Found"
    pins="P1_36 P1_33"
else
    echo " Not Found"
    pins=""
fi

for pin in $pins
do
    echo $pin
    config-pin $pin pruout
    config-pin -q $pin
done</pre>
</div>
</div>
<div class="paragraph">
<p>This makes sure the PRU 1 pins are properly configured.</p>
</div>
<div class="paragraph">
<p>Here we have a second <code>pwm7</code> file. <code>pwm7.pru1.c</code> is identical to <code>pwm7.pru0.c</code>
except <code>PRUNUM</code> is set to 1, instead of 0.</p>
</div>
<div class="paragraph">
<p>Compile and run the two files with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>make TARGET=pwm7.pru0; make TARGET=pwm7.pru1</strong>
/var/lib/cloud9/common/Makefile:29: MODEL=TI_AM335x_BeagleBone_Black,TARGET=pwm7.pru0
-    Stopping PRU 0
-   copying firmware file /tmp/cloud9-examples/pwm7.pru0.out to /lib/firmware/am335x-pru0-fw
write_init_pins.sh
-    Starting PRU 0
MODEL   = TI_AM335x_BeagleBone_Black
PROC    = pru
PRUN    = 0
PRU_DIR = /sys/class/remoteproc/remoteproc1
/var/lib/cloud9/common/Makefile:29: MODEL=TI_AM335x_BeagleBone_Black,TARGET=pwm7.pru1
-    Stopping PRU 1
-   copying firmware file /tmp/cloud9-examples/pwm7.pru1.out to /lib/firmware/am335x-pru1-fw
write_init_pins.sh
-    Starting PRU 1
MODEL   = TI_AM335x_BeagleBone_Black
PROC    = pru
PRUN    = 1
PRU_DIR = /sys/class/remoteproc/remoteproc2</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will first stop, compile and start PRU 0, then do the same for PRU 1.</p>
</div>
<div class="paragraph">
<p>Moving half of the channels to PRU1 dropped the period from 510ns to 370ns, so
we gained a bit.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_19"><a class="link" href="#_discussion_19">Discussion</a></h4>
<div class="paragraph">
<p>There weren&#8217;t many changes to be made.  Line 15 we set MAXCH to 2. Lines 44-48
is where the big change is.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">        pru0_dram[2*ch  ] = on [ch+PRUNUN*MAXCH];   // Copy to DRAM0 so the ARM can change it
        pru0_dram[2*ch+1] = off[ch+PRUNUN*MAXCH];   // Interleave the on and off values
        onCount[ch] = on [ch+PRUNUN*MAXCH];
        offCount[ch]= off[ch+PRUNUN*MAXCH];</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we are compiling for PRU 0, <code>on[ch+PRUNUN*MAXCH]</code> becomes <code>on[ch+0*2]</code> which is
<code>on[ch]</code> which is what we had before.  But now if we are on PRU 1 it becomes
<code>on[ch+1*2]</code> which is <code>on[ch+2]</code>.  That means we are picking up the second
half of the <code>on</code> and <code>off</code> arrays.  The first half goes to PRU 0, the second to
PRU 1.  So the same code can be used for both PRUs, but we get slightly different
behavior.</p>
</div>
<div class="paragraph">
<p>Running the code you will see the next figure.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./05blocks/figures/pwm7_two_prus_running.png" alt="pwm7.pru0 Two PRUs running">
</div>
<div class="title">Figure 36. pwm7.pru0 Two PRUs running</div>
</div>
<div class="paragraph">
<p>What&#8217;s going on there, the first channels look fine, but the PRU 1 channels
are blurred.  To see what&#8217;s happening, let&#8217;s stop the oscilloscope.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./05blocks/figures/pwm7_two_prus_stopped.png" alt="pwm7 Two PRUs stopped">
</div>
<div class="title">Figure 37. pwm7.pru0 Two PRUs stopped</div>
</div>
<div class="paragraph">
<p>The stopped display shows that the four channels are doing what we wanted, except
The PRU 0 channels have a period of 370ns while the PRU 1 channels at 330ns.
It appears the compiler has optimied the two PRUs slightly differenty.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sychronziing_two_prus"><a class="link" href="#_sychronziing_two_prus">5.8. Sychronziing Two PRUs</a></h3>
<div class="sect3">
<h4 id="_problem_35"><a class="link" href="#_problem_35">Problem</a></h4>
<div class="paragraph">
<p>I need to synchronize the two PRUs so they run together.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_35"><a class="link" href="#_solution_35">Solution</a></h4>
<div class="paragraph">
<p>Use the Interrupt Controller (INTC).  It allows one PRU to signal the other.
Page 225 of the
<a href="https://www.ti.com/lit/ug/spruh73p/spruh73p.pdf">AM335x Technical Reference Manual</a>
has details of how it works.  Here&#8217;s the code for PRU 0, which at the end of the
<code>while</code> loop signals PRU 1 to start(<code>pwm8.pru0.c</code>).</p>
</div>
<div class="listingblock">
<div class="title">pwm8.pru0.c PRU 0 using INTC to send a signal to PRU 1</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">// This code does MAXCH parallel PWM channels on both PRU 0 and PRU 1
// All channels start at the same time.
// It's period is 430ns
#include &lt;stdint.h&gt;
#include &lt;pru_cfg.h&gt;
#include &lt;pru_intc.h&gt;
#include &lt;pru_ctrl.h&gt;
#include "resource_table_empty.h"

#define PRUNUM 0

#define PRU0_DRAM       0x00000         // Offset to DRAM
// Skip the first 0x200 byte of DRAM since the Makefile allocates
// 0x100 for the STACK and 0x100 for the HEAP.
volatile unsigned int *pru0_dram = (unsigned int *) (PRU0_DRAM + 0x200);

#define MAXCH   2   // Maximum number of channels per PRU

#define update(ch) \
            if(onCount[ch]) {           \
                onCount[ch]--;          \
                Rtmp |= 0x1&lt;&lt;ch;        \
            } else if(offCount[ch]) {   \
                offCount[ch]--;         \
                Rtmp &amp;= ~(0x1&lt;&lt;ch); \
            } else {                    \
                onCount[ch] = pru0_dram[2*ch];  \
                offCount[ch]= pru0_dram[2*ch+1];    \
            }

volatile register uint32_t __R30;
volatile register uint32_t __R31;

// Initialize interupts so the PRUs can be syncronized.
// PRU1 is started first and then waits for PRU0
// PRU0 is then started and tells PRU1 when to start going
void configIntc(void) {
    __R31 = 0x00000000;                 // Clear any pending PRU-generated events
    CT_INTC.CMR4_bit.CH_MAP_16 = 1;     // Map event 16 to channel 1
    CT_INTC.HMR0_bit.HINT_MAP_1 = 1;    // Map channel 1 to host 1
    CT_INTC.SICR = 16;                  // Ensure event 16 is cleared
    CT_INTC.EISR = 16;                  // Enable event 16
    CT_INTC.HIEISR |= (1 &lt;&lt; 0);         // Enable Host interrupt 1
    CT_INTC.GER = 1;                    // Globally enable host interrupts
}

void main(void)
{
    uint32_t ch;
    uint32_t on[]  = {1, 2, 3, 4};
    uint32_t off[] = {4, 3, 2, 1};
    uint32_t onCount[MAXCH], offCount[MAXCH];
    register uint32_t Rtmp;

    CT_CFG.GPCFG0 = 0x0000;             // Configure GPI and GPO as Mode 0 (Direct Connect)
    configIntc();                       // Configure INTC

    /* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */
    CT_CFG.SYSCFG_bit.STANDBY_INIT = 0;

#pragma UNROLL(MAXCH)
    for(ch=0; ch&lt;MAXCH; ch++) {
        pru0_dram[2*ch  ] = on [ch+PRUNUM*MAXCH];   // Copy to DRAM0 so the ARM can change it
        pru0_dram[2*ch+1] = off[ch+PRUNUM*MAXCH];   // Interleave the on and off values
        onCount[ch] = on [ch+PRUNUM*MAXCH];
        offCount[ch]= off[ch+PRUNUM*MAXCH];
    }
    Rtmp = __R30;

    while (1) {
        __R30 = Rtmp;
        update(0)
        update(1)
#define PRU0_PRU1_EVT 16
        __R31 = (PRU0_PRU1_EVT-16) | (0x1&lt;&lt;5);  //Tell PRU 1 to start
        __delay_cycles(1);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>PRU 2&#8217;s code waits for PRU 0 before going.</p>
</div>
<div class="listingblock">
<div class="title">pwm8.pru1.c PRU 1 waiting for INTC from PRU 0</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">// This code does MAXCH parallel PWM channels on both PRU 0 and PRU 1
// All channels start at the same time.
// It's period is 430ns
#include &lt;stdint.h&gt;
#include &lt;pru_cfg.h&gt;
#include &lt;pru_intc.h&gt;
#include &lt;pru_ctrl.h&gt;
#include "resource_table_empty.h"

#define PRUNUM 1

#define PRU0_DRAM       0x00000         // Offset to DRAM
// Skip the first 0x200 byte of DRAM since the Makefile allocates
// 0x100 for the STACK and 0x100 for the HEAP.
volatile unsigned int *pru0_dram = (unsigned int *) (PRU0_DRAM + 0x200);

#define MAXCH   2   // Maximum number of channels per PRU

#define update(ch) \
            if(onCount[ch]) {           \
                onCount[ch]--;          \
                Rtmp |= 0x1&lt;&lt;ch;        \
            } else if(offCount[ch]) {   \
                offCount[ch]--;         \
                Rtmp &amp;= ~(0x1&lt;&lt;ch); \
            } else {                    \
                onCount[ch] = pru0_dram[2*ch];  \
                offCount[ch]= pru0_dram[2*ch+1];    \
            }

volatile register uint32_t __R30;
volatile register uint32_t __R31;

// Initialize interupts so the PRUs can be syncronized.
// PRU1 is started first and then waits for PRU0
// PRU0 is then started and tells PRU1 when to start going

void main(void)
{
    uint32_t ch;
    uint32_t on[]  = {1, 2, 3, 4};
    uint32_t off[] = {4, 3, 2, 1};
    uint32_t onCount[MAXCH], offCount[MAXCH];
    register uint32_t Rtmp;

    /* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */
    CT_CFG.SYSCFG_bit.STANDBY_INIT = 0;

#pragma UNROLL(MAXCH)
    for(ch=0; ch&lt;MAXCH; ch++) {
        pru0_dram[2*ch  ] = on [ch+PRUNUM*MAXCH];   // Copy to DRAM0 so the ARM can change it
        pru0_dram[2*ch+1] = off[ch+PRUNUM*MAXCH];   // Interleave the on and off values
        onCount[ch] = on [ch+PRUNUM*MAXCH];
        offCount[ch]= off[ch+PRUNUM*MAXCH];
    }
    Rtmp = __R30;

    while (1) {
        while((__R31 &amp; (0x1&lt;&lt;31))==0) {     // Wait for PRU 0
        }
        CT_INTC.SICR = 16;                  // Clear event 16
        __R30 = Rtmp;
        update(0)
        update(1)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In <code>pwm8.pru0.c</code> PRU 1 waits for a signal from PRU 0, so be sure to start PRU 1 first.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>make TARGET=pwm8.pru0; make TARGET=pwm8.pru1</strong></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_20"><a class="link" href="#_discussion_20">Discussion</a></h4>
<div class="paragraph">
<p>The figure below shows the two PRUs are synchronized, though there is some extra
overhead in the process so the period is longer.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./05blocks/figures/pwm8_prus_sycned.png" alt="pwm8.pru0 PRUs sycned">
</div>
<div class="title">Figure 38. pwm8.pru0 PRUs sycned</div>
</div>
<div class="paragraph">
<p>This isn&#8217;t much different from the previous examples.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 12. pwm8.pru0.c changes from pwm7.pru0.c</caption>
<colgroup>
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 81.8182%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">PRU</th>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Change</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">37-45</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For PRU 0 these define <code>configInitc()</code> which initializes the interupts.
See page 226 of the
<a href="https://www.ti.com/lit/ug/spruh73p/spruh73p.pdf">AM335x Technical Reference Manual</a>
for a diagram explaining events, channels, hosts, etc.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">55-56</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set a configuration register and call <code>configInitc</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">59-61</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PRU 1 then waits for PRU 0 to signal it.  Bit 31 of <code>__R31</code> corresponds
to the Host-1 channel which <code>configInitc()</code> set up. We also clear event 16 so
PRU 0 can set it again.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">74-75</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">On PRU 0 this generates the interupt to send to PRU 1.  I found PRU 1 was
slow to respond to the interupt, so I put this code at the end of the loop to
give time for the signal to get to PRU 1.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>This ends the multipart pwm example.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_reading_an_input_at_regular_intervals"><a class="link" href="#_reading_an_input_at_regular_intervals">5.9. Reading an Input at Regular Intervals</a></h3>
<div class="sect3">
<h4 id="_problem_36"><a class="link" href="#_problem_36">Problem</a></h4>
<div class="paragraph">
<p>You have an input pin that needs to be read at regular intervals.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_36"><a class="link" href="#_solution_36">Solution</a></h4>
<div class="paragraph">
<p>You can use the <code>__R31</code> register to read an input pin. Let&#8217;s use the following
pins.</p>
</div>
<table id="blocks_io_pins" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 13. Input/Output pins</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Direction</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bit number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Black</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AI (ICSS2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pocket</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">out</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_31</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_44</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.36</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">in</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_25</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_36</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.29</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>These values came from <a href="#blocks_mapping_bits">Mapping bit positions to pin names</a>.</p>
</div>
<div class="paragraph">
<p>Configure the pins with <code>input_setup.sh</code>.</p>
</div>
<div class="listingblock">
<div class="title">input_setup.sh</div>
<div class="content">
<pre class="highlight"><code class="language-linenums" data-lang="linenums">#!/bin/bash
#
export TARGET=input.pru0
echo TARGET=$TARGET

# Configure the PRU pins based on which Beagle is running
machine=$(awk '{print $NF}' /proc/device-tree/model)
echo -n $machine
if [ $machine = "Black" ]; then
    echo " Found"
    config-pin P9_31 pruout
    config-pin -q P9_31
    config-pin P9_25 pruin
    config-pin -q P9_25
elif [ $machine = "Blue" ]; then
    echo " Found"
    pins=""
elif [ $machine = "PocketBeagle" ]; then
    echo " Found"
    config-pin P1_36 pruout
    config-pin -q P1_36
    config-pin P1_29 pruin
    config-pin -q P1_29
else
    echo " Not Found"
    pins=""
fi</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following code reads the input pin and writes its value to the output pin.</p>
</div>
<div class="listingblock">
<div class="title">input.c</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">#include &lt;stdint.h&gt;
#include &lt;pru_cfg.h&gt;
#include "resource_table_empty.h"

volatile register uint32_t __R30;
volatile register uint32_t __R31;

void main(void)
{
    uint32_t led;
    uint32_t sw;

    /* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */
    CT_CFG.SYSCFG_bit.STANDBY_INIT = 0;

    led = 0x1&lt;&lt;0;   // P9_31 or P1_36
    sw  = 0x1&lt;&lt;7;   // P9_25 or P1_29

    while (1) {
        if((__R31&amp;sw) == sw) {
            __R30 |= led;       // Turn on LED
        } else
            __R30 &amp;= ~led;      // Turn off LED
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_21"><a class="link" href="#_discussion_21">Discussion</a></h4>
<div class="paragraph">
<p>Just remember that <code>__R30</code> is for outputs and <code>__R31</code> is
for inputs.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_analog_wave_generator"><a class="link" href="#_analog_wave_generator">5.10. Analog Wave Generator</a></h3>
<div class="sect3">
<h4 id="_problem_37"><a class="link" href="#_problem_37">Problem</a></h4>
<div class="paragraph">
<p>I want to generate an analog output, but only have GPIO pins.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_37"><a class="link" href="#_solution_37">Solution</a></h4>
<div class="paragraph">
<p>The Beagle doesn&#8217;t have a built-in  analog to digital converter. You could
get a <a href="https://www.amazon.com/external-Adapter-Windows-Microphone-SD-CM-UAUD/dp/B001MSS6CS/0&amp;keywords=audio+dongle">USB Audio Dongle</a> which are under $10.  But here
we&#8217;ll take another approach.</p>
</div>
<div class="paragraph">
<p>Earlier we generated a PWM signal.  Here we&#8217;ll generate a PWM whose duty cycle
changes with time.  A small duty cycle for when the output signal is small and
a large dudty cycle for when it is large.</p>
</div>
<div class="paragraph">
<p>This example was inspired by
<a href="https://github.com/derekmolloy/exploringBB/tree/master/chp13/sineWave">A PRU Sin Wave Generator</a>
in chapter 13 of
<a href="http://exploringbeaglebone.com/">Exploring BeagleBone by Derek Molloy</a>.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the code.</p>
</div>
<div class="listingblock">
<div class="title">sine.pru0.c</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">// Generate an analog waveform and use a filter to reconstruct it.
#include &lt;stdint.h&gt;
#include &lt;pru_cfg.h&gt;
#include "resource_table_empty.h"
#include &lt;math.h&gt;

#define MAXT    100 // Maximum number of time samples
#define SAWTOOTH    // Pick which waveform

volatile register uint32_t <em>R30;
volatile register uint32_t </em>R31;

void main(void)
{
    uint32_t onCount;       // Current count for 1 out
    uint32_t offCount;      // count for 0 out
    uint32_t i;
    uint32_t waveform[MAXT]; // Waveform to be produced

    // Generate a periodic wave in an array of MAXT values
#ifdef SAWTOOTH
    for(i=0; i&lt;MAXT; i++) {
        waveform[i] = i*100/MAXT;
    }
#endif
#ifdef TRIANGLE
    for(i=0; i&lt;MAXT/2; i++) {
        waveform[i]        = 2*i*100/MAXT;
        waveform[MAXT-i-1] = 2*i*100/MAXT;
    }
#endif
#ifdef SINE
    float gain = 50.0f;
    float bias = 50.0f;
    float freq = 2.0f * 3.14159f / MAXT;
    for (i=0; i&lt;MAXT; i++){
        waveform[i] = (uint32_t)(bias+gain*sin(i*freq));
    }
#endif

    /* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */
    CT_CFG.SYSCFG_bit.STANDBY_INIT = 0;

    while (1) {
        // Generate a PWM signal whose duty cycle matches
        // the amplitude of the signal.
        for(i=0; i&lt;MAXT; i++) {
            onCount = waveform[i];
            offCount = 100 - onCount;
            while(onCount--) {
                <em>R30 |= 0x1;       // Set the GPIO pin to 1
            }
            while(offCount--) {
                </em>R30 &amp;= ~(0x1);    // Clear the GPIO pin
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Set the <code>#define</code> at line 7 to the number of samples in one cycle of the waveform
and set the <code>#define</code> at line 8 to which waveform and then run <code>make</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_22"><a class="link" href="#_discussion_22">Discussion</a></h4>
<div class="paragraph">
<p>The code has two parts.  The first part (lines 21 to 39) generate the waveform
to be output. The <code>#define</code>s let you select which waveform you want to
generate.  Since the output is a percent duty cycle, the values in <code>waveform[]</code>
must be between 0 and 100 inclusive. The waveform is only generated once, so
this part of the code isn&#8217;t time critical.</p>
</div>
<div class="paragraph">
<p>The second part (lines 44 to 54) uses the generated data to set the
duty cycle of the PWM on a cycle-by-cycle basis. This part is time critical;
the faster we can output the values, the higher the frequency of the output
signal.</p>
</div>
<div class="paragraph">
<p>Suppose you want to generate a sawtooth waveform like the one shown in <a href="#blocks_sawtooth">Continuous Sawtooth Waveform</a>.</p>
</div>
<div id="blocks_sawtooth" class="imageblock">
<div class="content">
<img src="./05blocks/figures/sawtoothsmooth.png" alt="Continuous Sawtooth Waveform">
</div>
<div class="title">Figure 39. Continuous Sawtooth Waveform</div>
</div>
<div class="paragraph">
<p>You need to sample the waveform and store one cycle. <a href="#blocks_sawtoothsampled">Sampled Sawtooth Waveform</a>
shows a sampled version of the sawtooth. You need to generate <code>MAXT</code> samples;
here we show 20 samples, which may be enough. In the code <code>MAXT</code> is set to 100.</p>
</div>
<div id="blocks_sawtoothsampled" class="imageblock">
<div class="content">
<img src="./05blocks/figures/sawtoothsampled.png" alt="Sampled Sawtooth Waveform">
</div>
<div class="title">Figure 40. Sampled Sawtooth Waveform</div>
</div>
<div class="paragraph">
<p>There&#8217;s a lot going on here; let&#8217;s take it line by line.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 14. Line-by-line of sine.pru0.c</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2-5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Standard c-header includes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number for samples in one cycle of the analog waveform</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Which waveform to use.  We&#8217;ve defined SAWTOOTH, TRIANGLE and SINE, but
you can define your own too.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">10-11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declaring registers <code>__R30</code> and <code>__R31</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">15-16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>onCount</code> counts how many cycles the PWM should be 1 and <code>offCount</code> counts
how many it should be off.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">18</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>waveform[]</code> stores the analog waveform being ouput.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">21-24</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SAWTOOTH</code> is the simplest of the waveforms. Each sample is the duty cycle
at that time and must therefore be between 0 and 100.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">26-31</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TRIANGLE</code> is also a simple waveform.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">32-39</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SINE</code> generates a sine wave and also introduces floating point.  Yes, you can use floating point, but the PRUs don&#8217;t have floating point hardware,
rather, it&#8217;s all done in software.  This mean using floating point will make
your code much bigger and slower.  Slower doesn&#8217;t matter in this part, and
bigger isn&#8217;t bigger than our instruction memory, so we&#8217;re OK.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">47</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Here the for loop looks up each value of the generated waveform.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">48,49</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>onCount</code> is the number of cycles to be at 1 and <code>offCount</code> is the number
of cycles to be 0. The two add to 100, one full cycle.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">50-52</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stay on for <code>onCount</code> cycles.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">53-55</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No turn off for <code>offCount</code> cycles, the loop back and look up the next
cycle count.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#blocks_sawunfiltered">Unfiltered Sawtooth Waveform</a> shows the output of the code.</p>
</div>
<div id="blocks_sawunfiltered" class="imageblock">
<div class="content">
<img src="./05blocks/figures/sawunfiltered.png" alt="Unfiltered Sawtooth Waveform">
</div>
<div class="title">Figure 41. Unfiltered Sawtooth Waveform</div>
</div>
<div class="paragraph">
<p>It doesn&#8217;t look like a sawtooth; but if you look at the left side you will
see each cycle has a longer and longer on time.  The duty cycle is increasing.
Once it&#8217;s almost 100% duty cycle, it switches to a very small duty cycle.
Therefore it&#8217;s output what we programmed, but what we want is the average of
the signal.  The left hand side has a large (and increasing) average which
would be for top of the sawtooth.  The right hand side has a small average,
which is what you want for the start of the sawtooth.</p>
</div>
<div class="paragraph">
<p>A simple low-pass filter, built with one resistor and one capacitor will do it.
<a href="#blocks_filterwiring">Low-Pass Filter Wiring Diagram</a> shows how to wire it up.</p>
</div>
<div id="blocks_filterwiring" class="imageblock">
<div class="content">
<img src="./05blocks/figures/filter_bb.png" alt="Low-Pass Filter Wiring Diagram">
</div>
<div class="title">Figure 42. Low-Pass Filter Wiring Diagram</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>I used a 10K&Omega; variable resistor and a 0.022&mu;F capacitor.
Probe the circuit between the resistor and the capacitor and adjust the resistor
until you get a good looking waveform.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="#blocks_sawscope">Reconstructed Sawtooth Waveform</a> shows the results for filtered the SAWTOOTH.</p>
</div>
<div id="blocks_sawscope" class="imageblock">
<div class="content">
<img src="./05blocks/figures/sawscope.png" alt="Reconstructed Sawtooth Waveform">
</div>
<div class="title">Figure 43. Reconstructed Sawtooth Waveform</div>
</div>
<div class="paragraph">
<p>Now that looks more like a sawtooth wave.  The top plot is the time-domain
plot of the output of the low-pass filter. The bottom plot is the FFT of the top
plot, therefore it&#8217;s the frequency domain. We are getting a sawtooth with a
frequency of about 6.1KHz. You can see the fundamental frequency on the
bottom plot along with several harmonics.</p>
</div>
<div class="paragraph">
<p>The top looks like a sawtooth wave,
but there is a high freqnecy superimposed on it.  We are only using a simple
first-order filter.  You could lower the cutoff freqnecy by adjusting the
resistor.  You&#8217;ll see something like <a href="#blocks_lowercutoff">Reconstructed Sawtooth Waveform with Lower Cutoff Frequency</a>.</p>
</div>
<div id="blocks_lowercutoff" class="imageblock">
<div class="content">
<img src="./05blocks/figures/sawlowercutoff.png" alt="Reconstructed Sawtooth Waveform with Lower Cutoff Frequency">
</div>
<div class="title">Figure 44. Reconstructed Sawtooth Waveform with Lower Cutoff Frequency</div>
</div>
<div class="paragraph">
<p>The high freqencies have been reduced, but the corner of the waveform has
been rounded.  You can also adjust the cutoff to a higher frequency and you&#8217;ll
get a sharper corner, but you&#8217;ll also get more high frequencies. See
<a href="#blocks_highercutoff">Reconstructed Sawtooth Waveform with Higher Cutoff Frequency</a></p>
</div>
<div id="blocks_highercutoff" class="imageblock">
<div class="content">
<img src="./05blocks/figures/sawhighercutoff.png" alt="Reconstructed Sawtooth Waveform with Higher Cutoff Frequency">
</div>
<div class="title">Figure 45. Reconstructed Sawtooth Waveform with Higher Cutoff Frequency</div>
</div>
<div class="paragraph">
<p>Adjust to taste, though the real solution is to build a higher order filter.
Search for <em>second order filter</em> and you&#8217;ll find some nice circuits.</p>
</div>
<div class="paragraph">
<p>You can adjust the frequency of the signal by adjesting <code>MAXT</code>.  A smaller
<code>MAXT</code> will give a higher frequency.  I&#8217;m gotten good results with <code>MAXT</code>
as small as 20.</p>
</div>
<div class="paragraph">
<p>You can also get a triangle waveform by setting the <code>#define</code>.
<a href="#blocks_triangle">Reconstructed Triangle Waveform</a> shows the output signal.</p>
</div>
<div id="blocks_triangle" class="imageblock">
<div class="content">
<img src="./05blocks/figures/triangle.png" alt="Reconstructed Triangle Waveform">
</div>
<div class="title">Figure 46. Reconstructed Triangle Waveform</div>
</div>
<div class="paragraph">
<p>And also the sine wave as shown in <a href="#blocks_sine">Reconstructed Sinusoid Waveform</a>.</p>
</div>
<div id="blocks_sine" class="imageblock">
<div class="content">
<img src="./05blocks/figures/sine.png" alt="Reconstructed Sinusoid Waveform">
</div>
<div class="title">Figure 47. Reconstructed Sinusoid Waveform</div>
</div>
<div class="paragraph">
<p>Notice on the bottom plot the harmonics are much more suppressed.</p>
</div>
<div class="paragraph">
<p>Generating the sine waveform uses floats. This requires much more code.
You can look in <code>/tmp/cloud9-examples/sine.pru0.map</code> to see how much memory is being used.
<a href="#blocks_sine_map">/tmp/cloud9-examples/sine.pru0.map for Sine Wave</a> shows the first few lines for the sine wave.</p>
</div>
<div id="blocks_sine_map" class="listingblock">
<div class="title">/tmp/cloud9-examples/sine.pru0.map for Sine Wave</div>
<div class="content">
<pre class="highlight"><code class="language-linenums" data-lang="linenums">******************************************************************************
PRU Linker Unix v2.1.5
******************************************************************************
&gt;&gt; Linked Fri Jun 29 13:58:08 2018

OUTPUT FILE NAME:   &lt;/tmp/pru0-gen/sine1.out&gt;
ENTRY POINT SYMBOL: "_c_int00_noinit_noargs_noexit"  address: 00000000


MEMORY CONFIGURATION

         name            origin    length      used     unused   attr    fill
----------------------  --------  ---------  --------  --------  ----  --------
PAGE 0:
  PRU_IMEM              00000000   00002000  000018c0  00000740  RWIX

PAGE 1:
  PRU_DMEM_0_1          00000000   00002000  00000154  00001eac  RWIX
  PRU_DMEM_1_0          00002000   00002000  00000000  00002000  RWIX

PAGE 2:
  PRU_SHAREDMEM         00010000   00003000  00000000  00003000  RWIX</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice line 19 shows 0x18c0 bytes are being used for instructions.  That&#8217;s 6336
in decimal.</p>
</div>
<div class="paragraph">
<p>Now compile for the sawtooth and you see only 444 byes are used.  Floating-point
requires over 5K more bytes.  Use with care.  If you are short on instruction
space, you can move the table generation to the ARM and just copy the table
to the PRU.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="blocks_ws2812"><a class="link" href="#blocks_ws2812">5.11. WS2812 (NeoPixel) driver</a></h3>
<div class="sect3">
<h4 id="_problem_38"><a class="link" href="#_problem_38">Problem</a></h4>
<div class="paragraph">
<p>




You have an <a href="http://www.adafruit.com/products/1138">Adafruit NeoPixel LED string</a>
or <a href="http://www.adafruit.com/products/1487">Adafruit NeoPixel LED matrix</a>
and want to light it up.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_38"><a class="link" href="#_solution_38">Solution</a></h4>
<div class="paragraph">
<p>NeoPixel is Adafruit&#8217;s name for the WS2812 Intelligent control LED.  Each
NeoPixel contains a Red, Green and Blue LED with a PWM controller that can
dim each one individually making a rainbow of colors possible.  The
NeoPixel is driven by a single serial line.  The timing on the line is very
sensesitive, which make the PRU a perfect candidate for driving it.</p>
</div>
<div class="paragraph">
<p>Wire the input to <code>P9_29</code> and power to 3.3V and ground to ground as shown in
<a href="#blocks_neo_wiring">NeoPixel Wiring</a>.</p>
</div>
<div id="blocks_neo_wiring" class="imageblock">
<div class="content">
<img src="./05blocks/figures/neo_bb.png" alt="NeoPixel Wiring">
</div>
<div class="title">Figure 48. NeoPixel Wiring</div>
</div>
<div class="paragraph">
<p>Test your wiring with the simple code in <a href="#blocks_neo1">neo1.pru0.c - Code to turn all NeoPixels&#8217;s white</a>
which to turns all pixels white.</p>
</div>
<div id="blocks_neo1" class="listingblock">
<div class="title">neo1.pru0.c - Code to turn all NeoPixels&#8217;s white</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">// Control a ws2812 (NeoPixel) display, All on or all off
#include &lt;stdint.h&gt;
#include &lt;pru_cfg.h&gt;
#include "resource_table_empty.h"
#include "prugpio.h"

#define STR_LEN 24
#define oneCyclesOn     700/5   // Stay on 700ns
#define oneCyclesOff    800/5
#define zeroCyclesOn    350/5
#define zeroCyclesOff   600/5
#define resetCycles     60000/5 // Must be at least 50u, use 60u
#define gpio P9_29              // output pin

#define ONE

volatile register uint32_t <em>R30;
volatile register uint32_t </em>R31;

void main(void)
{
    /* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */
    CT_CFG.SYSCFG_bit.STANDBY_INIT = 0;

    uint32_t i;
    for(i=0; i&lt;STR_LEN*3*8; i++) {
#ifdef ONE
        <em>R30 |= gpio;      // Set the GPIO pin to 1
        </em>delay_cycles(oneCyclesOn-1);
        <em>R30 &amp;= ~gpio;     // Clear the GPIO pin
        </em>delay_cycles(oneCyclesOff-2);
#else
        <em>R30 |= gpio;      // Set the GPIO pin to 1
        </em>delay_cycles(zeroCyclesOn-1);
        <em>R30 &amp;= ~gpio;     // Clear the GPIO pin
        </em>delay_cycles(zeroCyclesOff-2);
#endif
    }
    // Send Reset
    <em>R30 &amp;= ~gpio; // Clear the GPIO pin
    </em>delay_cycles(resetCycles);

    __halt();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_23"><a class="link" href="#_discussion_23">Discussion</a></h4>
<div class="paragraph">
<p><a href="#blocks_sequence">NeoPixel bit sequence</a> (taken from  <a href="https://cdn-shop.adafruit.com/datasheets/WS2812.pdf">WS2812 Data Sheet</a>) shows the following waveforms are used to send a bit of data.</p>
</div>
<div id="blocks_sequence" class="imageblock">
<div class="content">
<img src="./05blocks/figures/neo_sequence.png" alt="NeoPixel bit sequence">
</div>
<div class="title">Figure 49. NeoPixel bit sequence</div>
</div>
<div class="paragraph">
<p>Where the times are:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Label</th>
<th class="tableblock halign-left valign-top">Time in ns</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">T0H</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">350</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">T0L</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">800</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">T1H</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">700</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">T1L</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">600</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Treset</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&gt;50,000</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The code in <a href="#blocks_neo1">neo1.pru0.c - Code to turn all NeoPixels&#8217;s white</a> define these times in lines 7-10.
The <code>/5</code> is because
each instruction take 5ns.  Lines 27-30 then set the output to 1 for
the desired time and then to 0 and keeps repeating it for the entire
string length.  <a href="#blocks_zero_scope">NeoPixel zero timing</a>
shows the waveform for sending a 0 value.  Note the times are spot on.</p>
</div>
<div id="blocks_zero_scope" class="imageblock">
<div class="content">
<img src="./05blocks/figures/neo_scope.png" alt="neo scope">
</div>
<div class="title">Figure 50. NeoPixel zero timing</div>
</div>
<div class="paragraph">
<p>Each NeoPixel listens for a RGB value. Once a value has arrived all other values
that follow are passed on to the next NeoPixel which does the same thing.
That way you can individually control all of the NeoPixels.</p>
</div>
<div class="paragraph">
<p>Lines 38-40 send out a reset pulse.  If a NeoPixel sees a reset pulse it will
grab the next value for itself and start over again.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_setting_neopixels_to_different_colors"><a class="link" href="#_setting_neopixels_to_different_colors">5.12. Setting NeoPixels to Different Colors</a></h3>
<div class="sect3">
<h4 id="_problem_39"><a class="link" href="#_problem_39">Problem</a></h4>
<div class="paragraph">
<p>I want to set the LEDs to different colors.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_39"><a class="link" href="#_solution_39">Solution</a></h4>
<div class="paragraph">
<p>Wire your NeoPixels as shown in <a href="#blocks_neo_wiring">NeoPixel Wiring</a> then run the code in
<a href="#blocks_neo2">neo2.pru0.c - Code to turn on green, red, blue</a>.</p>
</div>
<div id="blocks_neo2" class="listingblock">
<div class="title">neo2.pru0.c - Code to turn on green, red, blue</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">// Control a ws2812 (neo pixel) display, green, red, blue, green, ...
#include &lt;stdint.h&gt;
#include &lt;pru_cfg.h&gt;
#include "resource_table_empty.h"
#include "prugpio.h"

#define STR_LEN 3
#define oneCyclesOn     700/5   // Stay on 700ns
#define oneCyclesOff    800/5
#define zeroCyclesOn    350/5
#define zeroCyclesOff   600/5
#define resetCycles     60000/5 // Must be at least 50u, use 60u
#define gpio P9_29              // output pin

volatile register uint32_t <em>R30;
volatile register uint32_t </em>R31;

void main(void)
{
    /* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */
    CT_CFG.SYSCFG_bit.STANDBY_INIT = 0;

    uint32_t color[STR_LEN] = {0x0f0000, 0x000f00, 0x0000f};    // green, red, blue
    int i, j;

    for(j=0; j&lt;STR_LEN; j++) {
        for(i=23; i&gt;=0; i--) {
            if(color[j] &amp; (0x1&lt;&lt;i)) {
                <em>R30 |= gpio;      // Set the GPIO pin to 1
                </em>delay_cycles(oneCyclesOn-1);
                <em>R30 &amp;= ~gpio;     // Clear the GPIO pin
                </em>delay_cycles(oneCyclesOff-2);
            } else {
                <em>R30 |= gpio;      // Set the GPIO pin to 1
                </em>delay_cycles(zeroCyclesOn-1);
                <em>R30 &amp;= ~gpio;     // Clear the GPIO pin
                </em>delay_cycles(zeroCyclesOff-2);
            }
        }
    }
    // Send Reset
    <em>R30 &amp;= ~gpio; // Clear the GPIO pin
    </em>delay_cycles(resetCycles);

    __halt();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will make the first LED green, the second red and the third blue.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_24"><a class="link" href="#_discussion_24">Discussion</a></h4>
<div class="paragraph">
<p><a href="#blocks_new_data_seq">NeoPixel data sequence</a> shows the sequence of bits used to control the
green, red and blue values.</p>
</div>
<div id="blocks_new_data_seq" class="imageblock">
<div class="content">
<img src="./05blocks/figures/neo_data_seq.png" alt="neo data seq">
</div>
<div class="title">Figure 51. NeoPixel data sequence</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The usual order for colors is RGB (red, green, blue), but the NeoPixels use
GRB (green, red, blue).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="#blocks_neo2_line">Line-by-line for neo2.pru0.c</a> is the line-by-line for <code>neo2.pru0.c</code>.</p>
</div>
<table id="blocks_neo2_line" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 15. Line-by-line for neo2.pru0.c</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">23</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define the string of colors to be output.  Here the ordering of the
bits is the same as <a href="#blocks_new_data_seq">NeoPixel data sequence</a>, GRB.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">26</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Loop for each color to output.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">27</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Loop for each bit in an GRB color.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">28</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the j<sup>th</sup> color and mask off all but the i<sup>th</sup> bit.  <code>(0x1&lt;&lt;i)</code> takes
the value <code>0x1</code> and shifts it left <code>i</code> bits.  When anded (&amp;) with <code>color[j]</code>
it will zero out all but the i<sup>th</sup> bit.  If the result of the operation is
1, the <code>if</code> is done, otherwise the <code>else</code> is done.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">29-32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send a 1.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">34-37</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send a 0.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">42-43</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send a reset pulse once all the colors have been sent.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This will only change the first <code>STR_LEN</code> LEDs.  The LEDs that follow will not
be changed.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_controlling_arbitrary_leds"><a class="link" href="#_controlling_arbitrary_leds">5.13. Controlling Arbitrary LEDs</a></h3>
<div class="sect3">
<h4 id="_problem_40"><a class="link" href="#_problem_40">Problem</a></h4>
<div class="paragraph">
<p>I want to change the 10<sup>th</sup> LED and not have to change the others.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_40"><a class="link" href="#_solution_40">Solution</a></h4>
<div class="paragraph">
<p>You need to keep an array of colors for the whole string in the PRU.  Change
the color of any pixels you want in the array and then send out the whole
string to the LEDs.  <a href="#blocks_neo3">neo3.pru0.c - Code to animate a red pixel running around a ring of blue</a> shows an example animates a red pixel
running around a ring of blue background.  <a href="#blocks_neo3_video">neo3.pru0.c - Simple animation</a> shows
the code in action.</p>
</div>
<div id="blocks_neo3_video" class="videoblock">
<div class="title">neo3.pru0.c - Simple animation</div>
<div class="content">
<video src="./05blocks/figures/ring_around.mp4#t=,4" width="320" controls>
Your browser does not support the video tag.
</video>
</div>
</div>
<div id="blocks_neo3" class="listingblock">
<div class="title">neo3.pru0.c - Code to animate a red pixel running around a ring of blue</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">// Control a ws2812 (neo pixel) display, green, red, blue, green, ...
#include &lt;stdint.h&gt;
#include &lt;pru_cfg.h&gt;
#include "resource_table_empty.h"
#include "prugpio.h"

#define STR_LEN 24
#define oneCyclesOn     700/5   // Stay on 700ns
#define oneCyclesOff    800/5
#define zeroCyclesOn    350/5
#define zeroCyclesOff   600/5
#define resetCycles     60000/5 // Must be at least 50u, use 60u
#define gpio P9_29              // output pin

#define SPEED 20000000/5        // Time to wait between updates

volatile register uint32_t <em>R30;
volatile register uint32_t </em>R31;

void main(void)
{
    uint32_t background = 0x00000f;
    uint32_t foreground = 0x000f00;

    /* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */
    CT_CFG.SYSCFG_bit.STANDBY_INIT = 0;

    uint32_t color[STR_LEN];    // green, red, blue
    int i, j;
    int k, oldk = 0;;
    // Set everything to background
    for(i=0; i&lt;STR_LEN; i++) {
        color[i] = background;
    }

    while(1) {
        // Move forward one position
        for(k=0; k&lt;STR_LEN; k++) {
            color[oldk] = background;
            color[k]    = foreground;
            oldk=k;

            // Output the string
            for(j=0; j&lt;STR_LEN; j++) {
                for(i=23; i&gt;=0; i--) {
                    if(color[j] &amp; (0x1&lt;&lt;i)) {
                        <em>R30 |= gpio;      // Set the GPIO pin to 1
                        </em>delay_cycles(oneCyclesOn-1);
                        <em>R30 &amp;= ~gpio;     // Clear the GPIO pin
                        </em>delay_cycles(oneCyclesOff-2);
                    } else {
                        <em>R30 |= gpio;      // Set the GPIO pin to 1
                        </em>delay_cycles(zeroCyclesOn-1);
                        <em>R30 &amp;= ~gpio;     // Clear the GPIO pin
                        </em>delay_cycles(zeroCyclesOff-2);
                    }
                }
            }
            // Send Reset
            <em>R30 &amp;= ~gpio; // Clear the GPIO pin
            </em>delay_cycles(resetCycles);

            // Wait
            __delay_cycles(SPEED);
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_25"><a class="link" href="#_discussion_25">Discussion</a></h4>
<div class="paragraph">
<p>Here&#8217;s the highlights.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">32,33</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Initiallize the array of colors.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">38-41</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update the array.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">44-58</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send the array to the LEDs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">60-61</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send a reset.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Wait a bit.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_controlling_neopixels_through_a_kernel_driver"><a class="link" href="#_controlling_neopixels_through_a_kernel_driver">5.14. Controlling NeoPixels Through a Kernel Driver</a></h3>
<div class="sect3">
<h4 id="_problem_41"><a class="link" href="#_problem_41">Problem</a></h4>
<div class="paragraph">
<p>You want to control your NeoPixels through a kernel driver so you can control it
through a <code>/dev</code> interface.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_41"><a class="link" href="#_solution_41">Solution</a></h4>
<div class="paragraph">
<p>The <a href="https://github.com/beagleboard/linux/raw/4.9/drivers/rpmsg/rpmsg_pru.c">rpmsg_pru</a>
driver provides a way to pass data between the ARM processor and
the PRUs.  It&#8217;s already included on current images. <a href="#blocks_neo4">neo4.pru0.c - Code to talk to the PRU via rpmsg_pru</a> shows
an example.</p>
</div>
<div id="blocks_neo4" class="listingblock">
<div class="title">neo4.pru0.c - Code to talk to the PRU via rpmsg_pru</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">// Use rpmsg to control the NeoPixels via /dev/rpmsg_pru30
#include &lt;stdint.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;         // atoi
#include &lt;string.h&gt;
#include &lt;pru_cfg.h&gt;
#include &lt;pru_intc.h&gt;
#include &lt;rsc_types.h&gt;
#include &lt;pru_rpmsg.h&gt;
#include "resource_table_0.h"
#include "prugpio.h"

volatile register uint32_t <em>R30;
volatile register uint32_t </em>R31;

/* Host-0 Interrupt sets bit 30 in register R31 <strong>/
#define HOST_INT            ((uint32_t) 1 &lt;&lt; 30)

/</strong> The PRU-ICSS system events used for RPMsg are defined in the Linux device tree
 * PRU0 uses system event 16 (To ARM) and 17 (From ARM)
 * PRU1 uses system event 18 (To ARM) and 19 (From ARM)
 <strong>/
#define TO_ARM_HOST         16
#define FROM_ARM_HOST       17

/</strong>
* Using the name 'rpmsg-pru' will probe the rpmsg_pru driver found
* at linux-x.y.z/drivers/rpmsg/rpmsg_pru.c
<strong>/
#define CHAN_NAME           "rpmsg-pru"
#define CHAN_DESC           "Channel 30"
#define CHAN_PORT           30

/</strong>
 * Used to make sure the Linux drivers are ready for RPMsg communication
 * Found at linux-x.y.z/include/uapi/linux/virtio_config.h
 <strong>/
#define VIRTIO_CONFIG_S_DRIVER_OK   4

char payload[RPMSG_BUF_SIZE];

#define STR_LEN 24
#define oneCyclesOn     700/5   // Stay on for 700ns
#define oneCyclesOff    600/5
#define zeroCyclesOn    350/5
#define zeroCyclesOff   800/5
#define resetCycles     51000/5 // Must be at least 50u, use 51u
#define out P9_29               // Bit number to output on

#define SPEED 20000000/5        // Time to wait between updates

uint32_t color[STR_LEN];    // green, red, blue

/</strong>
 * main.c
 <strong>/
void main(void)
{
    struct pru_rpmsg_transport transport;
    uint16_t src, dst, len;
    volatile uint8_t *status;

    uint8_t r, g, b;
    int i, j;
    // Set everything to background
    for(i=0; i&lt;STR_LEN; i++) {
        color[i] = 0x010000;
    }

    /</strong> Allow OCP master port access by the PRU so the PRU can read external memories <strong>/
    CT_CFG.SYSCFG_bit.STANDBY_INIT = 0;

    /</strong> Clear the status of the PRU-ICSS system event that the ARM will use to 'kick' us <strong>/
#ifdef CHIP_IS_am57xx
    CT_INTC.SICR_bit.STATUS_CLR_INDEX = FROM_ARM_HOST;
#else
    CT_INTC.SICR_bit.STS_CLR_IDX = FROM_ARM_HOST;
#endif

    /</strong> Make sure the Linux drivers are ready for RPMsg communication <strong>/
    status = &amp;resourceTable.rpmsg_vdev.status;
    while (!(*status &amp; VIRTIO_CONFIG_S_DRIVER_OK));

    /</strong> Initialize the RPMsg transport structure <strong>/
    pru_rpmsg_init(&amp;transport, &amp;resourceTable.rpmsg_vring0, &amp;resourceTable.rpmsg_vring1, TO_ARM_HOST, FROM_ARM_HOST);

    /</strong> Create the RPMsg channel between the PRU and ARM user space using the transport structure. <strong>/
    while (pru_rpmsg_channel(RPMSG_NS_CREATE, &amp;transport, CHAN_NAME, CHAN_DESC, CHAN_PORT) != PRU_RPMSG_SUCCESS);
    while (1) {
        /</strong> Check bit 30 of register R31 to see if the ARM has kicked us <strong>/
        if (<em>R31 &amp; HOST_INT) {
            /</strong> Clear the event status <strong>/
#ifdef CHIP_IS_am57xx
            CT_INTC.SICR_bit.STATUS_CLR_INDEX = FROM_ARM_HOST;
#else
            CT_INTC.SICR_bit.STS_CLR_IDX = FROM_ARM_HOST;
#endif
            /</strong> Receive all available messages, multiple messages can be sent per kick */
            while (pru_rpmsg_receive(&amp;transport, &amp;src, &amp;dst, payload, &amp;len) == PRU_RPMSG_SUCCESS) {
                char *ret;  // rest of payload after front character is removed
                int index;  // index of LED to control
                // Input format is:  index red green blue
                index = atoi(payload);
                // Update the array, but don't write it out.
                if((index &gt;=0) &amp; (index &lt; STR_LEN)) {
                    ret = strchr(payload, ' '); // Skip over index
                    r = strtol(&amp;ret[1], NULL, 0);
                    ret = strchr(&amp;ret[1], ' '); // Skip over r, etc.
                    g = strtol(&amp;ret[1], NULL, 0);
                    ret = strchr(&amp;ret[1], ' ');
                    b = strtol(&amp;ret[1], NULL, 0);

                    color[index] = (g&lt;&lt;16)|(r&lt;&lt;8)|b;    // String wants GRB
                }
                // When index is -1, send the array to the LED string
                if(index == -1) {
                    // Output the string
                    for(j=0; j&lt;STR_LEN; j++) {
                        // Cycle through each bit
                        for(i=23; i&gt;=0; i--) {
                            if(color[j] &amp; (0x1&lt;&lt;i)) {
                                </em>R30 |= out;       // Set the GPIO pin to 1
                                <em>delay_cycles(oneCyclesOn-1);
                                </em>R30 &amp;= ~out;  // Clear the GPIO pin
                                <em>delay_cycles(oneCyclesOff-14);
                            } else {
                                </em>R30 |= out;       // Set the GPIO pin to 1
                                <em>delay_cycles(zeroCyclesOn-1);
                                </em>R30 &amp;= ~(out);    // Clear the GPIO pin
                                <em>delay_cycles(zeroCyclesOff-14);
                            }
                        }
                    }
                    // Send Reset
                    </em>R30 &amp;= ~out;  // Clear the GPIO pin
                    <em>delay_cycles(resetCycles);

                    // Wait
                    </em>delay_cycles(SPEED);
                }

            }
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the code as usual.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">bone$ <strong>make TARGET=neo4.pru0</strong>
/var/lib/cloud9/common/Makefile:29: MODEL=TI_AM335x_BeagleBone_Black,TARGET=neo4.pru0
-    Stopping PRU 0
-   copying firmware file /tmp/cloud9-examples/neo4.pru0.out to /lib/firmware/am335x-pru0-fw
write_init_pins.sh
-    Starting PRU 0
MODEL   = TI_AM335x_BeagleBone_Black
PROC    = pru
PRUN    = 0
PRU_DIR = /sys/class/remoteproc/remoteproc1</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>/dev/rpmsg_pru30</code> is a device driver that lets the ARM talk to the PRU.
The first <code>echo</code> says to set the 0<sup>th</sup> LED to RGB value 0xff 0 127. (Note: you can
mix hex and decimal.) The second <code>echo</code> tells the driver to send the data to the
LEDs.  You 0<sup>th</sup> LED should now be lit.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_26"><a class="link" href="#_discussion_26">Discussion</a></h4>
<div class="paragraph">
<p>There&#8217;s a lot here.  I&#8217;ll just hit some of the highlights in <a href="#blocks_neo4_lines">Line-by-line for neo4.pru0.c</a>.</p>
</div>
<table id="blocks_neo4_lines" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 16. Line-by-line for neo4.pru0.c</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">30</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>CHAN_NAME</code> of <code>rpmsg-pru</code> matches that <code>prmsg_pru</code> driver that is
is already installed.  This connects this PRU to the driver.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>CHAN_PORT</code> tells it to use port 30.  That&#8217;s why we use
<code>/dev/rpmsg_pru30</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">40</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payload[]</code> is the buffer that receives the data from the ARM.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">42-48</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as the previous NeoPixel examples.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">52</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>color[]</code> is the state to be sent to the LEDs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">66-68</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>color[]</code> is initialized.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">70-85</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Here are a number of details needed to set up the channel between
the PRU and the ARM.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">88</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Here we wait until the ARM sends us some numbers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">99</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Receive all the data from the ARM, store it in <code>payload[]</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">101-111</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The data sent is:  index red green blue.  Pull off the index.  If it&#8217;s
in the right range, pull off the red, green and blue values.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">113</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The NeoPixels want the data in GRB order.  Shift and OR everything
together.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">116-133</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the <code>index</code> = -1, send the contents of <code>color</code> to the LEDs.  This
code is same as before.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can now use programs running on the ARM to send colors to the PRU.
<a href="#blocks_neo-rainbow">neo-rainbow.py - A python program using /dev/rpmsg_pru30</a> shows an example.</p>
</div>
<div id="blocks_neo-rainbow" class="listingblock">
<div class="title">neo-rainbow.py - A python program using /dev/rpmsg_pru30</div>
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">#!/usr/bin/python3
from time import sleep
import math

len = 24
amp = 12
f = 25
shift = 3
phase = 0

# Open a file
fo = open("/dev/rpmsg_pru30", "w", 0)

while True:
    for i in range(0, len):
        r = (amp * (math.sin(2*math.pi*f*(i-phase-0*shift)/len) + 1)) + 1;
        g = (amp * (math.sin(2*math.pi*f*(i-phase-1*shift)/len) + 1)) + 1;
        b = (amp * (math.sin(2*math.pi*f*(i-phase-2*shift)/len) + 1)) + 1;
        fo.write("%d %d %d %d\n" % (i, r, g, b))
        # print("0 0 127 %d" % (i))

    fo.write("-1 0 0 0\n");
    phase = phase + 1
    sleep(0.05)

# Close opened file
fo.close()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Line 19 writes the data to the PRU.  Be sure to have a newline, or space after
the last number, or you numbers will get blurred together.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_rgb_led_matrix_no_integrated_drivers"><a class="link" href="#_rgb_led_matrix_no_integrated_drivers">5.15. RGB LED Matrix - No Integrated Drivers</a></h3>
<div class="sect3">
<h4 id="_problem_42"><a class="link" href="#_problem_42">Problem</a></h4>
<div class="paragraph">
<p>You have a RGB LED matrix
(<a href="../01case/case.html.html#case_rgb_matrix">1.4. RGB LED Matrix - No Integrated Drivers</a>) and want to know
at a low level how the PRU works.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_42"><a class="link" href="#_solution_42">Solution</a></h4>
<div class="paragraph">
<p>Here is the
<a href="https://cdn-shop.adafruit.com/product-files/2277/MI-T35P5RGBE-AE.pdf">datasheet</a>,
but the best description I&#8217;ve found for the RGB Matrix is from
<a href="https://www.adafruit.com/">Adafruit</a>.  I&#8217;ve reproduced it here, with
adjustments for the 64x32 matrix we are using.</p>
</div>
<div class="verseblock">
<pre class="content">There&#8217;s zero documention out there on how these matrices work, and no public datasheets or spec sheets so we are going to try to document how they work.

First thing to notice is that there are 2048 RGB LEDs in a 64x32 matrix. Like pretty much every matrix out there, you can&#8217;t drive all 2048 at once. One reason is that would require a lot of current, another reason is that it would be really expensive to have so many pins. Instead, the matrix is divided into 16 interleaved sections/strips. The first section is the 1<sup>st</sup> 'line' and the 17<sup>th</sup> 'line' (64 x 2 RGB LEDs = 128 RGB LEDs), the second is the 2<sup>nd</sup> and 18<sup>th</sup> line, etc until the last section which is the 16<sup>th</sup> and 32<sup>nd</sup> line. You might be asking, why are the lines paired this way? wouldn&#8217;t it be nicer to have the first section be the 1<sup>st</sup> and 2<sup>nd</sup> line, then 3<sup>rd</sup> and 4<sup>th</sup>, until the 15<sup>th</sup> and 16<sup>th</sup>? The reason they do it this way is so that the lines are interleaved and look better when refreshed, otherwise we&#8217;d see the stripes more clearly.

So, on the PCB is 24 LED driver chips. These are like 74HC595s but they have 16 outputs and they are constant current. 16 outputs * 24 chips = 384 LEDs that can be controlled at once, and 128 * 3 (R G and B) = 384. So now the design comes together: You have 384 outputs that can control one line at a time, with each of 384 R, G and B LEDs either on or off. The controller (say an FPGA or microcontroller) selects which section to currently draw (using LA, LB, LC and LD address pins - 4 bits can have 16 values). Once the address is set, the controller clocks out 384 bits of data (48 bytes) and latches it. Then it increments the address and clocks out another 384 bits, etc until it gets to address #15, then it sets the address back to #0</pre>
<div class="attribution">
&#8212; https://cdn-learn.adafruit.com/downloads/pdf/32x16-32x32-rgb-led-matrix.pdf
</div>
</div>
<div class="paragraph">
<p>That gives a good overview, but there are a few details missing.
<a href="#blocks_rgb_python">Python code for driving RGB LED matrix</a> is a functioning python program that gives a nice
high-level view of how to drive the display.</p>
</div>
<div id="blocks_rgb_python" class="listingblock">
<div class="title">Python code for driving RGB LED matrix</div>
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">#!/usr/bin/env python3
import Adafruit_BBIO.GPIO as GPIO

# Define which functions are connect to which pins
OE="P1_29"      # Output Enable, active low
LAT="P1_36"     # Latch, toggle after clocking in a row of pixels
CLK="P1_33"     # Clock, toggle after each pixel

# Input data pins
R1="P2_10"  # R1, G1, B1 are for the top rows (1-16) of pixels
G1="P2_8"
B1="P2_6"

R2="P2_4"   # R2, G2, B2 are for the bottom rows (17-32) of pixels
G2="P2_2"
B2="P2_1"

LA="P2_32"  # Address lines for which row (1-16 or 17-32) to update
LB="P2_30"
LC="P1_31"
LD="P2_34"

# Set everything as output ports
GPIO.setup(OE,  GPIO.OUT)
GPIO.setup(LAT, GPIO.OUT)
GPIO.setup(CLK, GPIO.OUT)

GPIO.setup(R1, GPIO.OUT)
GPIO.setup(G1, GPIO.OUT)
GPIO.setup(B1, GPIO.OUT)
GPIO.setup(R2, GPIO.OUT)
GPIO.setup(G2, GPIO.OUT)
GPIO.setup(B2, GPIO.OUT)

GPIO.setup(LA, GPIO.OUT)
GPIO.setup(LB, GPIO.OUT)
GPIO.setup(LC, GPIO.OUT)
GPIO.setup(LD, GPIO.OUT)

GPIO.output(OE,  0)     # Enable the display
GPIO.output(LAT, 0)     # Set latch to low

while True:
    for bank in range(64):
        GPIO.output(LA, bank&gt;&gt;0&amp;0x1)    # Select rows
        GPIO.output(LB, bank&gt;&gt;1&amp;0x1)
        GPIO.output(LC, bank&gt;&gt;2&amp;0x1)
        GPIO.output(LD, bank&gt;&gt;3&amp;0x1)

        # Shift the colors out.  Here we only have four different
        # colors to keep things simple.
        for i in range(16):
            GPIO.output(R1,  1)     # Top row, white
            GPIO.output(G1,  1)
            GPIO.output(B1,  1)

            GPIO.output(R2,  1)     # Bottom row, red
            GPIO.output(G2,  0)
            GPIO.output(B2,  0)

            GPIO.output(CLK, 0)     # Toggle clock
            GPIO.output(CLK, 1)

            GPIO.output(R1,  0)     # Top row, black
            GPIO.output(G1,  0)
            GPIO.output(B1,  0)

            GPIO.output(R2,  0)     # Bottom row, green
            GPIO.output(G2,  1)
            GPIO.output(B2,  0)

            GPIO.output(CLK, 0)     # Toggle clock
            GPIO.output(CLK, 1)

        GPIO.output(OE,  1)     # Disable display while updating
        GPIO.output(LAT, 1)     # Toggle latch
        GPIO.output(LAT, 0)
        GPIO.output(OE,  0)     # Enable display</code></pre>
</div>
</div>
<div class="paragraph">
<p>Be sure to run the <a href="#blocks_rgb_setup">rgb_python_setup.sh</a> script before running the python code.</p>
</div>
<div id="blocks_rgb_setup" class="listingblock">
<div class="title">rgb_python_setup.sh</div>
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">#!/bin/bash
# Setup for 64x32 RGB Matrix
export TARGET=rgb1.pru0
echo TARGET=$TARGET

# Configure the PRU pins based on which Beagle is running
machine=$(awk '{print $NF}' /proc/device-tree/model)
echo -n $machine
if [ $machine = "Black" ]; then
    echo " Found"
    pins=""
elif [ $machine = "Blue" ]; then
    echo " Found"
    pins=""
elif [ $machine = "PocketBeagle" ]; then
    echo " Found"
    prupins="P2_32 P1_31 P1_33 P1_29 P2_30 P2_34 P1_36"
    gpiopins="P2_10 P2_06 P2_04 P2_01 P2_08 P2_02"
    # Uncomment for J2
    # gpiopins="$gpiopins P2_27 P2_25 P2_05 P2_24 P2_22 P2_18"
else
    echo " Not Found"
    pins=""
fi

for pin in $prupins
do
    echo $pin
    # config-pin $pin pruout
    config-pin $pin gpio
    config-pin $pin out
    config-pin -q $pin
done

for pin in $gpiopins
do
    echo $pin
    config-pin $pin gpio
    config-pin $pin out
    config-pin -q $pin
done</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure line 29 is commented out and line 30 is uncommented.
Later we&#8217;ll configure for <em>pruout</em>, but for now the python code doesn&#8217;t use
the PRU outs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    # config-pin $pin pruout
    config-pin $pin out</code></pre>
</div>
</div>
<div class="paragraph">
<p>Your display should look like <a href="#blocks_rgb_python_jpg">Display running rgb_python.py</a>.</p>
</div>
<div id="blocks_rgb_python_jpg" class="imageblock">
<div class="content">
<img src="./05blocks/figures/rgb_python.jpg" alt="Display running rgb_python.py">
</div>
<div class="title">Figure 52. Display running rgb_python.py</div>
</div>
<div class="paragraph">
<p>So why do only two lines appear at a time?  That&#8217;s how the display works.
Currently lines 6 and 22 are showing, then a moment later 7 and 23 show, etc.
The display can only display two lines at a time, so it cycles through all the
lines.  Unfortunately, python is too slow to make the display appear
all at once.  Here&#8217;s where the PRU comes in.</p>
</div>
<div class="paragraph">
<p><a href="#blocks_rgb1">PRU code for driving the RGB LED matrix</a> is the PRU code to drive the RGB LED matrix.   Be sure to run
<code>bone$ source rgb_setup.sh</code> first.</p>
</div>
<div id="blocks_rgb1" class="listingblock">
<div class="title">PRU code for driving the RGB LED matrix</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">// This code drives the RGB LED Matrix on the 1st Connector
#include &lt;stdint.h&gt;
#include &lt;pru_cfg.h&gt;
#include "resource_table_empty.h"
#include "prugpio.h"
#include "rgb_pocket.h"

#define DELAY 10    // Number of cycles (5ns each) to wait after a write

volatile register uint32_t <em>R30;
volatile register uint32_t </em>R31;

void main(void)
{
    // Set up the pointers to each of the GPIO ports
    uint32_t *gpio[] = {
            (uint32_t *) GPIO0,
            (uint32_t *) GPIO1,
            (uint32_t *) GPIO2,
            (uint32_t *) GPIO3
        };

    uint32_t i, row;

    while(1) {
        for(row=0; row&lt;16; row++) {
            // Set the row address
            // Here we take advantage of the select bits (LA,LB,LC,LD)
            // being sequential in the R30 register (bits 2,3,4,5)
            // We shift row over so it lines up with the select bits
            // Oring (|=) with R30 sets bits to 1 and
            // Anding (&amp;=) clears bits to 0, the 0xffc mask makes sure the
            // other bits aren't changed.
            <em>R30 |=  row&lt;&lt;pru_sel0;
            </em>R30 &amp;= (row&lt;&lt;pru_sel0)|0xffc3;

            for(i=0; i&lt;64; i++) {
                // Top row white
                // Combining these to one write works because they are all in
                // the same gpio port
                gpio[r11_gpio][GPIO_SETDATAOUT] = r11_pin | g11_pin | b11_pin;
                <em>delay_cycles(DELAY);;

                // Bottom row red
                gpio[r12_gpio][GPIO_SETDATAOUT]   = r12_pin;
                </em>delay_cycles(DELAY);
                gpio[r12_gpio][GPIO_CLEARDATAOUT] = g12_pin | b12_pin;
                <em>delay_cycles(DELAY);

                </em>R30 |=  pru_clock;    // Toggle clock
                <em>delay_cycles(DELAY);
                </em>R30 &amp;= ~pru_clock;
                <em>delay_cycles(DELAY);

                // Top row black
                gpio[r11_gpio][GPIO_CLEARDATAOUT] = r11_pin | g11_pin | b11_pin;
                </em>delay_cycles(DELAY);

                // Bottom row green
                gpio[r12_gpio][GPIO_CLEARDATAOUT] = r12_pin | b12_pin;
                <em>delay_cycles(DELAY);
                gpio[r12_gpio][GPIO_SETDATAOUT]   = g12_pin;
                </em>delay_cycles(DELAY);

                <em>R30 |=  pru_clock;    // Toggle clock
                </em>delay_cycles(DELAY);
                <em>R30 &amp;= ~pru_clock;
                </em>delay_cycles(DELAY);
            }
            <em>R30 |=  pru_oe;        // Disable display
            </em>delay_cycles(DELAY);
            <em>R30 |=  pru_latch;     // Toggle latch
            </em>delay_cycles(DELAY);
            <em>R30 &amp;= ~pru_latch;
            </em>delay_cycles(DELAY);
            <em>R30 &amp;= ~pru_oe;        // Enable display
            </em>delay_cycles(DELAY);
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The results are shown in <a href="#blocks_rgb_pru">Display running rgb1.c on PRU 0</a>.</p>
</div>
<div id="blocks_rgb_pru" class="imageblock">
<div class="content">
<img src="./05blocks/figures/rgb_pru.jpg" alt="Display running rgb1.pru0.c on PRU 0">
</div>
<div class="title">Figure 53. Display running rgb1.c on PRU 0</div>
</div>
<div class="paragraph">
<p>The PRU is fast enough to quickly write to the display so that it appears
as if all the LEDs are on at once.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_27"><a class="link" href="#_discussion_27">Discussion</a></h4>
<div class="paragraph">
<p>There are a lot of details needed to make this simple display work.  Let&#8217;s
go over some of them.</p>
</div>
<div class="paragraph">
<p>First, the connector looks like <a href="#blocks_matrix_j1">RGB Matrix J1 connector</a>.</p>
</div>
<div id="blocks_matrix_j1" class="imageblock">
<div class="content">
<img src="./05blocks/figures/matrix_j1.jpg" alt="RGB Matrix J1 connector" width="200">
</div>
<div class="title">Figure 54. RGB Matrix J1 connector</div>
</div>
<div class="paragraph">
<p>Notice the labels on the connect match the labels in the code.
<a href="#blocks_pocket_scroller_pins">PocketScroller pin table</a> shows how the pins on the display are
mapped to the pins on the Pocket Beagle.</p>
</div>
<table id="blocks_pocket_scroller_pins" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 17. PocketScroller pin table</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">J1 Connector Pin</th>
<th class="tableblock halign-left valign-top">Pocket Headers</th>
<th class="tableblock halign-left valign-top">gpio port and bit number</th>
<th class="tableblock halign-left valign-top">Linux gpio number</th>
<th class="tableblock halign-left valign-top">PRU R30 bit number</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">R1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2_10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1-20</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">52</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">B1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2_06</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1-25</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">57</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">R2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2_04</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1-26</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">58</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">B2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2_01</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1-18</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">50</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2_32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3-16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">112</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PRU0.2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1_31</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3-18</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">114</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PRU0.4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CLK</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1_33</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3-15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">111</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PRU0.1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1_29</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3-21</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">117</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PRU0.7</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">G1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2_08</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1-28</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">60</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">G2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2_02</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1-27</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">59</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2_30</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3-17</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">113</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PRU0.3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2_34</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3-19</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">115</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PRU0.5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LAT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1_36</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3-14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">110</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PRU0.0</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The J1 mapping to gpio port and bit number comes from
<a href="https://github.com/FalconChristmas/fpp/blob/master/src/pru/PocketScrollerV1.hp" class="bare">https://github.com/FalconChristmas/fpp/blob/master/src/pru/PocketScrollerV1.hp</a>.
The gpio port and bit number mapping to Pocket Headers comes from
<a href="https://docs.google.com/spreadsheets/d/1FRGvYOyW1RiNSEVprvstfJAVeapnASgDXHtxeDOjgqw/edit#gid=0" class="bare">https://docs.google.com/spreadsheets/d/1FRGvYOyW1RiNSEVprvstfJAVeapnASgDXHtxeDOjgqw/edit#gid=0</a>.</p>
</div>
<div class="paragraph">
<p><a href="#blocks_rgb_waveforms">Oscilloscope display of CLK, OE, LAT and R1</a> shows four of the signal waveforms driving the RGB
LED matrix.</p>
</div>
<div id="blocks_rgb_waveforms" class="imageblock">
<div class="content">
<img src="./05blocks/figures/rgb_waveforms.png" alt=".Oscilloscope display of CLK" width="OE" height="LAT and R1">
</div>
<div class="title">Figure 55. Oscilloscope display of CLK, OE, LAT and R1</div>
</div>
<div class="paragraph">
<p>The top waveform is the CLK, the next is OE, followed by LAT and finally R1.
The OE (output enable) is active low, so most of the time the display is visible.
The sequence is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Put data on the R1, G1, B1, R2, G2 and B2 lines</p>
</li>
<li>
<p>Toggle the clock.</p>
</li>
<li>
<p>Repeat the first two steps as one row of data is transfered.  There are
384 LEDs (2 rows of 32 RGB LEDs times 3 LED per RGB), but we are clocking in
six bits (R1, G1, etc.) at a time, so 384/6=64 values need to be clocked in.</p>
</li>
<li>
<p>Once all the values are in, disable the display (OE goes high)</p>
</li>
<li>
<p>Then toggle the latch (LAT) to latch the new data.</p>
</li>
<li>
<p>Turn the display back on.</p>
</li>
<li>
<p>Increment the address lines (LA, LB, LC and LD) to point to the next rows.</p>
</li>
<li>
<p>Keep repeating the above to keep the display lit.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using the PRU we are able to run the clock a about 2.9 MKHz.
<a href="#blocks_rgb_fpp">FPP waveforms</a> shows the optimized assembler code used by FPP clocks in
at some 6.3 MHz.  So the compiler is doing a pretty good job, but you can run
some two times faster if you want to use assembly code.  In fairness to FPP,
it&#8217;s having to pull it&#8217;s data out of RAM to display it, so isn&#8217;t not a good
comparision.</p>
</div>
<div id="blocks_rgb_fpp" class="imageblock">
<div class="content">
<img src="./05blocks/figures/rgb_fpp.png" alt="FPP waveforms">
</div>
<div class="title">Figure 56. FPP waveforms</div>
</div>
<div class="sect4">
<h5 id="_getting_more_colors"><a class="link" href="#_getting_more_colors">Getting More Colors</a></h5>
<div class="paragraph">
<p>The Adafruit description goes on to say:</p>
</div>
<div class="verseblock">
<pre class="content">The only downside of this technique is that despite being very simple and fast, it has no PWM control built-in! The controller can only set the LEDs on or off. So what do you do when you want full color? You actually need to draw the entire matrix over and over again at very high speeds to PWM the matrix manually. For that reason, you need to have a very fast controller (50 MHz is a minimum) if you want to do a lot of colors and motion video and have it look good.</pre>
<div class="attribution">
&#8212; https://cdn-learn.adafruit.com/downloads/pdf/32x16-32x32-rgb-led-matrix.pdf
</div>
</div>
<div class="paragraph">
<p>This is what FPP does, but it&#8217;s beyond the scope of this project.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_compiling_and_inserting_rpmsg_pru"><a class="link" href="#_compiling_and_inserting_rpmsg_pru">5.16. Compiling and Inserting rpmsg_pru</a></h3>
<div class="sect3">
<h4 id="_problem_43"><a class="link" href="#_problem_43">Problem</a></h4>
<div class="paragraph">
<p>Your Beagle doesn&#8217;t have rpmsg_pru.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_43"><a class="link" href="#_solution_43">Solution</a></h4>
<div class="paragraph">
<p>Do the following.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>cd 05blocks/code/module</strong>
bone$ <strong>sudo apt install linux-headers-`uname -r`</strong>
bone$ <strong>wget https://github.com/beagleboard/linux/raw/4.9/drivers/rpmsg/rpmsg_pru.c</strong>
bone$ <strong>make</strong>
make -C /lib/modules/4.9.88-ti-r111/build M=$PWD
make[1]: Entering directory '/usr/src/linux-headers-4.9.88-ti-r111'
  LD      /home/debian/PRUCookbook/docs/05blocks/code/module/built-in.o
  CC [M]  /home/debian/PRUCookbook/docs/05blocks/code/module/rpmsg_client_sample.o
  CC [M]  /home/debian/PRUCookbook/docs/05blocks/code/module/rpmsg_pru.o
  Building modules, stage 2.
  MODPOST 2 modules
  CC      /home/debian/PRUCookbook/docs/05blocks/code/module/rpmsg_client_sample.mod.o
  LD [M]  /home/debian/PRUCookbook/docs/05blocks/code/module/rpmsg_client_sample.ko
  CC      /home/debian/PRUCookbook/docs/05blocks/code/module/rpmsg_pru.mod.o
  LD [M]  /home/debian/PRUCookbook/docs/05blocks/code/module/rpmsg_pru.ko
make[1]: Leaving directory '/usr/src/linux-headers-4.9.88-ti-r111'
bone$ <strong>insmod rpmsg_pru.ko</strong>
bone$ <strong>lsmod | grep rpm</strong>
rpmsg_pru               5799  2
virtio_rpmsg_bus       13620  0
rpmsg_core              8537  2 rpmsg_pru,virtio_rpmsg_bus</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s now installed and ready to go.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_copyright_2"><a class="link" href="#_copyright_2">5.17. Copyright</a></h3>
<div class="listingblock">
<div class="title">copyright.c</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">/*
 * Copyright (C) 2015 Texas Instruments Incorporated - http://www.ti.com/
 *
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 *  * Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 *
 *  * Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the
 *    distribution.
 *
 *  * Neither the name of Texas Instruments Incorporated nor the names of
 *    its contributors may be used to endorse or promote products derived
 *    from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
<div class="paragraph">
<p><a href="../index.html">Outline</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_accessing_more_io"><a class="link" href="#_accessing_more_io">6. Accessing More I/O</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far the examples have shown how to access the GPIO pins on the BeagleBone Black&#8217;s
<code>P9</code> header and through the <code>__R30</code> register.  Below shows how more GPIO pins
can be accessed.</p>
</div>
<div class="paragraph">
<p>The following are resources used in this chapter.</p>
</div>
<div class="ulist">
<div class="title">Resources</div>
<ul>
<li>
<p><a href="https://github.com/derekmolloy/exploringBB/blob/master/chp06/docs/BeagleboneBlackP8HeaderTable.pdf">P8 Header Table</a></p>
</li>
<li>
<p><a href="https://github.com/derekmolloy/exploringBB/blob/master/chp06/docs/BeagleboneBlackP9HeaderTable.pdf">P9 Header Table</a></p>
</li>
<li>
<p><a href="http://www.ti.com/lit/pdf/spruhz6l">AM572x Technical Reference Manual</a> (AI)</p>
</li>
<li>
<p><a href="http://www.ti.com/lit/pdf/spruh73">AM335x Technical Reference Manual</a> (All others)</p>
</li>
<li>
<p><a href="http://www.ti.com/lit/ug/spruhv6a/spruhv6a.pdf">PRU Assembly Language Tools</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_editing_bootuenv_txt_to_access_the_p8_header_on_the_black"><a class="link" href="#_editing_bootuenv_txt_to_access_the_p8_header_on_the_black">6.1. Editing /boot/uEnv.txt to Access the P8 Header on the Black</a></h3>
<div class="sect3">
<h4 id="_problem_44"><a class="link" href="#_problem_44">Problem</a></h4>
<div class="paragraph">
<p>When I try to configure some pins on the <code>P8</code> header of the Black I get an error.</p>
</div>
<div class="listingblock">
<div class="title">config-pin</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">bone$ <strong>config-pin P8_28 pruout</strong>
ERROR: open() for /sys/devices/platform/ocp/ocp:P8_28_pinmux/state failed, No such file or directory</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_solution_44"><a class="link" href="#_solution_44">Solution</a></h4>
<div class="paragraph">
<p>On the images for the BeagleBone Black, the HDMI display driver is enabled by
default and uses many of the <code>P8</code> pins.  If you are not using
HDMI video (or the HDI audio, or even the eMMC) you can disable it by editing
<code>/boot/uEnv.txt</code></p>
</div>
<div class="paragraph">
<p>Open <code>/boot/uEnv.txt</code> and scroll down aways until you see:</p>
</div>
<div class="listingblock">
<div class="title">/boot/uEnv.txt</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">###Disable auto loading of virtual capes (emmc/video/wireless/adc)
#disable_uboot_overlay_emmc=1
disable_uboot_overlay_video=1
#disable_uboot_overlay_audio=1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Uncomment the lines that correspond to the devices you want to disable and
free up their pins.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p><a href="https://github.com/derekmolloy/exploringBB/blob/master/chp06/docs/BeagleboneBlackP8HeaderTable.pdf">P8 Header Table</a>
shows what pins are allocated for what.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Save the file and reboot.  You now have access to the <code>P8</code> pins.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_accessing_gpio"><a class="link" href="#_accessing_gpio">6.2. Accessing gpio</a></h3>
<div class="sect3">
<h4 id="_problem_45"><a class="link" href="#_problem_45">Problem</a></h4>
<div class="paragraph">
<p>I&#8217;ve used up all the GPIO in <code>__R30</code>, where can I get more?</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_45"><a class="link" href="#_solution_45">Solution</a></h4>
<div class="paragraph">
<p>So far we have focused on using PRU 0.
<a href="../05blocks/blocks.html.html#blocks_mapping_bits">Mapping bit positions to pin names
PRU</a> shows
that PRU 0 can access ten GPIO pins on the BeagleBone Black.  If you use
PRU 1 you can get to an additional 14 pins (if they aren&#8217;t in use for other things.)</p>
</div>
<div class="paragraph">
<p>What if you need even more GPIO pins? You can access <em>any</em> GPIO pin by going
through the <strong>o</strong>ne <strong>c</strong>hip <strong>p</strong>eripheral (OCP) port.</p>
</div>
<div class="paragraph">
<div class="title">PRU Integration</div>
<p><span class="image"><img src="./06io/figures/pruIntegration.png" alt="PRU Integration"></span></p>
</div>
<div class="paragraph">
<p>The figure above shows we&#8217;ve been using the <em>Enhanced GPIO</em> interface when using
<code>__R30</code>, but it also shows you can use the OCP.  You get access to many more
GPIO pins, but it&#8217;s a slower access.</p>
</div>
<div class="listingblock">
<div class="title">gpio.pru0.c</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">// This code accesses GPIO without using R30 and R31
#include &lt;stdint.h&gt;
#include &lt;pru_cfg.h&gt;
#include "resource_table_empty.h"
#include "prugpio.h"

#define P9_11   (0x1&lt;&lt;30)           // Bit position tied to P9_11

volatile register uint32_t __R30;
volatile register uint32_t __R31;

void main(void)
{
    uint32_t *gpio0 = (uint32_t *)GPIO0;

    while(1) {
        gpio0[GPIO_SETDATAOUT]   = P9_11;
        __delay_cycles(100000000);
        gpio0[GPIO_CLEARDATAOUT] = P9_11;
        __delay_cycles(100000000);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This code will toggle <code>P9_11</code> on and off. Here&#8217;s the setup file.</p>
</div>
<div class="listingblock">
<div class="title">setup.sh</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">#!/bin/bash

export TARGET=gpio.pru0
echo TARGET=$TARGET

# Configure the PRU pins based on which Beagle is running
machine=$(awk '{print $NF}' /proc/device-tree/model)
echo -n $machine
if [ $machine = "Black" ]; then
    echo " Found"
    pins="P9_11"
elif [ $machine = "Blue" ]; then
    echo " Found"
    pins=""
elif [ $machine = "PocketBeagle" ]; then
    echo " Found"
    pins="P1_36"
else
    echo " Not Found"
    pins=""
fi

for pin in $pins
do
    echo $pin
    config-pin $pin out
    config-pin -q $pin
done</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice in the code <code>config-pin</code> set <code>P9_11</code> to <code>gpio</code>, not <code>pruout</code>. This is because
are are using the OCP interface to the pin, not the usual PRU interface.</p>
</div>
<div class="paragraph">
<p>Set your exports and make.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">bone$ <strong>source setup.sh</strong>
TARGET=gpio.pru0
...
bone$ <strong>make</strong>
/var/lib/cloud9/common/Makefile:29: MODEL=TI_AM335x_BeagleBone_Black,TARGET=gpio.pru0
-    Stopping PRU 0
-   copying firmware file /tmp/cloud9-examples/gpio.pru0.out to /lib/firmware/am335x-pru0-fw
write_init_pins.sh
-    Starting PRU 0
MODEL   = TI_AM335x_BeagleBone_Black
PROC    = pru
PRUN    = 0
PRU_DIR = /sys/class/remoteproc/remoteproc1</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_28"><a class="link" href="#_discussion_28">Discussion</a></h4>
<div class="paragraph">
<p>When you run the code you see <code>P9_11</code> toggling on and off.  Let&#8217;s go through
the code line-by-line to see what&#8217;s happening.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 18. gpio.pru0.c line-by-line</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2-5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Standard includes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The AM335x has four 32-bit GPIO ports.  Lines 55-58 of <code>prugpio.h</code> define the addresses
for each of the ports.  You can find these in Table 2-2 page 180 of the
<a href="https://www.ti.com/lit/ug/spruh73p/spruh73p.pdf">AM335x Technical Reference Manual</a>.
Look up <code>P9_11</code> in the <a href="https://github.com/derekmolloy/exploringBB/blob/master/chp06/docs/BeagleboneBlackP9HeaderTable.pdf">P9 Header Table</a>.
Under the <em>Mode7</em> column you see <code>gpio0[30]</code>.  This means <code>P9_11</code> is bit 30
on GPIO port 0.  Therefore we will use <code>GPIO0</code> in this code.</p>
<p class="tableblock">You can also run
<code>gpioinfo</code> and look for P9_11.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Line 105 of <code>prugpio.h</code> defines the address offset from <code>GIO0</code> that will
allow us to <em>clear</em>
any (or all) bits in GPIO port 0. Other architectures require you to read a port,
then change some bit, then write it out again, three steps.  Here we can do the same by writing to one location, just one step.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Line 106 of <code>prugpio.h</code> is like above, but for <em>setting</em> bits.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Using this offset  of line 107 of <code>prugpio.h</code> lets us just read the bits
without changing them.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This shifts <code>0x1</code> to the 30<sup>th</sup> bit position, which is the one corresponding
to <code>P9_11</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Here we initialize <code>gpio0</code> to point to the start of GPIO port 0&#8217;s control
registers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">17</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>gpio0[GPIO_SETDATAOUT]</code> refers to the <code>SETDATAOUT</code> register of port 0.
Writing to this register turns on the bits where 1&#8217;s are written,
but leaves alone the bits where 0&#8217;s are.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">18</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Wait 100,000,000 cycles, which is 0.5 seconds.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">19</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is line 17, but the output bit is set to 0 where 1&#8217;s are written.</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="_how_fast_can_it_go"><a class="link" href="#_how_fast_can_it_go">How fast can it go?</a></h5>
<div class="paragraph">
<p>This approach to GPIO goes through the slower OCP interface.  If you set <code>__delay_cycles(0)</code> you can see how fast it is.</p>
</div>
<div class="paragraph">
<div class="title">gpio.pru0.c with __delay_cycles(0)</div>
<p><span class="image"><img src="./06io/figures/gpio0delay.png" alt="gpio.pru0.c with __delay_cycles(0)"></span></p>
</div>
<div class="paragraph">
<p>The period is 80ns which is 12.MHz.  That&#8217;s about one forth the speed of the
<code>__R30</code> method, but still not bad.</p>
</div>
<div class="paragraph">
<p>If you are using an oscilloscope, look closely and you&#8217;ll see the following.</p>
</div>
<div class="paragraph">
<div class="title">PWM with jitter</div>
<p><span class="image"><img src="./06io/figures/jitter.png" alt="PWM with jitter"></span></p>
</div>
<div class="paragraph">
<p>The PRU is still as solid as before in it&#8217;s timing, but now it&#8217;s going through
the OCP interface.  This interface is shared with other parts of the system,
therefore the sometimes the PRU must wait for the other parts to finish.
When this happens the pulse width is a bit longer than usual thus adding
jitter to the output.</p>
</div>
<div class="paragraph">
<p>For many applications a few nanoseconds of jitter is unimportant and this
GPIO interface can be used.  If your application needs better timing,
use the <code>__R30</code> interface.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="io_uio"><a class="link" href="#io_uio">6.3. Configuring for UIO Instead of RemoteProc</a></h3>
<div class="sect3">
<h4 id="_problem_46"><a class="link" href="#_problem_46">Problem</a></h4>
<div class="paragraph">
<p>You have some legacy PRU code that uses UIO instead of remoteproc and
you want to switch to UIO.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_46"><a class="link" href="#_solution_46">Solution</a></h4>
<div class="paragraph">
<p>Edit <code>/boot/uEnt.txt</code> and search for <code>uio</code>.  I find</p>
</div>
<div class="listingblock">
<div class="content">
<pre>###pru_uio (4.4.x-ti, 4.9.x-ti, 4.14.x-ti &amp; mainline/bone kernel)
uboot_overlay_pru=/lib/firmware/AM335X-PRU-UIO-00A0.dtbo</pre>
</div>
</div>
<div class="paragraph">
<p>Uncomment the <code>uboot</code> line.  Look for other lines with
<code>uboot_overlay_pru=</code> and be sure they are commented out.</p>
</div>
<div class="paragraph">
<p>Reboot your Bone.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bone$ <strong>sudo reboot</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Check that UIO is running.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bone$ <strong>lsmod | grep uio</strong>
uio_pruss              16384  0
uio_pdrv_genirq        16384  0
uio                    20480  2 uio_pruss,uio_pdrv_genirq</pre>
</div>
</div>
<div class="paragraph">
<p>You are now ready to run the legacy PRU code.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_converting_pasm_assembly_code_to_clpru"><a class="link" href="#_converting_pasm_assembly_code_to_clpru">6.4. Converting pasm Assembly Code to clpru</a></h3>
<div class="sect3">
<h4 id="_problem_47"><a class="link" href="#_problem_47">Problem</a></h4>
<div class="paragraph">
<p>You have some legacy assembly code written in pasm and it won&#8217;t assemble
with clpru.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_47"><a class="link" href="#_solution_47">Solution</a></h4>
<div class="paragraph">
<p>Generally there is a simple mapping from pasm to clpru.
<a href="http://processors.wiki.ti.com/index.php/PRU_Assembly_Instructions#pasm_vs._clpru">pasm vs. clpru</a>
notes what needs to be changed. I have a less complete version on my
<a href="https://elinux.org/EBC_Exercise_30_PRU_porting_pasm_to_clpru">eLinux.org site</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_29"><a class="link" href="#_discussion_29">Discussion</a></h4>
<div class="paragraph">
<p>The clpru assembly can be found in <a href="http://www.ti.com/lit/ug/spruhv6a/spruhv6a.pdf">PRU Assembly Language Tools</a>.</p>
</div>
<div style="page-break-after: always;"></div>
<div class="paragraph">
<p><a href="../index.html">Outline</a></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_more_performance"><a class="link" href="#_more_performance">7. More Performance</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far in all our examples we&#8217;ve been able to meet our timing goals by writing
our code in the C programming language. The C compiler does a suprisingly
good job at generating code, most the time.  However there are times
when very precise timing is needed and the compiler isn&#8217;t doing it.</p>
</div>
<div class="paragraph">
<p>At these times you need to write in assembly language.  This chapter
introduces the PRU assembler and shows how to call assembly code from
C. Detailing on how to program in assembly are beyond the scope of this text.</p>
</div>
<div class="paragraph">
<p>The following are resources used in this chapter.</p>
</div>
<div class="ulist">
<div class="title">Resources</div>
<ul>
<li>
<p><a href="http://www.ti.com/lit/ug/spruhv7b/spruhv7b.pdf">PRU Optimizing C/C++ Compiler, v2.2, User&#8217;s Guide</a></p>
</li>
<li>
<p><a href="http://www.ti.com/lit/ug/spruhv6b/spruhv6b.pdf">PRU Assembly Language Tools User&#8217;s Guide</a></p>
</li>
<li>
<p><a href="http://www.ti.com/lit/ug/spruij2/spruij2.pdf">PRU Assembly Instruction User Guide</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_calling_assembly_from_c"><a class="link" href="#_calling_assembly_from_c">7.1. Calling Assembly from C</a></h3>
<div class="sect3">
<h4 id="_problem_48"><a class="link" href="#_problem_48">Problem</a></h4>
<div class="paragraph">
<p>You have some C code and you want to call an assembly language routine from
it.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_48"><a class="link" href="#_solution_48">Solution</a></h4>
<div class="paragraph">
<p>You need to do two things, write the assembler file and modify the <code>Makefile</code>
to include it. For example, let&#8217;s write our own <code>my_delay_cycles</code> routine in
in assembly.  The intrinsic <code>__delay_cycles</code> must be passed a compile time
constant.  Our new <code>delay_cycles</code> can take a runtime delay value.</p>
</div>
<div class="paragraph">
<p><a href="#more_delay-test">delay-test..pru0.c</a> is much like our other c code, but on line 10 we declare
<code>my_delay_cycles</code> and then on lines 24 and 26 we&#8217;ll call it with an argument
of 1.</p>
</div>
<div id="more_delay-test" class="listingblock">
<div class="title">delay-test..pru0.c</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">// Shows how to call an assembly routine with one parameter
#include &lt;stdint.h&gt;
#include &lt;pru_cfg.h&gt;
#include "resource_table_empty.h"
#include "prugpio.h"

// The function is defined in delay.asm in same dir
// We just need to add a declaration here, the defination can be
// seperately linked
extern void my_delay_cycles(uint32_t);

volatile register uint32_t <em>R30;
volatile register uint32_t </em>R31;

void main(void)
{
    uint32_t gpio = P9_31;  // Select which pin to toggle.;

    /* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */
    CT_CFG.SYSCFG_bit.STANDBY_INIT = 0;

    while(1) {
        <em>R30 |= gpio;      // Set the GPIO pin to 1
        my_delay_cycles(1);
        </em>R30 &amp;= ~gpio;     // Clear the GPIO pin
        my_delay_cycles(1);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#more_delay">delay.pru0.asm</a> is the assembly code.</p>
</div>
<div id="more_delay" class="listingblock">
<div class="title">delay.pru0.asm</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">; This is an example of how to call an assembly routine from C.
;   Mark A. Yoder, 9-July-2018
    .global my_delay_cycles
my_delay_cycles:
delay:
    sub     r14,   r14, 1       ; The first argument is passed in r14
    qbne    delay, r14, 0

    jmp     r3.w2           ; r3 contains the return address</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Makefile</code> has one addition that needs to be made to compile both <a href="#more_delay-test">delay-test..pru0.c</a>
and <a href="#more_delay">delay.pru0.asm</a>.
If you look in the local <code>Makefile</code> you&#8217;ll see:</p>
</div>
<div id="more_makefile" class="listingblock">
<div class="title">Makefile</div>
<div class="content">
<pre class="highlight"><code class="language-makefile" data-lang="makefile">include /var/lib/cloud9/common/Makefile</code></pre>
</div>
</div>
<div class="paragraph">
<p>This Makefle includes a common Makfile at  <code>/var/lib/cloud9/common/Makefile</code>,
this the Makefile you need to edit.
Edit <code>/var/lib/cloud9/common/Makefile</code> and go to line 197.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-makefile" data-lang="makefile">$(GEN_DIR)/%.out: $(GEN_DIR)/%.o <strong>$(GEN_DIR)/$(TARGETasm).o</strong>
    @mkdir -p $(GEN_DIR)
    @echo 'LD   $^'
    $(eval $(call target-to-proc,$@))
    $(eval $(call proc-to-build-vars,$@))
    @$(LD) $@ $^ $(LDFLAGS)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add <code><strong>(GEN_DIR)/$(TARGETasm).o</strong></code> as shown in bold above.  You will want to remove
this addition once you are done with this example since it will break the other examples.</p>
</div>
<div class="paragraph">
<p>The following will compile and run everything.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">bone$ <strong>config-pin P9_31 pruout</strong>
bone$ <strong>make TARGET=delay-test.pru0 TARGETasm=delay.pru0</strong>
/var/lib/cloud9/common/Makefile:29: MODEL=TI_AM335x_BeagleBone_Black,TARGET=delay-test.pru0
-    Stopping PRU 0
-   copying firmware file /tmp/cloud9-examples/delay-test.pru0.out to /lib/firmware/am335x-pru0-fw
write_init_pins.sh
-    Starting PRU 0
MODEL   = TI_AM335x_BeagleBone_Black
PROC    = pru
PRUN    = 0
PRU_DIR = /sys/class/remoteproc/remoteproc1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The resulting output is shown in <a href="#more_my_delay_cycles">Output of my_delay_cycles()</a>.</p>
</div>
<div id="more_my_delay_cycles" class="paragraph">
<div class="title">Output of my_delay_cycles()</div>
<p><span class="image"><img src="./07more/figures/my_delay_cycles.png" alt="Output of my_delay_cycles()"></span></p>
</div>
<div class="paragraph">
<p>Notice the on time is about 35ns and the off time is 30ns.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discission"><a class="link" href="#_discission">Discission</a></h4>
<div class="paragraph">
<p>There is much to explain here.  Let&#8217;s start with <a href="#more_delay">delay.pru0.asm</a>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 19. Line-by-line of delay.pru0.asm</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declare <code>my_delay_cycles</code> to be global so the linker can find it.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Label the starting point for <code>my_delay_cycles</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Label for our delay loop.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The first argument is passed in register <code>r14</code>.  Page 111 of
<a href="http://www.ti.com/lit/ug/spruhv7b/spruhv7b.pdf">PRU Optimizing C/C++ Compiler, v2.2, User&#8217;s Guide</a>
gives the argument passing convention.  Registers <code>r14</code> to <code>r29</code> are used
to pass arguments, if there are more arguments, the argument stack (<code>r4</code>)
is used.  The other register conventions are found on page 108.</p>
<p class="tableblock">Here we subtract 1 from <code>r14</code> and save it back into <code>r14</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>qbne</code> is a quick branch if not equal.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Once we&#8217;ve delayed enough we drop through the quick branch and
hit the jump.  The upper bits of register <code>r3</code> has the return address,
therefore we return to the c code.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#more_my_delay_cycles">Output of my_delay_cycles()</a> shows the <em>on</em> time is 35ns and the off time is 30ns.
With 5ns/cycle this gives 7 cycles on and 6 off. These times make sense
because each instruction takes a cycle and you have, set <code>R30</code>, jump to
<code>my_delay_cycles</code>, <code>sub</code>, <code>qbne</code>, <code>jmp</code>. Plus the instruction (not seen) that
initilizes <code>r14</code> to the passed value.  That&#8217;s a total of six instructions.
The extra instruction is the branch at the bottom of the <code>while</code> loop.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_returning_a_value_from_assembly"><a class="link" href="#_returning_a_value_from_assembly">7.2. Returning a Value from Assembly</a></h3>
<div class="sect3">
<h4 id="_problem_49"><a class="link" href="#_problem_49">Problem</a></h4>
<div class="paragraph">
<p>Your assembly code needs to return a value.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_49"><a class="link" href="#_solution_49">Solution</a></h4>
<div class="paragraph">
<p><code>R14</code> is how the return value is passed back.  <a href="#more_test2">delay-test2.pru0.c</a> shows the c
code.</p>
</div>
<div id="more_test2" class="listingblock">
<div class="title">delay-test2.pru0.c</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">// Shows how to call an assembly routine with a return value
#include &lt;stdint.h&gt;
#include &lt;pru_cfg.h&gt;
#include "resource_table_empty.h"
#include "prugpio.h"

#define TEST    100

// The function is defined in delay.asm in same dir
// We just need to add a declaration here, the defination can be
// seperately linked
extern uint32_t my_delay_cycles(uint32_t);

uint32_t ret;

volatile register uint32_t <em>R30;
volatile register uint32_t </em>R31;

void main(void)
{
    uint32_t gpio = P9_31;  // Select which pin to toggle.;

    /* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */
    CT_CFG.SYSCFG_bit.STANDBY_INIT = 0;

    while(1) {
        <em>R30 |= gpio;      // Set the GPIO pin to 1
        ret = my_delay_cycles(1);
        </em>R30 &amp;= ~gpio;     // Clear the GPIO pin
        ret = my_delay_cycles(1);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#more_delay2">delay2.pru0.asm</a> is the assembly code.</p>
</div>
<div id="more_delay2" class="listingblock">
<div class="title">delay2.pru0.asm</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">; This is an example of how to call an assembly routine from C with a retun value.
;   Mark A. Yoder, 9-July-2018

    .cdecls "delay-test2.pru0.c"

    .global my_delay_cycles
my_delay_cycles:
delay:
    sub     r14,   r14, 1       ; The first argument is passed in r14
    qbne    delay, r14, 0

    ldi     r14, TEST       ; TEST is defined in delay-test2.c
                            ; r14 is the return register

    jmp     r3.w2           ; r3 contains the return address</code></pre>
</div>
</div>
<div class="paragraph">
<p>An additional feature is shown in line 4 of <a href="#more_delay2">delay2.pru0.asm</a>.  The
<code>.cdecls "delay-test2.pru0.c"</code> says to include any defines from <code>delay-test2.pru0.c</code>
In this example, line 6 of <a href="#more_test2">delay-test2.pru0.c</a> <code>#defines</code> TEST and line 12 of
<a href="#more_delay2">delay2.pru0.asm</a> reference it.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_built_in_counter_for_timing"><a class="link" href="#_using_the_built_in_counter_for_timing">7.3. Using the Built-In Counter for Timing</a></h3>
<div class="sect3">
<h4 id="_problem_50"><a class="link" href="#_problem_50">Problem</a></h4>
<div class="paragraph">
<p>I want to count how many cycles my routine takes.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_50"><a class="link" href="#_solution_50">Solution</a></h4>
<div class="paragraph">
<p>Each PRU has a <code>CYCLE</code> register which counts the number of cycles since
the PRU was enabled. They also have a <code>STALL</code> register that counts how
many times the PRU stalled fetching an instruction.
<a href="#more_cycle">cycle.pru0.c - Code to count cycles.</a> shows they are used.</p>
</div>
<div id="more_cycle" class="listingblock">
<div class="title">cycle.pru0.c - Code to count cycles.</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">// Access the CYCLE and STALL registers
#include &lt;stdint.h&gt;
#include &lt;pru_cfg.h&gt;
#include &lt;pru_ctrl.h&gt;
#include "resource_table_empty.h"
#include "prugpio.h"

volatile register uint32_t <em>R30;
volatile register uint32_t </em>R31;

void main(void)
{
    uint32_t gpio = P9_31;  // Select which pin to toggle.;

    // These will be kept in registers and never witten to DRAM
    uint32_t cycle, stall;

    // Clear SYSCFG[STANDBY_INIT] to enable OCP master port
    CT_CFG.SYSCFG_bit.STANDBY_INIT = 0;

    PRU0_CTRL.CTRL_bit.CTR_EN = 1;  // Enable cycle counter

    <em>R30 |= gpio;              // Set the GPIO pin to 1
    // Reset cycle counter, cycle is on the right side to force the compiler
    // to put it in it's own register
    PRU0_CTRL.CYCLE = cycle;
    </em>R30 &amp;= ~gpio;             // Clear the GPIO pin
    cycle = PRU0_CTRL.CYCLE;    // Read cycle and store in a register
    stall = PRU0_CTRL.STALL;    // Ditto for stall

    __halt();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_discission_2"><a class="link" href="#_discission_2">Discission</a></h4>
<div class="paragraph">
<p>The code is mostly the same as other examples.
<code>cycle</code> and <code>stall</code> end up in registers which
we can read using prudebug.
<a href="#more_cycle_lines">Line-by-line for cycle.pru0.c</a> is the Line-by-line.</p>
</div>
<table id="more_cycle_lines" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 20. Line-by-line for cycle.pru0.c</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Include needed to reference <code>CYCLE</code> and <code>STALL</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declaring <code>cycle</code> and <code>stall</code>.  The compiler will optimize these and just
keep them in registers.  We&#8217;ll have to look at the <code>cycle.pru0.lst</code> file to see where
they are stored.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">21</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables <code>CYCLE</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">26</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reset <code>CYCLE</code>. It ignores the value assigned to it and always sets it
to 0.  <code>cycle</code> is on the right hand side to make the compiler give it it&#8217;s own
register.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">28, 29</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reads the <code>CYCLE</code> and <code>STALL</code> values into registers.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can see where <code>cycle</code> and <code>stall</code> are stored by looking into
<a href="#more_cycle_list0">/tmp/cloud9-examples/cycle.pru0.lst Lines 113..119</a>.</p>
</div>
<div id="more_cycle_list0" class="listingblock">
<div class="title">/tmp/cloud9-examples/cycle.pru0.lst Lines 113..119</div>
<div class="content">
<pre class="highlight"><code class="language-asm" data-lang="asm">     103;----------------------------------------------------------------------
     104;  23 | PRU0_CTRL.CTRL_bit.CTR_EN = 1;  // Enable cycle counter
     105;----------------------------------------------------------------------
     106 0000000c 200080240002C0          LDI32     r0, 0x00022000        ; [ALU_PRU] |23| $O$C1
     107 00000014 000000F1002081          LBBO      &amp;r1, r0, 0, 4         ; [ALU_PRU] |23|
     108 00000018 0000001F03E1E1          SET       r1, r1, 0x00000003    ; [ALU_PRU] |23|
     109 0000001c 000000E1002081          SBBO      &amp;r1, r0, 0, 4         ; [ALU_PRU] |23|</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here the <code>LDI32</code> instruction loads the address <code>0x22000</code> into <code>r0</code>.
This is the offset to the <code>CTRL</code> registers.
 Later in the file we see <a href="#more_cycle_list1">/tmp/cloud9-examples/cycle.pru0.lst Lines 146..152</a>.</p>
</div>
<div id="more_cycle_list1" class="listingblock">
<div class="title">/tmp/cloud9-examples/cycle.pru0.lst Lines 146..152</div>
<div class="content">
<pre class="highlight"><code class="language-asm" data-lang="asm">     131;----------------------------------------------------------------------
     132 0000002c 000000F10C2081          LBBO      &amp;r1, r0, 12, 4        ; [ALU_PRU] |30| $O$C1
     133        .dwpsn  file "cycle.pru0.c",line 31,column 2,is_stmt,isa 0
     134;----------------------------------------------------------------------
     135;  31 | stall = PRU0_CTRL.STALL;        // Ditto for stall
     136;----------------------------------------------------------------------
     137 00000030 000000F1102080          LBBO      &amp;r0, r0, 16, 4        ; [ALU_PRU] |31| $O$C1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first <code>LBBO</code> takes the contents of <code>r0</code> and adds the offset 12 to it and
copies 4 bytes into <code>r1</code>.  This points to <code>CYCLE</code>, so <code>r1</code> has the contents of
<code>CYCLE</code>.</p>
</div>
<div class="paragraph">
<p>The second <code>LBBO</code> does the same, but with offset 16, which points to <code>STALL</code>,
thus <code>STALL</code> is now  in <code>r0</code>.</p>
</div>
<div class="paragraph">
<p>Now fire up prudebug and look at those registers.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">bone$ <strong>sudo prudebug</strong>
PRU0&gt; <strong>r</strong>
r
r
Register info for PRU0
    Control register: 0x00000009
      Reset PC:0x0000  STOPPED, FREE_RUN, COUNTER_ENABLED, NOT_SLEEPING, PROC_DISABLED

    Program counter: 0x0012
      Current instruction: HALT

    R00: <strong>0x00000005</strong>    R08: 0x00000200    R16: 0x000003c6    R24: 0x00110210
    R01: <strong>0x00000003</strong>    R09: 0x00000000    R17: 0x00000000    R25: 0x00000000
    R02: 0x000000fc    R10: 0xfff4ea57    R18: 0x000003e6    R26: 0x6e616843
    R03: 0x0004272c    R11: 0x5fac6373    R19: 0x30203020    R27: 0x206c656e
    R04: 0xffffffff    R12: 0x59bfeafc    R20: 0x0000000a    R28: 0x00003033
    R05: 0x00000007    R13: 0xa4c19eaf    R21: 0x00757270    R29: 0x02100000
    R06: 0xefd30a00    R14: 0x00000005    R22: 0x0000001e    R30: 0xa03f9990
    R07: 0x00020024    R15: 0x00000003    R23: 0x00000000    R31: 0x00000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>So <code>cycle</code> is 3 and <code>stall</code> is 5. It must be one cycle to clear the GPIO
and 2 cycles to read the <code>CYCLE</code> register and save it in the register.
It&#8217;s interesting there are 5 <code>stall</code> cycles.</p>
</div>
<div class="paragraph">
<p>If you switch the order of
lines 30 and 31 you&#8217;ll see <code>cycle</code> is 7 and <code>stall</code> is 2. <code>cycle</code> now
includes the time needed to read <code>stall</code> and <code>stall</code> no longer includes
the time to read <code>cycle</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_xout_and_xin_transfering_between_prus"><a class="link" href="#_xout_and_xin_transfering_between_prus">7.4. Xout and Xin - Transfering Between PRUs</a></h3>
<div class="sect3">
<h4 id="_problem_51"><a class="link" href="#_problem_51">Problem</a></h4>
<div class="paragraph">
<p>I need to transfer data between PRUs quickly.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_51"><a class="link" href="#_solution_51">Solution</a></h4>
<div class="paragraph">
<p>The <code>__xout()</code> and <code>__xin()</code> intrinsics are able to transfer up to 30 registers between
PRU 0 and PRU 1 quickly.  <a href="#more_xout">xout.pru0.c</a> shows how <code>xout()</code> running on PRU 0
transfers six registers to PRU 1.</p>
</div>
<div id="more_xout" class="listingblock">
<div class="title">xout.pru0.c</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">// From: http://git.ti.com/pru-software-support-package/pru-software-support-package/trees/master/examples/am335x/PRU_Direct_Connect0
#include &lt;stdint.h&gt;
#include &lt;pru_intc.h&gt;
#include "resource_table_pru0.h"

volatile register uint32_t <em>R30;
volatile register uint32_t </em>R31;

typedef struct {
    uint32_t reg5;
    uint32_t reg6;
    uint32_t reg7;
    uint32_t reg8;
    uint32_t reg9;
    uint32_t reg10;
} bufferData;

bufferData dmemBuf;

/* PRU-to-ARM interrupt <strong>/
#define PRU1_PRU0_INTERRUPT (18)
#define PRU0_ARM_INTERRUPT (19+16)

void main(void)
{
    /</strong> Clear the status of all interrupts <strong>/
    CT_INTC.SECR0 = 0xFFFFFFFF;
    CT_INTC.SECR1 = 0xFFFFFFFF;

    /</strong> Load the buffer with default values to transfer <strong>/
    dmemBuf.reg5 = 0xDEADBEEF;
    dmemBuf.reg6 = 0xAAAAAAAA;
    dmemBuf.reg7 = 0x12345678;
    dmemBuf.reg8 = 0xBBBBBBBB;
    dmemBuf.reg9 = 0x87654321;
    dmemBuf.reg10 = 0xCCCCCCCC;

    /</strong> Poll until R31.30 (PRU0 interrupt) is set
     * This signals PRU1 is initialized <strong>/
    while ((<em>R31 &amp; (1&lt;&lt;30)) == 0) {
    }

    /</strong> XFR registers R5-R10 from PRU0 to PRU1 <strong>/
    /</strong> 14 is the device_id that signifies a PRU to PRU transfer <strong>/
    </em>xout(14, 5, 0, dmemBuf);

    /</strong> Clear the status of the interrupt <strong>/
    CT_INTC.SICR = PRU1_PRU0_INTERRUPT;

    /</strong> Halt the PRU core */
    __halt();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>PRU 1 waits at line 42 until PRU 0 signals it.  <a href="#more_xin">xin.pru1.c</a> sends sends an
interupt to PRU 0 and waits for it to send the data.</p>
</div>
<div id="more_xin" class="listingblock">
<div class="title">xin.pru1.c</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">// From: http://git.ti.com/pru-software-support-package/pru-software-support-package/trees/master/examples/am335x/PRU_Direct_Connect1
#include &lt;stdint.h&gt;
#include "resource_table_empty.h"

volatile register uint32_t <em>R30;
volatile register uint32_t </em>R31;

typedef struct {
    uint32_t reg5;
    uint32_t reg6;
    uint32_t reg7;
    uint32_t reg8;
    uint32_t reg9;
    uint32_t reg10;
} bufferData;

bufferData dmemBuf;

/* PRU-to-ARM interrupt <strong>/
#define PRU1_PRU0_INTERRUPT (18)
#define PRU1_ARM_INTERRUPT (20+16)

void main(void)
{
    /</strong> Let PRU0 know that I am awake <strong>/
    <em>R31 = PRU1_PRU0_INTERRUPT+16;

    /</strong> XFR registers R5-R10 from PRU0 to PRU1 <strong>/
    /</strong> 14 is the device_id that signifies a PRU to PRU transfer <strong>/
    </em>xin(14, 5, 0, dmemBuf);

    /</strong> Halt the PRU core */
    __halt();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use <code>prudebug</code> to see registers R5-R10 are transfered from PRU 0 to PRU 1.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">PRU0&gt; <strong>r</strong>
Register info for PRU0
    Control register: 0x00000001
      Reset PC:0x0000  STOPPED, FREE_RUN, COUNTER_DISABLED, NOT_SLEEPING, PROC_DISABLED

    Program counter: 0x0026
      Current instruction: HALT

    R00: 0x00000012    <strong>R08: 0xbbbbbbbb</strong>    R16: 0x000003c6    R24: 0x00110210
    R01: 0x00020000    <strong>R09: 0x87654321</strong>    R17: 0x00000000    R25: 0x00000000
    R02: 0x000000e4    <strong>R10: 0xcccccccc</strong>    R18: 0x000003e6    R26: 0x6e616843
    R03: 0x0004272c    R11: 0x5fac6373    R19: 0x30203020    R27: 0x206c656e
    R04: 0xffffffff    R12: 0x59bfeafc    R20: 0x0000000a    R28: 0x00003033
    <strong>R05: 0xdeadbeef</strong>    R13: 0xa4c19eaf    R21: 0x00757270    R29: 0x02100000
    <strong>R06: 0xaaaaaaaa</strong>    R14: 0x00000005    R22: 0x0000001e    R30: 0xa03f9990
    <strong>R07: 0x12345678</strong>    R15: 0x00000003    R23: 0x00000000    R31: 0x00000000

PRU0&gt; <strong>pru 1</strong>
pru 1
Active PRU is PRU1.

PRU1&gt; <strong>r</strong>
r
Register info for PRU1
    Control register: 0x00000001
      Reset PC:0x0000  STOPPED, FREE_RUN, COUNTER_DISABLED, NOT_SLEEPING, PROC_DISABLED

    Program counter: 0x000b
      Current instruction: HALT

    R00: 0x00000100    <strong>R08: 0xbbbbbbbb</strong>    R16: 0xe9da228b    R24: 0x28113189
    R01: 0xe48cdb1f    <strong>R09: 0x87654321</strong>    R17: 0x66621777    R25: 0xddd29ab1
    R02: 0x000000e4    <strong>R10: 0xcccccccc</strong>    R18: 0x661f83ea    R26: 0xcf1cd4a5
    R03: 0x0004db97    R11: 0xdec387d5    R19: 0xa85adb78    R27: 0x70af2d02
    R04: 0xa90e496f    R12: 0xbeac3878    R20: 0x048fff22    R28: 0x7465f5f0
    <strong>R05: 0xdeadbeef</strong>    R13: 0x5777b488    R21: 0xa32977c7    R29: 0xae96b530
    <strong>R06: 0xaaaaaaaa</strong>    R14: 0xffa60550    R22: 0x99fb123e    R30: 0x52c42a0d
    <strong>R07: 0x12345678</strong>    R15: 0xdeb2142d    R23: 0xa353129d    R31: 0x00000000</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_30"><a class="link" href="#_discussion_30">Discussion</a></h4>
<div class="paragraph">
<p><a href="#more_zout_lines">xout.pru0.c Line-by-line</a> shows the line-by-line for <code>xout.pru0.c</code></p>
</div>
<table id="more_zout_lines" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 21. xout.pru0.c Line-by-line</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A different resource so PRU 0 can receive a signal from PRU 1.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">9-16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>dmemBuf</code> holds the data to be sent to PRU 1.  Each will be transfered
to its corresponding register by <code>xout()</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">21-22</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define the interupts we&#8217;re using.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">27-28</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Clear the interrupts.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">31-36</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Initialize dmemBuf with easy to recognize values.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">40</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Wait for PRU 1 to signal.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">45</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>__xout()</code> does a direct transfer to PRU 1.
Page 92 of
<a href="http://www.ti.com/lit/ug/spruhv7b/spruhv7b.pdf">PRU Optimizing C/C++ Compiler, v2.2, User&#8217;s Guide</a>
shows how to use <code>xout()</code>. The first argument, 14, says to do a direct
transfer to PRU 1.  If the
first argument is 10, 11 or 12, the data is transfered to one of three
scratchpad memories that PRU 1 can access later.</p>
<p class="tableblock">The second argument, 5, says to start transfering
with register <code>r5</code> and use as many regsiters as needed to transfer all of
<code>dmemBuf</code>.</p>
<p class="tableblock">The third argument, 0, says to not use remapping. (See the User&#8217;s Guide for
details.)</p>
<p class="tableblock">The final argument is the data to be transfered.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">48</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Clear the interupt so it can go again.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#more_xin_lines">xin.pru1.c Line-by-line</a> shows the line-by-line for <code>xin.pru1.c</code>.</p>
</div>
<table id="more_xin_lines" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 22. xin.pru1.c Line-by-line</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">8-15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place to put the received data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">26</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Signal PRU 0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">30</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Receive the data. The arguments are the same as <code>xout()</code>,
14 says to get the data directly from PRU 0.
5 says to start with register <code>r5</code>.
<code>dmemBuf</code> is where to put the data.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If you really need speed, considering using <code>__xout()</code> and
<code>__xin()</code> in assembly.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_copyright_3"><a class="link" href="#_copyright_3">7.5. Copyright</a></h3>
<div class="listingblock">
<div class="title">copyright.c</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">/*
 * Copyright (C) 2015 Texas Instruments Incorporated - http://www.ti.com/
 *
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 *  * Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 *
 *  * Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the
 *    distribution.
 *
 *  * Neither the name of Texas Instruments Incorporated nor the names of
 *    its contributors may be used to endorse or promote products derived
 *    from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
<div class="paragraph">
<p><a href="../index.html">Outline</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_moving_to_the_beaglebone_ai"><a class="link" href="#_moving_to_the_beaglebone_ai">8. Moving to the BeagleBone AI</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far all our examples have focussed mostly on the BeagleBone Black and Pocket Beagle.
These are both based on the am335x chip.  The new kid on the block is the BeagleBone AI
which is based on the am5729. The new chip brings with it new capabilities one of
which is four PRUs.  This chapter details what changes when moving from two to
four PRUs.</p>
</div>
<div class="paragraph">
<p>The following are resources used in this chapter.</p>
</div>
<div class="ulist">
<div class="title">Resources</div>
<ul>
<li>
<p><a href="http://www.ti.com/lit/pdf/spruhz6l">AM572x Technical Reference Manual</a> (AI)</p>
</li>
<li>
<p><a href="https://docs.google.com/spreadsheets/d/1dFSBVem86vAUD7MLXvqdS-N0Efi8_g_O1iTqzql8DAo/edit#gid=0">BeagleBone AI PRU pins</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_moving_from_two_to_four_prus"><a class="link" href="#_moving_from_two_to_four_prus">8.1. Moving from two to four PRUs</a></h3>
<div class="sect3">
<h4 id="_problem_52"><a class="link" href="#_problem_52">Problem</a></h4>
<div class="paragraph">
<p>You have code that works on the am335x PRUs and you want to move it to the
am5729 on the AI.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_52"><a class="link" href="#_solution_52">Solution</a></h4>
<div class="paragraph">
<p>Things to consider when moving to the AI are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Which pins are you going to use</p>
</li>
<li>
<p>Which PRU are you going to run on</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Knowing which pins to use impacts the PRU you&#8217;ll use.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discission_3"><a class="link" href="#_discission_3">Discission</a></h4>
<div class="paragraph">
<p>The various System Reference Manuals (SRM&#8217;s) list which pins go to the PRUs.
Here the tables are combined into one to make it easier to see what goes where.</p>
</div>
<table id="aimapping_bits" class="tableblock frame-all grid-all" style="width: 50%;">
<caption class="title">Table 23. Mapping bit positions to pin names</caption>
<colgroup>
<col style="width: 7.1428%;">
<col style="width: 7.1428%;">
<col style="width: 21.4285%;">
<col style="width: 21.4285%;">
<col style="width: 21.4285%;">
<col style="width: 21.4289%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">PRU</th>
<th class="tableblock halign-left valign-top">Bit</th>
<th class="tableblock halign-left valign-top">Black pin</th>
<th class="tableblock halign-left valign-top">AI PRU1 pin</th>
<th class="tableblock halign-left valign-top">AI PRU2 pin</th>
<th class="tableblock halign-left valign-top">Pocket pin</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_31</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_44</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.36</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_29</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_41</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.33</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_30</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_42/P8_21</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.32</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_28</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_39/P8_20</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.30</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_92</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_40/P8_25</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.31</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_27</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_37/P8_24</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.34</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_91</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_38/P8_5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.28</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_25</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_36/P8_6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.29</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_34/P8_23</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_35/P8_22</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">19</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_33/P8_3</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_31/P8_4</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_32</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">13</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_45</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_12(out) P8_16(in)</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.24</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_11(out) P8_15(in)</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_17/P9_13</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.33</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_41(in) P9_26(in)</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_27</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">17</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_26</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_28</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">18</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_29</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">19</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_30</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_46/P8_8</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">---</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">---</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">---------</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-----------</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-----------</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-----</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_45</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_32</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_46</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>P9_20</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_43</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>P9_19</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_44</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_41</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_41</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_42</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>P8_18</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_25</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_39</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>P8_19</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_9</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_40</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>P8_13</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_31</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_27</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_18</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.35</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_29</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_17</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.01</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_28</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_42</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_31</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.35</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_30</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_27</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_29</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.04</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_21</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_30</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">13</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_20</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_26</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">14</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_42</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.32</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>P9_16</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.30</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_26(in)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>P8_15</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_7</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">17</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>P8_26</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_27</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">18</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>P8_16</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_45</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">19</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_46</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">19</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_43</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The pins in <strong>bold</strong> are already configured as pru pins.  See <a href="#ai_config">Seeing how pins are configured</a> to
see what&#8217;s currently configured as what.  See <a href="#ai_device_tree">Configuring pins on the AI via device trees</a> to
configure pins.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ai_config"><a class="link" href="#ai_config">8.2. Seeing how pins are configured</a></h3>
<div class="sect3">
<h4 id="_problem_53"><a class="link" href="#_problem_53">Problem</a></h4>
<div class="paragraph">
<p>You want to know how the pins are currently configured.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_53"><a class="link" href="#_solution_53">Solution</a></h4>
<div class="paragraph">
<p>The <code>show-pins.pl</code> command does what you want, but you have to set it up first.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>cd ~/bin</strong>
bone$ <strong>ln -s /opt/scripts/device/bone/show-pins.pl .</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>This creates a symbolic link to the <code>show-pins.pl</code> command that is rather hidden
away.  The link is put in the <code>bin</code> directory which is in the default command
<code>$PATH</code>.  Now you can run <code>show-pins.pl</code> from anywhere.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>show-pins.pl</strong>
P9.19a                    16   R6 7 fast rx  up  i2c4_scl
P9.20a                    17   T9 7 fast rx  up  i2c4_sda
P8.35b                    57  AD9 e fast    down gpio3_0
P8.33b                    58  AF9 e fast    down gpio3_1
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here you see <code>P9.19a</code> and <code>P9.20a</code> are configured for i2c with pull up resistors.
The <code>P8</code> pins are configured as gpio with pull down resistors. They are
both on gpio port 3.  <code>P8.35b</code> is bit 0 while <code>P8.33b</code> is bit 1. You can find
which direction they are set by using <code>gpioinfo</code> and the chip number.
Unfortunately you subtract one from the port number to get the chip number.
So <code>P8.35b</code> is on chip number 2.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>gpioinfo 2</strong>
    line   0:      unnamed       unused   <strong>input</strong>  active-high
    line   1:      unnamed       unused   <strong>input</strong>  active-high
    line   2:      unnamed       unused   input  active-high
    line   3:      unnamed       unused   input  active-high
    line   4:      unnamed       unused   input  active-high
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we see both (lines 0 and 1) are set to input.</p>
</div>
<div class="paragraph">
<p>Adding <code>-v</code> gives more details.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>show-pins.pl -v</strong>
...
sysboot 14                14   H2 f fast    down sysboot14
sysboot 15                15   H3 f fast    down sysboot15
P9.19a                    16   R6 7 fast rx  up  i2c4_scl
P9.20a                    17   T9 7 fast rx  up  i2c4_sda
                          18   T6 f fast    down Driver off
                          19   T7 f fast    down Driver off
bluetooth in              20   P6 8 fast rx      uart6_rxd        mmc@480d1000 (wifibt_extra_pins_default)
bluetooth out             21   R9 8 fast rx      uart6_txd        mmc@480d1000 (wifibt_extra_pins_default)
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The best way to use <code>show-pins.pl</code> is with <code>grep</code>.  To see all the pru pins try:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>show-pins.pl  | grep -i pru | sort</strong>
P8.13                    100   D3 c fast rx      pr1_pru1_gpi7
P8.15b                   109   A3 d fast    down pr1_pru1_gpo16
P8.16                    111   B4 d fast    down pr1_pru1_gpo18
P8.18                     98   F5 c fast rx      pr1_pru1_gpi5
P8.19                     99   E6 c fast rx      pr1_pru1_gpi6
P8.26                    110   B3 d fast    down pr1_pru1_gpo17
P9.16                    108   C5 d fast    down pr1_pru1_gpo15
P9.19b                    95   F4 c fast rx  up  pr1_pru1_gpi2
P9.20b                    94   D2 c fast rx  up  pr1_pru1_gpi1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we have nine pins configured for the PRU registers <code>R30</code> and <code>R31</code>.
Five are input pins and four are out.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ai_device_tree"><a class="link" href="#ai_device_tree">8.3. Configuring pins on the AI via device trees</a></h3>
<div class="sect3">
<h4 id="_problem_54"><a class="link" href="#_problem_54">Problem</a></h4>
<div class="paragraph">
<p>I want to configure another pin for the PRU, but I get an error.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>config-pin P9_31 pruout</strong>
ERROR: open() for /sys/devices/platform/ocp/ocp:P9_31_pinmux/state failed, No such file or directory</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_solution_54"><a class="link" href="#_solution_54">Solution</a></h4>
<div class="paragraph">
<p>The pins on the AI must be configure at boot time and therefor cannot be
configured with <code>config-pin</code>.  Instead you must edit the device tree.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discission_4"><a class="link" href="#_discission_4">Discission</a></h4>
<div class="paragraph">
<p>Suppose you want to make <code>P9_31</code> a PRU output pin. First go to the
<a href="https://github.com/beagleboard/beaglebone-ai/wiki/System-Reference-Manual#p8.10-p8.13">am5729 System Reference Manual</a>
and look up <code>P9_31</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>The <a href="https://docs.google.com/spreadsheets/d/1dFSBVem86vAUD7MLXvqdS-N0Efi8_g_O1iTqzql8DAo/edit#gid=0">BeagleBone AI PRU pins</a>
table may be easier to use.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>P9_31</code> appears twice, as <code>P9_31a</code> and <code>P9_31b</code>. Either should work, let&#8217;s pick
<code>P9_31a</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>When you have two internal pins attached to the same header (either P8 or P9)
make sure only one is configured as an output.  If both are outputs, you could
damage the AI.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We see that when <code>P9_31a</code> is set to <code>MODE13</code> it will be a PRU <em>out</em> pin.
<code>MODE12</code> makes it a PRU <em>in</em> pin.  It appears at bit 10 on PRU2_1.</p>
</div>
<div class="paragraph">
<p>Next, find which kernel you are running.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>uname -a</strong>
Linux ai <strong>4.14</strong>.108-ti-r131 #1buster SMP PREEMPT Tue Mar 24 19:18:36 UTC 2020 armv7l GNU/Linux</code></pre>
</div>
</div>
<div class="paragraph">
<p>I&#8217;m running the 4.14 version. Now look in <code>/opt/source</code> for your kernel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bone$ <strong>cd /opt/source/</strong>
bone$ <strong>ls</strong>
adafruit-beaglebone-io-python  dtb-5.4-ti       rcpy
BBIOConfig                     librobotcontrol  u-boot_v2019.04
bb.org-overlays                list.txt         u-boot_v2019.07-rc4
<strong>dtb-4.14-ti</strong>                    pyctrl
dtb-4.19-ti                    py-uio</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>am5729-beagleboneai.dts</code> is the file we need to edit.  Search for <code>P9_31</code>.
You&#8217;l see:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>DRA7XX_CORE_IOPAD(0x36DC, MUX_MODE14) // B13: P9.30: mcasp1_axr10.off //
DRA7XX_CORE_IOPAD(0x36D4, <strong>MUX_MODE13</strong>) // B12: <strong>P9.31a</strong>: mcasp1_axr8.off //
DRA7XX_CORE_IOPAD(0x36A4, MUX_MODE14) // C14: P9.31b: mcasp1_aclkx.off //</pre>
</div>
</div>
<div class="paragraph">
<p>Change the <code>MUX_MODE14</code> to <code>MUX_MODE13</code> for output, or <code>MUX_MODE12</code> for input.</p>
</div>
<div class="paragraph">
<p>Compile and install.  The first time will take a while since it recompiles all
the dts files.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bone$ <strong>make</strong>
...
DTC     src/arm/am335x-sl50.dtb
<strong>DTC     src/arm/am5729-beagleboneai.dtb</strong>
DTC     src/arm/am335x-nano.dtb
...
bone$ <strong>sudo make install</strong>
...
'src/arm/am5729-beagleboneai.dtb' -&gt; '/boot/dtbs/4.14.108-ti-r131/am5729-beagleboneai.dtb'
...
bone$ <strong>reboot</strong>
...
bone$ <strong>show-pins.pl -v | sort | grep -i pru</strong>
P8.13                    100   D3 c fast rx      pr1_pru1_gpi7
P8.15b                   109   A3 d fast    down pr1_pru1_gpo16
P8.16                    111   B4 d fast    down pr1_pru1_gpo18
P8.18                     98   F5 c fast rx      pr1_pru1_gpi5
P8.19                     99   E6 c fast rx      pr1_pru1_gpi6
P8.26                    110   B3 d fast    down pr1_pru1_gpo17
P9.16                    108   C5 d fast    down pr1_pru1_gpo15
P9.19b                    95   F4 c fast rx  up  pr1_pru1_gpi2
P9.20b                    94   D2 c fast rx  up  pr1_pru1_gpi1
<strong>P9.31a                   181  B12 d fast    down pr2_pru1_gpo10</strong></pre>
</div>
</div>
<div class="paragraph">
<p>There it is.  <code>P9_31</code> is now a PRU output pin on PRU1_0, bit 3.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ai_using_pru_pins"><a class="link" href="#ai_using_pru_pins">8.4. Using the PRU pins</a></h3>
<div class="sect3">
<h4 id="_problem_55"><a class="link" href="#_problem_55">Problem</a></h4>
<div class="paragraph">
<p>Once I have the PRU pins configured on the AI how do I use them?</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_55"><a class="link" href="#_solution_55">Solution</a></h4>
<div class="paragraph">
<p>In <a href="#ai_device_tree">Configuring pins on the AI via device trees</a> we configured <code>P9_31a</code> to be a PRU pin.  <code>show-pins.pl</code> showed
that it appears at <code>pr2_pru1_gpo10</code>, which means pru2_1 accesses it using
bit 10 of register <code>R30</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discission_5"><a class="link" href="#_discission_5">Discission</a></h4>
<div class="paragraph">
<p>It&#8217;s easy to modify the pwm example from <a href="#blocks_pwm">PWM Generator</a> to use this pin.
First copy the example you want to modify to <code>pwm1.pru2_1.c</code>.  The <code>pru2_1</code> in
the file name tells the Makefile to run the code on pru2_1.  <a href="#ai_pwm1">pwm1.pru2_1.c</a> shows
the adapted code.</p>
</div>
<div id="ai_pwm1" class="listingblock">
<div class="title">pwm1.pru2_1.c</div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">#include &lt;stdint.h&gt;
#include &lt;pru_cfg.h&gt;
#include "resource_table_empty.h"
#include "prugpio.h"

#define P9_31 (0x1&lt;&lt;10)

volatile register uint32_t __R30;
volatile register uint32_t __R31;

void main(void)
{
    uint32_t gpio = P9_31;  // Select which pin to toggle.;

    /* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */
    CT_CFG.SYSCFG_bit.STANDBY_INIT = 0;

    while(1) {
        __R30 |= gpio;      // Set the GPIO pin to 1
        __delay_cycles(100000000);
        __R30 &amp;= ~gpio;     // Clear the GPIO pin
        __delay_cycles(100000000);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>One line 6 <code>P9_31</code> is defined as <code>(0x1&lt;&lt;10)</code>, which means shift <code>1</code> over by 10 bits.
That&#8217;s the only change needed.  Copy the local Makefile to the same directory and
compile and run.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bone$ <strong>make TARGET=pwm1.pru2_1</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Attach an LED to <code>P9_31</code> and it should be blinking.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_index"><a class="link" href="#_index">Index</a></h2>
<div class="sectionbody">

</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. Four if you are on the BeagleBone AI
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. FTDI images are from the BeagleBone Cookbook <a href="http://shop.oreilly.com/product/0636920033899.do" class="bare">http://shop.oreilly.com/product/0636920033899.do</a>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 2.0 beta<br>
Last updated 2020-06-22 17:22:10 -0400
</div>
</div>
</body>
</html>