<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5">
<meta name="author" content="Mark A. Yoder">
<title>PRU Cookbook</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
</head>
<body class="article">
<div id="header">
<h1>PRU Cookbook</h1>
<div class="details">
<span id="author" class="author">Mark A. Yoder</span><br>
<span id="email" class="email"><a href="mailto:Mark.A.Yoder@Rose-Hulman.edu">Mark.A.Yoder@Rose-Hulman.edu</a></span><br>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_getting_started"><a class="link" href="#_getting_started">1. Getting Started</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is mostly filler just to get a place to put things.</p>
</div>
<div class="sect2">
<h3 id="_selecting_a_beagle"><a class="link" href="#_selecting_a_beagle">1.1. Selecting a Beagle</a></h3>
<div class="sect3">
<h4 id="_problem"><a class="link" href="#_problem">1.1.1. Problem</a></h4>
<div class="paragraph">
<p>Which Beagle should you use?</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution"><a class="link" href="#_solution">1.1.2. Solution</a></h4>
<div class="paragraph">
<p>There are many to choose from.  Try the PocketBeagle, it&#8217;s the newest.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion"><a class="link" href="#_discussion">1.1.3. Discussion</a></h4>
<div class="paragraph">
<p>The Blue is a good choice if you are doing robotics.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_installing_the_latest_os_on_your_bone"><a class="link" href="#_installing_the_latest_os_on_your_bone">1.2. Installing the Latest OS on Your Bone</a></h3>
<div class="sect3">
<h4 id="_problem_2"><a class="link" href="#_problem_2">1.2.1. Problem</a></h4>
<div class="paragraph">
<p>You want to find the lastest version of Debian that is available for your Bone.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_2"><a class="link" href="#_solution_2">1.2.2. Solution</a></h4>
<div class="paragraph">
<p>On your host computer open a browser and go to
<a href="http://rcn-ee.net/deb/testing/" class="bare">http://rcn-ee.net/deb/testing/</a>](<a href="http://rcn-ee.net/deb/testing/" class="bare">http://rcn-ee.net/deb/testing/</a>
This show you a list of dates of the most recent Debian images.</p>
</div>
<div class="paragraph">
<div class="title">Latest Debian images</div>
<p><span class="image"><img src="figures/debianImages.png" alt="Latest Debian images"></span></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_case_studies"><a class="link" href="#_case_studies">2. Case Studies</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <strong>P</strong>rogrammable <strong>R</strong>eal-Time <strong>U</strong>nit (PRU) has two 32-bit cores which run
independently of the ARM processor that is running Linux.  Therefore they can
be programmed to respond quickly to inputs and produce very precisely timed
outputs. A good way to learn how to use the PRUs is to study how others have
used them.  Here we present some case studies that do just that.</p>
</div>
<div class="paragraph">
<p>In these study you&#8217;ll see a high-level view of using the PRUs.  In later
chapters you will see the details.</p>
</div>
<div class="paragraph">
<p>Here we present</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Robotics Control Library <a href="http://strawsondesign.com/docs/roboticscape/" class="bare">http://strawsondesign.com/docs/roboticscape/</a></p>
</li>
<li>
<p>BeagleLogic <a href="https://github.com/abhishek-kakkar/BeagleLogic/wiki" class="bare">https://github.com/abhishek-kakkar/BeagleLogic/wiki</a></p>
</li>
<li>
<p>LEDscape <a href="https://github.com/Yona-Appletree/LEDscape" class="bare">https://github.com/Yona-Appletree/LEDscape</a></p>
</li>
<li>
<p>MachineKit <a href="http://www.machinekit.io/" class="bare">http://www.machinekit.io/</a></p>
</li>
<li>
<p>ArduPilot <a href="http://ardupilot.org/" class="bare">http://ardupilot.org/</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_robotics_control_library"><a class="link" href="#_robotics_control_library">2.1. Robotics Control Library</a></h3>
<div class="paragraph">
<p>The <a href="http://strawsondesign.com/docs/roboticscape/">Robotics Control Library</a> is a package, that is already installed,
that contains a C library and example/testing programs for the BeagleBone Blue
and the BeagleBone Black with Robotics Cape. It uses the PRU to extend the real-time hardware of the Bone.</p>
</div>
<div class="sect3">
<h4 id="_problem_3"><a class="link" href="#_problem_3">2.1.1. Problem</a></h4>
<div class="paragraph">
<p>How do I configure the pins so the PRUs are accessable</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_3"><a class="link" href="#_solution_3">2.1.2. Solution</a></h4>
<div class="paragraph">
<p>It depends on which Beagle you are running on.  If you are on the Blue, everything is already configured for you.
If you are on the Black or Pocket you&#8217;ll need to run the following script.</p>
</div>
<div class="listingblock">
<div class="title">servos_setup.sh</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td>
  <td class="code"><pre>#!/bin/bash
# Configure the PRU pins based on which Beagle is running
machine=$(awk '{print $NF}' /proc/device-tree/model)
echo -n $machine
if [ $machine = &quot;Black&quot; ]; then
    echo &quot; Found&quot;
    pins=&quot;P8_27 P8_28 P8_29 P8_30 P8_39 P8_40 P8_41 P8_42&quot;
elif [ $machine = &quot;Blue&quot; ]; then
    echo &quot; Found&quot;
    pins=&quot;&quot;
elif [ $machine = &quot;PocketBeagle&quot; ]; then
    echo &quot; Found&quot;
    pins=&quot;P2_35 P1_35 P1_02 P1_04&quot;
else
    echo &quot; Not Found&quot;
    pins=&quot;&quot;
fi

for pin in $pins
do
    echo $pin
    config-pin $pin pruout
    config-pin -q $pin
done</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_2"><a class="link" href="#_discussion_2">2.1.3. Discussion</a></h4>
<div class="paragraph">
<p>The first part of the code looks in <code>/proc/device-tree/model</code> to see which Beagle is running. Based on that it
assigns <code>pins</code> a list of pins to configure.  Then the last part of the script loops through each of the pins and configures it.</p>
</div>
</div>
<div class="sect3">
<h4 id="_problem_4"><a class="link" href="#_problem_4">2.1.4. Problem</a></h4>
<div class="paragraph">
<p>I need to control eight servos, but the Bone doesn&#8217;t have enough PWMs.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_4"><a class="link" href="#_solution_4">2.1.5. Solution</a></h4>
<div class="paragraph">
<p>The Robotics Control Library provides eight additional PWM channels via the PRU that can be used out of the box.  Just run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">bone$ sudo rc_test_servos -f 10 -p 1.5</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>-f 10</code> says to use a frequency of 10 Hz and the <code>-p 1.5</code> says to set the position to <code>1.5</code>.  The range of positions is
<code>-1.5</code> to <code>1.5</code>.   Run <code>rc_test_servos -h</code> to see all the options.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">bone$ rc_test_servos -h

 Options
 -c {channel}   Specify one channel from 1-8.
                Otherwise all channels will be driven equally
 -f {hz}        Specify pulse frequency, otherwise 50hz is used
 -p {position}  Drive servo to a position between -1.5 &amp; 1.5
 -w {width_us}  Send pulse width in microseconds (us)
 -s {limit}     Sweep servo back/forth between +- limit
                Limit can be between 0 &amp; 1.5
 -r {ch}        Use DSM radio channel {ch} to control servo
 -h             Print this help messege

sample use to center servo channel 1:
   rc_test_servo -c 1 -p 0.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>The BeagleBone Blue sends these eight outputs to it&#8217;s servo channels.  The Black and the Pocket use the pins shown in this table.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. PRU register to pin table</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pru pin</th>
<th class="tableblock halign-left valign-top">Blue pin</th>
<th class="tableblock halign-left valign-top">Black pin</th>
<th class="tableblock halign-left valign-top">Pocket pin</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pru1_r30_8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_27</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.35</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pru1_r30_10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_28</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.35</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pru1_r30_9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_29</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.02</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pru1_r30_11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_30</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.04</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pru1_r30_6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_39</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pru1_r30_7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_40</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pru1_r30_4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_41</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pru1_r30_5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_42</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_discussion_3"><a class="link" href="#_discussion_3">2.1.6. Discussion</a></h4>
<div class="paragraph">
<p>This comes from:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/beagleboard/pocketbeagle/wiki/System-Reference-Manual#673_PRUICSS_Pin_Access" class="bare">https://github.com/beagleboard/pocketbeagle/wiki/System-Reference-Manual#673_PRUICSS_Pin_Access</a></p>
</li>
<li>
<p>[/opt/source/Robotics_Cape_Installer/pru_firmware/src/pru1-servo.asm]</p>
</li>
<li>
<p><a href="https://github.com/derekmolloy/exploringBB/blob/master/chp06/docs/BeagleboneBlackP8HeaderTable.pdf" class="bare">https://github.com/derekmolloy/exploringBB/blob/master/chp06/docs/BeagleboneBlackP8HeaderTable.pdf</a></p>
</li>
<li>
<p><a href="https://github.com/derekmolloy/exploringBB/blob/master/chp06/docs/BeagleboneBlackP9HeaderTable.pdf" class="bare">https://github.com/derekmolloy/exploringBB/blob/master/chp06/docs/BeagleboneBlackP9HeaderTable.pdf</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_problem_5"><a class="link" href="#_problem_5">2.1.7. Problem</a></h4>
<div class="paragraph">
<p><code>rc_test_servos</code> is nice, but I need to control the servos individually.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_5"><a class="link" href="#_solution_5">2.1.8. Solution</a></h4>
<div class="paragraph">
<p>You can modify <code>rc_test_servos.c</code>.  You&#8217;ll find it on the bone at
<code>/opt/source/Robotics_Cape_Installer/examples/src/rc_test_servos.c</code>, or online at
<a href="https://github.com/StrawsonDesign/Robotics_Cape_Installer/blob/master/examples/src/rc_test_servos.c" class="bare">https://github.com/StrawsonDesign/Robotics_Cape_Installer/blob/master/examples/src/rc_test_servos.c</a>.</p>
</div>
<div class="paragraph">
<p>Just past line 250 you&#8217;ll find a <code>while</code> loop that has calls to <code>rc_servo_send_pulse_normalized(ch,servo_pos)</code> and
<code>rc_servo_send_pulse_us(ch, width_us)</code>.  The first call sets the pulse width relative to the pulse period; the other
sets the width to an absolute time.  Use whichever works for you.</p>
</div>
</div>
<div class="sect3">
<h4 id="_problem_6"><a class="link" href="#_problem_6">2.1.9. Problem</a></h4>
<div class="paragraph">
<p>I need more than eight PWM channels, or I need less jitter on the off time.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_6"><a class="link" href="#_solution_6">2.1.10. Solution</a></h4>
<div class="paragraph">
<p>This is a more advanced problem and required reprograming the PRUs.  See
<a href="../05blocks/blocks.html">Building Blocks - Applications</a> for an example.</p>
</div>
</div>
<div class="sect3">
<h4 id="_problem_7"><a class="link" href="#_problem_7">2.1.11. Problem</a></h4>
<div class="paragraph">
<p>I want to use four encoders to measure four motors, but I only see hardware for three.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_7"><a class="link" href="#_solution_7">2.1.12. Solution</a></h4>
<div class="paragraph">
<p>The forth encoder can be implemented on the PRU. If you run <code>rc_test_encoders_eqep</code> on the Blue, you will see the output of
encoders E1-E3 which are connected to the eEQP hardware.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">bone$ rc_test_encoders_eqep

Raw encoder positions
      E1   |      E2   |      E3   |
         0 |         0 |         0 |^C</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also access these hardware encoders on the Black and Pocket using the pins shown below.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 2. eQEP to pin mapping</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">eQEP</th>
<th class="tableblock halign-left valign-top">Blue pin</th>
<th class="tableblock halign-left valign-top">Black pin A</th>
<th class="tableblock halign-left valign-top">Black pin B</th>
<th class="tableblock halign-left valign-top">Pocket pin A</th>
<th class="tableblock halign-left valign-top">Pocket pin B</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_42B</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_27</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.31</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.24</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_35</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_33</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.10</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.24</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.33</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_41</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_42</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.09</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.18</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You will need to first configure the pins using
.encoder.sh</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">#!/bin/bash
# Configure the pins based on which Beagle is running
machine=$(awk '{print $NF}' /proc/device-tree/model)
echo -n $machine

# Configure eQEP pins
if [ $machine = &quot;Black&quot; ]; then
    echo &quot; Found&quot;
    pins=&quot;P9_92 P9_27 P8_35 P8_33 P8_12 P8_11 P8_41 P8_42&quot;
elif [ $machine = &quot;Blue&quot; ]; then
    echo &quot; Found&quot;
    pins=&quot;&quot;
elif [ $machine = &quot;PocketBeagle&quot; ]; then
    echo &quot; Found&quot;
    pins=&quot;P1_31 P2_34 P2_10 P2_24 P2_33&quot;
else
    echo &quot; Not Found&quot;
    pins=&quot;&quot;
fi

for pin in $pins
do
    echo $pin
    config-pin $pin qep
    config-pin -q $pin
done

##########################################
# Configure PRU pins
if [ $machine = &quot;Black&quot; ]; then
    echo &quot; Found&quot;
    pins=&quot;P8_16 P8_15&quot;
elif [ $machine = &quot;Blue&quot; ]; then
    echo &quot; Found&quot;
    pins=&quot;&quot;
elif [ $machine = &quot;PocketBeagle&quot; ]; then
    echo &quot; Found&quot;
    pins=&quot;P2_09 P2_18&quot;
else
    echo &quot; Not Found&quot;
    pins=&quot;&quot;
fi

for pin in $pins
do
    echo $pin
    config-pin $pin pruin
    config-pin -q $pin
done</code></pre>
</div>
</div>
<div class="paragraph">
<p>The eQEP pins are configured with the top half of the code.</p>
</div>
</div>
<div class="sect3">
<h4 id="_problem_8"><a class="link" href="#_problem_8">2.1.13. Problem</a></h4>
<div class="paragraph">
<p>I want to access the PRU encoder.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_8"><a class="link" href="#_solution_8">2.1.14. Solution</a></h4>
<div class="paragraph">
<p>The forth encoder is implemented on the PRU and accessed with <code>sudo rc_test_encoders_pru</code></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This command
needs root permissions, so the <code>sudo</code> is needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here&#8217;s what you will see</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">bone$ sudo rc_test_encoders_pru
[sudo] password for debian:

Raw encoder position
      E4   |
         0 |^C</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you aren&#8217;t running the Blue you will have to configure the pins as shown above.  The bottom half of the code
does the PRU configuring.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_beaglelogic"><a class="link" href="#_beaglelogic">2.2. BeagleLogic</a></h3>
<div class="sect3">
<h4 id="_problem_9"><a class="link" href="#_problem_9">2.2.1. Problem</a></h4>
<div class="paragraph">
<p>I need a 100Msps, 14-channel logic analyzer</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_9"><a class="link" href="#_solution_9">2.2.2. Solution</a></h4>
<div class="paragraph">
<p><a href="https://github.com/abhishek-kakkar/BeagleLogic/wiki">BeagleLogic</a> is a 100Msps, 14-channel logic analyzer that runs on the
Beagle. The quickest solution is to get the <a href="https://github.com/abhishek-kakkar/BeagleLogic/wiki/BeagleLogic-%22no-setup-required%22-setup:-Introducing-System-Image!">no-setup-required image</a>.  It runs on an older image (15-Apr-2016) but should still work.</p>
</div>
<div class="paragraph">
<p>If you want to be running a newer image, there are instructions on the site for <a href="https://github.com/abhishek-kakkar/BeagleLogic/wiki/Build-BeagleLogic">building BeagleLogic from scratch</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_4"><a class="link" href="#_discussion_4">2.2.3. Discussion</a></h4>
<div class="paragraph">
<p>BeagleLogic uses the two PRUs to sample at 100Msps.  Getting a PRU running at 200Hz to sample at 100Msps is a slick trick.
<a href="http://theembeddedkitchen.net/beaglelogic-building-a-logic-analyzer-with-the-prus-part-1/449">The Embedded Kitchen</a> has a nice article
explaining how the PRUs get this type of performance.   In section
<a href="../05blocks/blocks.html">Building Blocks</a> we&#8217;ll give an overview of the technique.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_machinekit"><a class="link" href="#_machinekit">2.3. MachineKit</a></h3>
<div class="paragraph">
<p>MachineKit is a platform for machine control applications.  It can control
machine tools, robots, or other automated devices. It can control servo
motors, stepper motors, relays, and other devices related to machine tools.</p>
</div>
</div>
<div class="sect2">
<h3 id="_ledscape"><a class="link" href="#_ledscape">2.4. LEDScape</a></h3>

</div>
<div class="sect2">
<h3 id="_ardupilot"><a class="link" href="#_ardupilot">2.5. ArduPilot</a></h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="_details_on_compiling_and_running_a_file"><a class="link" href="#_details_on_compiling_and_running_a_file">3. Details on compiling and running a file</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are a lot details in compiling and running PRU code.
Here are some details on how it works.</p>
</div>
<div class="sect2">
<h3 id="_problem_10"><a class="link" href="#_problem_10">3.1. Problem</a></h3>
<div class="paragraph">
<p>There are all sorts of options that need to be set when compiling
a program.  How can I be sure to get them all right?</p>
</div>
</div>
<div class="sect2">
<h3 id="_solution_10"><a class="link" href="#_solution_10">3.2. Solution</a></h3>
<div class="paragraph">
<p>The surest way to make sure everything is right is to use our
standard Makefile.</p>
</div>
</div>
<div class="sect2">
<h3 id="_discussion_5"><a class="link" href="#_discussion_5">3.3. Discussion</a></h3>
<div class="paragraph">
<p>It&#8217;s assumed you alrady know how Makefiles work.  If not, there are
many resources on line that can bring you up to speed.</p>
</div>
<div class="paragraph">
<p>Here is the stardard Makefile (<code>Makefile</code>) used throughout.</p>
</div>
<div class="listingblock">
<div class="title">Standard Makefile</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="makefile">#
# Copyright (c) 2016 Zubeen Tolani &lt;ZeekHuge - zeekhuge@gmail.com&gt;
# Copyright (c) 2017 Texas Instruments - Jason Kridner &lt;jdk@ti.com&gt;
#

# TARGET must be defined
# PRUN must be defined

# PRU_CGT environment variable must point to the TI PRU compiler directory.
# PRU_SUPPORT points to pru-software-support-package
PRU_CGT:=/usr/share/ti/cgt-pru
PRU_SUPPORT:=/usr/lib/ti/pru-software-support-package

LINKER_COMMAND_FILE=$(dir $(realpath $(firstword $(MAKEFILE_LIST))))/AM335x_PRU.cmd
LIBS=--library=$(PRU_SUPPORT)/lib/rpmsg_lib.lib
INCLUDE=--include_path=$(PRU_SUPPORT)/include --include_path=$(PRU_SUPPORT)/include/am335x
STACK_SIZE=0x100
HEAP_SIZE=0x100

CFLAGS=-v3 -O2 --display_error_number --endian=little --hardware_mac=on --obj_directory=$(GEN_DIR) --pp_directory=$(GEN_DIR) --asm_directory=$(GEN_DIR) -ppd -ppa --asm_listing --c_src_interlist # --absolute_listing
LFLAGS=--reread_libs --warn_sections --stack_size=$(STACK_SIZE) --heap_size=$(HEAP_SIZE) -m $(GEN_DIR)/file.map

GEN_DIR=/tmp/pru$(PRUN)-gen

# Lookup PRU by address
ifeq ($(PRUN),0)
PRU_ADDR=4a334000
endif
ifeq ($(PRUN),1)
PRU_ADDR=4a338000
endif

PRU_DIR=$(wildcard /sys/devices/platform/ocp/4a326000.pruss-soc-bus/4a300000.pruss/$(PRU_ADDR).*/remoteproc/remoteproc*)

all: stop install start

stop:
        @echo &quot;-    Stopping PRU $(PRUN)&quot;
        @echo stop | sudo tee $(PRU_DIR)/state || echo Cannot stop $(PRUN)

start:
        @echo &quot;-    Starting PRU $(PRUN)&quot;
        @echo start | sudo tee $(PRU_DIR)/state

install: $(GEN_DIR)/$(TARGET).out
        @echo '-        copying firmware file $(GEN_DIR)/$(TARGET).out to /lib/firmware/am335x-pru$(PRUN)-fw'
        @sudo cp $(GEN_DIR)/$(TARGET).out /lib/firmware/am335x-pru$(PRUN)-fw

$(GEN_DIR)/$(TARGET).out: $(GEN_DIR)/$(TARGET).obj
        @echo 'LD        $^'
        @lnkpru -i$(PRU_CGT)/lib -i$(PRU_CGT)/include $(LFLAGS) -o $@ $^ $(LINKER_COMMAND_FILE) --library=libc.a $(LIBS) $^

$(GEN_DIR)/$(TARGET).obj: $(TARGET).c
        @mkdir -p $(GEN_DIR)
        @echo 'CC        $&lt;'
        @clpru --include_path=$(PRU_CGT)/include $(INCLUDE) $(CFLAGS) -fe $@ $&lt;

clean:
        @echo 'CLEAN        .    PRU $(PRUN)'
        @rm -rf $(GEN_DIR)</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_debugging_and_benchmarking"><a class="link" href="#_debugging_and_benchmarking">4. Debugging and Benchmarking</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here&#8217;s where we learn how to debug. On of the challenges is getting debug
information out without slowing the real-time execution.</p>
</div>
<div class="sect2">
<h3 id="_led_and_switch_for_debugging"><a class="link" href="#_led_and_switch_for_debugging">4.1. LED and switch for debugging</a></h3>

</div>
<div class="sect2">
<h3 id="_oscilloscope"><a class="link" href="#_oscilloscope">4.2. Oscilloscope</a></h3>

</div>
<div class="sect2">
<h3 id="_dmesg_hw"><a class="link" href="#_dmesg_hw">4.3. dmesg Hw</a></h3>
<div class="sect3">
<h4 id="_problem_11"><a class="link" href="#_problem_11">4.3.1. Problem</a></h4>
<div class="paragraph">
<p>I&#8217;m getting an error message (<code>/sys/devices/platform/ocp/4a326000.pruss-soc-bus/4a300000.pruss/4a334000.pru0/remoteproc/remoteproc1/state: Invalid argument</code>)
when I load my code, but don&#8217;t know what&#8217;s causing it.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_11"><a class="link" href="#_solution_11">4.3.2. Solution</a></h4>
<div class="paragraph">
<p>The command <code>dmesg</code> outputs usefull information when dealing with the kernel.
Simplying running <code>dmesg -H</code> can tell you a lot.  The <code>-H</code> flag puts the
dates in the human readable for.  Often I&#8217;ll have a window open running <code>dmesg -Hw</code>;
the <code>-w</code> tells it to wait for more information.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s what <code>dmesg</code> said for the example above.</p>
</div>
<div class="listingblock">
<div class="title">dmesg -Hw</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre>[  +0.000018] remoteproc remoteproc1: header-less resource table
[  +0.011879] remoteproc remoteproc1: Failed to find resource table
[  +0.008770] remoteproc remoteproc1: Boot failed: -22</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>It quickly told me I needed to add the line <code>#include "resource_table_empty.h"</code>
to my code.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_prubug"><a class="link" href="#_prubug">4.4. prubug?</a></h3>

</div>
<div class="sect2">
<h3 id="_uart"><a class="link" href="#_uart">4.5. UART</a></h3>
<div class="sect3">
<h4 id="_problem_12"><a class="link" href="#_problem_12">4.5.1. Problem</a></h4>
<div class="paragraph">
<p>I&#8217;d like to use something like <code>printf()</code> to debug my code.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_12"><a class="link" href="#_solution_12">4.5.2. Solution</a></h4>
<div class="paragraph">
<p>One simple, yet effective approach to 'printing' from the PRU is
an idea taken from the Adruino playbook;
use the UART (serial port) to output debug information.  The PRU has it&#8217;s
own UART that can send characters to a serial port.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_6"><a class="link" href="#_discussion_6">4.5.3. Discussion</a></h4>
<div class="paragraph">
<p>Two examples of using the UART are presented here.  The first (<code>uart1.c</code>) Sends
a character out the serial port then waits for a character to come in.  Once
the new character arrives another character is output.</p>
</div>
<div class="paragraph">
<p>The second example (<code>uart2.c</code>) prints out a string and then waits for characters to arrive.
Once an ENTER appears the string is sent back.</p>
</div>
<div class="paragraph">
<p>For either of these you will need to set the pin muxes.
.config-pin</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre># Configure tx
bone$ config-pin P9_24 pru_uart
# Configure rx
bone$ config-pin P9_26 pru_uart</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_uart1_c"><a class="link" href="#_uart1_c">uart1.c</a></h5>
<div class="paragraph">
<p>Set the following variables so <code>make</code> will know what to compile.
.make</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre>bone$ export PRUN=0
bone$ export TARGET=uart1
bone$ make</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now <code>make</code> will compile, load PRU0 and start it.  In a terminal window run</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>bone$ screen /dev/ttyUSB0 115200</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>It will initially display the first charters (<code>H</code>) and then as you enter
characters on the keyboard, the rest of the message will appear.</p>
</div>
<div class="paragraph">
<div class="title">uart1.c output</div>
<p><span class="image"><img src="figures/uart1.png" alt="uart1.c output"></span></p>
</div>
<div class="paragraph">
<p>Here&#8217;s the code (<code>uart1.c</code>) that does it.</p>
</div>
<div class="listingblock">
<div class="title">uart1.c</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
</pre></td>
  <td class="code"><pre><span class="comment">// From: http://git.ti.com/pru-software-support-package/pru-software-support-package/trees/master/examples/am335x/PRU_Hardware_UART</span>

<span class="preprocessor">#include</span> <span class="include">&lt;stdint.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_uart.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;resource_table_empty.h&quot;</span>

<span class="comment">/* The FIFO size on the PRU UART is 16 bytes; however, we are (arbitrarily)
 * only going to send 8 at a time */</span>
<span class="preprocessor">#define</span> FIFO_SIZE        <span class="integer">16</span>
<span class="preprocessor">#define</span> MAX_CHARS        <span class="integer">8</span>

<span class="directive">void</span> main(<span class="directive">void</span>)
{
        uint8_t tx;
        uint8_t rx;
        uint8_t cnt;

        <span class="comment">/*  hostBuffer points to the string to be printed */</span>
        <span class="predefined-type">char</span>* hostBuffer;

        <span class="comment">/* TODO: If modifying this to send data through the pins then PinMuxing
         * needs to be taken care of prior to running this code.  */</span>

        <span class="comment">/*** INITIALIZATION ***/</span>

        <span class="comment">/* Set up UART to function at 115200 baud - DLL divisor is 104 at 16x oversample
         * 192MHz / 104 / 16 = ~115200 */</span>
        CT_UART.DLL = <span class="integer">104</span>;
        CT_UART.DLH = <span class="integer">0</span>;
        CT_UART.MDR = <span class="hex">0x0</span>;

        <span class="comment">/* Enable Interrupts in UART module. This allows the main thread to poll for
         * Receive Data Available and Transmit Holding Register Empty */</span>
        CT_UART.IER = <span class="hex">0x7</span>;

        <span class="comment">/* If FIFOs are to be used, select desired trigger level and enable
         * FIFOs by writing to FCR. FIFOEN bit in FCR must be set first before
         * other bits are configured */</span>
        <span class="comment">/* Enable FIFOs for now at 1-byte, and flush them */</span>
        CT_UART.FCR = (<span class="hex">0x8</span>) | (<span class="hex">0x4</span>) | (<span class="hex">0x2</span>) | (<span class="hex">0x1</span>);
        <span class="comment">//CT_UART.FCR = (0x80) | (0x4) | (0x2) | (0x01); // 8-byte RX FIFO trigger</span>

        <span class="comment">/* Choose desired protocol settings by writing to LCR */</span>
        <span class="comment">/* 8-bit word, 1 stop bit, no parity, no break control and no divisor latch */</span>
        CT_UART.LCR = <span class="integer">3</span>;

        <span class="comment">/* Enable loopback for test */</span>
        CT_UART.MCR = <span class="hex">0x00</span>;

        <span class="comment">/* Choose desired response to emulation suspend events by configuring
         * FREE bit and enable UART by setting UTRST and URRST in PWREMU_MGMT */</span>
        <span class="comment">/* Allow UART to run free, enable UART TX/RX */</span>
        CT_UART.PWREMU_MGMT = <span class="hex">0x6001</span>;

        <span class="comment">/*** END INITIALIZATION ***/</span>

        <span class="comment">/* Priming the 'hostbuffer' with a message */</span>
        hostBuffer = <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello!  This is a long string</span><span class="char">\r</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>;

        <span class="comment">/*** SEND SOME DATA ***/</span>

        <span class="comment">/* Let's send/receive some dummy data */</span>
        <span class="keyword">while</span>(<span class="integer">1</span>) {
                cnt = <span class="integer">0</span>;
                <span class="keyword">while</span>(<span class="integer">1</span>) {
                        <span class="comment">/* Load character, ensure it is not string termination */</span>
                        <span class="keyword">if</span> ((tx = hostBuffer[cnt]) == <span class="char">'\0'</span>)
                                <span class="keyword">break</span>;
                        cnt++;
                        CT_UART.THR = tx;

                        <span class="comment">/* Because we are doing loopback, wait until LSR.DR == 1
                         * indicating there is data in the RX FIFO */</span>
                        <span class="keyword">while</span> ((CT_UART.LSR &amp; <span class="hex">0x1</span>) == <span class="hex">0x0</span>);

                        <span class="comment">/* Read the value from RBR */</span>
                        rx = CT_UART.RBR;

                        <span class="comment">/* Wait for TX FIFO to be empty */</span>
                        <span class="keyword">while</span> (!((CT_UART.FCR &amp; <span class="hex">0x2</span>) == <span class="hex">0x2</span>));
                }
        }

        <span class="comment">/*** DONE SENDING DATA ***/</span>

        <span class="comment">/* Disable UART before halting */</span>
        CT_UART.PWREMU_MGMT = <span class="hex">0x0</span>;

        <span class="comment">/* Halt PRU core */</span>
        __halt();
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The first part of the code initializes the UART. Then the line <code>CT_UART.THR = tx;</code>
takes a character in <code>tx</code> and sends it to the transmit buffer on the UART.
Think of this as the UART version of the <code>printf()</code>.</p>
</div>
<div class="paragraph">
<p>Later the line <code>while (!CT_UART.FCR &amp; 0x2) == 0x2;</code>
waits for the transmit FIFO to be empty.  This makes sure later characters
won&#8217;t overwrite the buffer before they can be sent.  The downside is, this will
cause your code to wait on the buffer and it might miss an important
real-time event.</p>
</div>
<div class="paragraph">
<p>The line <code>while ((CT_UART.LSR &amp; 0x1) == 0x0);</code> waits for an input from the
UART (possibly missing something) and <code>rx = CT_UART.RBR;</code> reads from the
receive register on the UART.</p>
</div>
<div class="paragraph">
<p>These simple lines should be enough to place in your code to print out
debugging information.</p>
</div>
</div>
<div class="sect4">
<h5 id="_uart2_c"><a class="link" href="#_uart2_c">uart2.c</a></h5>
<div class="paragraph">
<p>If you want to try <code>uart2.c</code>, run the following:
.make</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre>bone$ export PRUN=0
bone$ export TARGET=uart2
bone$make</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>You will see:</p>
</div>
<div class="paragraph">
<div class="title">uart2.c output</div>
<p><span class="image"><img src="figures/uart2.png" alt="uart2.c output"></span></p>
</div>
<div class="paragraph">
<p>Type a few characters and hit ENTER.  The PRU will playback what you typed,
but it won&#8217;t echo it as you type.</p>
</div>
<div class="paragraph">
<p><code>uart2.c</code> defines <code>PrintMessageOut()</code> which is passed a string that is
sent to the UART. It take advantage of the eight character FIFO on the UART.
Be careful using it because it also uses <code>while (!CT_UART.LSR_bit.TEMT);</code> to
wait for the FIFO to empty, which may cause your code to miss something.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the code (<code>uart2.c</code>) that does it.</p>
</div>
<div class="listingblock">
<div class="title">uart2.c</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
</pre></td>
  <td class="code"><pre><span class="comment">// From: http://git.ti.com/pru-software-support-package/pru-software-support-package/trees/master/pru_cape/pru_fw/PRU_Hardware_UART</span>

<span class="preprocessor">#include</span> <span class="include">&lt;stdint.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_uart.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;resource_table_empty.h&quot;</span>

<span class="comment">/* The FIFO size on the PRU UART is 16 bytes; however, we are (arbitrarily)
 * only going to send 8 at a time */</span>
<span class="preprocessor">#define</span> FIFO_SIZE        <span class="integer">16</span>
<span class="preprocessor">#define</span> MAX_CHARS        <span class="integer">8</span>
<span class="preprocessor">#define</span> BUFFER                <span class="integer">40</span>

<span class="comment">//******************************************************************************</span>
<span class="comment">//    Print Message Out</span>
<span class="comment">//      This function take in a string literal of any size and then fill the</span>
<span class="comment">//      TX FIFO when it's empty and waits until there is info in the RX FIFO</span>
<span class="comment">//      before returning.</span>
<span class="comment">//******************************************************************************</span>
<span class="directive">void</span> PrintMessageOut(<span class="directive">volatile</span> <span class="predefined-type">char</span>* Message)
{
        uint8_t cnt, index = <span class="integer">0</span>;

        <span class="keyword">while</span> (<span class="integer">1</span>) {
                cnt = <span class="integer">0</span>;

                <span class="comment">/* Wait until the TX FIFO and the TX SR are completely empty */</span>
                <span class="keyword">while</span> (!CT_UART.LSR_bit.TEMT);

                <span class="keyword">while</span> (Message[index] != <span class="predefined-constant">NULL</span> &amp;&amp; cnt &lt; MAX_CHARS) {
                        CT_UART.THR = Message[index];
                        index++;
                        cnt++;
                }
                <span class="keyword">if</span> (Message[index] == <span class="predefined-constant">NULL</span>)
                        <span class="keyword">break</span>;
        }

        <span class="comment">/* Wait until the TX FIFO and the TX SR are completely empty */</span>
        <span class="keyword">while</span> (!CT_UART.LSR_bit.TEMT);

}

<span class="comment">//******************************************************************************</span>
<span class="comment">//    IEP Timer Config</span>
<span class="comment">//      This function waits until there is info in the RX FIFO and then returns</span>
<span class="comment">//      the first character entered.</span>
<span class="comment">//******************************************************************************</span>
<span class="predefined-type">char</span> ReadMessageIn(<span class="directive">void</span>)
{
        <span class="keyword">while</span> (!CT_UART.LSR_bit.DR);

        <span class="keyword">return</span> CT_UART.RBR_bit.DATA;
}

<span class="directive">void</span> main(<span class="directive">void</span>)
{
        uint32_t i;
        <span class="directive">volatile</span> uint32_t not_done = <span class="integer">1</span>;

        <span class="predefined-type">char</span> rxBuffer[BUFFER];
        rxBuffer[BUFFER-<span class="integer">1</span>] = <span class="predefined-constant">NULL</span>; <span class="comment">// null terminate the string</span>

        <span class="comment">/*** INITIALIZATION ***/</span>

        <span class="comment">/* Set up UART to function at 115200 baud - DLL divisor is 104 at 16x oversample
         * 192MHz / 104 / 16 = ~115200 */</span>
        CT_UART.DLL = <span class="integer">104</span>;
        CT_UART.DLH = <span class="integer">0</span>;
        CT_UART.MDR_bit.OSM_SEL = <span class="hex">0x0</span>;

        <span class="comment">/* Enable Interrupts in UART module. This allows the main thread to poll for
         * Receive Data Available and Transmit Holding Register Empty */</span>
        CT_UART.IER = <span class="hex">0x7</span>;

        <span class="comment">/* If FIFOs are to be used, select desired trigger level and enable
         * FIFOs by writing to FCR. FIFOEN bit in FCR must be set first before
         * other bits are configured */</span>
        <span class="comment">/* Enable FIFOs for now at 1-byte, and flush them */</span>
        CT_UART.FCR = (<span class="hex">0x80</span>) | (<span class="hex">0x8</span>) | (<span class="hex">0x4</span>) | (<span class="hex">0x2</span>) | (<span class="hex">0x01</span>); <span class="comment">// 8-byte RX FIFO trigger</span>

        <span class="comment">/* Choose desired protocol settings by writing to LCR */</span>
        <span class="comment">/* 8-bit word, 1 stop bit, no parity, no break control and no divisor latch */</span>
        CT_UART.LCR = <span class="integer">3</span>;

        <span class="comment">/* If flow control is desired write appropriate values to MCR. */</span>
        <span class="comment">/* No flow control for now, but enable loopback for test */</span>
        CT_UART.MCR = <span class="hex">0x00</span>;

        <span class="comment">/* Choose desired response to emulation suspend events by configuring
         * FREE bit and enable UART by setting UTRST and URRST in PWREMU_MGMT */</span>
        <span class="comment">/* Allow UART to run free, enable UART TX/RX */</span>
        CT_UART.PWREMU_MGMT_bit.FREE = <span class="hex">0x1</span>;
        CT_UART.PWREMU_MGMT_bit.URRST = <span class="hex">0x1</span>;
        CT_UART.PWREMU_MGMT_bit.UTRST = <span class="hex">0x1</span>;

        <span class="comment">/* Turn off RTS and CTS functionality */</span>
        CT_UART.MCR_bit.AFE = <span class="hex">0x0</span>;
        CT_UART.MCR_bit.RTS = <span class="hex">0x0</span>;

        <span class="comment">/*** END INITIALIZATION ***/</span>

        <span class="keyword">while</span>(<span class="integer">1</span>) {
                <span class="comment">/* Print out greeting message */</span>
                PrintMessageOut(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello you are in the PRU UART demo test please enter some characters</span><span class="char">\r</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);

                <span class="comment">/* Read in 5 characters from user, then echo them back out */</span>
                <span class="keyword">for</span> (i = <span class="integer">0</span>; i &lt; BUFFER-<span class="integer">1</span> ; i++) {
                        rxBuffer[i] = ReadMessageIn();
                        <span class="keyword">if</span>(rxBuffer[i] == <span class="char">'\r'</span>) {        <span class="comment">// Quit early if ENTER is hit.</span>
                                rxBuffer[i+<span class="integer">1</span>] = <span class="predefined-constant">NULL</span>;
                                <span class="keyword">break</span>;
                        }
                }

                PrintMessageOut(<span class="string"><span class="delimiter">&quot;</span><span class="content">you typed:</span><span class="char">\r</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);
                PrintMessageOut(rxBuffer);
                PrintMessageOut(<span class="string"><span class="delimiter">&quot;</span><span class="char">\r</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);
        }

        <span class="comment">/*** DONE SENDING DATA ***/</span>
        <span class="comment">/* Disable UART before halting */</span>
        CT_UART.PWREMU_MGMT = <span class="hex">0x0</span>;

        <span class="comment">/* Halt PRU core */</span>
        __halt();
}</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_building_blocks_applications"><a class="link" href="#_building_blocks_applications">5. Building Blocks - Applications</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here are some examples that use the basic PRU building blocks.</p>
</div>
<div class="sect2">
<h3 id="_pwm_generator"><a class="link" href="#_pwm_generator">5.1. PWM generator</a></h3>
<div class="paragraph">
<p>One of the simplest things a PRU can to is generate a simple
problems starting with a single channel PWM that has a fixed frequency and
duty cycle and ending with a multi channel PWM that the ARM can change
the frequency and duty cycle on the fly.</p>
</div>
<div class="sect3">
<h4 id="_problem_13"><a class="link" href="#_problem_13">5.1.1. Problem</a></h4>
<div class="paragraph">
<p>I want to generate a PWM signal that has a fixed frequency and duty cycle.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_13"><a class="link" href="#_solution_13">5.1.2. Solution</a></h4>
<div class="paragraph">
<p>The solution is fairly easy, but be sure to check the <strong>Discussion</strong> section
for details on making it work.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the code.</p>
</div>
<div class="listingblock">
<div class="title">pwm1.c</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td>
  <td class="code"><pre><span class="preprocessor">#include</span> <span class="include">&lt;stdint.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_cfg.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;resource_table_empty.h&quot;</span>

<span class="directive">volatile</span> <span class="directive">register</span> uint32_t __R30;
<span class="directive">volatile</span> <span class="directive">register</span> uint32_t __R31;

<span class="directive">void</span> main(<span class="directive">void</span>)
{
        uint32_t gpio;

        <span class="comment">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
        CT_CFG.SYSCFG_bit.STANDBY_INIT = <span class="integer">0</span>;

        gpio = <span class="hex">0x0001</span>;        <span class="comment">// Select which pin to toggle.</span>

        <span class="keyword">while</span> (<span class="integer">1</span>) {
                __R30 |= gpio;                <span class="comment">// Set the GPIO pin to 1</span>
                __delay_cycles(<span class="integer">100000000</span>);
                __R30 &amp;= ~gpio;                <span class="comment">// Clearn the GPIO pin</span>
                __delay_cycles(<span class="integer">100000000</span>);
        }
}
</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>To run this code you need to configure the pin muxes to output the PRU.  If you are on the Black run</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>config-pin P9_31 pruout</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>On the Pocket run</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>config-pin P1_36 pruout</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, tell Makefile which PRU you are compiling for and what your target file is</p>
</div>
<div class="literalblock">
<div class="content">
<pre>bone$ export PRUN=0
bone$ export TARGET=pwm1</pre>
</div>
</div>
<div class="paragraph">
<p>Now you are ready to compile</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
</pre></td>
  <td class="code"><pre>make
-    Stopping PRU 0
stop
CC        pwm1.c
LD        /tmp/pru0-gen/pwm1.obj
-        copying firmware file /tmp/pru0-gen/pwm1.out to /lib/firmware/am335x-pru0-fw
-    Starting PRU 0
start</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now attach and LED (or oscilloscope) to <code>P9_31</code> on the Black or <code>P1.36</code> on the Pocket.  You should see a squarewave.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_7"><a class="link" href="#_discussion_7">5.1.3. Discussion</a></h4>
<div class="paragraph">
<p>Since this is our first example we&#8217;ll discuss the many parts in detail.</p>
</div>
<div class="sect4">
<h5 id="_pwm1_c"><a class="link" href="#_pwm1_c">pwm1.c</a></h5>
<div class="paragraph">
<p>Here&#8217;s a line-by-line expanation of the c code.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 3. Line-by-line</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Explantion</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Standard c-header include</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Include for the PRU.  The compiler know where to find this since the Makefile says to look for includes in <code>/usr/lib/ti/pru-software-support-package</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The file <code>resource_table_empty.h</code> is used by the PRU loader.  Generally we&#8217;ll use the same file, and don&#8217;t need to modify it.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Here&#8217;s what&#8217;s in <code>resource_table_empty.h</code>
.resource_table_empty.c</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td>
  <td class="code"><pre><span class="comment">/*
 *  ======== resource_table_empty.h ========
 *
 *  Define the resource table entries for all PRU cores. This will be
 *  incorporated into corresponding base images, and used by the remoteproc
 *  on the host-side to allocated/reserve resources.  Note the remoteproc
 *  driver requires that all PRU firmware be built with a resource table.
 *
 *  This file contains an empty resource table.  It can be used either as:
 *
 *        1) A template, or
 *        2) As-is if a PRU application does not need to configure PRU_INTC
 *                  or interact with the rpmsg driver
 *
 */</span>

<span class="preprocessor">#ifndef</span> _RSC_TABLE_PRU_H_
<span class="preprocessor">#define</span> _RSC_TABLE_PRU_H_

<span class="preprocessor">#include</span> <span class="include">&lt;stddef.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;rsc_types.h&gt;</span>

<span class="keyword">struct</span> my_resource_table {
        <span class="keyword">struct</span> resource_table base;

        uint32_t offset[<span class="integer">1</span>]; <span class="comment">/* Should match 'num' in actual definition */</span>
};

<span class="preprocessor">#pragma</span> DATA_SECTION(pru_remoteproc_ResourceTable, <span class="string"><span class="delimiter">&quot;</span><span class="content">.resource_table</span><span class="delimiter">&quot;</span></span>)
<span class="preprocessor">#pragma</span> RETAIN(pru_remoteproc_ResourceTable)
<span class="keyword">struct</span> my_resource_table pru_remoteproc_ResourceTable = {
        <span class="integer">1</span>,        <span class="comment">/* we're the first version that implements this */</span>
        <span class="integer">0</span>,        <span class="comment">/* number of entries in the table */</span>
        <span class="integer">0</span>, <span class="integer">0</span>,        <span class="comment">/* reserved, must be zero */</span>
        <span class="integer">0</span>,        <span class="comment">/* offset[0] */</span>
};

<span class="preprocessor">#endif</span> <span class="comment">/* _RSC_TABLE_PRU_H_ */</span>
</pre></td>
</tr></table></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 4. Line-by-line (continuted)</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Explantion</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5-6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><em>R30</code> and <code></em>R31</code> are two variables that refer to the PRU output (<code><em>R30</code>) and input (<code></em>R31</code>) registers.
When you write something to <code><em>R30</code> it will show up on the corresponding output pins.
When you read from <code></em>R31</code> you read the data on the input pins.
NOTE: Both names begin with two underscore&#8217;s. Section 5.7.2 of the [PRU Optimizing C/C++ Compiler, v2.2,
User&#8217;s Guide](<a href="http://www.ti.com/lit/ug/spruhv7b/spruhv7b.pdf" class="bare">http://www.ti.com/lit/ug/spruhv7b/spruhv7b.pdf</a>) gives more details.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">13</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CT_CFG.SYSCFG_bit.STANDBY_INIT</code> is set to <code>0</code> to enable the OCP master port. More details on this and thousands of other regesters see the [AM335x Technical Reference Manual](<a href="https://www.ti.com/lit/ug/spruh73p/spruh73p.pdf" class="bare">https://www.ti.com/lit/ug/spruh73p/spruh73p.pdf</a>). Section 4 is on the PRU and section 4.5 gives details for all the registers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This line selects which GPIO pin to toggle.  The table below shows which bits in <code>__R30</code> map to which pins</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Bit 0 is the LSB.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 5. Mapping bit positions to pin names</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">PRU</th>
<th class="tableblock halign-left valign-top">Bit</th>
<th class="tableblock halign-left valign-top">Black pin</th>
<th class="tableblock halign-left valign-top">Blue pin</th>
<th class="tableblock halign-left valign-top">Pocket pin</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_31</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.36</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_29</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.33</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_30</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.32</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_28</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.30</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_92</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.31</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_27</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.34</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_91</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.28</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_25</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.29</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_12</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.24</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_11</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.33</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">---</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">---</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">---------</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">--------</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">----------</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_45</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_46</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_43</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_44</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_41</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_42</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_39</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_40</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_27</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.35</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_29</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.01</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_28</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.35</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_30</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.04</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_21</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">13</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_20</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">14</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.32</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.30</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Since we are running on PRU 0 we&#8217;re using <code>0x0001</code>, that is bit 0, we&#8217;ll be toggling <code>P9_31</code>.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 6. Line-by-line (continued again)</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Explantion</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">18</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Here is where the action is.  This line reads <code><em>R30</code> and then ORs it with <code>gpio</code>, setting the bits where there is a 1 in <code>gpio</code> and leaving the bits where there is a 0.  Thus we are setting the bit we selected. Finally the new value is written back to <code></em>R30</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">19</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>__delay_cycles</code> is an instrinsic function that delays with number of cycles passed to it. Each cycle is 5ns, and we are delaying 100,000,000 cycles which is 500,000,000ns, or 0.5 seconds.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">20</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is like line 18, but <code>~gpio</code> inverts all the bits in <code>gpio</code> so that where we had a 1, there is now a 0.  This 0 is then ANDed with <code>__R30</code> setting the corresponding bit to 0.  Thus we are clearing the bit we selected.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can read more about instrinsics in section 5.11 of the (<a href="http://www.ti.com/lit/ug/spruhv7b/spruhv7b.pdf">PRU Optimizing C/C++ Compiler, v2.2, User&#8217;s Guide</a>.)</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When you run this code and look at the output you will see something like the following figure.</p>
</div>
<div class="paragraph">
<div class="title">Output of pwm1.c with 100,000,000 delays cycles giving a 1s period</div>
<p><span class="image"><img src="figures/pwm1.png" alt="pwm1.c output"></span></p>
</div>
<div class="paragraph">
<p>Notice the on time (<code>+Width(1)</code>) is 500ms, just as we predicted.  The off time is 498ms, which is only 2ms off from our prediction.  The standard deviation is 0, or only 380as, which is 380 * 10<sup>-18</sup>!.</p>
</div>
<div class="paragraph">
<p>You can see how fast the PRU can run by setting both of the <code>__delay_cycles</code> to 0. This results in the next figure.</p>
</div>
<div class="paragraph">
<div class="title">Output of pwm1.c with 0 delay cycles</div>
<p><span class="image"><img src="figures/pwm2.png" alt="pwm1.c output with 0 delay"></span></p>
</div>
<div class="paragraph">
<p>Notice the period is 15ns which gives us a frequency of about 67MHz. At this high frequency the breadboard that I&#8217;m using distorts the waveform so it&#8217;s no longer a squarewave. The <em>on</em> time is 5.3ns and the <em>off</em> time is 9.8ns.  That means <code><em>R30 |= gpio;</code> took only one 5ns cycle and <code></em>R30 &amp;= ~gpio;</code> also only took one cycle, but there is also an extra cycle needed for the loop.  This means the compiler was able to implement the while loop in just three 5ns instructions!  Not bad.</p>
</div>
<div class="paragraph">
<p>We want a square wave, so we need to add a delay to correct for the delay of looping back.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the code that does just that.</p>
</div>
<div class="listingblock">
<div class="title">pwm2.c</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td>
  <td class="code"><pre><span class="preprocessor">#include</span> <span class="include">&lt;stdint.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_cfg.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;resource_table_empty.h&quot;</span>

<span class="directive">volatile</span> <span class="directive">register</span> uint32_t __R30;
<span class="directive">volatile</span> <span class="directive">register</span> uint32_t __R31;

<span class="directive">void</span> main(<span class="directive">void</span>)
{
        uint32_t gpio;

        <span class="comment">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
        CT_CFG.SYSCFG_bit.STANDBY_INIT = <span class="integer">0</span>;

        gpio = <span class="hex">0x0001</span>;        <span class="comment">// Select which pin to toggle.</span>

        <span class="keyword">while</span> (<span class="integer">1</span>) {
                __R30 |= gpio;                <span class="comment">// Set the GPIO pin to 1</span>
                __delay_cycles(<span class="integer">1</span>);        <span class="comment">// Delay one cycle to correct for loop time</span>
                __R30 &amp;= ~gpio;                <span class="comment">// Clear the GPIO pin</span>
                __delay_cycles(<span class="integer">0</span>);
        }
}
</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output now looks like:
.Output of pwm2.c corrected delay (<code>pwm3.png</code>)
<span class="image"><img src="figures/pwm3.png" alt="pwm2.c corrected delay"></span></p>
</div>
<div class="paragraph">
<p>It&#8217;s not hard to adjust the two <code>__delay_cycles</code> to get the desired frequency and duty cycle.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_problem_14"><a class="link" href="#_problem_14">5.1.4. Problem</a></h4>
<div class="paragraph">
<p>You would like to control the frequency and duty cycle of the PWM without recompiling.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_14"><a class="link" href="#_solution_14">5.1.5. Solution</a></h4>
<div class="paragraph">
<p>Have the PRU read the <em>on</em> and <em>off</em> times from a shared memory location.  Each PRU has is own 8KB of data memory (DRAM) and 12KB of shared memory (SHAREDMEM) that the ARM processor can also access.</p>
</div>
<div class="paragraph">
<div class="title">PRU Block Diagram</div>
<p><span class="image"><img src="figures/blockDiagram.png" alt="PRU Block diagram"></span></p>
</div>
<div class="paragraph">
<p>The DRAM 0 address is 0x0000 for PRU 0.  The same DRAM appears at address 0x4A300000 as seen from the ARM processor.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>See page
184 of the [AM335x Technical Reference Manual](<a href="https://www.ti.com/lit/ug/spruh73p/spruh73p.pdf)" class="bare">https://www.ti.com/lit/ug/spruh73p/spruh73p.pdf)</a>).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We take the previous PRU and add the lines</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre><span class="preprocessor">#define</span> PRU0_DRAM                <span class="hex">0x00000</span>                        <span class="comment">// Offset to DRAM</span>
<span class="predefined-type">unsigned</span> <span class="predefined-type">int</span> *pru0_dram = PRU0_DRAM;</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>to define a pointer to the DRAM.  Later we use</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre>                pru0_dram[ch] = on[ch];                <span class="comment">// Copy to DRAM0 so the ARM can change it</span>
                pru0_dram[ch+MAXCH] = off[ch];        <span class="comment">// Copy oafter the on array</span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>to write the <code>on</code> and <code>off</code> times to the DRAM.  Then inside the <code>while</code> loop we use</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre>                                onCount[ch] = pru0_dram[ch];                <span class="comment">// Read from DRAM0</span>
                                offCount[ch]= pru0_dram[ch+MAXCH];</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>to read from the DRAM when reseting the counters.  Now, while the PRU is running, the ARM can write values into the DRAM and change
the PWM on and off times.  Here&#8217;s the whole code:</p>
</div>
<div class="listingblock">
<div class="title">pwm4.c</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td>
  <td class="code"><pre><span class="comment">// This code does MAXCH parallel PWM channels.</span>
<span class="comment">// It's period is 3 us</span>
<span class="preprocessor">#include</span> <span class="include">&lt;stdint.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_cfg.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;resource_table_empty.h&quot;</span>

<span class="preprocessor">#define</span> PRU0_DRAM                <span class="hex">0x00000</span>                        <span class="comment">// Offset to DRAM</span>
<span class="comment">// Skip the first 0x200 byte of DRAM since the Makefile allocates</span>
<span class="comment">// 0x100 for the STACK and 0x100 for the HEAP.</span>
<span class="predefined-type">unsigned</span> <span class="predefined-type">int</span> *pru0_dram = (<span class="predefined-type">unsigned</span> <span class="predefined-type">int</span> *) (PRU0_DRAM + <span class="hex">0x200</span>);

<span class="preprocessor">#define</span> MAXCH        <span class="integer">4</span>        <span class="comment">// Maximum number of channels</span>

<span class="directive">volatile</span> <span class="directive">register</span> uint32_t __R30;
<span class="directive">volatile</span> <span class="directive">register</span> uint32_t __R31;

<span class="directive">void</span> main(<span class="directive">void</span>)
{
        uint32_t ch;
        uint32_t on[]  = {<span class="integer">1</span>, <span class="integer">2</span>, <span class="integer">3</span>, <span class="integer">4</span>};        <span class="comment">// Number of cycles to stay on</span>
        uint32_t off[] = {<span class="integer">4</span>, <span class="integer">3</span>, <span class="integer">2</span>, <span class="integer">1</span>};        <span class="comment">// Number to stay off</span>
        uint32_t onCount[MAXCH];                <span class="comment">// Current count</span>
        uint32_t offCount[MAXCH];

        <span class="comment">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
        CT_CFG.SYSCFG_bit.STANDBY_INIT = <span class="integer">0</span>;

        <span class="comment">// Initialize the channel counters.</span>
        <span class="keyword">for</span>(ch=<span class="integer">0</span>; ch&lt;MAXCH; ch++) {
                pru0_dram[<span class="integer">2</span>*ch  ] = on[ch];                <span class="comment">// Copy to DRAM0 so the ARM can change it</span>
                pru0_dram[<span class="integer">2</span>*ch+<span class="integer">1</span>] = off[ch];        <span class="comment">// Interleave the on and off values</span>
                onCount[ch] = on[ch];
                offCount[ch]= off[ch];
        }

        <span class="keyword">while</span> (<span class="integer">1</span>) {
                <span class="keyword">for</span>(ch=<span class="integer">0</span>; ch&lt;MAXCH; ch++) {
                        <span class="keyword">if</span>(onCount[ch]) {
                                onCount[ch]--;
                                __R30 |= <span class="hex">0x1</span>&lt;&lt;ch;                <span class="comment">// Set the GPIO pin to 1</span>
                        } <span class="keyword">else</span> <span class="keyword">if</span>(offCount[ch]) {
                                offCount[ch]--;
                                __R30 &amp;= ~(<span class="hex">0x1</span>&lt;&lt;ch);        <span class="comment">// Clear the GPIO pin</span>
                        } <span class="keyword">else</span> {
                                onCount[ch] = pru0_dram[<span class="integer">2</span>*ch];                <span class="comment">// Read from DRAM0</span>
                                offCount[ch]= pru0_dram[<span class="integer">2</span>*ch+<span class="integer">1</span>];
                        }
                }
        }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s is code that runs on the ARM side to set the on and off time values.</p>
</div>
<div class="listingblock">
<div class="title">pwm-test.c</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
</pre></td>
  <td class="code"><pre><span class="comment">/*
 *
 *  pwm tester
 *  (c) Copyright 2016
 *  Mark A. Yoder, 20-July-2016
 *        The channels 0-11 are on PRU1 and channels 12-17 are on PRU0
 *        The period and duty cycle values are stored in each PRU's Data memory
 *        The enable bits are stored in the shared memory
 *
 */</span>

<span class="preprocessor">#include</span> <span class="include">&lt;stdio.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;fcntl.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;sys/mman.h&gt;</span>

<span class="preprocessor">#define</span> MAXCH <span class="integer">4</span>

<span class="preprocessor">#define</span> PRU_ADDR                <span class="hex">0x4A300000</span>                <span class="comment">// Start of PRU memory Page 184 am335x TRM</span>
<span class="preprocessor">#define</span> PRU_LEN                        <span class="hex">0x80000</span>                        <span class="comment">// Length of PRU memory</span>
<span class="preprocessor">#define</span> PRU0_DRAM                <span class="hex">0x00000</span>                        <span class="comment">// Offset to DRAM</span>
<span class="preprocessor">#define</span> PRU1_DRAM                <span class="hex">0x02000</span>
<span class="preprocessor">#define</span> PRU_SHAREDMEM        <span class="hex">0x10000</span>                        <span class="comment">// Offset to shared memory</span>

<span class="predefined-type">unsigned</span> <span class="predefined-type">int</span>        *pru0DRAM_32int_ptr;                <span class="comment">// Points to the start of local DRAM</span>
<span class="predefined-type">unsigned</span> <span class="predefined-type">int</span>        *pru1DRAM_32int_ptr;                <span class="comment">// Points to the start of local DRAM</span>
<span class="predefined-type">unsigned</span> <span class="predefined-type">int</span>        *prusharedMem_32int_ptr;        <span class="comment">// Points to the start of the shared memory</span>

<span class="comment">/*******************************************************************************
* int start_pwm_count(int ch, int countOn, int countOff)
*
* Starts a pwm pulse on for countOn and off for countOff to a single channel (ch)
*******************************************************************************/</span>
<span class="predefined-type">int</span> start_pwm_count(<span class="predefined-type">int</span> ch, <span class="predefined-type">int</span> countOn, <span class="predefined-type">int</span> countOff) {
        <span class="predefined-type">unsigned</span> <span class="predefined-type">int</span> *pruDRAM_32int_ptr = pru0DRAM_32int_ptr;

        printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">countOn: %d, countOff: %d, count: %d</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>,
                countOn, countOff, countOn+countOff);
        <span class="comment">// write to PRU shared memory</span>
        pruDRAM_32int_ptr[<span class="integer">2</span>*(ch)+<span class="integer">0</span>] = countOn;        <span class="comment">// On time</span>
        pruDRAM_32int_ptr[<span class="integer">2</span>*(ch)+<span class="integer">1</span>] = countOff;        <span class="comment">// Off time</span>
        <span class="keyword">return</span> <span class="integer">0</span>;
}

<span class="predefined-type">int</span> main(<span class="predefined-type">int</span> argc, <span class="predefined-type">char</span> *argv[])
{
        <span class="predefined-type">unsigned</span> <span class="predefined-type">int</span>        *pru;                <span class="comment">// Points to start of PRU memory.</span>
        <span class="predefined-type">int</span>        fd;
        printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Servo tester</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);

        fd = open (<span class="string"><span class="delimiter">&quot;</span><span class="content">/dev/mem</span><span class="delimiter">&quot;</span></span>, O_RDWR | O_SYNC);
        <span class="keyword">if</span> (fd == -<span class="integer">1</span>) {
                printf (<span class="string"><span class="delimiter">&quot;</span><span class="content">ERROR: could not open /dev/mem.</span><span class="char">\n</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);
                <span class="keyword">return</span> <span class="integer">1</span>;
        }
        pru = mmap (<span class="integer">0</span>, PRU_LEN, PROT_READ | PROT_WRITE, MAP_SHARED, fd, PRU_ADDR);
        <span class="keyword">if</span> (pru == MAP_FAILED) {
                printf (<span class="string"><span class="delimiter">&quot;</span><span class="content">ERROR: could not map memory.</span><span class="char">\n</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);
                <span class="keyword">return</span> <span class="integer">1</span>;
        }
        close(fd);
        printf (<span class="string"><span class="delimiter">&quot;</span><span class="content">Using /dev/mem.</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);

        pru0DRAM_32int_ptr =     pru + PRU0_DRAM/<span class="integer">4</span> + <span class="hex">0x200</span>/<span class="integer">4</span>;        <span class="comment">// Points to 0x200 of PRU0 memory</span>
        pru1DRAM_32int_ptr =     pru + PRU1_DRAM/<span class="integer">4</span> + <span class="hex">0x200</span>/<span class="integer">4</span>;        <span class="comment">// Points to 0x200 of PRU1 memory</span>
        prusharedMem_32int_ptr = pru + PRU_SHAREDMEM/<span class="integer">4</span>;        <span class="comment">// Points to start of shared memory</span>

        <span class="comment">// int i;</span>
        <span class="comment">// for(i=0; i&lt;SERVO_CHANNELS; i++) {</span>
        <span class="comment">//         start_pwm_us(i, 1000, 5*(i+1));</span>
        <span class="comment">// }</span>

        <span class="comment">// int period=1000;</span>
        <span class="comment">// start_pwm_us(0, 1*period, 10);</span>
        <span class="comment">// start_pwm_us(1, 2*period, 10);</span>
        <span class="comment">// start_pwm_us(2, 4*period, 10);</span>
        <span class="comment">// start_pwm_us(3, 8*period, 10);</span>
        <span class="comment">// start_pwm_us(4, 1*period, 10);</span>
        <span class="comment">// start_pwm_us(5, 2*period, 10);</span>
        <span class="comment">// start_pwm_us(6, 4*period, 10);</span>
        <span class="comment">// start_pwm_us(7, 8*period, 10);</span>
        <span class="comment">// start_pwm_us(8, 1*period, 10);</span>
        <span class="comment">// start_pwm_us(9, 2*period, 10);</span>
        <span class="comment">// start_pwm_us(10, 4*period, 10);</span>
        <span class="comment">// start_pwm_us(11, 8*period, 10);</span>

        <span class="predefined-type">int</span> i;
        <span class="keyword">for</span>(i=<span class="integer">0</span>; i&lt;MAXCH; i++) {
                start_pwm_count(i, i+<span class="integer">1</span>, <span class="integer">20</span>-(i+<span class="integer">1</span>));
        }

        <span class="comment">// start_pwm_count(0, 1, 1);</span>
        <span class="comment">// start_pwm_count(1, 2, 2);</span>
        <span class="comment">// start_pwm_count(2, 10, 30);</span>
        <span class="comment">// start_pwm_count(3, 30, 10);</span>
        <span class="comment">// start_pwm_count(4, 1, 1);</span>
        <span class="comment">// start_pwm_count(5, 10, 10);</span>
        <span class="comment">// start_pwm_count(6, 20, 30);</span>
        <span class="comment">// start_pwm_count(7, 30, 20);</span>
        <span class="comment">// start_pwm_count(8, 1, 3);</span>
        <span class="comment">// start_pwm_count(9, 2, 2);</span>
        <span class="comment">// start_pwm_count(10, 3, 1);</span>
        <span class="comment">// start_pwm_count(11, 1, 7);</span>

        <span class="comment">// start_pwm_count(12, 1, 15);</span>
        <span class="comment">// start_pwm_count(13, 2, 15);</span>
        <span class="comment">// start_pwm_count(14, 3, 15);</span>
        <span class="comment">// start_pwm_count(15, 4, 15);</span>
        <span class="comment">// start_pwm_count(16, 5, 15);</span>
        <span class="comment">// start_pwm_count(17, 6, 15);</span>

        <span class="comment">// for(i=0; i&lt;24; i++) {</span>
        <span class="comment">//         int mask = 1 &lt;&lt; (i%12);</span>
        <span class="comment">//         printf(&quot;Mask: %x\n&quot;, mask);</span>
        <span class="comment">//         pwm_enable(mask);</span>
        <span class="comment">//         usleep(500000);</span>
        <span class="comment">// }</span>

        <span class="keyword">if</span>(munmap(pru, PRU_LEN)) {
                printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">munmap failed</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);
        } <span class="keyword">else</span> {
                printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">munmap succeeded</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);
        }
}
</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sine_wave_generator"><a class="link" href="#_sine_wave_generator">5.2. Sine Wave Generator</a></h3>

</div>
<div class="sect2">
<h3 id="_ultrasonic_sensor_application"><a class="link" href="#_ultrasonic_sensor_application">5.3. Ultrasonic Sensor Application</a></h3>

</div>
<div class="sect2">
<h3 id="_neopixel_driver"><a class="link" href="#_neopixel_driver">5.4. neoPixel driver</a></h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="_accessing_more_i_o"><a class="link" href="#_accessing_more_i_o">6. Accessing more I/O</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far the examples have shown how to access the GPIO pins on the BeagleBone Black&#8217;s
<code>P9</code> header and through the <code>__R30</code> register.  Below shows how more GPIO pins
can be accessed.</p>
</div>
<div class="sect2">
<h3 id="_editing_boot_uenv_txt_to_access_the_p8_header_on_the_black"><a class="link" href="#_editing_boot_uenv_txt_to_access_the_p8_header_on_the_black">6.1. Editing /boot/uEnv.txt to access the P8 header on the Black</a></h3>
<div class="sect3">
<h4 id="_problem_15"><a class="link" href="#_problem_15">6.1.1. Problem</a></h4>
<div class="paragraph">
<p>When I try ton configure some pins on the <code>P8</code> header of the Black I get an error.</p>
</div>
<div class="listingblock">
<div class="title">config-pin</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">bone$ config-pin P8_28 pruout
P8_27 pinmux file not found!
Pin has no cape: P8_27</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_solution_15"><a class="link" href="#_solution_15">6.1.2. Solution</a></h4>
<div class="paragraph">
<p>On the images for the BeagleBone Black, the HDMI display driver is enabled by
default.  The driver uses many of the <code>P8</code> pins.  If you are not using
HDMI video (or the HDI audio, or even the eMMC) you can disable it by editing
<code>/boot/uEnt.txt</code></p>
</div>
<div class="paragraph">
<p>Open <code>/boot/uEnv.txt</code> and scroll down aways until you see:
./boot/uEnv.txt</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">###Disable auto loading of virtual capes (emmc/video/wireless/adc)
#disable_uboot_overlay_emmc=1
disable_uboot_overlay_video=1
#disable_uboot_overlay_audio=1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Uncomment the lines that correspond to the devices you want to disable and
free up their pins.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p><a href="https://github.com/derekmolloy/exploringBB/blob/master/chp06/docs/BeagleboneBlackP8HeaderTable.pdf">P8 Header Table</a>
shows what pins are allocated for what.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Save the file and reboot.  You now have access to the <code>P8</code> pins.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_accessing_gpio"><a class="link" href="#_accessing_gpio">6.2. Accessing gpio</a></h3>
<div class="sect3">
<h4 id="_problem_16"><a class="link" href="#_problem_16">6.2.1. Problem</a></h4>
<div class="paragraph">
<p>I&#8217;ve used up all the GPIO in <code>__R30</code>, where can I get more?</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_16"><a class="link" href="#_solution_16">6.2.2. Solution</a></h4>
<div class="paragraph">
<p>So far we have focused on using PRU 0.
<a href="../05blocks/blocks.html#_pwm1_c">Table 3</a> shows
that PRU 0 can access tem GPIO pins on the BeagleBone Black.  If you use
PRU 1 you can get to and additional 14 pins (if they aren&#8217;t in use for other things.)</p>
</div>
<div class="paragraph">
<p>What if you need even more GPIO pins? You can access <em>any</em> GPIO pin by going
through the <strong>o</strong>ne <strong>c</strong>hip <strong>p</strong>eripheral (CP) port.</p>
</div>
<div class="paragraph">
<div class="title">PRU Integration</div>
<p><span class="image"><img src="figures/pruIntegration.png" alt="PRU Integration"></span></p>
</div>
<div class="paragraph">
<p>The figure above shows we&#8217;ve been using the <em>Enhanced GPIO</em> interface when using
<code>__R30</code>, but it also shows you can useing the OCP.  You get access to many more
GPIO pins, but it&#8217;s a slower access.</p>
</div>
<div class="listingblock">
<div class="title">gpio1.c</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td>
  <td class="code"><pre><span class="comment">// This code accesses GPIO without using R30 and R31</span>
<span class="preprocessor">#include</span> <span class="include">&lt;stdint.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_cfg.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;resource_table_empty.h&quot;</span>

<span class="preprocessor">#define</span> GPIO0        <span class="hex">0x44e07000</span>                <span class="comment">// GPIO Bank 0  See Table 2.2 of TRM </span><b class="conum">(1)</b>
<span class="preprocessor">#define</span> GPIO1        <span class="hex">0x4804c000</span>                <span class="comment">// GPIO Bank 1</span>
<span class="preprocessor">#define</span> GPIO2        <span class="hex">0x481ac000</span>                <span class="comment">// GPIO Bank 2</span>
<span class="preprocessor">#define</span> GPIO3        <span class="hex">0x481ae000</span>                <span class="comment">// GPIO Bank 3</span>
<span class="preprocessor">#define</span> GPIO_CLEARDATAOUT        <span class="hex">0x190</span>        <span class="comment">// For clearing the GPIO registers</span>
<span class="preprocessor">#define</span> GPIO_SETDATAOUT                <span class="hex">0x194</span>        <span class="comment">// For setting the GPIO registers</span>
<span class="preprocessor">#define</span> GPIO_DATAOUT                <span class="hex">0x138</span>        <span class="comment">// For reading the GPIO registers</span>
<span class="preprocessor">#define</span> P9_11        (<span class="hex">0x1</span>&lt;&lt;<span class="integer">30</span>)                        <span class="comment">// Bit position tied to P9_11</span>

<span class="directive">volatile</span> <span class="directive">register</span> uint32_t __R30;
<span class="directive">volatile</span> <span class="directive">register</span> uint32_t __R31;

<span class="directive">void</span> main(<span class="directive">void</span>)
{
        uint32_t *gpio0 = (uint32_t *)GPIO0;

        <span class="keyword">while</span>(<span class="integer">1</span>) {
                gpio0[GPIO_SETDATAOUT/<span class="integer">4</span>] = P9_11;
                __delay_cycles(<span class="integer">0</span>);
                gpio0[GPIO_CLEARDATAOUT/<span class="integer">4</span>] = P9_11;
                __delay_cycles(<span class="integer">0</span>);
        }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>This code will toggle <code>P9_11</code> on and off. Here&#8217;s the setup file.</p>
</div>
<div class="listingblock">
<div class="title">gpio_setup.sh</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td>
  <td class="code"><pre>#!/bin/bash
#
export PRUN=0
export TARGET=gpio1

# Configure the PRU pins based on which Beagle is running
machine=$(awk '{print $NF}' /proc/device-tree/model)
echo -n $machine
if [ $machine = &quot;Black&quot; ]; then
    echo &quot; Found&quot;
    pins=&quot;P9_11&quot;
elif [ $machine = &quot;Blue&quot; ]; then
    echo &quot; Found&quot;
    pins=&quot;&quot;
elif [ $machine = &quot;PocketBeagle&quot; ]; then
    echo &quot; Found&quot;
    pins=&quot;P1_36&quot;
else
    echo &quot; Not Found&quot;
    pins=&quot;&quot;
fi

for pin in $pins
do
    echo $pin
    config-pin $pin gpio
    config-pin -q $pin
done</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice in the code <code>config-pin</code> set <code>P9_11</code> to <code>gpio</code>, not <code>pruout</code>. This is because
are are using the OCP interface to the pin, not the usual PRU interface.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_8"><a class="link" href="#_discussion_8">6.2.3. Discussion</a></h4>
<div class="paragraph">
<p>When you run the code you see <code>P9_11</code> toggling on and off.  Let&#8217;s go through
the code line-by-line to see what&#8217;s happening.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 7. gpio1 line-by-line</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2-4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Standard includes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">6-9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The AM335x has four 32-bit GPIO ports.  These lines define the addresses
for each of the ports.  You can find these in Table 2-2 page 180 of the
<a href="https://www.ti.com/lit/ug/spruh73p/spruh73p.pdf">AM335x Technical Reference Manual</a>.
Look up <code>P9_11</code> in the <a href="https://github.com/derekmolloy/exploringBB/blob/master/chp06/docs/BeagleboneBlackP9HeaderTable.pdf">P9 Header Table</a>.
Under the <em>Mode7</em> column you see <code>gpio0[30]</code>.  This means <code>P9_11</code> is bit 30
on GPIO port 0.  Therefore we will use <code>GPIO0</code> in this code.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Here we define the address offset from <code>GIO0</code> that will allow us to clear
any (or all) bits in GPIO port 0. Other architectures require you to read a port,
then change some bit, then write it out again, three steps.  Here we can do the same by writing to one location, just one step.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is like above, but for setting bits.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Using this offset lets us just read the bits without changing them.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">13</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This shifts <code>0x1</code> to the 30<sup>th</sup> bit position, which is the one corresponding
to <code>P9_11</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">20</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Here we initialize <code>gpio0</code> to point to the start of GPIO port 0&#8217;s control
registeres.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">23</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>gpio0[GPIO_SETDATAOUT/4]</code> refers to the <code>SETDATAOUT</code> register of port 0.
The <code>/4</code> is since <code>gpio0[]</code> expects a <em>word</em> index and <code>GPIO_SETDATAOUT</code> is
a byte index. Writing to this register turns on the bits where 1&#8217;s are written,
but leaves alone the bits where 0&#8217;s are.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">24</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Wait 100,000,000 cycles, which is 0.5 seconds.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">25</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is like like line 23, but the output bit is set to 0 where 1&#8217;s are written.</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="_how_fast_can_it_go"><a class="link" href="#_how_fast_can_it_go">How fast can it go?</a></h5>
<div class="paragraph">
<p>This approach to GPIO goes through the slower OCP interface.  If you set <code>__delay_cycls(0)</code> you can see how fast it is.</p>
</div>
<div class="paragraph">
<div class="title">gpio1.c with __delay_cycles(0)</div>
<p><span class="image"><img src="figures/gpio0delay.png" alt="gpio1.c with __delay_cycles(0)"></span></p>
</div>
<div class="paragraph">
<p>The period is 80ns which is 12.MHz.  That&#8217;s about one forth the speed of the
<code>__R30</code> method, but still not bad.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_uart_2"><a class="link" href="#_uart_2">6.3. UART?</a></h3>

</div>
<div class="sect2">
<h3 id="_ecap_pwm"><a class="link" href="#_ecap_pwm">6.4. ECAP/PWM?</a></h3>

</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2018-06-12 15:06:05 EDT
</div>
</div>
</body>
</html>