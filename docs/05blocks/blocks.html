<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>Building Blocks - Applications</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_building_blocks_applications">1. Building Blocks - Applications</a>
<ul class="sectlevel2">
<li><a href="#_memory_allocation">1.1. Memory Allocation</a></li>
<li><a href="#_auto_initialization_of_built_in_led_triggers">1.2. Auto Initialization of built-in LED Triggers</a></li>
<li><a href="#blocks_pwm">1.3. PWM Generator</a></li>
<li><a href="#_controlling_the_pwm_frequency">1.4. Controlling the PWM Frequency</a></li>
<li><a href="#_loop_unrolling_for_better_performance">1.5. Loop Unrolling for Better Performance</a></li>
<li><a href="#_making_all_the_pulses_start_at_the_same_time">1.6. Making All the Pulses Start at the Same Time</a></li>
<li><a href="#_adding_more_channels_via_pru_1">1.7. Adding More Channels via PRU 1</a></li>
<li><a href="#_synchronizing_two_prus">1.8. Synchronizing Two PRUs</a></li>
<li><a href="#_reading_an_input_at_regular_intervals">1.9. Reading an Input at Regular Intervals</a></li>
<li><a href="#_analog_wave_generator">1.10. Analog Wave Generator</a></li>
<li><a href="#blocks_ws2812">1.11. WS2812 (NeoPixel) driver</a></li>
<li><a href="#_setting_neopixels_to_different_colors">1.12. Setting NeoPixels to Different Colors</a></li>
<li><a href="#_controlling_arbitrary_leds">1.13. Controlling Arbitrary LEDs</a></li>
<li><a href="#_controlling_neopixels_through_a_kernel_driver">1.14. Controlling NeoPixels Through a Kernel Driver</a></li>
<li><a href="#_rgb_led_matrix_no_integrated_drivers">1.15. RGB LED Matrix - No Integrated Drivers</a></li>
<li><a href="#_compiling_and_inserting_rpmsg_pru">1.16. Compiling and Inserting rpmsg_pru</a></li>
<li><a href="#_copyright">1.17. Copyright</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="paragraph">
<p><a href="../index.html">Outline</a></p>
</div>
<div class="sect1">
<h2 id="_building_blocks_applications"><a class="link" href="#_building_blocks_applications">1. Building Blocks - Applications</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here are some examples that use the basic PRU building blocks.</p>
</div>
<div class="paragraph">
<p>The following are resources used in this chapter.</p>
</div>
<div class="ulist">
<div class="title">Resources</div>
<ul>
<li>
<p><a href="http://www.ti.com/lit/ug/spruhv7b/spruhv7b.pdf">PRU Optimizing C/C++ Compiler, v2.2, User&#8217;s Guide</a></p>
</li>
<li>
<p><a href="http://www.ti.com/lit/pdf/spruhz6l">AM572x Technical Reference Manual</a> (AI)</p>
</li>
<li>
<p><a href="http://www.ti.com/lit/pdf/spruh73">AM335x Technical Reference Manual</a> (All others)</p>
</li>
<li>
<p><a href="http://exploringbeaglebone.com/">Exploring BeagleBone by Derek Molloy</a></p>
</li>
<li>
<p><a href="https://cdn-shop.adafruit.com/datasheets/WS2812.pdf">WS2812 Data Sheet</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These examples are based on other&#8217;s examples.  The copyright headers
have been removed from the code for claity and reproduced at the end of the
chaper.</p>
</div>
<div class="sect2">
<h3 id="_memory_allocation"><a class="link" href="#_memory_allocation">1.1. Memory Allocation</a></h3>
<div class="sect3">
<h4 id="_problem"><a class="link" href="#_problem">Problem</a></h4>
<div class="paragraph">
<p>I want to control where my variables are stored in memory.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution"><a class="link" href="#_solution">Solution</a></h4>
<div class="paragraph">
<p>Each PRU has is own 8KB of data memory (Data Mem0 and Mem1) and 12KB of shared memory (Shared RAM) as shown in <a href="#blocks_PRU_block_diagram">PRU Block Diagram</a>.</p>
</div>
<div id="blocks_PRU_block_diagram" class="imageblock">
<div class="content">
<img src="figures/blockDiagram.png" alt="PRU Block diagram">
</div>
<div class="title">Figure 1. PRU Block Diagram</div>
</div>
<div class="paragraph">
<p>Each PRU accesses it&#8217;s own DRAM starting at location 0x0000_0000. Each PRU
can also access the other PRU&#8217;s DRAM starting at 0x0000_2000. Both PRUs
access the shared RAM at 0x0001_0000. The compiler can control where each
of these memories variables are stored.</p>
</div>
<div class="paragraph">
<p><a href="#blocks_shared">shared.pro0.c - Examples of Using Different Memory Locations</a> shows how to allocate seven variable in six different locations.</p>
</div>
<div id="blocks_shared" class="listingblock">
<div class="title">shared.pro0.c - Examples of Using Different Memory Locations</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre></td>
  <td class="code"><pre><span class="comment">// From: http://git.ti.com/pru-software-support-package/pru-software-support-package/blobs/master/examples/am335x/PRU_access_const_table/PRU_access_const_table.c</span>
<span class="preprocessor">#include</span> <span class="include">&lt;stdint.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_cfg.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_ctrl.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;resource_table_empty.h&quot;</span>

<span class="preprocessor">#define</span> PRU_SRAM  <em>far </em>attribute<em>((cregister(<span class="string"><span class="delimiter">&quot;</span><span class="content">PRU_SHAREDMEM</span><span class="delimiter">&quot;</span></span>, near)))
<span class="preprocessor">#define</span> PRU_DMEM0 </em>far <em>attribute</em>((cregister(<span class="string"><span class="delimiter">&quot;</span><span class="content">PRU_DMEM_0_1</span><span class="delimiter">&quot;</span></span>,  near)))
<span class="preprocessor">#define</span> PRU_DMEM1 <em>far </em>attribute<em>((cregister(<span class="string"><span class="delimiter">&quot;</span><span class="content">PRU_DMEM_1_0</span><span class="delimiter">&quot;</span></span>,  near)))

<span class="comment">/* NOTE:  Allocating shared_x to PRU Shared Memory means that other PRU cores on
 *        the same subsystem must take care not to allocate data to that memory.
 *        Users also cannot rely on where in shared memory these variables are placed
 *        so accessing them from another PRU core or from the ARM is an undefined behavior.
 <strong>/</span>
<span class="directive">volatile</span> uint32_t shared_0;
PRU_SRAM  <span class="directive">volatile</span> uint32_t shared_1;
PRU_DMEM0 <span class="directive">volatile</span> uint32_t shared_2;
PRU_DMEM1 <span class="directive">volatile</span> uint32_t shared_3;
<span class="preprocessor">#pragma</span> DATA_SECTION(shared_4, <span class="string"><span class="delimiter">&quot;</span><span class="content">.bss</span><span class="delimiter">&quot;</span></span>)
<span class="directive">volatile</span> uint32_t shared_4;

<span class="comment">/</strong> NOTE:  Here we pick where in memory to store shared_5.  The stack and
 *        heap take up the first 0x200 words, so we must start after that.
 *        Since we are hardcoding where things are stored we can share
 *        this between the PRUs and the ARM.
<strong>/</span>
<span class="preprocessor">#define</span> PRU0_DRAM       <span class="hex">0x00000</span>         <span class="comment">// Offset to DRAM</span>
<span class="comment">// Skip the first 0x200 bytes of DRAM since the Makefile allocates</span>
<span class="comment">// 0x100 for the STACK and 0x100 for the HEAP.</span>
<span class="directive">volatile</span> <span class="predefined-type">unsigned</span> <span class="predefined-type">int</span> *shared_5 = (<span class="predefined-type">unsigned</span> <span class="predefined-type">int</span> *) (PRU0_DRAM + <span class="hex">0x200</span>);


<span class="predefined-type">int</span> main(<span class="directive">void</span>)
{
    <span class="directive">volatile</span> uint32_t shared_6;
    <span class="directive">volatile</span> uint32_t shared_7;
    <span class="comment">/<strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong>/</span>
    <span class="comment">/* Access PRU peripherals using Constant Table &amp; PRU header file <strong>/</span>
    <span class="comment">/<strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong>/</span>

    <span class="comment">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port <strong>/</span>
    CT_CFG.SYSCFG_bit.STANDBY_INIT = <span class="integer">0</span>;

    <span class="comment">/<strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong>/</span>
    <span class="comment">/* Access PRU Shared RAM using Constant Table                    <strong>/</span>
    <span class="comment">/<strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong><strong><strong></strong><strong></strong></strong>/</span>

    <span class="comment">/* C28 defaults to 0x00000000, we need to set bits 23:8 to 0x0100 in order to have it point to 0x00010000    <strong>/</span>
    PRU0_CTRL.CTPPR0_bit.C28_BLK_POINTER = <span class="hex">0x0100</span>;

    shared_0 =  <span class="hex">0xfeef</span>;
    shared_1 = <span class="hex">0xdeadbeef</span>;
    shared_2 = shared_2 + <span class="hex">0xfeed</span>;
    shared_3 = <span class="hex">0xdeed</span>;
    shared_4 = <span class="hex">0xbeed</span>;
    shared_5[<span class="integer">0</span>] = <span class="hex">0x1234</span>;
    shared_6 = <span class="hex">0x4321</span>;
    shared_7 = <span class="hex">0x9876</span>;

    <span class="comment">/</strong> Halt PRU core */</span>
    </em>halt();
}</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion"><a class="link" href="#_discussion">Discussion</a></h4>
<div class="paragraph">
<p>Here&#8217;s the line-by-line</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Line-byline for shared.pru0.c</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PRU_SRAM</code> is defined here.  It will be used later to declare variables
in the <code>Shared RAM</code> location of memory.  Section 5.5.2 on page 75 of the
<a href="http://www.ti.com/lit/ug/spruhv7b/spruhv7b.pdf">PRU Optimizing C/C++ Compiler, v2.2, User&#8217;s Guide</a> gives details of the command.  The <code>PRU_SHAREDMEM</code>
refers to the memory section defined in <code>am335x_pru.cmd</code> on line 26.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">8 9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">These are like the previous line except for the DMEM sections.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Variables declared outside of <code>main()</code> are put on the heap.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">17</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adding <code>PRU_SRAM</code> has the variable stored in the shared memory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">18, 19</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">These are stored in the PRU&#8217;s local RAM.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">20, 21</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">These lines are for storing in the <code>.bss</code> section as declared on
line 74 of <code>am335x_pru.cmd</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">28-31</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All the previous examples direct the compiler to an area in memory
and the compilers figures out what to put where.  With these lines we
specify the exact location.  Here are start with the PRU_DRAM starting address and add 0x200 to it to avoid
the stack and the heap.  The advantage of this technique is you can
easily share these variables between the ARM and the two PRUs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">36, 37</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Variable declared inside <code>main()</code> go on the stack.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
<div class="paragraph">
<p>Using the technique of line 28-31 you can put variables anywhere,
even where the compiler has put them.
Be careful, it&#8217;s easy to overwrite what the compiler has done</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Compile and run the program.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linenums">bone$ <strong>source shared_setup.sh</strong>
TARGET=shared.pru0
Black Found
P9_31
Current mode for P9_31 is:     pruout
Current mode for P9_31 is:     pruout
P9_29
Current mode for P9_29 is:     pruout
Current mode for P9_29 is:     pruout
P9_30
Current mode for P9_30 is:     pruout
Current mode for P9_30 is:     pruout
P9_28
Current mode for P9_28 is:     pruout
Current mode for P9_28 is:     pruout
bone$ <strong>make</strong>
/var/lib/cloud9/common/Makefile:29: MODEL=TI_AM335x_BeagleBone_Black,TARGET=shared.pru0
-    Stopping PRU 0
-   copying firmware file /tmp/cloud9-examples/shared.pru0.out to /lib/firmware/am335x-pru0-fw
write_init_pins.sh
-    Starting PRU 0
MODEL   = TI_AM335x_BeagleBone_Black
PROC    = pru
PRUN    = 0
PRU_DIR = /sys/class/remoteproc/remoteproc1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now check the symbol table to see where things are allocated.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linenums">bone $ <strong>grep shared /tmp/cloud9-examples/shared.pru0.map</strong>
....
1     0000011c  shared_0
2     00010000  shared_1
1     00000000  shared_2
1     00002000  shared_3
1     00000118  shared_4
1     00000120  shared_5</code></pre>
</div>
</div>
<div class="paragraph">
<p>We see, <code>shared_0</code> had no directives and was places in the heap that is 0x100
to 0x1ff.  <code>shared_1</code> was directed to go to the SHAREDMEM, <code>shared_2</code> to
the start of the local DRAM (which is also the top of the stack).  <code>shared_3</code>
was placed in the DRAM of PRU 1, <code>shared_4</code> was placed in the <code>.bss</code> section,
which is in the heap.  Finally <code>shared_5</code> is a pointer to where the value
is stored.</p>
</div>
<div class="paragraph">
<p>Where are <code>shared_6</code> and <code>shared_7</code>?  They are declared inside <code>main()</code> and are
therefore placed on the stack at run time.  The <code>shared.map</code> file shows the
compile time allocations.  We have to look in the memory itself to see what
happen at run time.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s fire up <code>prudebug</code>
(<a href="../04debug/debug.html.html#debug_prudebug">prudebug - A Simple Debugger for the PRU</a>)
to see where things are.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linenums">bone$ <strong>sudo ./prudebug</strong>
PRU Debugger v0.25
(C) Copyright 2011, 2013 by Arctica Technologies.  All rights reserved.
Written by Steven Anderson

Using /dev/mem device.
Processor type      AM335x
PRUSS memory address    0x4a300000
PRUSS memory length 0x00080000

         offsets below are in 32-bit byte addresses (not ARM byte addresses)
         PRU            Instruction    Data         Ctrl
         0              0x00034000     0x00000000   0x00022000
         1              0x00038000     0x00002000   0x00024000

PRU0&gt; <strong>d 0</strong>
Absolute addr = 0x0000, offset = 0x0000, Len = 16
[0x0000] 0x0000feed 0x00000000 0x00000000 0x00000000
[0x0010] 0x00000000 0x00000000 0x00000000 0x00000000
[0x0020] 0x00000000 0x00000000 0x00000000 0x00000000
[0x0030] 0x00000000 0x00000000 0x00000000 0x00000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>The value of <code>shared_2</code> is in memory location 0.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linenums">PRU0&gt; <strong>dd 0x100</strong>
Absolute addr = 0x0100, offset = 0x0000, Len = 16
[0x0100] 0x00000000 0x00000001 0x00000000 0x00000000
[0x0110] 0x00000000 0x00000000 0x0000beed 0x0000feef
[0x0120] 0x00000200 0x3ec71de3 0x1a013e1a 0xbf2a01a0
[0x0130] 0x111110b0 0x3f811111 0x55555555 0xbfc55555</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are <code>shared_0</code> and <code>shared_4</code> in the heap, but where is <code>shared_6</code> and
<code>shared_7</code>?  They are supposed to be on the stack that starts at 0.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linenums">PRU0&gt; dd <strong>0xc0</strong>
Absolute addr = 0x00c0, offset = 0x0000, Len = 16
[0x00c0] 0x00000000 0x00000000 0x00000000 0x00000000
[0x00d0] 0x00000000 0x00000000 0x00000000 0x00000000
[0x00e0] 0x00000000 0x00000000 0x00000000 0x00000000
[0x00f0] 0x00000000 0x00000000 0x00004321 0x00009876</code></pre>
</div>
</div>
<div class="paragraph">
<p>There they are; the stack grows from the top. (The heap grows from the bottom.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linenums">PRU0&gt; dd <strong>0x2000</strong>
Absolute addr = 0x2000, offset = 0x0000, Len = 16
[0x2000] 0x0000deed 0x00000001 0x00000000 0x557fcfb5
[0x2010] 0xce97bd0f 0x6afb2c8f 0xc7f35df4 0x5afb6dcb
[0x2020] 0x8dec3da3 0xe39a6756 0x642cb8b8 0xcb6952c0
[0x2030] 0x2f22ebda 0x548d97c5 0x9241786f 0x72dfeb86</code></pre>
</div>
</div>
<div class="paragraph">
<p>And there is PRU 1&#8217;s memory with <code>shared_3</code>. And finally the shared memory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linenums">PRU0&gt; <strong>dd 0x10000</strong>
Absolute addr = 0x10000, offset = 0x0000, Len = 16
[0x10000] 0xdeadbeef 0x0000feed 0x00000000 0x68c44f8b
[0x10010] 0xc372ba7e 0x2ffa993b 0x11c66da5 0xfbf6c5d7
[0x10020] 0x5ada3fcf 0x4a5d0712 0x48576fb7 0x1004796b
[0x10030] 0x2267ebc6 0xa2793aa1 0x100d34dc 0x9ca06d4a</code></pre>
</div>
</div>
<div class="paragraph">
<p>The compiler offers great control over where variables are stored. Just
be sure if you are hand picking where things are put, not to put them in places
used by the compiler.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_auto_initialization_of_built_in_led_triggers"><a class="link" href="#_auto_initialization_of_built_in_led_triggers">1.2. Auto Initialization of built-in LED Triggers</a></h3>
<div class="sect3">
<h4 id="_problem_2"><a class="link" href="#_problem_2">Problem</a></h4>
<div class="paragraph">
<p>I see the built-in LEDs blink to their own patterns.  How do I turn this off?
Can this be automated?</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_2"><a class="link" href="#_solution_2">Solution</a></h4>
<div class="paragraph">
<p>Each built-in LED has a default action (trigger) when the Bone boots up.
This is controlled by <code>/sys/class/leds</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bone$ <strong>cd /sys/class/leds</strong>
bone$ <strong>ls</strong>
beaglebone:green:usr0  beaglebone:green:usr2
beaglebone:green:usr1  beaglebone:green:usr3</pre>
</div>
</div>
<div class="paragraph">
<p>Here you see a directory for each of the LEDs.  Let&#8217;s pick USR1.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bone$ <strong>cd beaglebone\:green\:usr1</strong>
bone$ <strong>ls</strong>
brightness  device  max_brightness  power  subsystem  trigger  uevent
bone$ <strong>cat trigger</strong>
none rc-feedback kbd-scrolllock kbd-numlock kbd-capslock kbd-kanalock
kbd-shiftlock kbd-altgrlock kbd-ctrllock kbd-altlock kbd-shiftllock
kbd-shiftrlock kbd-ctrlllock kbd-ctrlrlock usb-gadget usb-host
<strong>[mmc0]</strong> mmc1 timer oneshot disk-activity ide-disk mtd nand-disk
heartbeat backlight gpio cpu0 default-on</pre>
</div>
</div>
<div class="paragraph">
<p>Notice <code>[mmc0]</code> is in brackets.  This means it&#8217;s the current trigger; it flashes
when the built-in flash memory is in use.  You can turn this off using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bone$ <strong>echo none &gt; trigger</strong>
bone$ <strong>cat trigger</strong>
[none] rc-feedback kbd-scrolllock kbd-numlock kbd-capslock kbd-kanalock
kbd-shiftlock kbd-altgrlock kbd-ctrllock kbd-altlock kbd-shiftllock
kbd-shiftrlock kbd-ctrlllock kbd-ctrlrlock usb-gadget usb-host
mmc0 mmc1 timer oneshot disk-activity ide-disk mtd nand-disk
heartbeat backlight gpio cpu0 default-on</pre>
</div>
</div>
<div class="paragraph">
<p>Now it is no longer flashing.</p>
</div>
<div class="paragraph">
<p>How can this be automated so when code is run that needs the trigger off, it&#8217;s
turned off automatically?  Here&#8217;s a trick.  Include the following in your code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre><span class="preprocessor">#pragma</span> DATA_SECTION(init_pins, <span class="string"><span class="delimiter">&quot;</span><span class="content">.init_pins</span><span class="delimiter">&quot;</span></span>)
<span class="preprocessor">#pragma</span> RETAIN(init_pins)
<span class="directive">const</span> <span class="predefined-type">char</span> init_pins[] =
        <span class="string"><span class="delimiter">&quot;</span><span class="content">/sys/class/leds/beaglebone:green:usr3/trigger</span><span class="char">\0</span><span class="content">none</span><span class="char">\0</span><span class="delimiter">&quot;</span></span> \
        <span class="string"><span class="delimiter">&quot;</span><span class="char">\0</span><span class="char">\0</span><span class="delimiter">&quot;</span></span>;</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lines 3 and 4 declare the array <code>init_pins</code> to have an entry which is the path
to <code>trigger</code> and the value that should be 'echoed' into it. Both are NULL
terminated.  Line 1 says to put this in a section called <code>.init_pins</code> and
line 2 says to <code>RETAIN</code> it.  That is don&#8217;t throw it away if it appears to be
unused.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_2"><a class="link" href="#_discussion_2">Discussion</a></h4>
<div class="paragraph">
<p>The above code stores this array in the <code>.out</code> file thats created, but that&#8217;s not
enough. You need to run <a href="#blocks_write_init_pins">write_init_pins.sh</a> on the <code>.out</code> file to make
the code work.  Fortunately the Makefile always runs it.</p>
</div>
<div id="blocks_write_init_pins" class="listingblock">
<div class="title">write_init_pins.sh</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linenums">#!/bin/bash
init_pins=$(readelf -x .init_pins $1 | grep 0x000 | cut -d' ' -f4-7 | xxd -r -p | tr '\0' '\n' | paste - -)
while read -a line; do
    if [ ${#line[@]} == 2 ]; then
        echo writing \&quot;${line[1]}\&quot; to \&quot;${line[0]}\&quot;
        echo ${line[1]} &gt; ${line[0]}
        sleep 0.1
    fi
done &lt;&lt;&lt; &quot;$init_pins&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>readelf</code> command extracts the path and value from the <code>.out</code> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linenums">bone$ <strong>readelf -x .init_pins /tmp/pru0-gen/shared.out</strong>

Hex dump of section '.init_pins':
  0x000000c0 2f737973 2f636c61 73732f6c 6564732f /sys/class/leds/
  0x000000d0 62656167 6c65626f 6e653a67 7265656e beaglebone:green
  0x000000e0 3a757372 332f7472 69676765 72006e6f :usr3/trigger.no
  0x000000f0 6e650000 0000                       ne....</code></pre>
</div>
</div>
<div class="paragraph">
<p>The rest of the command formats it.  Finally line 6 echos the <code>none</code> into
the path.</p>
</div>
<div class="paragraph">
<p>This can be generalized to initialize other things.  The point is, the <code>.out</code>
file contains everything needed to run the executable.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="blocks_pwm"><a class="link" href="#blocks_pwm">1.3. PWM Generator</a></h3>
<div class="paragraph">
<p>One of the simplest things a PRU can to is generate a simple
signals starting with a single channel PWM that has a fixed frequency and
duty cycle and ending with a multi channel PWM that the ARM can change
the frequency and duty cycle on the fly.</p>
</div>
<div class="sect3">
<h4 id="_problem_3"><a class="link" href="#_problem_3">Problem</a></h4>
<div class="paragraph">
<p>I want to generate a PWM signal that has a fixed frequency and duty cycle.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_3"><a class="link" href="#_solution_3">Solution</a></h4>
<div class="paragraph">
<p>The solution is fairly easy, but be sure to check the <strong>Discussion</strong> section
for details on making it work.</p>
</div>
<div class="paragraph">
<p><a href="#blocks_pwm1">pwm1.pru0.c</a> shows the code.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>This code is for the BeagleBone Black.  See <code>pwm1.pru1_1.c</code> for an example
that works on the AI.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="blocks_pwm1" class="listingblock">
<div class="title">pwm1.pru0.c</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td>
  <td class="code"><pre><span class="preprocessor">#include</span> <span class="include">&lt;stdint.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_cfg.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;resource_table_empty.h&quot;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;prugpio.h&quot;</span>

<span class="directive">volatile</span> <span class="directive">register</span> uint32_t __R30;
<span class="directive">volatile</span> <span class="directive">register</span> uint32_t __R31;

<span class="directive">void</span> main(<span class="directive">void</span>)
{
    uint32_t gpio = P9_31;  <span class="comment">// Select which pin to toggle.;</span>

    <span class="comment">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
    CT_CFG.SYSCFG_bit.STANDBY_INIT = <span class="integer">0</span>;

    <span class="keyword">while</span>(<span class="integer">1</span>) {
        __R30 |= gpio;      <span class="comment">// Set the GPIO pin to 1</span>
        __delay_cycles(<span class="integer">100000000</span>);
        __R30 &amp;= ~gpio;     <span class="comment">// Clear the GPIO pin</span>
        __delay_cycles(<span class="integer">100000000</span>);
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>To run this code you need to configure the pin muxes to output the PRU.  If you are on the Black run</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>bone$ <strong>config-pin P9_31 pruout</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>On the Pocket run</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>bone$ <strong>config-pin P1_36 pruout</strong></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>See <a href="08ai/ai.html.html">Configuring pins on the AI via device trees</a> for configuring
pins on the AI.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then, tell <code>Makefile</code> which PRU you are compiling for and what your target file is</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>bone$ <strong>export TARGET=pwm1.pru0</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you are ready to compile</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linenums">bone$ <strong>make</strong>
/var/lib/cloud9/common/Makefile:29: MODEL=TI_AM335x_BeagleBone_Black,TARGET=pwm1.pru0
-    Stopping PRU 0
-   copying firmware file /tmp/cloud9-examples/pwm1.pru0.out to /lib/firmware/am335x-pru0-fw
write_init_pins.sh
-    Starting PRU 0
MODEL   = TI_AM335x_BeagleBone_Black
PROC    = pru
PRUN    = 0
PRU_DIR = /sys/class/remoteproc/remoteproc1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now attach an LED (or oscilloscope) to <code>P9_31</code> on the Black or <code>P1.36</code> on the Pocket.  You should see a squarewave.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_3"><a class="link" href="#_discussion_3">Discussion</a></h4>
<div class="paragraph">
<p>Since this is our first example we&#8217;ll discuss the many parts in detail.</p>
</div>
<div class="sect4">
<h5 id="_pwm1_pru0_c"><a class="link" href="#_pwm1_pru0_c">pwm1.pru0.c</a></h5>
<div class="paragraph">
<p><a href="#blocks_pwm1_line_by_line">Line-by-line of pwm1.pru0.c</a> is a line-by-line expanation of the c code.</p>
</div>
<table id="blocks_pwm1_line_by_line" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Line-by-line of pwm1.pru0.c</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Standard c-header include</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Include for the PRU.  The compiler knows where to find this since the <code>Makefile</code> says to look for includes in <code>/usr/lib/ti/pru-software-support-package</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The file <code>resource_table_empty.h</code> is used by the PRU loader.  Generally we&#8217;ll use the same file, and don&#8217;t need to modify it.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This include has addresses for the GPIO ports and some bit positions for some
of the headers.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Here&#8217;s what&#8217;s in <code>resource_table_empty.h</code></p>
</div>
<div class="listingblock">
<div class="title">resource_table_empty.c</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td>
  <td class="code"><pre><span class="comment">/*
 *  ======== resource_table_empty.h ========
 *
 *  Define the resource table entries for all PRU cores. This will be
 *  incorporated into corresponding base images, and used by the remoteproc
 *  on the host-side to allocated/reserve resources.  Note the remoteproc
 *  driver requires that all PRU firmware be built with a resource table.
 *
 *  This file contains an empty resource table.  It can be used either as:
 *
 *        1) A template, or
 *        2) As-is if a PRU application does not need to configure PRU_INTC
 *                  or interact with the rpmsg driver
 *
 */</span>

<span class="preprocessor">#ifndef</span> _RSC_TABLE_PRU_H_
<span class="preprocessor">#define</span> _RSC_TABLE_PRU_H_

<span class="preprocessor">#include</span> <span class="include">&lt;stddef.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;rsc_types.h&gt;</span>

<span class="keyword">struct</span> my_resource_table {
    <span class="keyword">struct</span> resource_table base;

    uint32_t offset[<span class="integer">1</span>]; <span class="comment">/* Should match 'num' in actual definition */</span>
};

<span class="preprocessor">#pragma</span> DATA_SECTION(pru_remoteproc_ResourceTable, <span class="string"><span class="delimiter">&quot;</span><span class="content">.resource_table</span><span class="delimiter">&quot;</span></span>)
<span class="preprocessor">#pragma</span> RETAIN(pru_remoteproc_ResourceTable)
<span class="keyword">struct</span> my_resource_table pru_remoteproc_ResourceTable = {
    <span class="integer">1</span>,  <span class="comment">/* we're the first version that implements this */</span>
    <span class="integer">0</span>,  <span class="comment">/* number of entries in the table */</span>
    <span class="integer">0</span>, <span class="integer">0</span>,   <span class="comment">/* reserved, must be zero */</span>
    <span class="integer">0</span>,  <span class="comment">/* offset[0] */</span>
};

<span class="preprocessor">#endif</span> <span class="comment">/* _RSC_TABLE_PRU_H_ */</span>
</pre></td>
</tr></table></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Line-by-line (continuted)</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">6-7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>__R30</code> and <code>__R31</code> are two variables that refer to the PRU output (<code>__R30</code>) and input (<code>__R31</code>) registers.
When you write something to <code>__R30</code> it will show up on the corresponding output pins.
When you read from <code>__R31</code> you read the data on the input pins.
NOTE: Both names begin with two underscore&#8217;s. Section 5.7.2 of the
<a href="http://www.ti.com/lit/ug/spruhv7b/spruhv7b.pdf">PRU Optimizing C/C++ Compiler, v2.2, User&#8217;s Guide</a>
gives more details.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This line selects which GPIO pin to toggle.  The table below shows which bits in <code>__R30</code> map to which pins</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CT_CFG.SYSCFG_bit.STANDBY_INIT</code> is set to <code>0</code> to enable the OCP master port. More details on this and thousands of other regesters see the
<a href="https://www.ti.com/lit/ug/spruh73p/spruh73p.pdf">AM335x Technical Reference Manual</a>. Section 4 is on the PRU and section 4.5 gives details for all the registers.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Bit 0 is the LSB.</p>
</div>
<div class="paragraph">
<p></p>
</div>
<table id="blocks_mapping_bits" class="tableblock frame-all grid-all" style="width: 35%;">
<caption class="title">Table 4. Mapping bit positions to pin names</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 10%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">PRU</th>
<th class="tableblock halign-left valign-top">Bit</th>
<th class="tableblock halign-left valign-top">Black pin</th>
<th class="tableblock halign-left valign-top">Pocket pin</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_31</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.36</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_29</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.33</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_30</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.32</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_28</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.30</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_42b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.31</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_27</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.34</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_41b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.28</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_25</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.29</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_12(out) P8_16(in)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.24</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_11(out) P8_15(in)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.33</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">---</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">---</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">---------</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-----</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_45</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_46</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_43</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_44</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_41</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_42</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_39</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_40</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_27</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.35</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_29</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2.01</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_28</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.35</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_30</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.04</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_21</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">13</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_20</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">14</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.32</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.30</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_26(in)</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>See <a href="08ai/ai.html.html">Configuring pins on the AI via device trees</a> for all
the PRU pins on the AI.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Since we are running on PRU 0, and we&#8217;re using <code>0x0001</code>, that is bit 0,
we&#8217;ll be toggling <code>P9_31</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Line-by-line (continued again)</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">17</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Here is where the action is.  This line reads <code>__R30</code> and then ORs it with <code>gpio</code>, setting the bits where there is a 1 in <code>gpio</code> and leaving the bits where there is a 0.  Thus we are setting the bit we selected. Finally the new value is written back to <code>__R30</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">18</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>__delay_cycles</code> is an instrinsic function that delays with number of cycles passed to it. Each cycle is 5ns, and we are delaying 100,000,000 cycles which is 500,000,000ns, or 0.5 seconds.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">19</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is like line 17, but <code>~gpio</code> inverts all the bits in <code>gpio</code> so that where we had a 1, there is now a 0.  This 0 is then ANDed with <code>__R30</code> setting the corresponding bit to 0.  Thus we are clearing the bit we selected.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You can read more about instrinsics in section 5.11 of the (<a href="http://www.ti.com/lit/ug/spruhv7b/spruhv7b.pdf">PRU Optimizing C/C++ Compiler, v2.2, User&#8217;s Guide</a>.)</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When you run this code and look at the output you will see something like the following figure.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="figures/pwm1.png" alt="pwm1.pru0.c output">
</div>
<div class="title">Figure 2. Output of pwm1.pru0.c with 100,000,000 delays cycles giving a 1s period</div>
</div>
<div class="paragraph">
<p>Notice the on time (<code>+Width(1)</code>) is 500ms, just as we predicted.  The off time is 498ms, which is only 2ms off from our prediction.  The standard deviation is 0, or only 380as, which is 380 * 10<sup>-18</sup>!.</p>
</div>
<div class="paragraph">
<p>You can see how fast the PRU can run by setting both of the <code>__delay_cycles</code> to 0. This results in the next figure.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="figures/pwm2.png" alt="pwm1.pru0.c output with 0 delay">
</div>
<div class="title">Figure 3. Output of pwm1.pru0c with 0 delay cycles</div>
</div>
<div class="paragraph">
<p>Notice the period is 15ns which gives us a frequency of about 67MHz. At this high frequency the breadboard that I&#8217;m using distorts the waveform so it&#8217;s no longer a squarewave. The <em>on</em> time is 5.3ns and the <em>off</em> time is 9.8ns.  That means <code>__R30 |= gpio</code> took only one 5ns cycle and <code>__R30 &amp;= ~gpio</code> also only took one cycle, but there is also an extra cycle needed for the loop.  This means the compiler was able to implement the <code>while</code> loop in just three 5ns instructions!  Not bad.</p>
</div>
<div class="paragraph">
<p>We want a square wave, so we need to add a delay to correct for the delay of looping back.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the code that does just that.</p>
</div>
<div class="listingblock">
<div class="title">pwm2.pru0.c</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td>
  <td class="code"><pre><span class="preprocessor">#include</span> <span class="include">&lt;stdint.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_cfg.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;resource_table_empty.h&quot;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;prugpio.h&quot;</span>

<span class="directive">volatile</span> <span class="directive">register</span> uint32_t __R30;
<span class="directive">volatile</span> <span class="directive">register</span> uint32_t __R31;

<span class="directive">void</span> main(<span class="directive">void</span>)
{
    uint32_t gpio = P9_31;  <span class="comment">// Select which pin to toggle.;</span>

    <span class="comment">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
    CT_CFG.SYSCFG_bit.STANDBY_INIT = <span class="integer">0</span>;

    <span class="keyword">while</span> (<span class="integer">1</span>) {
        __R30 |= gpio;      <span class="comment">// Set the GPIO pin to 1</span>
        __delay_cycles(<span class="integer">1</span>);  <span class="comment">// Delay one cycle to correct for loop time</span>
        __R30 &amp;= ~gpio;     <span class="comment">// Clear the GPIO pin</span>
        __delay_cycles(<span class="integer">0</span>);
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output now looks like:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="figures/pwm3.png" alt="pwm2.c corrected delay">
</div>
<div class="title">Figure 4. Output of pwm2.pru0.c corrected delay</div>
</div>
<div class="paragraph">
<p>It&#8217;s not hard to adjust the two <code>__delay_cycles</code> to get the desired frequency and duty cycle.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_controlling_the_pwm_frequency"><a class="link" href="#_controlling_the_pwm_frequency">1.4. Controlling the PWM Frequency</a></h3>
<div class="sect3">
<h4 id="_problem_4"><a class="link" href="#_problem_4">Problem</a></h4>
<div class="paragraph">
<p>You would like to control the frequency and duty cycle of the PWM without recompiling.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_4"><a class="link" href="#_solution_4">Solution</a></h4>
<div class="paragraph">
<p>Have the PRU read the <em>on</em> and <em>off</em> times from a shared memory location.  Each PRU has is own 8KB of data memory (DRAM) and 12KB of shared memory (SHAREDMEM) that the ARM processor can also access.  See <a href="#blocks_PRU_block_diagram">PRU Block Diagram</a>.</p>
</div>
<div class="paragraph">
<p>The DRAM 0 address is 0x0000 for PRU 0.  The same DRAM appears at address 0x4A300000 as seen from the ARM processor.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>See page
184 of the <a href="https://www.ti.com/lit/ug/spruh73p/spruh73p.pdf">AM335x Technical Reference Manual</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We take the previous PRU code and add the lines</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre><span class="preprocessor">#define</span> PRU0_DRAM       <span class="hex">0x00000</span>         <span class="comment">// Offset to DRAM</span>
<span class="directive">volatile</span> <span class="predefined-type">unsigned</span> <span class="predefined-type">int</span> *pru0_dram = PRU0_DRAM;</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>to define a pointer to the DRAM.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>volatile</code> keyword is used here to tell the compiler the value this
points to may change, so don&#8217;t make any assumptions while optimizing.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Later in the code we use</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre>    pru0_dram[ch] = on[ch];         <span class="comment">// Copy to DRAM0 so the ARM can change it</span>
    pru0_dram[ch+MAXCH] = off[ch];  <span class="comment">// Copy after the on array</span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>to write the <code>on</code> and <code>off</code> times to the DRAM.  Then inside the <code>while</code> loop we use</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre>    onCount[ch] = pru0_dram[<span class="integer">2</span>*ch];      <span class="comment">// Read from DRAM0</span>
    offCount[ch]= pru0_dram[<span class="integer">2</span>*ch+<span class="integer">1</span>];</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>to read from the DRAM when reseting the counters.  Now, while the PRU is running, the ARM can write values into the DRAM and change
the PWM on and off times.  <a href="#blocks_pwm4">pwm4.pru0.c</a> is the whole code.</p>
</div>
<div id="blocks_pwm4" class="listingblock">
<div class="title">pwm4.pru0.c</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td>
  <td class="code"><pre><span class="comment">// This code does MAXCH parallel PWM channels.</span>
<span class="comment">// It's period is 3 us</span>
<span class="preprocessor">#include</span> <span class="include">&lt;stdint.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_cfg.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;resource_table_empty.h&quot;</span>

<span class="preprocessor">#define</span> PRU0_DRAM       <span class="hex">0x00000</span>         <span class="comment">// Offset to DRAM</span>
<span class="comment">// Skip the first 0x200 byte of DRAM since the Makefile allocates</span>
<span class="comment">// 0x100 for the STACK and 0x100 for the HEAP.</span>
<span class="directive">volatile</span> <span class="predefined-type">unsigned</span> <span class="predefined-type">int</span> *pru0_dram = (<span class="predefined-type">unsigned</span> <span class="predefined-type">int</span> *) (PRU0_DRAM + <span class="hex">0x200</span>);

<span class="preprocessor">#define</span> MAXCH   <span class="integer">4</span>   <span class="comment">// Maximum number of channels per PRU</span>

<span class="directive">volatile</span> <span class="directive">register</span> uint32_t __R30;
<span class="directive">volatile</span> <span class="directive">register</span> uint32_t __R31;

<span class="directive">void</span> main(<span class="directive">void</span>)
{
    uint32_t ch;
    uint32_t on[]  = {<span class="integer">1</span>, <span class="integer">2</span>, <span class="integer">3</span>, <span class="integer">4</span>};  <span class="comment">// Number of cycles to stay on</span>
    uint32_t off[] = {<span class="integer">4</span>, <span class="integer">3</span>, <span class="integer">2</span>, <span class="integer">1</span>};  <span class="comment">// Number to stay off</span>
    uint32_t onCount[MAXCH];        <span class="comment">// Current count</span>
    uint32_t offCount[MAXCH];

    <span class="comment">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
    CT_CFG.SYSCFG_bit.STANDBY_INIT = <span class="integer">0</span>;

    <span class="comment">// Initialize the channel counters.</span>
    <span class="keyword">for</span>(ch=<span class="integer">0</span>; ch&lt;MAXCH; ch++) {
        pru0_dram[<span class="integer">2</span>*ch  ] = on[ch];     <span class="comment">// Copy to DRAM0 so the ARM can change it</span>
        pru0_dram[<span class="integer">2</span>*ch+<span class="integer">1</span>] = off[ch];    <span class="comment">// Interleave the on and off values</span>
        onCount[ch] = on[ch];
        offCount[ch]= off[ch];
    }

    <span class="keyword">while</span> (<span class="integer">1</span>) {
        <span class="keyword">for</span>(ch=<span class="integer">0</span>; ch&lt;MAXCH; ch++) {
            <span class="keyword">if</span>(onCount[ch]) {
                onCount[ch]--;
                __R30 |= <span class="hex">0x1</span>&lt;&lt;ch;       <span class="comment">// Set the GPIO pin to 1</span>
            } <span class="keyword">else</span> <span class="keyword">if</span>(offCount[ch]) {
                offCount[ch]--;
                __R30 &amp;= ~(<span class="hex">0x1</span>&lt;&lt;ch);    <span class="comment">// Clear the GPIO pin</span>
            } <span class="keyword">else</span> {
                onCount[ch] = pru0_dram[<span class="integer">2</span>*ch];      <span class="comment">// Read from DRAM0</span>
                offCount[ch]= pru0_dram[<span class="integer">2</span>*ch+<span class="integer">1</span>];
            }
        }
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is code that runs on the ARM side to set the on and off time values.</p>
</div>
<div class="listingblock">
<div class="title">pwm-test.c</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre></td>
  <td class="code"><pre><span class="comment">/*
 *
 *  pwm tester
 *  The on cycle and off cycles are stored in each PRU's Data memory
 *
 */</span>

<span class="preprocessor">#include</span> <span class="include">&lt;stdio.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;fcntl.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;sys/mman.h&gt;</span>

<span class="preprocessor">#define</span> MAXCH <span class="integer">4</span>

<span class="preprocessor">#define</span> PRU_ADDR        <span class="hex">0x4A300000</span>      <span class="comment">// Start of PRU memory Page 184 am335x TRM</span>
<span class="preprocessor">#define</span> PRU_LEN         <span class="hex">0x80000</span>         <span class="comment">// Length of PRU memory</span>
<span class="preprocessor">#define</span> PRU0_DRAM       <span class="hex">0x00000</span>         <span class="comment">// Offset to DRAM</span>
<span class="preprocessor">#define</span> PRU1_DRAM       <span class="hex">0x02000</span>
<span class="preprocessor">#define</span> PRU_SHAREDMEM   <span class="hex">0x10000</span>         <span class="comment">// Offset to shared memory</span>

<span class="predefined-type">unsigned</span> <span class="predefined-type">int</span>    *pru0DRAM_32int_ptr;        <span class="comment">// Points to the start of local DRAM</span>
<span class="predefined-type">unsigned</span> <span class="predefined-type">int</span>    *pru1DRAM_32int_ptr;        <span class="comment">// Points to the start of local DRAM</span>
<span class="predefined-type">unsigned</span> <span class="predefined-type">int</span>    *prusharedMem_32int_ptr;    <span class="comment">// Points to the start of the shared memory</span>

<span class="comment">/*******************************************************************************
* int start_pwm_count(int ch, int countOn, int countOff)
*
* Starts a pwm pulse on for countOn and off for countOff to a single channel (ch)
*******************************************************************************/</span>
<span class="predefined-type">int</span> start_pwm_count(<span class="predefined-type">int</span> ch, <span class="predefined-type">int</span> countOn, <span class="predefined-type">int</span> countOff) {
    <span class="predefined-type">unsigned</span> <span class="predefined-type">int</span> *pruDRAM_32int_ptr = pru0DRAM_32int_ptr;

    printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">countOn: %d, countOff: %d, count: %d</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>,
        countOn, countOff, countOn+countOff);
    <span class="comment">// write to PRU shared memory</span>
    pruDRAM_32int_ptr[<span class="integer">2</span>*(ch)+<span class="integer">0</span>] = countOn;  <span class="comment">// On time</span>
    pruDRAM_32int_ptr[<span class="integer">2</span>*(ch)+<span class="integer">1</span>] = countOff; <span class="comment">// Off time</span>
    <span class="keyword">return</span> <span class="integer">0</span>;
}

<span class="predefined-type">int</span> main(<span class="predefined-type">int</span> argc, <span class="predefined-type">char</span> *argv[])
{
    <span class="predefined-type">unsigned</span> <span class="predefined-type">int</span>    *pru;       <span class="comment">// Points to start of PRU memory.</span>
    <span class="predefined-type">int</span> fd;
    printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Servo tester</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);

    fd = open (<span class="string"><span class="delimiter">&quot;</span><span class="content">/dev/mem</span><span class="delimiter">&quot;</span></span>, O_RDWR | O_SYNC);
    <span class="keyword">if</span> (fd == -<span class="integer">1</span>) {
        printf (<span class="string"><span class="delimiter">&quot;</span><span class="content">ERROR: could not open /dev/mem.</span><span class="char">\n</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> <span class="integer">1</span>;
    }
    pru = mmap (<span class="integer">0</span>, PRU_LEN, PROT_READ | PROT_WRITE, MAP_SHARED, fd, PRU_ADDR);
    <span class="keyword">if</span> (pru == MAP_FAILED) {
        printf (<span class="string"><span class="delimiter">&quot;</span><span class="content">ERROR: could not map memory.</span><span class="char">\n</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> <span class="integer">1</span>;
    }
    close(fd);
    printf (<span class="string"><span class="delimiter">&quot;</span><span class="content">Using /dev/mem.</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);

    pru0DRAM_32int_ptr =     pru + PRU0_DRAM/<span class="integer">4</span> + <span class="hex">0x200</span>/<span class="integer">4</span>;   <span class="comment">// Points to 0x200 of PRU0 memory</span>
    pru1DRAM_32int_ptr =     pru + PRU1_DRAM/<span class="integer">4</span> + <span class="hex">0x200</span>/<span class="integer">4</span>;   <span class="comment">// Points to 0x200 of PRU1 memory</span>
    prusharedMem_32int_ptr = pru + PRU_SHAREDMEM/<span class="integer">4</span>; <span class="comment">// Points to start of shared memory</span>

    <span class="predefined-type">int</span> i;
    <span class="keyword">for</span>(i=<span class="integer">0</span>; i&lt;MAXCH; i++) {
        start_pwm_count(i, i+<span class="integer">1</span>, <span class="integer">20</span>-(i+<span class="integer">1</span>));
    }

    <span class="keyword">if</span>(munmap(pru, PRU_LEN)) {
        printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">munmap failed</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);
    } <span class="keyword">else</span> {
        printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">munmap succeeded</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);
    }
}
</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>A quick check on the 'scope shows <a href="#blocks_pwm_arm_control">Four Channel PWM with ARM control</a>.</p>
</div>
<div id="blocks_pwm_arm_control" class="imageblock">
<div class="content">
<img src="figures/pwm4.png" alt="pwm4.png">
</div>
<div class="title">Figure 5. Four Channel PWM with ARM control</div>
</div>
<div class="paragraph">
<p>From the 'scope you see a 1 cycle <em>on</em> time results in a 450ns wide pulse and
a 3.06us period is 326KHz, much
slower than the 10ns pulse we saw before.  But it may be more than fast enough
for many applications.  For example, most servos run at 50Hz.</p>
</div>
<div class="paragraph">
<p>But we can do better.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_loop_unrolling_for_better_performance"><a class="link" href="#_loop_unrolling_for_better_performance">1.5. Loop Unrolling for Better Performance</a></h3>
<div class="sect3">
<h4 id="_problem_5"><a class="link" href="#_problem_5">Problem</a></h4>
<div class="paragraph">
<p>The ARM controlled PRU code runs too slowly.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_5"><a class="link" href="#_solution_5">Solution</a></h4>
<div class="paragraph">
<p>Simple loop unrolling can greatly improve the speed.  <code>pwm5.pru0.c</code> is our unrolled
version.</p>
</div>
<div class="listingblock">
<div class="title">pwm5.pru0.c Unrolled</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre></td>
  <td class="code"><pre><span class="comment">// This code does MAXCH parallel PWM channels.</span>
<span class="comment">// It's period is 510ns.</span>
<span class="preprocessor">#include</span> <span class="include">&lt;stdint.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_cfg.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;resource_table_empty.h&quot;</span>

<span class="preprocessor">#define</span> PRU0_DRAM       <span class="hex">0x00000</span>         <span class="comment">// Offset to DRAM</span>
<span class="comment">// Skip the first 0x200 byte of DRAM since the Makefile allocates</span>
<span class="comment">// 0x100 for the STACK and 0x100 for the HEAP.</span>
<span class="directive">volatile</span> <span class="predefined-type">unsigned</span> <span class="predefined-type">int</span> *pru0_dram = (<span class="predefined-type">unsigned</span> <span class="predefined-type">int</span> *) (PRU0_DRAM + <span class="hex">0x200</span>);

<span class="preprocessor">#define</span> MAXCH   <span class="integer">4</span>   <span class="comment">// Maximum number of channels per PRU</span>

<span class="preprocessor">#define</span> update(ch) \
            <span class="keyword">if</span>(onCount[ch]) {           \
                onCount[ch]--;          \
                __R30 |= <span class="hex">0x1</span>&lt;&lt;ch;       \
            } <span class="keyword">else</span> <span class="keyword">if</span>(offCount[ch]) {   \
                offCount[ch]--;         \
                __R30 &amp;= ~(<span class="hex">0x1</span>&lt;&lt;ch);    \
            } <span class="keyword">else</span> {                    \
                onCount[ch] = pru0_dram[<span class="integer">2</span>*ch];  \
                offCount[ch]= pru0_dram[<span class="integer">2</span>*ch+<span class="integer">1</span>];    \
            }

<span class="directive">volatile</span> <span class="directive">register</span> uint32_t __R30;
<span class="directive">volatile</span> <span class="directive">register</span> uint32_t __R31;

<span class="directive">void</span> main(<span class="directive">void</span>)
{
    uint32_t ch;
    uint32_t on[]  = {<span class="integer">1</span>, <span class="integer">2</span>, <span class="integer">3</span>, <span class="integer">4</span>};
    uint32_t off[] = {<span class="integer">4</span>, <span class="integer">3</span>, <span class="integer">2</span>, <span class="integer">1</span>};
    uint32_t onCount[MAXCH], offCount[MAXCH];

    <span class="comment">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
    CT_CFG.SYSCFG_bit.STANDBY_INIT = <span class="integer">0</span>;

<span class="preprocessor">#pragma</span> UNROLL(MAXCH)
    <span class="keyword">for</span>(ch=<span class="integer">0</span>; ch&lt;MAXCH; ch++) {
        pru0_dram[<span class="integer">2</span>*ch  ] = on[ch];     <span class="comment">// Copy to DRAM0 so the ARM can change it</span>
        pru0_dram[<span class="integer">2</span>*ch+<span class="integer">1</span>] = off[ch];    <span class="comment">// Interleave the on and off values</span>
        onCount[ch] = on[ch];
        offCount[ch]= off[ch];
    }

    <span class="keyword">while</span> (<span class="integer">1</span>) {
        update(<span class="integer">0</span>)
        update(<span class="integer">1</span>)
        update(<span class="integer">2</span>)
        update(<span class="integer">3</span>)
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output of <code>pwm5.pru0.c</code> is in the figure below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="figures/pwm5_no_loop.png" alt="pwm5.pru0.c Unrolled version of pwm4.pru0.c">
</div>
<div class="title">Figure 6. pwm5.pru0.c Unrolled version of pwm4.pru0.c</div>
</div>
<div class="paragraph">
<p>It&#8217;s running about 6 times faster than <code>pwm4.pru0.c</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. pwm4.pru0.c vs. pwm5.pru0.c</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Measure</th>
<th class="tableblock halign-left valign-top">pwm4.pru0.c time</th>
<th class="tableblock halign-left valign-top">pwm5.pru0.c time</th>
<th class="tableblock halign-left valign-top">Speedup</th>
<th class="tableblock halign-left valign-top">pwm5.pru0.c w/o UNROLL</th>
<th class="tableblock halign-left valign-top">Speedup</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Period</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.06&mu;s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">510ns</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.81&mu;s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">~1.7x</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Width+</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">450ns</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">70ns</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">~6x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.56&mu;s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">~.3x</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Not a bad speed up for just a couple of simple changes.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_4"><a class="link" href="#_discussion_4">Discussion</a></h4>
<div class="paragraph">
<p>Here&#8217;s how it works.
First look at line 39.  You see <code>#pragma UNROLL(MAXCH)</code> which is a <code>pragma</code>
that tells the compiler to unroll the loop that follows.  We are unrolling it
<code>MAXCH</code> times (four times in this example). Just removing the <code>pragma</code> causes
the speedup compared to the <code>pwm4.pru0.c</code> case to drop from 6x to only 1.7x.</p>
</div>
<div class="paragraph">
<p>We also have our <code>for</code> loop inside the <code>while</code> loop that can be unrolled.
Unfortunately <code>UNROLL()</code> doesn&#8217;t work on it, therefore we have to do it by
hand. We could take the loop and just copy it three times, but that would
make it harder to maintain the code.  Instead I convered the loop into a
<code>#define</code> (lines 14-24) and invoked <code>update()</code> as needed (lines 48-51).
This is not a function call. Whenever the preprocessor sees the <code>update()</code>
it copies the code an then it&#8217;s compiled.</p>
</div>
<div class="paragraph">
<p>This unrolling gets us an impressive 6x speedup.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_making_all_the_pulses_start_at_the_same_time"><a class="link" href="#_making_all_the_pulses_start_at_the_same_time">1.6. Making All the Pulses Start at the Same Time</a></h3>
<div class="sect3">
<h4 id="_problem_6"><a class="link" href="#_problem_6">Problem</a></h4>
<div class="paragraph">
<p>I have a mutlichannel PWM working, but the pulses aren&#8217;t synchronized, that is
they don&#8217;t all start at the same time.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_6"><a class="link" href="#_solution_6">Solution</a></h4>
<div class="paragraph">
<p><a href="#blocks_zoomed">pwm5.pru0 Zoomed In</a> is a zoomed in version of the previous figure. Notice the pulse in each channel starts about 15ns later than the channel above
it.</p>
</div>
<div id="blocks_zoomed" class="imageblock">
<div class="content">
<img src="figures/pwm5_zoomed.png" alt="pwm5.pru0 zoomed.png">
</div>
<div class="title">Figure 7. pwm5.pru0 Zoomed In</div>
</div>
<div class="paragraph">
<p>The solution is to declare <code>Rtmp</code> (line 35) which holds the value for <code>__R30</code>.</p>
</div>
<div class="listingblock">
<div class="title">pwm6.pru0.c Sync&#8217;ed Version of pwm5.pru0.c</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre></td>
  <td class="code"><pre><span class="comment">// This code does MAXCH parallel PWM channels.</span>
<span class="comment">// All channels start at the same time. It's period is 510ns</span>
<span class="preprocessor">#include</span> <span class="include">&lt;stdint.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_cfg.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;resource_table_empty.h&quot;</span>

<span class="preprocessor">#define</span> PRU0_DRAM       <span class="hex">0x00000</span>         <span class="comment">// Offset to DRAM</span>
<span class="comment">// Skip the first 0x200 byte of DRAM since the Makefile allocates</span>
<span class="comment">// 0x100 for the STACK and 0x100 for the HEAP.</span>
<span class="directive">volatile</span> <span class="predefined-type">unsigned</span> <span class="predefined-type">int</span> *pru0_dram = (<span class="predefined-type">unsigned</span> <span class="predefined-type">int</span> *) (PRU0_DRAM + <span class="hex">0x200</span>);

<span class="preprocessor">#define</span> MAXCH   <span class="integer">4</span>   <span class="comment">// Maximum number of channels per PRU</span>

<span class="preprocessor">#define</span> update(ch) \
            <span class="keyword">if</span>(onCount[ch]) {           \
                onCount[ch]--;          \
                Rtmp |= <span class="hex">0x1</span>&lt;&lt;ch;        \
            } <span class="keyword">else</span> <span class="keyword">if</span>(offCount[ch]) {   \
                offCount[ch]--;         \
                Rtmp &amp;= ~(<span class="hex">0x1</span>&lt;&lt;ch); \
            } <span class="keyword">else</span> {                    \
                onCount[ch] = pru0_dram[<span class="integer">2</span>*ch];  \
                offCount[ch]= pru0_dram[<span class="integer">2</span>*ch+<span class="integer">1</span>];    \
            }

<span class="directive">volatile</span> <span class="directive">register</span> uint32_t __R30;
<span class="directive">volatile</span> <span class="directive">register</span> uint32_t __R31;

<span class="directive">void</span> main(<span class="directive">void</span>)
{
    uint32_t ch;
    uint32_t on[]  = {<span class="integer">1</span>, <span class="integer">2</span>, <span class="integer">3</span>, <span class="integer">4</span>};
    uint32_t off[] = {<span class="integer">4</span>, <span class="integer">3</span>, <span class="integer">2</span>, <span class="integer">1</span>};
    uint32_t onCount[MAXCH], offCount[MAXCH];
    <span class="directive">register</span> uint32_t Rtmp;

    <span class="comment">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
    CT_CFG.SYSCFG_bit.STANDBY_INIT = <span class="integer">0</span>;

<span class="preprocessor">#pragma</span> UNROLL(MAXCH)
    <span class="keyword">for</span>(ch=<span class="integer">0</span>; ch&lt;MAXCH; ch++) {
        pru0_dram[<span class="integer">2</span>*ch  ] = on[ch];     <span class="comment">// Copy to DRAM0 so the ARM can change it</span>
        pru0_dram[<span class="integer">2</span>*ch+<span class="integer">1</span>] = off[ch];    <span class="comment">// Interleave the on and off values</span>
        onCount[ch] = on[ch];
        offCount[ch]= off[ch];
    }
    Rtmp = __R30;

    <span class="keyword">while</span> (<span class="integer">1</span>) {
        update(<span class="integer">0</span>)
        update(<span class="integer">1</span>)
        update(<span class="integer">2</span>)
        update(<span class="integer">3</span>)
        __R30 = Rtmp;
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Each channel writes it&#8217;s value to <code>Rtmp</code> (lines 17 and 20) and then after
each channel has updated, <code>Rtmp</code> is copied to <code>__R30</code> (line 54).</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_5"><a class="link" href="#_discussion_5">Discussion</a></h4>
<div class="paragraph">
<p>The following figure shows the channel are sync&#8217;ed. Though the period is slightly
longer than before.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="figures/pwm6_synced.png" alt="pwm6.pru0 Synchronized Channels">
</div>
<div class="title">Figure 8. pwm6.pru0 Synchronized Channels</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_adding_more_channels_via_pru_1"><a class="link" href="#_adding_more_channels_via_pru_1">1.7. Adding More Channels via PRU 1</a></h3>
<div class="sect3">
<h4 id="_problem_7"><a class="link" href="#_problem_7">Problem</a></h4>
<div class="paragraph">
<p>You need more output channels, or you need to shorten the period.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_7"><a class="link" href="#_solution_7">Solution</a></h4>
<div class="paragraph">
<p>PRU 0 can output up to eight output pins (see
<a href="#blocks_mapping_bits">Mapping bit positions to pin names</a>). The code presented so far
can be easily extended to use the eight output pins.</p>
</div>
<div class="paragraph">
<p>But what if you need more channels?
You can always use PRU1, it has 14 output pins.</p>
</div>
<div class="paragraph">
<p>Or, what if four channels is enough, but you need a shorter period. Everytime
you add a channel, the overall period gets longer.  Twice as many channels
means twice as long a period.  If you move half the channels to PRU 1, you
will make the period half as long.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the code (<code>pwm7.pru0.c</code>)</p>
</div>
<div class="listingblock">
<div class="title">pwm7.pru0.c Using Both PRUs</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td>
  <td class="code"><pre><span class="comment">// This code does MAXCH parallel PWM channels on both PRU 0 and PRU 1</span>
<span class="comment">// All channels start at the same time. But the PRU 1 ch have a difference period</span>
<span class="comment">// It's period is 370ns</span>
<span class="preprocessor">#include</span> <span class="include">&lt;stdint.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_cfg.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;resource_table_empty.h&quot;</span>

<span class="preprocessor">#define</span> PRUNUM <span class="integer">0</span>

<span class="preprocessor">#define</span> PRU0_DRAM       <span class="hex">0x00000</span>         <span class="comment">// Offset to DRAM</span>
<span class="comment">// Skip the first 0x200 byte of DRAM since the Makefile allocates</span>
<span class="comment">// 0x100 for the STACK and 0x100 for the HEAP.</span>
<span class="directive">volatile</span> <span class="predefined-type">unsigned</span> <span class="predefined-type">int</span> *pru0_dram = (<span class="predefined-type">unsigned</span> <span class="predefined-type">int</span> *) (PRU0_DRAM + <span class="hex">0x200</span>);

<span class="preprocessor">#define</span> MAXCH   <span class="integer">2</span>   <span class="comment">// Maximum number of channels per PRU</span>

<span class="preprocessor">#define</span> update(ch) \
            <span class="keyword">if</span>(onCount[ch]) {           \
                onCount[ch]--;          \
                Rtmp |= <span class="hex">0x1</span>&lt;&lt;ch;        \
            } <span class="keyword">else</span> <span class="keyword">if</span>(offCount[ch]) {   \
                offCount[ch]--;         \
                Rtmp &amp;= ~(<span class="hex">0x1</span>&lt;&lt;ch); \
            } <span class="keyword">else</span> {                    \
                onCount[ch] = pru0_dram[<span class="integer">2</span>*ch];  \
                offCount[ch]= pru0_dram[<span class="integer">2</span>*ch+<span class="integer">1</span>];    \
            }

<span class="directive">volatile</span> <span class="directive">register</span> uint32_t __R30;
<span class="directive">volatile</span> <span class="directive">register</span> uint32_t __R31;

<span class="directive">void</span> main(<span class="directive">void</span>)
{
    uint32_t ch;
    uint32_t on[]  = {<span class="integer">1</span>, <span class="integer">2</span>, <span class="integer">3</span>, <span class="integer">4</span>};
    uint32_t off[] = {<span class="integer">4</span>, <span class="integer">3</span>, <span class="integer">2</span>, <span class="integer">1</span>};
    uint32_t onCount[MAXCH], offCount[MAXCH];
    <span class="directive">register</span> uint32_t Rtmp;

    <span class="comment">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
    CT_CFG.SYSCFG_bit.STANDBY_INIT = <span class="integer">0</span>;

<span class="preprocessor">#pragma</span> UNROLL(MAXCH)
    <span class="keyword">for</span>(ch=<span class="integer">0</span>; ch&lt;MAXCH; ch++) {
        pru0_dram[<span class="integer">2</span>*ch  ] = on [ch+PRUNUM*MAXCH];   <span class="comment">// Copy to DRAM0 so the ARM can change it</span>
        pru0_dram[<span class="integer">2</span>*ch+<span class="integer">1</span>] = off[ch+PRUNUM*MAXCH];   <span class="comment">// Interleave the on and off values</span>
        onCount[ch] = on [ch+PRUNUM*MAXCH];
        offCount[ch]= off[ch+PRUNUM*MAXCH];
    }
    Rtmp = __R30;

    <span class="keyword">while</span> (<span class="integer">1</span>) {
        update(<span class="integer">0</span>)
        update(<span class="integer">1</span>)
        __R30 = Rtmp;
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Be sure to run <code>pwm7_setup.sh</code> to get the correct pins configured.</p>
</div>
<div class="listingblock">
<div class="title">pwm7_setup.sh</div>
<div class="content">
<pre>#!/bin/bash
#
export TARGET=pwm7.pru0
echo TARGET=$TARGET

# Configure the PRU pins based on which Beagle is running
machine=$(awk '{print $NF}' /proc/device-tree/model)
echo -n $machine
if [ $machine = "Black" ]; then
    echo " Found"
    pins="P9_31 P9_29 P8_45 P8_46"
elif [ $machine = "Blue" ]; then
    echo " Found"
    pins=""
elif [ $machine = "PocketBeagle" ]; then
    echo " Found"
    pins="P1_36 P1_33"
else
    echo " Not Found"
    pins=""
fi

for pin in $pins
do
    echo $pin
    config-pin $pin pruout
    config-pin -q $pin
done</pre>
</div>
</div>
<div class="paragraph">
<p>This makes sure the PRU 1 pins are properly configured.</p>
</div>
<div class="paragraph">
<p>Here we have a second <code>pwm7</code> file. <code>pwm7.pru1.c</code> is identical to <code>pwm7.pru0.c</code>
except <code>PRUNUM</code> is set to 1, instead of 0.</p>
</div>
<div class="paragraph">
<p>Compile and run the two files with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>bone$ <strong>make TARGET=pwm7.pru0; make TARGET=pwm7.pru1</strong>
/var/lib/cloud9/common/Makefile:29: MODEL=TI_AM335x_BeagleBone_Black,TARGET=pwm7.pru0
-    Stopping PRU 0
-   copying firmware file /tmp/cloud9-examples/pwm7.pru0.out to /lib/firmware/am335x-pru0-fw
write_init_pins.sh
-    Starting PRU 0
MODEL   = TI_AM335x_BeagleBone_Black
PROC    = pru
PRUN    = 0
PRU_DIR = /sys/class/remoteproc/remoteproc1
/var/lib/cloud9/common/Makefile:29: MODEL=TI_AM335x_BeagleBone_Black,TARGET=pwm7.pru1
-    Stopping PRU 1
-   copying firmware file /tmp/cloud9-examples/pwm7.pru1.out to /lib/firmware/am335x-pru1-fw
write_init_pins.sh
-    Starting PRU 1
MODEL   = TI_AM335x_BeagleBone_Black
PROC    = pru
PRUN    = 1
PRU_DIR = /sys/class/remoteproc/remoteproc2</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will first stop, compile and start PRU 0, then do the same for PRU 1.</p>
</div>
<div class="paragraph">
<p>Moving half of the channels to PRU1 dropped the period from 510ns to 370ns, so
we gained a bit.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_6"><a class="link" href="#_discussion_6">Discussion</a></h4>
<div class="paragraph">
<p>There weren&#8217;t many changes to be made.  Line 15 we set MAXCH to 2. Lines 44-48
is where the big change is.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">        pru0_dram[<span class="integer">2</span>*ch  ] = on [ch+PRUNUN*MAXCH];   <span class="comment">// Copy to DRAM0 so the ARM can change it</span>
        pru0_dram[<span class="integer">2</span>*ch+<span class="integer">1</span>] = off[ch+PRUNUN*MAXCH];   <span class="comment">// Interleave the on and off values</span>
        onCount[ch] = on [ch+PRUNUN*MAXCH];
        offCount[ch]= off[ch+PRUNUN*MAXCH];</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we are compiling for PRU 0, <code>on[ch+PRUNUN*MAXCH]</code> becomes <code>on[ch+0*2]</code> which is
<code>on[ch]</code> which is what we had before.  But now if we are on PRU 1 it becomes
<code>on[ch+1*2]</code> which is <code>on[ch+2]</code>.  That means we are picking up the second
half of the <code>on</code> and <code>off</code> arrays.  The first half goes to PRU 0, the second to
PRU 1.  So the same code can be used for both PRUs, but we get slightly different
behavior.</p>
</div>
<div class="paragraph">
<p>Running the code you will see the next figure.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="figures/pwm7_two_prus_running.png" alt="pwm7.pru0 Two PRUs running">
</div>
<div class="title">Figure 9. pwm7.pru0 Two PRUs running</div>
</div>
<div class="paragraph">
<p>What&#8217;s going on there, the first channels look fine, but the PRU 1 channels
are blurred.  To see what&#8217;s happening, let&#8217;s stop the oscilloscope.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="figures/pwm7_two_prus_stopped.png" alt="pwm7 Two PRUs stopped">
</div>
<div class="title">Figure 10. pwm7.pru0 Two PRUs stopped</div>
</div>
<div class="paragraph">
<p>The stopped display shows that the four channels are doing what we wanted, except
The PRU 0 channels have a period of 370ns while the PRU 1 channels at 330ns.
It appears the compiler has optimied the two PRUs slightly differenty.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_synchronizing_two_prus"><a class="link" href="#_synchronizing_two_prus">1.8. Synchronizing Two PRUs</a></h3>
<div class="sect3">
<h4 id="_problem_8"><a class="link" href="#_problem_8">Problem</a></h4>
<div class="paragraph">
<p>I need to synchronize the two PRUs so they run together.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_8"><a class="link" href="#_solution_8">Solution</a></h4>
<div class="paragraph">
<p>Use the Interrupt Controller (INTC).  It allows one PRU to signal the other.
Page 225 of the
<a href="https://www.ti.com/lit/ug/spruh73p/spruh73p.pdf">AM335x Technical Reference Manual</a>
has details of how it works.  Here&#8217;s the code for PRU 0, which at the end of the
<code>while</code> loop signals PRU 1 to start(<code>pwm8.pru0.c</code>).</p>
</div>
<div class="listingblock">
<div class="title">pwm8.pru0.c PRU 0 using INTC to send a signal to PRU 1</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
</pre></td>
  <td class="code"><pre><span class="comment">// This code does MAXCH parallel PWM channels on both PRU 0 and PRU 1</span>
<span class="comment">// All channels start at the same time.</span>
<span class="comment">// It's period is 430ns</span>
<span class="preprocessor">#include</span> <span class="include">&lt;stdint.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_cfg.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_intc.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_ctrl.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;resource_table_empty.h&quot;</span>

<span class="preprocessor">#define</span> PRUNUM <span class="integer">0</span>

<span class="preprocessor">#define</span> PRU0_DRAM       <span class="hex">0x00000</span>         <span class="comment">// Offset to DRAM</span>
<span class="comment">// Skip the first 0x200 byte of DRAM since the Makefile allocates</span>
<span class="comment">// 0x100 for the STACK and 0x100 for the HEAP.</span>
<span class="directive">volatile</span> <span class="predefined-type">unsigned</span> <span class="predefined-type">int</span> *pru0_dram = (<span class="predefined-type">unsigned</span> <span class="predefined-type">int</span> *) (PRU0_DRAM + <span class="hex">0x200</span>);

<span class="preprocessor">#define</span> MAXCH   <span class="integer">2</span>   <span class="comment">// Maximum number of channels per PRU</span>

<span class="preprocessor">#define</span> update(ch) \
            <span class="keyword">if</span>(onCount[ch]) {           \
                onCount[ch]--;          \
                Rtmp |= <span class="hex">0x1</span>&lt;&lt;ch;        \
            } <span class="keyword">else</span> <span class="keyword">if</span>(offCount[ch]) {   \
                offCount[ch]--;         \
                Rtmp &amp;= ~(<span class="hex">0x1</span>&lt;&lt;ch); \
            } <span class="keyword">else</span> {                    \
                onCount[ch] = pru0_dram[<span class="integer">2</span>*ch];  \
                offCount[ch]= pru0_dram[<span class="integer">2</span>*ch+<span class="integer">1</span>];    \
            }

<span class="directive">volatile</span> <span class="directive">register</span> uint32_t __R30;
<span class="directive">volatile</span> <span class="directive">register</span> uint32_t __R31;

<span class="comment">// Initialize interupts so the PRUs can be syncronized.</span>
<span class="comment">// PRU1 is started first and then waits for PRU0</span>
<span class="comment">// PRU0 is then started and tells PRU1 when to start going</span>
<span class="directive">void</span> configIntc(<span class="directive">void</span>) {
    __R31 = <span class="hex">0x00000000</span>;                 <span class="comment">// Clear any pending PRU-generated events</span>
    CT_INTC.CMR4_bit.CH_MAP_16 = <span class="integer">1</span>;     <span class="comment">// Map event 16 to channel 1</span>
    CT_INTC.HMR0_bit.HINT_MAP_1 = <span class="integer">1</span>;    <span class="comment">// Map channel 1 to host 1</span>
    CT_INTC.SICR = <span class="integer">16</span>;                  <span class="comment">// Ensure event 16 is cleared</span>
    CT_INTC.EISR = <span class="integer">16</span>;                  <span class="comment">// Enable event 16</span>
    CT_INTC.HIEISR |= (<span class="integer">1</span> &lt;&lt; <span class="integer">0</span>);         <span class="comment">// Enable Host interrupt 1</span>
    CT_INTC.GER = <span class="integer">1</span>;                    <span class="comment">// Globally enable host interrupts</span>
}

<span class="directive">void</span> main(<span class="directive">void</span>)
{
    uint32_t ch;
    uint32_t on[]  = {<span class="integer">1</span>, <span class="integer">2</span>, <span class="integer">3</span>, <span class="integer">4</span>};
    uint32_t off[] = {<span class="integer">4</span>, <span class="integer">3</span>, <span class="integer">2</span>, <span class="integer">1</span>};
    uint32_t onCount[MAXCH], offCount[MAXCH];
    <span class="directive">register</span> uint32_t Rtmp;

    CT_CFG.GPCFG0 = <span class="hex">0x0000</span>;             <span class="comment">// Configure GPI and GPO as Mode 0 (Direct Connect)</span>
    configIntc();                       <span class="comment">// Configure INTC</span>

    <span class="comment">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
    CT_CFG.SYSCFG_bit.STANDBY_INIT = <span class="integer">0</span>;

<span class="preprocessor">#pragma</span> UNROLL(MAXCH)
    <span class="keyword">for</span>(ch=<span class="integer">0</span>; ch&lt;MAXCH; ch++) {
        pru0_dram[<span class="integer">2</span>*ch  ] = on [ch+PRUNUM*MAXCH];   <span class="comment">// Copy to DRAM0 so the ARM can change it</span>
        pru0_dram[<span class="integer">2</span>*ch+<span class="integer">1</span>] = off[ch+PRUNUM*MAXCH];   <span class="comment">// Interleave the on and off values</span>
        onCount[ch] = on [ch+PRUNUM*MAXCH];
        offCount[ch]= off[ch+PRUNUM*MAXCH];
    }
    Rtmp = __R30;

    <span class="keyword">while</span> (<span class="integer">1</span>) {
        __R30 = Rtmp;
        update(<span class="integer">0</span>)
        update(<span class="integer">1</span>)
<span class="preprocessor">#define</span> PRU0_PRU1_EVT <span class="integer">16</span>
        __R31 = (PRU0_PRU1_EVT-<span class="integer">16</span>) | (<span class="hex">0x1</span>&lt;&lt;<span class="integer">5</span>);  <span class="comment">//Tell PRU 1 to start</span>
        __delay_cycles(<span class="integer">1</span>);
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>PRU 2&#8217;s code waits for PRU 0 before going.</p>
</div>
<div class="listingblock">
<div class="title">pwm8.pru1.c PRU 1 waiting for INTC from PRU 0</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
</pre></td>
  <td class="code"><pre><span class="comment">// This code does MAXCH parallel PWM channels on both PRU 0 and PRU 1</span>
<span class="comment">// All channels start at the same time.</span>
<span class="comment">// It's period is 430ns</span>
<span class="preprocessor">#include</span> <span class="include">&lt;stdint.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_cfg.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_intc.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_ctrl.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;resource_table_empty.h&quot;</span>

<span class="preprocessor">#define</span> PRUNUM <span class="integer">1</span>

<span class="preprocessor">#define</span> PRU0_DRAM       <span class="hex">0x00000</span>         <span class="comment">// Offset to DRAM</span>
<span class="comment">// Skip the first 0x200 byte of DRAM since the Makefile allocates</span>
<span class="comment">// 0x100 for the STACK and 0x100 for the HEAP.</span>
<span class="directive">volatile</span> <span class="predefined-type">unsigned</span> <span class="predefined-type">int</span> *pru0_dram = (<span class="predefined-type">unsigned</span> <span class="predefined-type">int</span> *) (PRU0_DRAM + <span class="hex">0x200</span>);

<span class="preprocessor">#define</span> MAXCH   <span class="integer">2</span>   <span class="comment">// Maximum number of channels per PRU</span>

<span class="preprocessor">#define</span> update(ch) \
            <span class="keyword">if</span>(onCount[ch]) {           \
                onCount[ch]--;          \
                Rtmp |= <span class="hex">0x1</span>&lt;&lt;ch;        \
            } <span class="keyword">else</span> <span class="keyword">if</span>(offCount[ch]) {   \
                offCount[ch]--;         \
                Rtmp &amp;= ~(<span class="hex">0x1</span>&lt;&lt;ch); \
            } <span class="keyword">else</span> {                    \
                onCount[ch] = pru0_dram[<span class="integer">2</span>*ch];  \
                offCount[ch]= pru0_dram[<span class="integer">2</span>*ch+<span class="integer">1</span>];    \
            }

<span class="directive">volatile</span> <span class="directive">register</span> uint32_t __R30;
<span class="directive">volatile</span> <span class="directive">register</span> uint32_t __R31;

<span class="comment">// Initialize interupts so the PRUs can be syncronized.</span>
<span class="comment">// PRU1 is started first and then waits for PRU0</span>
<span class="comment">// PRU0 is then started and tells PRU1 when to start going</span>

<span class="directive">void</span> main(<span class="directive">void</span>)
{
    uint32_t ch;
    uint32_t on[]  = {<span class="integer">1</span>, <span class="integer">2</span>, <span class="integer">3</span>, <span class="integer">4</span>};
    uint32_t off[] = {<span class="integer">4</span>, <span class="integer">3</span>, <span class="integer">2</span>, <span class="integer">1</span>};
    uint32_t onCount[MAXCH], offCount[MAXCH];
    <span class="directive">register</span> uint32_t Rtmp;

    <span class="comment">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
    CT_CFG.SYSCFG_bit.STANDBY_INIT = <span class="integer">0</span>;

<span class="preprocessor">#pragma</span> UNROLL(MAXCH)
    <span class="keyword">for</span>(ch=<span class="integer">0</span>; ch&lt;MAXCH; ch++) {
        pru0_dram[<span class="integer">2</span>*ch  ] = on [ch+PRUNUM*MAXCH];   <span class="comment">// Copy to DRAM0 so the ARM can change it</span>
        pru0_dram[<span class="integer">2</span>*ch+<span class="integer">1</span>] = off[ch+PRUNUM*MAXCH];   <span class="comment">// Interleave the on and off values</span>
        onCount[ch] = on [ch+PRUNUM*MAXCH];
        offCount[ch]= off[ch+PRUNUM*MAXCH];
    }
    Rtmp = __R30;

    <span class="keyword">while</span> (<span class="integer">1</span>) {
        <span class="keyword">while</span>((__R31 &amp; (<span class="hex">0x1</span>&lt;&lt;<span class="integer">31</span>))==<span class="integer">0</span>) {     <span class="comment">// Wait for PRU 0</span>
        }
        CT_INTC.SICR = <span class="integer">16</span>;                  <span class="comment">// Clear event 16</span>
        __R30 = Rtmp;
        update(<span class="integer">0</span>)
        update(<span class="integer">1</span>)
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>In <code>pwm8.pru0.c</code> PRU 1 waits for a signal from PRU 0, so be sure to start PRU 1 first.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>bone$ <strong>make TARGET=pwm8.pru0; make TARGET=pwm8.pru1</strong></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_7"><a class="link" href="#_discussion_7">Discussion</a></h4>
<div class="paragraph">
<p>The figure below shows the two PRUs are synchronized, though there is some extra
overhead in the process so the period is longer.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="figures/pwm8_prus_sycned.png" alt="pwm8.pru0 PRUs sycned">
</div>
<div class="title">Figure 11. pwm8.pru0 PRUs sycned</div>
</div>
<div class="paragraph">
<p>This isn&#8217;t much different from the previous examples.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. pwm8.pru0.c changes from pwm7.pru0.c</caption>
<colgroup>
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 81.8182%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">PRU</th>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Change</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">37-45</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For PRU 0 these define <code>configInitc()</code> which initializes the interupts.
See page 226 of the
<a href="https://www.ti.com/lit/ug/spruh73p/spruh73p.pdf">AM335x Technical Reference Manual</a>
for a diagram explaining events, channels, hosts, etc.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">55-56</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set a configuration register and call <code>configInitc</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">59-61</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PRU 1 then waits for PRU 0 to signal it.  Bit 31 of <code>__R31</code> corresponds
to the Host-1 channel which <code>configInitc()</code> set up. We also clear event 16 so
PRU 0 can set it again.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">74-75</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">On PRU 0 this generates the interupt to send to PRU 1.  I found PRU 1 was
slow to respond to the interupt, so I put this code at the end of the loop to
give time for the signal to get to PRU 1.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>This ends the multipart pwm example.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_reading_an_input_at_regular_intervals"><a class="link" href="#_reading_an_input_at_regular_intervals">1.9. Reading an Input at Regular Intervals</a></h3>
<div class="sect3">
<h4 id="_problem_9"><a class="link" href="#_problem_9">Problem</a></h4>
<div class="paragraph">
<p>You have an input pin that needs to be read at regular intervals.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_9"><a class="link" href="#_solution_9">Solution</a></h4>
<div class="paragraph">
<p>You can use the <code>__R31</code> register to read an input pin. Let&#8217;s use the following
pins.</p>
</div>
<table id="blocks_io_pins" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Input/Output pins</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Direction</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bit number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Black</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AI (ICSS2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pocket</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">out</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_31</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_44</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.36</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">in</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P9_25</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P8_36</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1.29</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>These values came from <a href="#blocks_mapping_bits">Mapping bit positions to pin names</a>.</p>
</div>
<div class="paragraph">
<p>Configure the pins with <code>input_setup.sh</code>.</p>
</div>
<div class="listingblock">
<div class="title">input_setup.sh</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linenums">#!/bin/bash
#
export TARGET=input.pru0
echo TARGET=$TARGET

# Configure the PRU pins based on which Beagle is running
machine=$(awk '{print $NF}' /proc/device-tree/model)
echo -n $machine
if [ $machine = &quot;Black&quot; ]; then
    echo &quot; Found&quot;
    config-pin P9_31 pruout
    config-pin -q P9_31
    config-pin P9_25 pruin
    config-pin -q P9_25
elif [ $machine = &quot;Blue&quot; ]; then
    echo &quot; Found&quot;
    pins=&quot;&quot;
elif [ $machine = &quot;PocketBeagle&quot; ]; then
    echo &quot; Found&quot;
    config-pin P1_36 pruout
    config-pin -q P1_36
    config-pin P1_29 pruin
    config-pin -q P1_29
else
    echo &quot; Not Found&quot;
    pins=&quot;&quot;
fi</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following code reads the input pin and writes its value to the output pin.</p>
</div>
<div class="listingblock">
<div class="title">input.c</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td>
  <td class="code"><pre><span class="preprocessor">#include</span> <span class="include">&lt;stdint.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_cfg.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;resource_table_empty.h&quot;</span>

<span class="directive">volatile</span> <span class="directive">register</span> uint32_t __R30;
<span class="directive">volatile</span> <span class="directive">register</span> uint32_t __R31;

<span class="directive">void</span> main(<span class="directive">void</span>)
{
    uint32_t led;
    uint32_t sw;

    <span class="comment">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
    CT_CFG.SYSCFG_bit.STANDBY_INIT = <span class="integer">0</span>;

    led = <span class="hex">0x1</span>&lt;&lt;<span class="integer">0</span>;   <span class="comment">// P9_31 or P1_36</span>
    sw  = <span class="hex">0x1</span>&lt;&lt;<span class="integer">7</span>;   <span class="comment">// P9_25 or P1_29</span>

    <span class="keyword">while</span> (<span class="integer">1</span>) {
        <span class="keyword">if</span>((__R31&amp;sw) == sw) {
            __R30 |= led;       <span class="comment">// Turn on LED</span>
        } <span class="keyword">else</span>
            __R30 &amp;= ~led;      <span class="comment">// Turn off LED</span>
    }
}
</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_8"><a class="link" href="#_discussion_8">Discussion</a></h4>
<div class="paragraph">
<p>Just remember that <code>__R30</code> is for outputs and <code>__R31</code> is
for inputs.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_analog_wave_generator"><a class="link" href="#_analog_wave_generator">1.10. Analog Wave Generator</a></h3>
<div class="sect3">
<h4 id="_problem_10"><a class="link" href="#_problem_10">Problem</a></h4>
<div class="paragraph">
<p>I want to generate an analog output, but only have GPIO pins.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_10"><a class="link" href="#_solution_10">Solution</a></h4>
<div class="paragraph">
<p>The Beagle doesn&#8217;t have a built-in  analog to digital converter. You could
get a <a href="https://www.amazon.com/external-Adapter-Windows-Microphone-SD-CM-UAUD/dp/B001MSS6CS/0&amp;keywords=audio+dongle">USB Audio Dongle</a> which are under $10.  But here
we&#8217;ll take another approach.</p>
</div>
<div class="paragraph">
<p>Earlier we generated a PWM signal.  Here we&#8217;ll generate a PWM whose duty cycle
changes with time.  A small duty cycle for when the output signal is small and
a large dudty cycle for when it is large.</p>
</div>
<div class="paragraph">
<p>This example was inspired by
<a href="https://github.com/derekmolloy/exploringBB/tree/master/chp13/sineWave">A PRU Sin Wave Generator</a>
in chapter 13 of
<a href="http://exploringbeaglebone.com/">Exploring BeagleBone by Derek Molloy</a>.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the code.</p>
</div>
<div class="listingblock">
<div class="title">sine.pru0.c</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre></td>
  <td class="code"><pre><span class="comment">// Generate an analog waveform and use a filter to reconstruct it.</span>
<span class="preprocessor">#include</span> <span class="include">&lt;stdint.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_cfg.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;resource_table_empty.h&quot;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;math.h&gt;</span>

<span class="preprocessor">#define</span> MAXT    <span class="integer">100</span> <span class="comment">// Maximum number of time samples</span>
<span class="preprocessor">#define</span> SAWTOOTH    <span class="comment">// Pick which waveform</span>

<span class="directive">volatile</span> <span class="directive">register</span> uint32_t <em>R30;
<span class="directive">volatile</span> <span class="directive">register</span> uint32_t </em>R31;

<span class="directive">void</span> main(<span class="directive">void</span>)
{
    uint32_t onCount;       <span class="comment">// Current count for 1 out</span>
    uint32_t offCount;      <span class="comment">// count for 0 out</span>
    uint32_t i;
    uint32_t waveform[MAXT]; <span class="comment">// Waveform to be produced</span>

    <span class="comment">// Generate a periodic wave in an array of MAXT values</span>
<span class="preprocessor">#ifdef</span> SAWTOOTH
    <span class="keyword">for</span>(i=<span class="integer">0</span>; i&lt;MAXT; i++) {
        waveform[i] = i*<span class="integer">100</span>/MAXT;
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor">#ifdef</span> TRIANGLE
    <span class="keyword">for</span>(i=<span class="integer">0</span>; i&lt;MAXT/<span class="integer">2</span>; i++) {
        waveform[i]        = <span class="integer">2</span><strong>i</strong><span class="integer">100</span>/MAXT;
        waveform[MAXT-i-<span class="integer">1</span>] = <span class="integer">2</span><strong>i</strong><span class="integer">100</span>/MAXT;
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor">#ifdef</span> SINE
    <span class="predefined-type">float</span> gain = <span class="integer">5</span><span class="float">0</span><span class="float">.0f</span>;
    <span class="predefined-type">float</span> bias = <span class="integer">5</span><span class="float">0</span><span class="float">.0f</span>;
    <span class="predefined-type">float</span> freq = <span class="float">2</span><span class="float">.0f</span> * <span class="float">3</span><span class="float">.14159f</span> / MAXT;
    <span class="keyword">for</span> (i=<span class="integer">0</span>; i&lt;MAXT; i++){
        waveform[i] = (uint32_t)(bias+gain*sin(i*freq));
    }
<span class="preprocessor">#endif</span>

    <span class="comment">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
    CT_CFG.SYSCFG_bit.STANDBY_INIT = <span class="integer">0</span>;

    <span class="keyword">while</span> (<span class="integer">1</span>) {
        <span class="comment">// Generate a PWM signal whose duty cycle matches</span>
        <span class="comment">// the amplitude of the signal.</span>
        <span class="keyword">for</span>(i=<span class="integer">0</span>; i&lt;MAXT; i++) {
            onCount = waveform[i];
            offCount = <span class="integer">100</span> - onCount;
            <span class="keyword">while</span>(onCount--) {
                <em>R30 |= <span class="hex">0x1</span>;       <span class="comment">// Set the GPIO pin to 1</span>
            }
            <span class="keyword">while</span>(offCount--) {
                </em>R30 &amp;= ~(<span class="hex">0x1</span>);    <span class="comment">// Clear the GPIO pin</span>
            }
        }
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Set the <code>#define</code> at line 7 to the number of samples in one cycle of the waveform
and set the <code>#define</code> at line 8 to which waveform and then run <code>make</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_9"><a class="link" href="#_discussion_9">Discussion</a></h4>
<div class="paragraph">
<p>The code has two parts.  The first part (lines 21 to 39) generate the waveform
to be output. The <code>#define</code>s let you select which waveform you want to
generate.  Since the output is a percent duty cycle, the values in <code>waveform[]</code>
must be between 0 and 100 inclusive. The waveform is only generated once, so
this part of the code isn&#8217;t time critical.</p>
</div>
<div class="paragraph">
<p>The second part (lines 44 to 54) uses the generated data to set the
duty cycle of the PWM on a cycle-by-cycle basis. This part is time critical;
the faster we can output the values, the higher the frequency of the output
signal.</p>
</div>
<div class="paragraph">
<p>Suppose you want to generate a sawtooth waveform like the one shown in <a href="#blocks_sawtooth">Continuous Sawtooth Waveform</a>.</p>
</div>
<div id="blocks_sawtooth" class="imageblock">
<div class="content">
<img src="figures/sawtoothsmooth.png" alt="Continuous Sawtooth Waveform">
</div>
<div class="title">Figure 12. Continuous Sawtooth Waveform</div>
</div>
<div class="paragraph">
<p>You need to sample the waveform and store one cycle. <a href="#blocks_sawtoothsampled">Sampled Sawtooth Waveform</a>
shows a sampled version of the sawtooth. You need to generate <code>MAXT</code> samples;
here we show 20 samples, which may be enough. In the code <code>MAXT</code> is set to 100.</p>
</div>
<div id="blocks_sawtoothsampled" class="imageblock">
<div class="content">
<img src="figures/sawtoothsampled.png" alt="Sampled Sawtooth Waveform">
</div>
<div class="title">Figure 13. Sampled Sawtooth Waveform</div>
</div>
<div class="paragraph">
<p>There&#8217;s a lot going on here; let&#8217;s take it line by line.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. Line-by-line of sine.pru0.c</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2-5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Standard c-header includes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number for samples in one cycle of the analog waveform</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Which waveform to use.  We&#8217;ve defined SAWTOOTH, TRIANGLE and SINE, but
you can define your own too.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">10-11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Declaring registers <code>__R30</code> and <code>__R31</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">15-16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>onCount</code> counts how many cycles the PWM should be 1 and <code>offCount</code> counts
how many it should be off.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">18</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>waveform[]</code> stores the analog waveform being ouput.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">21-24</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SAWTOOTH</code> is the simplest of the waveforms. Each sample is the duty cycle
at that time and must therefore be between 0 and 100.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">26-31</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TRIANGLE</code> is also a simple waveform.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">32-39</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SINE</code> generates a sine wave and also introduces floating point.  Yes, you can use floating point, but the PRUs don&#8217;t have floating point hardware,
rather, it&#8217;s all done in software.  This mean using floating point will make
your code much bigger and slower.  Slower doesn&#8217;t matter in this part, and
bigger isn&#8217;t bigger than our instruction memory, so we&#8217;re OK.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">47</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Here the for loop looks up each value of the generated waveform.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">48,49</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>onCount</code> is the number of cycles to be at 1 and <code>offCount</code> is the number
of cycles to be 0. The two add to 100, one full cycle.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">50-52</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stay on for <code>onCount</code> cycles.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">53-55</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No turn off for <code>offCount</code> cycles, the loop back and look up the next
cycle count.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#blocks_sawunfiltered">Unfiltered Sawtooth Waveform</a> shows the output of the code.</p>
</div>
<div id="blocks_sawunfiltered" class="imageblock">
<div class="content">
<img src="figures/sawunfiltered.png" alt="Unfiltered Sawtooth Waveform">
</div>
<div class="title">Figure 14. Unfiltered Sawtooth Waveform</div>
</div>
<div class="paragraph">
<p>It doesn&#8217;t look like a sawtooth; but if you look at the left side you will
see each cycle has a longer and longer on time.  The duty cycle is increasing.
Once it&#8217;s almost 100% duty cycle, it switches to a very small duty cycle.
Therefore it&#8217;s output what we programmed, but what we want is the average of
the signal.  The left hand side has a large (and increasing) average which
would be for top of the sawtooth.  The right hand side has a small average,
which is what you want for the start of the sawtooth.</p>
</div>
<div class="paragraph">
<p>A simple low-pass filter, built with one resistor and one capacitor will do it.
<a href="#blocks_filterwiring">Low-Pass Filter Wiring Diagram</a> shows how to wire it up.</p>
</div>
<div id="blocks_filterwiring" class="imageblock">
<div class="content">
<img src="figures/filter_bb.png" alt="Low-Pass Filter Wiring Diagram">
</div>
<div class="title">Figure 15. Low-Pass Filter Wiring Diagram</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>I used a 10K&Omega; variable resistor and a 0.022&mu;F capacitor.
Probe the circuit between the resistor and the capacitor and adjust the resistor
until you get a good looking waveform.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="#blocks_sawscope">Reconstructed Sawtooth Waveform</a> shows the results for filtered the SAWTOOTH.</p>
</div>
<div id="blocks_sawscope" class="imageblock">
<div class="content">
<img src="figures/sawscope.png" alt="Reconstructed Sawtooth Waveform">
</div>
<div class="title">Figure 16. Reconstructed Sawtooth Waveform</div>
</div>
<div class="paragraph">
<p>Now that looks more like a sawtooth wave.  The top plot is the time-domain
plot of the output of the low-pass filter. The bottom plot is the FFT of the top
plot, therefore it&#8217;s the frequency domain. We are getting a sawtooth with a
frequency of about 6.1KHz. You can see the fundamental frequency on the
bottom plot along with several harmonics.</p>
</div>
<div class="paragraph">
<p>The top looks like a sawtooth wave,
but there is a high freqnecy superimposed on it.  We are only using a simple
first-order filter.  You could lower the cutoff freqnecy by adjusting the
resistor.  You&#8217;ll see something like <a href="#blocks_lowercutoff">Reconstructed Sawtooth Waveform with Lower Cutoff Frequency</a>.</p>
</div>
<div id="blocks_lowercutoff" class="imageblock">
<div class="content">
<img src="figures/sawlowercutoff.png" alt="Reconstructed Sawtooth Waveform with Lower Cutoff Frequency">
</div>
<div class="title">Figure 17. Reconstructed Sawtooth Waveform with Lower Cutoff Frequency</div>
</div>
<div class="paragraph">
<p>The high freqencies have been reduced, but the corner of the waveform has
been rounded.  You can also adjust the cutoff to a higher frequency and you&#8217;ll
get a sharper corner, but you&#8217;ll also get more high frequencies. See
<a href="#blocks_highercutoff">Reconstructed Sawtooth Waveform with Higher Cutoff Frequency</a></p>
</div>
<div id="blocks_highercutoff" class="imageblock">
<div class="content">
<img src="figures/sawhighercutoff.png" alt="Reconstructed Sawtooth Waveform with Higher Cutoff Frequency">
</div>
<div class="title">Figure 18. Reconstructed Sawtooth Waveform with Higher Cutoff Frequency</div>
</div>
<div class="paragraph">
<p>Adjust to taste, though the real solution is to build a higher order filter.
Search for <em>second order filter</em> and you&#8217;ll find some nice circuits.</p>
</div>
<div class="paragraph">
<p>You can adjust the frequency of the signal by adjesting <code>MAXT</code>.  A smaller
<code>MAXT</code> will give a higher frequency.  I&#8217;m gotten good results with <code>MAXT</code>
as small as 20.</p>
</div>
<div class="paragraph">
<p>You can also get a triangle waveform by setting the <code>#define</code>.
<a href="#blocks_triangle">Reconstructed Triangle Waveform</a> shows the output signal.</p>
</div>
<div id="blocks_triangle" class="imageblock">
<div class="content">
<img src="figures/triangle.png" alt="Reconstructed Triangle Waveform">
</div>
<div class="title">Figure 19. Reconstructed Triangle Waveform</div>
</div>
<div class="paragraph">
<p>And also the sine wave as shown in <a href="#blocks_sine">Reconstructed Sinusoid Waveform</a>.</p>
</div>
<div id="blocks_sine" class="imageblock">
<div class="content">
<img src="figures/sine.png" alt="Reconstructed Sinusoid Waveform">
</div>
<div class="title">Figure 20. Reconstructed Sinusoid Waveform</div>
</div>
<div class="paragraph">
<p>Notice on the bottom plot the harmonics are much more suppressed.</p>
</div>
<div class="paragraph">
<p>Generating the sine waveform uses floats. This requires much more code.
You can look in <code>/tmp/cloud9-examples/sine.pru0.map</code> to see how much memory is being used.
<a href="#blocks_sine_map">/tmp/cloud9-examples/sine.pru0.map for Sine Wave</a> shows the first few lines for the sine wave.</p>
</div>
<div id="blocks_sine_map" class="listingblock">
<div class="title">/tmp/cloud9-examples/sine.pru0.map for Sine Wave</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linenums">******************************************************************************
PRU Linker Unix v2.1.5
******************************************************************************
&gt;&gt; Linked Fri Jun 29 13:58:08 2018

OUTPUT FILE NAME:   &lt;/tmp/pru0-gen/sine1.out&gt;
ENTRY POINT SYMBOL: &quot;_c_int00_noinit_noargs_noexit&quot;  address: 00000000


MEMORY CONFIGURATION

         name            origin    length      used     unused   attr    fill
----------------------  --------  ---------  --------  --------  ----  --------
PAGE 0:
  PRU_IMEM              00000000   00002000  000018c0  00000740  RWIX

PAGE 1:
  PRU_DMEM_0_1          00000000   00002000  00000154  00001eac  RWIX
  PRU_DMEM_1_0          00002000   00002000  00000000  00002000  RWIX

PAGE 2:
  PRU_SHAREDMEM         00010000   00003000  00000000  00003000  RWIX</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice line 19 shows 0x18c0 bytes are being used for instructions.  That&#8217;s 6336
in decimal.</p>
</div>
<div class="paragraph">
<p>Now compile for the sawtooth and you see only 444 byes are used.  Floating-point
requires over 5K more bytes.  Use with care.  If you are short on instruction
space, you can move the table generation to the ARM and just copy the table
to the PRU.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="blocks_ws2812"><a class="link" href="#blocks_ws2812">1.11. WS2812 (NeoPixel) driver</a></h3>
<div class="sect3">
<h4 id="_problem_11"><a class="link" href="#_problem_11">Problem</a></h4>
<div class="paragraph">
<p>




You have an <a href="http://www.adafruit.com/products/1138">Adafruit NeoPixel LED string</a>
or <a href="http://www.adafruit.com/products/1487">Adafruit NeoPixel LED matrix</a>
and want to light it up.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_11"><a class="link" href="#_solution_11">Solution</a></h4>
<div class="paragraph">
<p>NeoPixel is Adafruit&#8217;s name for the WS2812 Intelligent control LED.  Each
NeoPixel contains a Red, Green and Blue LED with a PWM controller that can
dim each one individually making a rainbow of colors possible.  The
NeoPixel is driven by a single serial line.  The timing on the line is very
sensesitive, which make the PRU a perfect candidate for driving it.</p>
</div>
<div class="paragraph">
<p>Wire the input to <code>P9_29</code> and power to 3.3V and ground to ground as shown in
<a href="#blocks_neo_wiring">NeoPixel Wiring</a>.</p>
</div>
<div id="blocks_neo_wiring" class="imageblock">
<div class="content">
<img src="figures/neo_bb.png" alt="NeoPixel Wiring">
</div>
<div class="title">Figure 21. NeoPixel Wiring</div>
</div>
<div class="paragraph">
<p>Test your wiring with the simple code in <a href="#blocks_neo1">neo1.pru0.c - Code to turn all NeoPixels&#8217;s white</a>
which to turns all pixels white.</p>
</div>
<div id="blocks_neo1" class="listingblock">
<div class="title">neo1.pru0.c - Code to turn all NeoPixels&#8217;s white</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td>
  <td class="code"><pre><span class="comment">// Control a ws2812 (NeoPixel) display, All on or all off</span>
<span class="preprocessor">#include</span> <span class="include">&lt;stdint.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_cfg.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;resource_table_empty.h&quot;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;prugpio.h&quot;</span>

<span class="preprocessor">#define</span> STR_LEN <span class="integer">24</span>
<span class="preprocessor">#define</span> oneCyclesOn     <span class="integer">700</span>/<span class="integer">5</span>   <span class="comment">// Stay on 700ns</span>
<span class="preprocessor">#define</span> oneCyclesOff    <span class="integer">800</span>/<span class="integer">5</span>
<span class="preprocessor">#define</span> zeroCyclesOn    <span class="integer">350</span>/<span class="integer">5</span>
<span class="preprocessor">#define</span> zeroCyclesOff   <span class="integer">600</span>/<span class="integer">5</span>
<span class="preprocessor">#define</span> resetCycles     <span class="integer">60000</span>/<span class="integer">5</span> <span class="comment">// Must be at least 50u, use 60u</span>
<span class="preprocessor">#define</span> gpio P9_29              <span class="comment">// output pin</span>

<span class="preprocessor">#define</span> ONE

<span class="directive">volatile</span> <span class="directive">register</span> uint32_t <em>R30;
<span class="directive">volatile</span> <span class="directive">register</span> uint32_t </em>R31;

<span class="directive">void</span> main(<span class="directive">void</span>)
{
    <span class="comment">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port <strong>/</span>
    CT_CFG.SYSCFG_bit.STANDBY_INIT = <span class="integer">0</span>;

    uint32_t i;
    <span class="keyword">for</span>(i=<span class="integer">0</span>; i&lt;STR_LEN</strong><span class="integer">3</span>*<span class="integer">8</span>; i++) {
<span class="preprocessor">#ifdef</span> ONE
        <em>R30 |= gpio;      <span class="comment">// Set the GPIO pin to 1</span>
        </em>delay_cycles(oneCyclesOn-<span class="integer">1</span>);
        <em>R30 &amp;= ~gpio;     <span class="comment">// Clear the GPIO pin</span>
        </em>delay_cycles(oneCyclesOff-<span class="integer">2</span>);
<span class="preprocessor">#else</span>
        <em>R30 |= gpio;      <span class="comment">// Set the GPIO pin to 1</span>
        </em>delay_cycles(zeroCyclesOn-<span class="integer">1</span>);
        <em>R30 &amp;= ~gpio;     <span class="comment">// Clear the GPIO pin</span>
        </em>delay_cycles(zeroCyclesOff-<span class="integer">2</span>);
<span class="preprocessor">#endif</span>
    }
    <span class="comment">// Send Reset</span>
    <em>R30 &amp;= ~gpio; <span class="comment">// Clear the GPIO pin</span>
    </em>delay_cycles(resetCycles);

    __halt();
}</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_10"><a class="link" href="#_discussion_10">Discussion</a></h4>
<div class="paragraph">
<p><a href="#blocks_sequence">NeoPixel bit sequence</a> (taken from  <a href="https://cdn-shop.adafruit.com/datasheets/WS2812.pdf">WS2812 Data Sheet</a>) shows the following waveforms are used to send a bit of data.</p>
</div>
<div id="blocks_sequence" class="imageblock">
<div class="content">
<img src="figures/neo_sequence.png" alt="NeoPixel bit sequence">
</div>
<div class="title">Figure 22. NeoPixel bit sequence</div>
</div>
<div class="paragraph">
<p>Where the times are:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Label</th>
<th class="tableblock halign-left valign-top">Time in ns</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">T0H</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">350</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">T0L</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">800</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">T1H</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">700</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">T1L</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">600</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Treset</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&gt;50,000</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The code in <a href="#blocks_neo1">neo1.pru0.c - Code to turn all NeoPixels&#8217;s white</a> define these times in lines 7-10.
The <code>/5</code> is because
each instruction take 5ns.  Lines 27-30 then set the output to 1 for
the desired time and then to 0 and keeps repeating it for the entire
string length.  <a href="#blocks_zero_scope">NeoPixel zero timing</a>
shows the waveform for sending a 0 value.  Note the times are spot on.</p>
</div>
<div id="blocks_zero_scope" class="imageblock">
<div class="content">
<img src="figures/neo_scope.png" alt="neo scope">
</div>
<div class="title">Figure 23. NeoPixel zero timing</div>
</div>
<div class="paragraph">
<p>Each NeoPixel listens for a RGB value. Once a value has arrived all other values
that follow are passed on to the next NeoPixel which does the same thing.
That way you can individually control all of the NeoPixels.</p>
</div>
<div class="paragraph">
<p>Lines 38-40 send out a reset pulse.  If a NeoPixel sees a reset pulse it will
grab the next value for itself and start over again.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_setting_neopixels_to_different_colors"><a class="link" href="#_setting_neopixels_to_different_colors">1.12. Setting NeoPixels to Different Colors</a></h3>
<div class="sect3">
<h4 id="_problem_12"><a class="link" href="#_problem_12">Problem</a></h4>
<div class="paragraph">
<p>I want to set the LEDs to different colors.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_12"><a class="link" href="#_solution_12">Solution</a></h4>
<div class="paragraph">
<p>Wire your NeoPixels as shown in <a href="#blocks_neo_wiring">NeoPixel Wiring</a> then run the code in
<a href="#blocks_neo2">neo2.pru0.c - Code to turn on green, red, blue</a>.</p>
</div>
<div id="blocks_neo2" class="listingblock">
<div class="title">neo2.pru0.c - Code to turn on green, red, blue</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre></td>
  <td class="code"><pre><span class="comment">// Control a ws2812 (neo pixel) display, green, red, blue, green, ...</span>
<span class="preprocessor">#include</span> <span class="include">&lt;stdint.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_cfg.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;resource_table_empty.h&quot;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;prugpio.h&quot;</span>

<span class="preprocessor">#define</span> STR_LEN <span class="integer">3</span>
<span class="preprocessor">#define</span> oneCyclesOn     <span class="integer">700</span>/<span class="integer">5</span>   <span class="comment">// Stay on 700ns</span>
<span class="preprocessor">#define</span> oneCyclesOff    <span class="integer">800</span>/<span class="integer">5</span>
<span class="preprocessor">#define</span> zeroCyclesOn    <span class="integer">350</span>/<span class="integer">5</span>
<span class="preprocessor">#define</span> zeroCyclesOff   <span class="integer">600</span>/<span class="integer">5</span>
<span class="preprocessor">#define</span> resetCycles     <span class="integer">60000</span>/<span class="integer">5</span> <span class="comment">// Must be at least 50u, use 60u</span>
<span class="preprocessor">#define</span> gpio P9_29              <span class="comment">// output pin</span>

<span class="directive">volatile</span> <span class="directive">register</span> uint32_t <em>R30;
<span class="directive">volatile</span> <span class="directive">register</span> uint32_t </em>R31;

<span class="directive">void</span> main(<span class="directive">void</span>)
{
    <span class="comment">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
    CT_CFG.SYSCFG_bit.STANDBY_INIT = <span class="integer">0</span>;

    uint32_t color[STR_LEN] = {<span class="hex">0x0f0000</span>, <span class="hex">0x000f00</span>, <span class="hex">0x0000f</span>};    <span class="comment">// green, red, blue</span>
    <span class="predefined-type">int</span> i, j;

    <span class="keyword">for</span>(j=<span class="integer">0</span>; j&lt;STR_LEN; j++) {
        <span class="keyword">for</span>(i=<span class="integer">23</span>; i&gt;=<span class="integer">0</span>; i--) {
            <span class="keyword">if</span>(color[j] &amp; (<span class="hex">0x1</span>&lt;&lt;i)) {
                <em>R30 |= gpio;      <span class="comment">// Set the GPIO pin to 1</span>
                </em>delay_cycles(oneCyclesOn-<span class="integer">1</span>);
                <em>R30 &amp;= ~gpio;     <span class="comment">// Clear the GPIO pin</span>
                </em>delay_cycles(oneCyclesOff-<span class="integer">2</span>);
            } <span class="keyword">else</span> {
                <em>R30 |= gpio;      <span class="comment">// Set the GPIO pin to 1</span>
                </em>delay_cycles(zeroCyclesOn-<span class="integer">1</span>);
                <em>R30 &amp;= ~gpio;     <span class="comment">// Clear the GPIO pin</span>
                </em>delay_cycles(zeroCyclesOff-<span class="integer">2</span>);
            }
        }
    }
    <span class="comment">// Send Reset</span>
    <em>R30 &amp;= ~gpio; <span class="comment">// Clear the GPIO pin</span>
    </em>delay_cycles(resetCycles);

    __halt();
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will make the first LED green, the second red and the third blue.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_11"><a class="link" href="#_discussion_11">Discussion</a></h4>
<div class="paragraph">
<p><a href="#blocks_new_data_seq">NeoPixel data sequence</a> shows the sequence of bits used to control the
green, red and blue values.</p>
</div>
<div id="blocks_new_data_seq" class="imageblock">
<div class="content">
<img src="figures/neo_data_seq.png" alt="neo data seq">
</div>
<div class="title">Figure 24. NeoPixel data sequence</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The usual order for colors is RGB (red, green, blue), but the NeoPixels use
GRB (green, red, blue).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="#blocks_neo2_line">Line-by-line for neo2.pru0.c</a> is the line-by-line for <code>neo2.pru0.c</code>.</p>
</div>
<table id="blocks_neo2_line" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 10. Line-by-line for neo2.pru0.c</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">23</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Define the string of colors to be output.  Here the ordering of the
bits is the same as <a href="#blocks_new_data_seq">NeoPixel data sequence</a>, GRB.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">26</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Loop for each color to output.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">27</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Loop for each bit in an GRB color.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">28</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the j<sup>th</sup> color and mask off all but the i<sup>th</sup> bit.  <code>(0x1&lt;&lt;i)</code> takes
the value <code>0x1</code> and shifts it left <code>i</code> bits.  When anded (&amp;) with <code>color[j]</code>
it will zero out all but the i<sup>th</sup> bit.  If the result of the operation is
1, the <code>if</code> is done, otherwise the <code>else</code> is done.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">29-32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send a 1.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">34-37</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send a 0.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">42-43</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send a reset pulse once all the colors have been sent.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This will only change the first <code>STR_LEN</code> LEDs.  The LEDs that follow will not
be changed.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_controlling_arbitrary_leds"><a class="link" href="#_controlling_arbitrary_leds">1.13. Controlling Arbitrary LEDs</a></h3>
<div class="sect3">
<h4 id="_problem_13"><a class="link" href="#_problem_13">Problem</a></h4>
<div class="paragraph">
<p>I want to change the 10<sup>th</sup> LED and not have to change the others.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_13"><a class="link" href="#_solution_13">Solution</a></h4>
<div class="paragraph">
<p>You need to keep an array of colors for the whole string in the PRU.  Change
the color of any pixels you want in the array and then send out the whole
string to the LEDs.  <a href="#blocks_neo3">neo3.pru0.c - Code to animate a red pixel running around a ring of blue</a> shows an example animates a red pixel
running around a ring of blue background.  <a href="#blocks_neo3_video">neo3.pru0.c - Simple animation</a> shows
the code in action.</p>
</div>
<div id="blocks_neo3_video" class="videoblock">
<div class="title">neo3.pru0.c - Simple animation</div>
<div class="content">
<video src="figures/ring_around.mp4#t=,4" width="320" controls>
Your browser does not support the video tag.
</video>
</div>
</div>
<div id="blocks_neo3" class="listingblock">
<div class="title">neo3.pru0.c - Code to animate a red pixel running around a ring of blue</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
</pre></td>
  <td class="code"><pre><span class="comment">// Control a ws2812 (neo pixel) display, green, red, blue, green, ...</span>
<span class="preprocessor">#include</span> <span class="include">&lt;stdint.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_cfg.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;resource_table_empty.h&quot;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;prugpio.h&quot;</span>

<span class="preprocessor">#define</span> STR_LEN <span class="integer">24</span>
<span class="preprocessor">#define</span> oneCyclesOn     <span class="integer">700</span>/<span class="integer">5</span>   <span class="comment">// Stay on 700ns</span>
<span class="preprocessor">#define</span> oneCyclesOff    <span class="integer">800</span>/<span class="integer">5</span>
<span class="preprocessor">#define</span> zeroCyclesOn    <span class="integer">350</span>/<span class="integer">5</span>
<span class="preprocessor">#define</span> zeroCyclesOff   <span class="integer">600</span>/<span class="integer">5</span>
<span class="preprocessor">#define</span> resetCycles     <span class="integer">60000</span>/<span class="integer">5</span> <span class="comment">// Must be at least 50u, use 60u</span>
<span class="preprocessor">#define</span> gpio P9_29              <span class="comment">// output pin</span>

<span class="preprocessor">#define</span> SPEED <span class="integer">20000000</span>/<span class="integer">5</span>        <span class="comment">// Time to wait between updates</span>

<span class="directive">volatile</span> <span class="directive">register</span> uint32_t <em>R30;
<span class="directive">volatile</span> <span class="directive">register</span> uint32_t </em>R31;

<span class="directive">void</span> main(<span class="directive">void</span>)
{
    uint32_t background = <span class="hex">0x00000f</span>;
    uint32_t foreground = <span class="hex">0x000f00</span>;

    <span class="comment">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
    CT_CFG.SYSCFG_bit.STANDBY_INIT = <span class="integer">0</span>;

    uint32_t color[STR_LEN];    <span class="comment">// green, red, blue</span>
    <span class="predefined-type">int</span> i, j;
    <span class="predefined-type">int</span> k, oldk = <span class="integer">0</span>;;
    <span class="comment">// Set everything to background</span>
    <span class="keyword">for</span>(i=<span class="integer">0</span>; i&lt;STR_LEN; i++) {
        color[i] = background;
    }

    <span class="keyword">while</span>(<span class="integer">1</span>) {
        <span class="comment">// Move forward one position</span>
        <span class="keyword">for</span>(k=<span class="integer">0</span>; k&lt;STR_LEN; k++) {
            color[oldk] = background;
            color[k]    = foreground;
            oldk=k;

            <span class="comment">// Output the string</span>
            <span class="keyword">for</span>(j=<span class="integer">0</span>; j&lt;STR_LEN; j++) {
                <span class="keyword">for</span>(i=<span class="integer">23</span>; i&gt;=<span class="integer">0</span>; i--) {
                    <span class="keyword">if</span>(color[j] &amp; (<span class="hex">0x1</span>&lt;&lt;i)) {
                        <em>R30 |= gpio;      <span class="comment">// Set the GPIO pin to 1</span>
                        </em>delay_cycles(oneCyclesOn-<span class="integer">1</span>);
                        <em>R30 &amp;= ~gpio;     <span class="comment">// Clear the GPIO pin</span>
                        </em>delay_cycles(oneCyclesOff-<span class="integer">2</span>);
                    } <span class="keyword">else</span> {
                        <em>R30 |= gpio;      <span class="comment">// Set the GPIO pin to 1</span>
                        </em>delay_cycles(zeroCyclesOn-<span class="integer">1</span>);
                        <em>R30 &amp;= ~gpio;     <span class="comment">// Clear the GPIO pin</span>
                        </em>delay_cycles(zeroCyclesOff-<span class="integer">2</span>);
                    }
                }
            }
            <span class="comment">// Send Reset</span>
            <em>R30 &amp;= ~gpio; <span class="comment">// Clear the GPIO pin</span>
            </em>delay_cycles(resetCycles);

            <span class="comment">// Wait</span>
            __delay_cycles(SPEED);
        }
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_12"><a class="link" href="#_discussion_12">Discussion</a></h4>
<div class="paragraph">
<p>Here&#8217;s the highlights.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">32,33</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Initiallize the array of colors.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">38-41</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update the array.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">44-58</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send the array to the LEDs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">60-61</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send a reset.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Wait a bit.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_controlling_neopixels_through_a_kernel_driver"><a class="link" href="#_controlling_neopixels_through_a_kernel_driver">1.14. Controlling NeoPixels Through a Kernel Driver</a></h3>
<div class="sect3">
<h4 id="_problem_14"><a class="link" href="#_problem_14">Problem</a></h4>
<div class="paragraph">
<p>You want to control your NeoPixels through a kernel driver so you can control it
through a <code>/dev</code> interface.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_14"><a class="link" href="#_solution_14">Solution</a></h4>
<div class="paragraph">
<p>The <a href="https://github.com/beagleboard/linux/raw/4.9/drivers/rpmsg/rpmsg_pru.c">rpmsg_pru</a>
driver provides a way to pass data between the ARM processor and
the PRUs.  It&#8217;s already included on current images. <a href="#blocks_neo4">neo4.pru0.c - Code to talk to the PRU via rpmsg_pru</a> shows
an example.</p>
</div>
<div id="blocks_neo4" class="listingblock">
<div class="title">neo4.pru0.c - Code to talk to the PRU via rpmsg_pru</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
</pre></td>
  <td class="code"><pre><span class="comment">// Use rpmsg to control the NeoPixels via /dev/rpmsg_pru30</span>
<span class="preprocessor">#include</span> <span class="include">&lt;stdint.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;stdio.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;stdlib.h&gt;</span>         <span class="comment">// atoi</span>
<span class="preprocessor">#include</span> <span class="include">&lt;string.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_cfg.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_intc.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;rsc_types.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_rpmsg.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;resource_table_0.h&quot;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;prugpio.h&quot;</span>

<span class="directive">volatile</span> <span class="directive">register</span> uint32_t <em>R30;
<span class="directive">volatile</span> <span class="directive">register</span> uint32_t </em>R31;

<span class="comment">/* Host-0 Interrupt sets bit 30 in register R31 <strong>/</span>
<span class="preprocessor">#define</span> HOST_INT            ((uint32_t) <span class="integer">1</span> &lt;&lt; <span class="integer">30</span>)

<span class="comment">/</strong> The PRU-ICSS system events used for RPMsg are defined in the Linux device tree
 * PRU0 uses system event 16 (To ARM) and 17 (From ARM)
 * PRU1 uses system event 18 (To ARM) and 19 (From ARM)
 <strong>/</span>
<span class="preprocessor">#define</span> TO_ARM_HOST         <span class="integer">16</span>
<span class="preprocessor">#define</span> FROM_ARM_HOST       <span class="integer">17</span>

<span class="comment">/</strong>
* Using the name 'rpmsg-pru' will probe the rpmsg_pru driver found
* at linux-x.y.z/drivers/rpmsg/rpmsg_pru.c
<strong>/</span>
<span class="preprocessor">#define</span> CHAN_NAME           <span class="string"><span class="delimiter">&quot;</span><span class="content">rpmsg-pru</span><span class="delimiter">&quot;</span></span>
<span class="preprocessor">#define</span> CHAN_DESC           <span class="string"><span class="delimiter">&quot;</span><span class="content">Channel 30</span><span class="delimiter">&quot;</span></span>
<span class="preprocessor">#define</span> CHAN_PORT           <span class="integer">30</span>

<span class="comment">/</strong>
 * Used to make sure the Linux drivers are ready for RPMsg communication
 * Found at linux-x.y.z/include/uapi/linux/virtio_config.h
 <strong>/</span>
<span class="preprocessor">#define</span> VIRTIO_CONFIG_S_DRIVER_OK   <span class="integer">4</span>

<span class="predefined-type">char</span> payload[RPMSG_BUF_SIZE];

<span class="preprocessor">#define</span> STR_LEN <span class="integer">24</span>
<span class="preprocessor">#define</span> oneCyclesOn     <span class="integer">700</span>/<span class="integer">5</span>   <span class="comment">// Stay on for 700ns</span>
<span class="preprocessor">#define</span> oneCyclesOff    <span class="integer">600</span>/<span class="integer">5</span>
<span class="preprocessor">#define</span> zeroCyclesOn    <span class="integer">350</span>/<span class="integer">5</span>
<span class="preprocessor">#define</span> zeroCyclesOff   <span class="integer">800</span>/<span class="integer">5</span>
<span class="preprocessor">#define</span> resetCycles     <span class="integer">51000</span>/<span class="integer">5</span> <span class="comment">// Must be at least 50u, use 51u</span>
<span class="preprocessor">#define</span> out P9_29               <span class="comment">// Bit number to output on</span>

<span class="preprocessor">#define</span> SPEED <span class="integer">20000000</span>/<span class="integer">5</span>        <span class="comment">// Time to wait between updates</span>

uint32_t color[STR_LEN];    <span class="comment">// green, red, blue</span>

<span class="comment">/</strong>
 * main.c
 <strong>/</span>
<span class="directive">void</span> main(<span class="directive">void</span>)
{
    <span class="keyword">struct</span> pru_rpmsg_transport transport;
    uint16_t src, dst, len;
    <span class="directive">volatile</span> uint8_t *status;

    uint8_t r, g, b;
    <span class="predefined-type">int</span> i, j;
    <span class="comment">// Set everything to background</span>
    <span class="keyword">for</span>(i=<span class="integer">0</span>; i&lt;STR_LEN; i++) {
        color[i] = <span class="hex">0x010000</span>;
    }

    <span class="comment">/</strong> Allow OCP master port access by the PRU so the PRU can read external memories <strong>/</span>
    CT_CFG.SYSCFG_bit.STANDBY_INIT = <span class="integer">0</span>;

    <span class="comment">/</strong> Clear the status of the PRU-ICSS system event that the ARM will use to 'kick' us <strong>/</span>
<span class="preprocessor">#ifdef</span> CHIP_IS_am57xx
    CT_INTC.SICR_bit.STATUS_CLR_INDEX = FROM_ARM_HOST;
<span class="preprocessor">#else</span>
    CT_INTC.SICR_bit.STS_CLR_IDX = FROM_ARM_HOST;
<span class="preprocessor">#endif</span>

    <span class="comment">/</strong> Make sure the Linux drivers are ready for RPMsg communication <strong>/</span>
    status = &amp;resourceTable.rpmsg_vdev.status;
    <span class="keyword">while</span> (!(*status &amp; VIRTIO_CONFIG_S_DRIVER_OK));

    <span class="comment">/</strong> Initialize the RPMsg transport structure <strong>/</span>
    pru_rpmsg_init(&amp;transport, &amp;resourceTable.rpmsg_vring0, &amp;resourceTable.rpmsg_vring1, TO_ARM_HOST, FROM_ARM_HOST);

    <span class="comment">/</strong> Create the RPMsg channel between the PRU and ARM user space using the transport structure. <strong>/</span>
    <span class="keyword">while</span> (pru_rpmsg_channel(RPMSG_NS_CREATE, &amp;transport, CHAN_NAME, CHAN_DESC, CHAN_PORT) != PRU_RPMSG_SUCCESS);
    <span class="keyword">while</span> (<span class="integer">1</span>) {
        <span class="comment">/</strong> Check bit 30 of register R31 to see if the ARM has kicked us <strong>/</span>
        <span class="keyword">if</span> (<em>R31 &amp; HOST_INT) {
            <span class="comment">/</strong> Clear the event status <strong>/</span>
<span class="preprocessor">#ifdef</span> CHIP_IS_am57xx
            CT_INTC.SICR_bit.STATUS_CLR_INDEX = FROM_ARM_HOST;
<span class="preprocessor">#else</span>
            CT_INTC.SICR_bit.STS_CLR_IDX = FROM_ARM_HOST;
<span class="preprocessor">#endif</span>
            <span class="comment">/</strong> Receive all available messages, multiple messages can be sent per kick */</span>
            <span class="keyword">while</span> (pru_rpmsg_receive(&amp;transport, &amp;src, &amp;dst, payload, &amp;len) == PRU_RPMSG_SUCCESS) {
                <span class="predefined-type">char</span> *ret;  <span class="comment">// rest of payload after front character is removed</span>
                <span class="predefined-type">int</span> index;  <span class="comment">// index of LED to control</span>
                <span class="comment">// Input format is:  index red green blue</span>
                index = atoi(payload);
                <span class="comment">// Update the array, but don't write it out.</span>
                <span class="keyword">if</span>((index &gt;=<span class="integer">0</span>) &amp; (index &lt; STR_LEN)) {
                    ret = strchr(payload, <span class="char">' '</span>); <span class="comment">// Skip over index</span>
                    r = strtol(&amp;ret[<span class="integer">1</span>], <span class="predefined-constant">NULL</span>, <span class="integer">0</span>);
                    ret = strchr(&amp;ret[<span class="integer">1</span>], <span class="char">' '</span>); <span class="comment">// Skip over r, etc.</span>
                    g = strtol(&amp;ret[<span class="integer">1</span>], <span class="predefined-constant">NULL</span>, <span class="integer">0</span>);
                    ret = strchr(&amp;ret[<span class="integer">1</span>], <span class="char">' '</span>);
                    b = strtol(&amp;ret[<span class="integer">1</span>], <span class="predefined-constant">NULL</span>, <span class="integer">0</span>);

                    color[index] = (g&lt;&lt;<span class="integer">16</span>)|(r&lt;&lt;<span class="integer">8</span>)|b;    <span class="comment">// String wants GRB</span>
                }
                <span class="comment">// When index is -1, send the array to the LED string</span>
                <span class="keyword">if</span>(index == -<span class="integer">1</span>) {
                    <span class="comment">// Output the string</span>
                    <span class="keyword">for</span>(j=<span class="integer">0</span>; j&lt;STR_LEN; j++) {
                        <span class="comment">// Cycle through each bit</span>
                        <span class="keyword">for</span>(i=<span class="integer">23</span>; i&gt;=<span class="integer">0</span>; i--) {
                            <span class="keyword">if</span>(color[j] &amp; (<span class="hex">0x1</span>&lt;&lt;i)) {
                                </em>R30 |= out;       <span class="comment">// Set the GPIO pin to 1</span>
                                <em>delay_cycles(oneCyclesOn-<span class="integer">1</span>);
                                </em>R30 &amp;= ~out;  <span class="comment">// Clear the GPIO pin</span>
                                <em>delay_cycles(oneCyclesOff-<span class="integer">14</span>);
                            } <span class="keyword">else</span> {
                                </em>R30 |= out;       <span class="comment">// Set the GPIO pin to 1</span>
                                <em>delay_cycles(zeroCyclesOn-<span class="integer">1</span>);
                                </em>R30 &amp;= ~(out);    <span class="comment">// Clear the GPIO pin</span>
                                <em>delay_cycles(zeroCyclesOff-<span class="integer">14</span>);
                            }
                        }
                    }
                    <span class="comment">// Send Reset</span>
                    </em>R30 &amp;= ~out;  <span class="comment">// Clear the GPIO pin</span>
                    <em>delay_cycles(resetCycles);

                    <span class="comment">// Wait</span>
                    </em>delay_cycles(SPEED);
                }

            }
        }
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the code as usual.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">bone$ <strong>make TARGET=neo4.pru0</strong>
/var/lib/cloud9/common/Makefile:<span class="integer">29</span>: MODEL=TI_AM335x_BeagleBone_Black,TARGET=neo4.pru0
-    Stopping PRU <span class="integer">0</span>
-   copying firmware file /tmp/cloud9-examples/neo4.pru0.out to /lib/firmware/am335x-pru0-fw
write_init_pins.sh
-    Starting PRU <span class="integer">0</span>
MODEL   = TI_AM335x_BeagleBone_Black
PROC    = pru
PRUN    = <span class="integer">0</span>
PRU_DIR = /sys/class/remoteproc/remoteproc1

bone$ <strong>echo <span class="integer">0</span> <span class="hex">0xff</span> <span class="integer">0</span> <span class="integer">127</span> &gt; /dev/rpmsg_pru30</strong>
bone$ <strong>echo -<span class="integer">1</span> &gt; /dev/rpmsg_pru30</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>/dev/rpmsg_pru30</code> is a device driver that lets the ARM talk to the PRU.
The first <code>echo</code> says to set the 0<sup>th</sup> LED to RGB value 0xff 0 127. (Note: you can
mix hex and decimal.) The second <code>echo</code> tells the driver to send the data to the
LEDs.  Your 0<sup>th</sup> LED should now be lit.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_13"><a class="link" href="#_discussion_13">Discussion</a></h4>
<div class="paragraph">
<p>There&#8217;s a lot here.  I&#8217;ll just hit some of the highlights in <a href="#blocks_neo4_lines">Line-by-line for neo4.pru0.c</a>.</p>
</div>
<table id="blocks_neo4_lines" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 11. Line-by-line for neo4.pru0.c</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 90%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Line</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">30</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>CHAN_NAME</code> of <code>rpmsg-pru</code> matches that <code>prmsg_pru</code> driver that is
is already installed.  This connects this PRU to the driver.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>CHAN_PORT</code> tells it to use port 30.  That&#8217;s why we use
<code>/dev/rpmsg_pru30</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">40</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payload[]</code> is the buffer that receives the data from the ARM.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">42-48</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as the previous NeoPixel examples.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">52</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>color[]</code> is the state to be sent to the LEDs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">66-68</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>color[]</code> is initialized.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">70-85</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Here are a number of details needed to set up the channel between
the PRU and the ARM.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">88</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Here we wait until the ARM sends us some numbers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">99</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Receive all the data from the ARM, store it in <code>payload[]</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">101-111</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The data sent is:  index red green blue.  Pull off the index.  If it&#8217;s
in the right range, pull off the red, green and blue values.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">113</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The NeoPixels want the data in GRB order.  Shift and OR everything
together.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">116-133</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the <code>index</code> = -1, send the contents of <code>color</code> to the LEDs.  This
code is same as before.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can now use programs running on the ARM to send colors to the PRU.
<a href="#blocks_neo-rainbow">neo-rainbow.py - A python program using /dev/rpmsg_pru30</a> shows an example.</p>
</div>
<div id="blocks_neo-rainbow" class="listingblock">
<div class="title">neo-rainbow.py - A python program using /dev/rpmsg_pru30</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td>
  <td class="code"><pre><span class="comment"><mark>!/usr/bin/python3</span>
<span class="keyword">from</span> <span class="include">time</span> <span class="keyword">import</span> <span class="include">sleep</span>
<span class="keyword">import</span> <span class="include">math</span>

len = <span class="integer">24</span>
amp = <span class="integer">12</span>
f = <span class="integer">25</span>
shift = <span class="integer">3</span>
phase = <span class="integer">0</span>

<span class="comment"></mark> Open a file</span>
fo = <span class="predefined">open</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/dev/rpmsg_pru30</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">w</span><span class="delimiter">&quot;</span></span>, <span class="integer">0</span>)

<span class="keyword">while</span> <span class="predefined-constant">True</span>:
    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="predefined">range</span>(<span class="integer">0</span>, <span class="predefined">len</span>):
        r = (amp * (math.sin(<span class="integer">2</span><strong>math.pi*f</strong>(i-phase-<span class="integer">0</span><strong>shift)/<span class="predefined">len</span>) + <span class="integer">1</span>)) + <span class="integer">1</span>;
        g = (amp * (math.sin(<span class="integer">2</span>*math.pi*f</strong>(i-phase-<span class="integer">1</span><strong>shift)/<span class="predefined">len</span>) + <span class="integer">1</span>)) + <span class="integer">1</span>;
        b = (amp * (math.sin(<span class="integer">2</span>*math.pi*f</strong>(i-phase-<span class="integer">2</span>*shift)/<span class="predefined">len</span>) + <span class="integer">1</span>)) + <span class="integer">1</span>;
        fo.write(<span class="string"><span class="delimiter">&quot;</span><span class="content">%d %d %d %d</span><span class="char">\n</span><span class="delimiter">&quot;</span></span> % (i, r, g, b))
        <span class="comment"># print(&quot;0 0 127 %d&quot; % (i))</span>

    fo.write(<span class="string"><span class="delimiter">&quot;</span><span class="content">-1 0 0 0</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);
    phase = phase + <span class="integer">1</span>
    sleep(<span class="float">0.05</span>)

<span class="comment"># Close opened file</span>
fo.close()</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Line 19 writes the data to the PRU.  Be sure to have a newline, or space after
the last number, or you numbers will get blurred together.</p>
</div>
<div class="sect4">
<h5 id="_switching_from_pru0_to_pru1_with_rpmsg_pru"><a class="link" href="#_switching_from_pru0_to_pru1_with_rpmsg_pru">Switching from pru0 to pru1 with rpmsg_pru</a></h5>
<div class="paragraph">
<p>There are three things you need to change when switching from pru0 to pru1
when using rpmsg_pru.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The include on line 10 is switched to <code>#include "resource_table_1.h"</code>
(0 is switched to a 1)</p>
</li>
<li>
<p>Line 17 is switched to <code>#define HOST_INT			((uint32_t) 1 &lt;&lt; 31)</code>
(30 is switched to 31.)</p>
</li>
<li>
<p>Lines 23 and 24 are switched to:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>#define TO_ARM_HOST         18
#define FROM_ARM_HOST       19</pre>
</div>
</div>
<div class="paragraph">
<p>These changes switch to the proper channel numbers to use pru1 instead of pru0.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_rgb_led_matrix_no_integrated_drivers"><a class="link" href="#_rgb_led_matrix_no_integrated_drivers">1.15. RGB LED Matrix - No Integrated Drivers</a></h3>
<div class="sect3">
<h4 id="_problem_15"><a class="link" href="#_problem_15">Problem</a></h4>
<div class="paragraph">
<p>You have a RGB LED matrix
(<a href="../01case/case.html.html#case_rgb_matrix">1.4. RGB LED Matrix - No Integrated Drivers</a>) and want to know
at a low level how the PRU works.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_15"><a class="link" href="#_solution_15">Solution</a></h4>
<div class="paragraph">
<p>Here is the
<a href="https://cdn-shop.adafruit.com/product-files/2277/MI-T35P5RGBE-AE.pdf">datasheet</a>,
but the best description I&#8217;ve found for the RGB Matrix is from
<a href="https://www.adafruit.com/">Adafruit</a>.  I&#8217;ve reproduced it here, with
adjustments for the 64x32 matrix we are using.</p>
</div>
<div class="verseblock">
<pre class="content">There&#8217;s zero documention out there on how these matrices work, and no public datasheets or spec sheets so we are going to try to document how they work.

First thing to notice is that there are 2048 RGB LEDs in a 64x32 matrix. Like pretty much every matrix out there, you can&#8217;t drive all 2048 at once. One reason is that would require a lot of current, another reason is that it would be really expensive to have so many pins. Instead, the matrix is divided into 16 interleaved sections/strips. The first section is the 1<sup>st</sup> 'line' and the 17<sup>th</sup> 'line' (64 x 2 RGB LEDs = 128 RGB LEDs), the second is the 2<sup>nd</sup> and 18<sup>th</sup> line, etc until the last section which is the 16<sup>th</sup> and 32<sup>nd</sup> line. You might be asking, why are the lines paired this way? wouldn&#8217;t it be nicer to have the first section be the 1<sup>st</sup> and 2<sup>nd</sup> line, then 3<sup>rd</sup> and 4<sup>th</sup>, until the 15<sup>th</sup> and 16<sup>th</sup>? The reason they do it this way is so that the lines are interleaved and look better when refreshed, otherwise we&#8217;d see the stripes more clearly.

So, on the PCB is 24 LED driver chips. These are like 74HC595s but they have 16 outputs and they are constant current. 16 outputs * 24 chips = 384 LEDs that can be controlled at once, and 128 * 3 (R G and B) = 384. So now the design comes together: You have 384 outputs that can control one line at a time, with each of 384 R, G and B LEDs either on or off. The controller (say an FPGA or microcontroller) selects which section to currently draw (using LA, LB, LC and LD address pins - 4 bits can have 16 values). Once the address is set, the controller clocks out 384 bits of data (48 bytes) and latches it. Then it increments the address and clocks out another 384 bits, etc until it gets to address #15, then it sets the address back to #0</pre>
<div class="attribution">
&#8212; https://cdn-learn.adafruit.com/downloads/pdf/32x16-32x32-rgb-led-matrix.pdf
</div>
</div>
<div class="paragraph">
<p>That gives a good overview, but there are a few details missing.
<a href="#blocks_rgb_python">Python code for driving RGB LED matrix</a> is a functioning python program that gives a nice
high-level view of how to drive the display.</p>
</div>
<div id="blocks_rgb_python" class="listingblock">
<div class="title">Python code for driving RGB LED matrix</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
</pre></td>
  <td class="code"><pre><span class="comment"><mark>!/usr/bin/env python3</span>
<span class="keyword">import</span> <span class="include">Adafruit_BBIO.GPIO</span> <span class="keyword">as</span> GPIO

<span class="comment"></mark> Define which functions are connect to which pins</span>
OE=<span class="string"><span class="delimiter">&quot;</span><span class="content">P1_29</span><span class="delimiter">&quot;</span></span>      <span class="comment"># Output Enable, active low</span>
LAT=<span class="string"><span class="delimiter">&quot;</span><span class="content">P1_36</span><span class="delimiter">&quot;</span></span>     <span class="comment"># Latch, toggle after clocking in a row of pixels</span>
CLK=<span class="string"><span class="delimiter">&quot;</span><span class="content">P1_33</span><span class="delimiter">&quot;</span></span>     <span class="comment"># Clock, toggle after each pixel</span>

<span class="comment"># Input data pins</span>
R1=<span class="string"><span class="delimiter">&quot;</span><span class="content">P2_10</span><span class="delimiter">&quot;</span></span>  <span class="comment"># R1, G1, B1 are for the top rows (1-16) of pixels</span>
G1=<span class="string"><span class="delimiter">&quot;</span><span class="content">P2_8</span><span class="delimiter">&quot;</span></span>
B1=<span class="string"><span class="delimiter">&quot;</span><span class="content">P2_6</span><span class="delimiter">&quot;</span></span>

R2=<span class="string"><span class="delimiter">&quot;</span><span class="content">P2_4</span><span class="delimiter">&quot;</span></span>   <span class="comment"># R2, G2, B2 are for the bottom rows (17-32) of pixels</span>
G2=<span class="string"><span class="delimiter">&quot;</span><span class="content">P2_2</span><span class="delimiter">&quot;</span></span>
B2=<span class="string"><span class="delimiter">&quot;</span><span class="content">P2_1</span><span class="delimiter">&quot;</span></span>

LA=<span class="string"><span class="delimiter">&quot;</span><span class="content">P2_32</span><span class="delimiter">&quot;</span></span>  <span class="comment"># Address lines for which row (1-16 or 17-32) to update</span>
LB=<span class="string"><span class="delimiter">&quot;</span><span class="content">P2_30</span><span class="delimiter">&quot;</span></span>
LC=<span class="string"><span class="delimiter">&quot;</span><span class="content">P1_31</span><span class="delimiter">&quot;</span></span>
LD=<span class="string"><span class="delimiter">&quot;</span><span class="content">P2_34</span><span class="delimiter">&quot;</span></span>

<span class="comment"># Set everything as output ports</span>
GPIO.setup(OE,  GPIO.OUT)
GPIO.setup(LAT, GPIO.OUT)
GPIO.setup(CLK, GPIO.OUT)

GPIO.setup(R1, GPIO.OUT)
GPIO.setup(G1, GPIO.OUT)
GPIO.setup(B1, GPIO.OUT)
GPIO.setup(R2, GPIO.OUT)
GPIO.setup(G2, GPIO.OUT)
GPIO.setup(B2, GPIO.OUT)

GPIO.setup(LA, GPIO.OUT)
GPIO.setup(LB, GPIO.OUT)
GPIO.setup(LC, GPIO.OUT)
GPIO.setup(LD, GPIO.OUT)

GPIO.output(OE,  <span class="integer">0</span>)     <span class="comment"># Enable the display</span>
GPIO.output(LAT, <span class="integer">0</span>)     <span class="comment"># Set latch to low</span>

<span class="keyword">while</span> <span class="predefined-constant">True</span>:
    <span class="keyword">for</span> bank <span class="keyword">in</span> <span class="predefined">range</span>(<span class="integer">64</span>):
        GPIO.output(LA, bank&gt;&gt;<span class="integer">0</span>&amp;<span class="hex">0x1</span>)    <span class="comment"># Select rows</span>
        GPIO.output(LB, bank&gt;&gt;<span class="integer">1</span>&amp;<span class="hex">0x1</span>)
        GPIO.output(LC, bank&gt;&gt;<span class="integer">2</span>&amp;<span class="hex">0x1</span>)
        GPIO.output(LD, bank&gt;&gt;<span class="integer">3</span>&amp;<span class="hex">0x1</span>)

        <span class="comment"># Shift the colors out.  Here we only have four different</span>
        <span class="comment"># colors to keep things simple.</span>
        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="predefined">range</span>(<span class="integer">16</span>):
            GPIO.output(R1,  <span class="integer">1</span>)     <span class="comment"># Top row, white</span>
            GPIO.output(G1,  <span class="integer">1</span>)
            GPIO.output(B1,  <span class="integer">1</span>)

            GPIO.output(R2,  <span class="integer">1</span>)     <span class="comment"># Bottom row, red</span>
            GPIO.output(G2,  <span class="integer">0</span>)
            GPIO.output(B2,  <span class="integer">0</span>)

            GPIO.output(CLK, <span class="integer">0</span>)     <span class="comment"># Toggle clock</span>
            GPIO.output(CLK, <span class="integer">1</span>)

            GPIO.output(R1,  <span class="integer">0</span>)     <span class="comment"># Top row, black</span>
            GPIO.output(G1,  <span class="integer">0</span>)
            GPIO.output(B1,  <span class="integer">0</span>)

            GPIO.output(R2,  <span class="integer">0</span>)     <span class="comment"># Bottom row, green</span>
            GPIO.output(G2,  <span class="integer">1</span>)
            GPIO.output(B2,  <span class="integer">0</span>)

            GPIO.output(CLK, <span class="integer">0</span>)     <span class="comment"># Toggle clock</span>
            GPIO.output(CLK, <span class="integer">1</span>)

        GPIO.output(OE,  <span class="integer">1</span>)     <span class="comment"># Disable display while updating</span>
        GPIO.output(LAT, <span class="integer">1</span>)     <span class="comment"># Toggle latch</span>
        GPIO.output(LAT, <span class="integer">0</span>)
        GPIO.output(OE,  <span class="integer">0</span>)     <span class="comment"># Enable display</span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Be sure to run the <a href="#blocks_rgb_setup">rgb_python_setup.sh</a> script before running the python code.</p>
</div>
<div id="blocks_rgb_setup" class="listingblock">
<div class="title">rgb_python_setup.sh</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td>
  <td class="code"><pre><span class="comment"><mark>!/bin/bash</span>
<span class="comment"></mark> Setup for 64x32 RGB Matrix</span>
export TARGET=rgb1.pru0
echo TARGET=<span class="error">$</span>TARGET

<span class="comment"># Configure the PRU pins based on which Beagle is running</span>
machine=<span class="error">$</span>(awk <span class="string"><span class="delimiter">'</span><span class="content">{print $NF}</span><span class="delimiter">'</span></span> /proc/device-tree/model)
echo -n <span class="error">$</span>machine
<span class="keyword">if</span> [ <span class="error">$</span>machine = <span class="string"><span class="delimiter">&quot;</span><span class="content">Black</span><span class="delimiter">&quot;</span></span> ]; then
    echo <span class="string"><span class="delimiter">&quot;</span><span class="content"> Found</span><span class="delimiter">&quot;</span></span>
    pins=<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
<span class="keyword">elif</span> [ <span class="error">$</span>machine = <span class="string"><span class="delimiter">&quot;</span><span class="content">Blue</span><span class="delimiter">&quot;</span></span> ]; then
    echo <span class="string"><span class="delimiter">&quot;</span><span class="content"> Found</span><span class="delimiter">&quot;</span></span>
    pins=<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
<span class="keyword">elif</span> [ <span class="error">$</span>machine = <span class="string"><span class="delimiter">&quot;</span><span class="content">PocketBeagle</span><span class="delimiter">&quot;</span></span> ]; then
    echo <span class="string"><span class="delimiter">&quot;</span><span class="content"> Found</span><span class="delimiter">&quot;</span></span>
    prupins=<span class="string"><span class="delimiter">&quot;</span><span class="content">P2_32 P1_31 P1_33 P1_29 P2_30 P2_34 P1_36</span><span class="delimiter">&quot;</span></span>
    gpiopins=<span class="string"><span class="delimiter">&quot;</span><span class="content">P2_10 P2_06 P2_04 P2_01 P2_08 P2_02</span><span class="delimiter">&quot;</span></span>
    <span class="comment"># Uncomment for J2</span>
    <span class="comment"># gpiopins=&quot;$gpiopins P2_27 P2_25 P2_05 P2_24 P2_22 P2_18&quot;</span>
<span class="keyword">else</span>
    echo <span class="string"><span class="delimiter">&quot;</span><span class="content"> Not Found</span><span class="delimiter">&quot;</span></span>
    pins=<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
fi

<span class="keyword">for</span> pin <span class="keyword">in</span> <span class="error">$</span>prupins
do
    echo <span class="error">$</span>pin
    <span class="comment"># config-pin $pin pruout</span>
    config-pin <span class="error">$</span>pin gpio
    config-pin <span class="error">$</span>pin out
    config-pin -q <span class="error">$</span>pin
done

<span class="keyword">for</span> pin <span class="keyword">in</span> <span class="error">$</span>gpiopins
do
    echo <span class="error">$</span>pin
    config-pin <span class="error">$</span>pin gpio
    config-pin <span class="error">$</span>pin out
    config-pin -q <span class="error">$</span>pin
done</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure line 29 is commented out and line 30 is uncommented.
Later we&#8217;ll configure for <em>pruout</em>, but for now the python code doesn&#8217;t use
the PRU outs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>    # config-pin $pin pruout
    config-pin $pin out</code></pre>
</div>
</div>
<div class="paragraph">
<p>Your display should look like <a href="#blocks_rgb_python_jpg">Display running rgb_python.py</a>.</p>
</div>
<div id="blocks_rgb_python_jpg" class="imageblock">
<div class="content">
<img src="figures/rgb_python.jpg" alt="Display running rgb_python.py">
</div>
<div class="title">Figure 25. Display running rgb_python.py</div>
</div>
<div class="paragraph">
<p>So why do only two lines appear at a time?  That&#8217;s how the display works.
Currently lines 6 and 22 are showing, then a moment later 7 and 23 show, etc.
The display can only display two lines at a time, so it cycles through all the
lines.  Unfortunately, python is too slow to make the display appear
all at once.  Here&#8217;s where the PRU comes in.</p>
</div>
<div class="paragraph">
<p><a href="#blocks_rgb1">PRU code for driving the RGB LED matrix</a> is the PRU code to drive the RGB LED matrix.   Be sure to run
<code>bone$ source rgb_setup.sh</code> first.</p>
</div>
<div id="blocks_rgb1" class="listingblock">
<div class="title">PRU code for driving the RGB LED matrix</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
</pre></td>
  <td class="code"><pre><span class="comment">// This code drives the RGB LED Matrix on the 1st Connector</span>
<span class="preprocessor">#include</span> <span class="include">&lt;stdint.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;pru_cfg.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;resource_table_empty.h&quot;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;prugpio.h&quot;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;rgb_pocket.h&quot;</span>

<span class="preprocessor">#define</span> DELAY <span class="integer">10</span>    <span class="comment">// Number of cycles (5ns each) to wait after a write</span>

<span class="directive">volatile</span> <span class="directive">register</span> uint32_t <em>R30;
<span class="directive">volatile</span> <span class="directive">register</span> uint32_t </em>R31;

<span class="directive">void</span> main(<span class="directive">void</span>)
{
    <span class="comment">// Set up the pointers to each of the GPIO ports</span>
    uint32_t *gpio[] = {
            (uint32_t *) GPIO0,
            (uint32_t *) GPIO1,
            (uint32_t *) GPIO2,
            (uint32_t *) GPIO3
        };

    uint32_t i, row;

    <span class="keyword">while</span>(<span class="integer">1</span>) {
        <span class="keyword">for</span>(row=<span class="integer">0</span>; row&lt;<span class="integer">16</span>; row++) {
            <span class="comment">// Set the row address</span>
            <span class="comment">// Here we take advantage of the select bits (LA,LB,LC,LD)</span>
            <span class="comment">// being sequential in the R30 register (bits 2,3,4,5)</span>
            <span class="comment">// We shift row over so it lines up with the select bits</span>
            <span class="comment">// Oring (|=) with R30 sets bits to 1 and</span>
            <span class="comment">// Anding (&amp;=) clears bits to 0, the 0xffc mask makes sure the</span>
            <span class="comment">// other bits aren't changed.</span>
            <em>R30 |=  row&lt;&lt;pru_sel0;
            </em>R30 &amp;= (row&lt;&lt;pru_sel0)|<span class="hex">0xffc3</span>;

            <span class="keyword">for</span>(i=<span class="integer">0</span>; i&lt;<span class="integer">64</span>; i++) {
                <span class="comment">// Top row white</span>
                <span class="comment">// Combining these to one write works because they are all in</span>
                <span class="comment">// the same gpio port</span>
                gpio[r11_gpio][GPIO_SETDATAOUT] = r11_pin | g11_pin | b11_pin;
                <em>delay_cycles(DELAY);;

                <span class="comment">// Bottom row red</span>
                gpio[r12_gpio][GPIO_SETDATAOUT]   = r12_pin;
                </em>delay_cycles(DELAY);
                gpio[r12_gpio][GPIO_CLEARDATAOUT] = g12_pin | b12_pin;
                <em>delay_cycles(DELAY);

                </em>R30 |=  pru_clock;    <span class="comment">// Toggle clock</span>
                <em>delay_cycles(DELAY);
                </em>R30 &amp;= ~pru_clock;
                <em>delay_cycles(DELAY);

                <span class="comment">// Top row black</span>
                gpio[r11_gpio][GPIO_CLEARDATAOUT] = r11_pin | g11_pin | b11_pin;
                </em>delay_cycles(DELAY);

                <span class="comment">// Bottom row green</span>
                gpio[r12_gpio][GPIO_CLEARDATAOUT] = r12_pin | b12_pin;
                <em>delay_cycles(DELAY);
                gpio[r12_gpio][GPIO_SETDATAOUT]   = g12_pin;
                </em>delay_cycles(DELAY);

                <em>R30 |=  pru_clock;    <span class="comment">// Toggle clock</span>
                </em>delay_cycles(DELAY);
                <em>R30 &amp;= ~pru_clock;
                </em>delay_cycles(DELAY);
            }
            <em>R30 |=  pru_oe;        <span class="comment">// Disable display</span>
            </em>delay_cycles(DELAY);
            <em>R30 |=  pru_latch;     <span class="comment">// Toggle latch</span>
            </em>delay_cycles(DELAY);
            <em>R30 &amp;= ~pru_latch;
            </em>delay_cycles(DELAY);
            <em>R30 &amp;= ~pru_oe;        <span class="comment">// Enable display</span>
            </em>delay_cycles(DELAY);
        }
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The results are shown in <a href="#blocks_rgb_pru">Display running rgb1.c on PRU 0</a>.</p>
</div>
<div id="blocks_rgb_pru" class="imageblock">
<div class="content">
<img src="figures/rgb_pru.jpg" alt="Display running rgb1.pru0.c on PRU 0">
</div>
<div class="title">Figure 26. Display running rgb1.c on PRU 0</div>
</div>
<div class="paragraph">
<p>The PRU is fast enough to quickly write to the display so that it appears
as if all the LEDs are on at once.</p>
</div>
</div>
<div class="sect3">
<h4 id="_discussion_14"><a class="link" href="#_discussion_14">Discussion</a></h4>
<div class="paragraph">
<p>There are a lot of details needed to make this simple display work.  Let&#8217;s
go over some of them.</p>
</div>
<div class="paragraph">
<p>First, the connector looks like <a href="#blocks_matrix_j1">RGB Matrix J1 connector</a>.</p>
</div>
<div id="blocks_matrix_j1" class="imageblock">
<div class="content">
<img src="figures/matrix_j1.jpg" alt="RGB Matrix J1 connector" width="200">
</div>
<div class="title">Figure 27. RGB Matrix J1 connector</div>
</div>
<div class="paragraph">
<p>Notice the labels on the connect match the labels in the code.
<a href="#blocks_pocket_scroller_pins">PocketScroller pin table</a> shows how the pins on the display are
mapped to the pins on the Pocket Beagle.</p>
</div>
<table id="blocks_pocket_scroller_pins" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 12. PocketScroller pin table</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">J1 Connector Pin</th>
<th class="tableblock halign-left valign-top">Pocket Headers</th>
<th class="tableblock halign-left valign-top">gpio port and bit number</th>
<th class="tableblock halign-left valign-top">Linux gpio number</th>
<th class="tableblock halign-left valign-top">PRU R30 bit number</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">R1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2_10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1-20</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">52</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">B1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2_06</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1-25</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">57</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">R2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2_04</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1-26</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">58</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">B2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2_01</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1-18</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">50</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2_32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3-16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">112</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PRU0.2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1_31</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3-18</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">114</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PRU0.4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CLK</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1_33</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3-15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">111</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PRU0.1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1_29</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3-21</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">117</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PRU0.7</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">G1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2_08</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1-28</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">60</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">G2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2_02</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1-27</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">59</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2_30</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3-17</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">113</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PRU0.3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P2_34</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3-19</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">115</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PRU0.5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LAT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">P1_36</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3-14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">110</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PRU0.0</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The J1 mapping to gpio port and bit number comes from
<a href="https://github.com/FalconChristmas/fpp/blob/master/src/pru/PocketScrollerV1.hp" class="bare">https://github.com/FalconChristmas/fpp/blob/master/src/pru/PocketScrollerV1.hp</a>.
The gpio port and bit number mapping to Pocket Headers comes from
<a href="https://docs.google.com/spreadsheets/d/1FRGvYOyW1RiNSEVprvstfJAVeapnASgDXHtxeDOjgqw/edit#gid=0" class="bare">https://docs.google.com/spreadsheets/d/1FRGvYOyW1RiNSEVprvstfJAVeapnASgDXHtxeDOjgqw/edit#gid=0</a>.</p>
</div>
<div class="paragraph">
<p><a href="#blocks_rgb_waveforms">Oscilloscope display of CLK, OE, LAT and R1</a> shows four of the signal waveforms driving the RGB
LED matrix.</p>
</div>
<div id="blocks_rgb_waveforms" class="imageblock">
<div class="content">
<img src="figures/rgb_waveforms.png" alt=".Oscilloscope display of CLK" width="OE" height="LAT and R1">
</div>
<div class="title">Figure 28. Oscilloscope display of CLK, OE, LAT and R1</div>
</div>
<div class="paragraph">
<p>The top waveform is the CLK, the next is OE, followed by LAT and finally R1.
The OE (output enable) is active low, so most of the time the display is visible.
The sequence is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Put data on the R1, G1, B1, R2, G2 and B2 lines</p>
</li>
<li>
<p>Toggle the clock.</p>
</li>
<li>
<p>Repeat the first two steps as one row of data is transfered.  There are
384 LEDs (2 rows of 32 RGB LEDs times 3 LED per RGB), but we are clocking in
six bits (R1, G1, etc.) at a time, so 384/6=64 values need to be clocked in.</p>
</li>
<li>
<p>Once all the values are in, disable the display (OE goes high)</p>
</li>
<li>
<p>Then toggle the latch (LAT) to latch the new data.</p>
</li>
<li>
<p>Turn the display back on.</p>
</li>
<li>
<p>Increment the address lines (LA, LB, LC and LD) to point to the next rows.</p>
</li>
<li>
<p>Keep repeating the above to keep the display lit.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using the PRU we are able to run the clock a about 2.9 MKHz.
<a href="#blocks_rgb_fpp">FPP waveforms</a> shows the optimized assembler code used by FPP clocks in
at some 6.3 MHz.  So the compiler is doing a pretty good job, but you can run
some two times faster if you want to use assembly code.  In fairness to FPP,
it&#8217;s having to pull it&#8217;s data out of RAM to display it, so isn&#8217;t not a good
comparision.</p>
</div>
<div id="blocks_rgb_fpp" class="imageblock">
<div class="content">
<img src="figures/rgb_fpp.png" alt="FPP waveforms">
</div>
<div class="title">Figure 29. FPP waveforms</div>
</div>
<div class="sect4">
<h5 id="_getting_more_colors"><a class="link" href="#_getting_more_colors">Getting More Colors</a></h5>
<div class="paragraph">
<p>The Adafruit description goes on to say:</p>
</div>
<div class="verseblock">
<pre class="content">The only downside of this technique is that despite being very simple and fast, it has no PWM control built-in! The controller can only set the LEDs on or off. So what do you do when you want full color? You actually need to draw the entire matrix over and over again at very high speeds to PWM the matrix manually. For that reason, you need to have a very fast controller (50 MHz is a minimum) if you want to do a lot of colors and motion video and have it look good.</pre>
<div class="attribution">
&#8212; https://cdn-learn.adafruit.com/downloads/pdf/32x16-32x32-rgb-led-matrix.pdf
</div>
</div>
<div class="paragraph">
<p>This is what FPP does, but it&#8217;s beyond the scope of this project.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_compiling_and_inserting_rpmsg_pru"><a class="link" href="#_compiling_and_inserting_rpmsg_pru">1.16. Compiling and Inserting rpmsg_pru</a></h3>
<div class="sect3">
<h4 id="_problem_16"><a class="link" href="#_problem_16">Problem</a></h4>
<div class="paragraph">
<p>Your Beagle doesn&#8217;t have rpmsg_pru.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solution_16"><a class="link" href="#_solution_16">Solution</a></h4>
<div class="paragraph">
<p>Do the following.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>bone$ <strong>cd 05blocks/code/module</strong>
bone$ <strong>sudo apt install linux-headers-`uname -r`</strong>
bone$ <strong>wget https://github.com/beagleboard/linux/raw/4.9/drivers/rpmsg/rpmsg_pru.c</strong>
bone$ <strong>make</strong>
make -C /lib/modules/4.9.88-ti-r111/build M=$PWD
make[1]: Entering directory '/usr/src/linux-headers-4.9.88-ti-r111'
  LD      /home/debian/PRUCookbook/docs/05blocks/code/module/built-in.o
  CC [M]  /home/debian/PRUCookbook/docs/05blocks/code/module/rpmsg_client_sample.o
  CC [M]  /home/debian/PRUCookbook/docs/05blocks/code/module/rpmsg_pru.o
  Building modules, stage 2.
  MODPOST 2 modules
  CC      /home/debian/PRUCookbook/docs/05blocks/code/module/rpmsg_client_sample.mod.o
  LD [M]  /home/debian/PRUCookbook/docs/05blocks/code/module/rpmsg_client_sample.ko
  CC      /home/debian/PRUCookbook/docs/05blocks/code/module/rpmsg_pru.mod.o
  LD [M]  /home/debian/PRUCookbook/docs/05blocks/code/module/rpmsg_pru.ko
make[1]: Leaving directory '/usr/src/linux-headers-4.9.88-ti-r111'
bone$ <strong>insmod rpmsg_pru.ko</strong>
bone$ <strong>lsmod | grep rpm</strong>
rpmsg_pru               5799  2
virtio_rpmsg_bus       13620  0
rpmsg_core              8537  2 rpmsg_pru,virtio_rpmsg_bus</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s now installed and ready to go.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_copyright"><a class="link" href="#_copyright">1.17. Copyright</a></h3>
<div class="listingblock">
<div class="title">copyright.c</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td>
  <td class="code"><pre><span class="comment">/*
 * Copyright (C) 2015 Texas Instruments Incorporated - http://www.ti.com/
 *
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 *  * Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 *
 *  * Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the
 *    distribution.
 *
 *  * Neither the name of Texas Instruments Incorporated nor the names of
 *    its contributors may be used to endorse or promote products derived
 *    from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */</span></pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-07-03 11:08:26 -0400
</div>
</div>
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid currentColor;opacity:.35;padding:0 .5em 0 0}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</body>
</html>